<!-- build time:Tue Aug 18 2020 21:54:23 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.0.0"><meta name="baidu-site-verification" content="CpUtq7PVXz"><meta name="baidu-site-verification" content="yBAdXP3M7c"><meta name="google-site-verification" content="BDfwg8yARZd_uEasrK3RvZGmWmUg37NQSE3cumBTgMI"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="baidu-site-verification" content="64WFuMirLucMnUVd"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"7.4.2",exturl:!0,sidebar:{position:"left",display:"post",offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"Copy",copy_success:"Copied",copy_failure:"Copy failed"},sidebarPadding:40}</script><meta name="description" content="PE文件需要认真学的地方了，我多次学这个都放弃了，这次得认真学下去手动解析PE文件dos头123456789101112131415161718192021typedef struct _IMAGE_DOS_HEADER &amp;#123;      &#x2F;&#x2F; DOS .EXE header    WORD   e_magic;                     &#x2F;&#x2F; Magic number *"><meta name="keywords" content="reverse,逆向"><meta property="og:type" content="article"><meta property="og:title" content="15-pe文件"><meta property="og:url" content="https:&#x2F;&#x2F;noonegroup.xyz&#x2F;posts&#x2F;6fd44671&#x2F;index.html"><meta property="og:site_name" content="NoOne"><meta property="og:description" content="PE文件需要认真学的地方了，我多次学这个都放弃了，这次得认真学下去手动解析PE文件dos头123456789101112131415161718192021typedef struct _IMAGE_DOS_HEADER &amp;#123;      &#x2F;&#x2F; DOS .EXE header    WORD   e_magic;                     &#x2F;&#x2F; Magic number *"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;NoOne-hub&#x2F;picture&#x2F;raw&#x2F;master&#x2F;img&#x2F;20200131155415.png"><meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;NoOne-hub&#x2F;picture&#x2F;raw&#x2F;master&#x2F;img&#x2F;20200131154632.png"><meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;NoOne-hub&#x2F;picture&#x2F;raw&#x2F;master&#x2F;img&#x2F;20200131205411.png"><meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;NoOne-hub&#x2F;picture&#x2F;raw&#x2F;master&#x2F;img&#x2F;20200202122230.png"><meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;NoOne-hub&#x2F;picture&#x2F;raw&#x2F;master&#x2F;img&#x2F;20200204145337.png"><meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;NoOne-hub&#x2F;picture&#x2F;raw&#x2F;master&#x2F;img&#x2F;20200204145314.png"><meta property="og:updated_time" content="2020-08-18T12:45:06.528Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;NoOne-hub&#x2F;picture&#x2F;raw&#x2F;master&#x2F;img&#x2F;20200131155415.png"><link rel="canonical" href="https://noonegroup.xyz/posts/6fd44671/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>15-pe文件 | NoOne</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">NoOne</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-fw fa-link"></i>友链</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Searching..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL05vT25lLWh1Yg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></span><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans"><link itemprop="mainEntityOfPage" href="https://noonegroup.xyz/posts/6fd44671/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/photo.jpg"><meta itemprop="name" content="NoOne"><meta itemprop="description" content></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="NoOne"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">15-pe文件</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2020-01-28 23:23:00" itemprop="dateCreated datePublished" datetime="2020-01-28T23:23:00+08:00">2020-01-28</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2020-08-18 20:45:06" itemprop="dateModified" datetime="2020-08-18T20:45:06+08:00">2020-08-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/bin/" itemprop="url" rel="index"><span itemprop="name">bin</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/bin/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span> </a></span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/bin/%E9%80%86%E5%90%91/%E6%BB%B4%E6%B0%B4%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">滴水逆向</span> </a></span></span><span id="/posts/6fd44671/" class="post-meta-item leancloud_visitors" data-flag-title="15-pe文件" title="Views"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span class="leancloud-visitors-count"></span> </span><span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine: </span><a title="valine" href="/posts/6fd44671/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/posts/6fd44671/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>61k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>55 mins.</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="PE文件"><a href="#PE文件" class="headerlink" title="PE文件"></a>PE文件</h1><p>需要认真学的地方了，我多次学这个都放弃了，这次得认真学下去</p><h2 id="手动解析PE文件"><a href="#手动解析PE文件" class="headerlink" title="手动解析PE文件"></a>手动解析PE文件</h2><h3 id="dos头"><a href="#dos头" class="headerlink" title="dos头"></a>dos头</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span> &#123;</span>      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number *</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// Bytes on last page of file</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// Pages in file</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// Relocations</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// Size of header in paragraphs</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// Minimum extra paragraphs needed</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// Maximum extra paragraphs needed</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// Initial (relative) SS value</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// Initial SP value</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// Initial IP value</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// Initial (relative) CS value</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// File address of relocation table</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM identifier (for e_oeminfo)</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM information; e_oemid specific</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// File address of new exe header *</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure><a id="more"></a><p>总大小为60+4 = 64 = 0x3c + 4</p><p>我以吾爱破解od的exe为例进行观察</p><p>带*为必背的</p><ol><li>e_magic</li><li>e_lfanew</li></ol><p>第一个ascii为MZ ,一般用于判断是否是DOS_HEADER</p><p>第二个表示NT_HEADER的偏移地址 (计算方法　０+e_lfanew) 0代表基址</p><table><thead><tr><th>变量名</th><th>变量值</th></tr></thead><tbody><tr><td>e_magic</td><td>5A4D</td></tr><tr><td>e_cblp</td><td>0050</td></tr><tr><td>e_cp</td><td>0002</td></tr><tr><td>e_crlc</td><td>0000</td></tr><tr><td>e_cparhdr</td><td>0004</td></tr><tr><td>e_minalloc</td><td>000F</td></tr><tr><td>e_maxalloc</td><td>FFFF</td></tr><tr><td>e_ss</td><td>0000</td></tr><tr><td>e_sp</td><td>00B8</td></tr><tr><td>e_csum</td><td>0000</td></tr><tr><td>e_ip</td><td>0000</td></tr><tr><td>e_cs</td><td>0000</td></tr><tr><td>e_lfarlc</td><td>0040</td></tr><tr><td>e_ovno</td><td>001A</td></tr><tr><td>e_res[4]</td><td>0000 * 0x4</td></tr><tr><td>e_oemid</td><td>0000</td></tr><tr><td>e_oeminfo</td><td>0000</td></tr><tr><td>e_res2[10]</td><td>0000 * 0xA</td></tr><tr><td>e_lfanew</td><td>0000 0200</td></tr></tbody></table><h3 id="NT-HEADER"><a href="#NT-HEADER" class="headerlink" title="NT_HEADER"></a>NT_HEADER</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NT_HEADER</span> &#123;</span></span><br><span class="line">    DWORD signature; <span class="comment">//ansi字符串　恒定为50 45 PE</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">IMAGE_FILE_HEADER</span> <span class="title">fileHeader</span>;</span> <span class="comment">//后续介绍</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">IMAGE_OPTIONAL_HEADER</span> <span class="title">optionalHeader</span>;</span><span class="comment">//后续介绍</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IMAGE-FILE-HEADER"><a href="#IMAGE-FILE-HEADER" class="headerlink" title="IMAGE_FILE_HEADER"></a>IMAGE_FILE_HEADER</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class="line">  WORD  Machine;  <span class="comment">//*</span></span><br><span class="line">  WORD  NumberOfSections;<span class="comment">//*</span></span><br><span class="line">  DWORD TimeDateStamp;<span class="comment">//*</span></span><br><span class="line">  DWORD PointerToSymbolTable;</span><br><span class="line">  DWORD NumberOfSymbols;</span><br><span class="line">  WORD  SizeOfOptionalHeader;<span class="comment">//*</span></span><br><span class="line">  WORD  Characteristics;<span class="comment">//*</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure><table><thead><tr><th>变量名</th><th>变量值</th></tr></thead><tbody><tr><td>Machine</td><td>014C</td></tr><tr><td>NumberOfSections</td><td>0009</td></tr><tr><td>TimeDateStamp</td><td>40B10868</td></tr><tr><td>PointerToSymbolTable</td><td>00000000</td></tr><tr><td>NumberOfSymbols</td><td>00000000</td></tr><tr><td>SizeOfOptionalHeader</td><td>00E0</td></tr><tr><td>Characteristics</td><td>010E</td></tr></tbody></table><p>总大小为: 20 = 0x14</p><ol><li>Machine 代表的是PE文件的类型，只会为三个值<ul><li>0x014c(x86架构)</li><li>0x0200(英特尔安腾架构 已基本废弃)</li><li>0x8664(64架构程序)</li></ul></li><li>NumberOfSections 表示节(块, 区段)的数量</li><li>TimeDateStamp 文件编译的时间</li><li>SizeOfOptionalHeader 是可选头的大小</li><li>Characteristics 文件属性,dll跟exe标志存放</li></ol><h3 id="IMAGE-OPTIONAL-HEADER"><a href="#IMAGE-OPTIONAL-HEADER" class="headerlink" title="IMAGE_OPTIONAL_HEADER"></a>IMAGE_OPTIONAL_HEADER</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORD    Magic; <span class="comment">//*</span></span><br><span class="line">    BYTE    MajorLinkerVersion;</span><br><span class="line">    BYTE    MinorLinkerVersion;</span><br><span class="line">    DWORD   SizeOfCode; <span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfInitializedData;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfUninitializedData;<span class="comment">//*</span></span><br><span class="line">    DWORD   AddressOfEntryPoint;<span class="comment">//*</span></span><br><span class="line">    DWORD   BaseOfCode;<span class="comment">//*</span></span><br><span class="line">    DWORD   BaseOfData;<span class="comment">//*</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;<span class="comment">//*</span></span><br><span class="line">    DWORD   SectionAlignment;<span class="comment">//*</span></span><br><span class="line">    DWORD   FileAlignment;<span class="comment">//*</span></span><br><span class="line">    WORD    MajorOperatingSystemVersion;</span><br><span class="line">    WORD    MinorOperatingSystemVersion;</span><br><span class="line">    WORD    MajorImageVersion;</span><br><span class="line">    WORD    MinorImageVersion;</span><br><span class="line">    WORD    MajorSubsystemVersion;</span><br><span class="line">    WORD    MinorSubsystemVersion;</span><br><span class="line">    DWORD   Win32VersionValue;</span><br><span class="line">    DWORD   SizeOfImage;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfHeaders;<span class="comment">//*</span></span><br><span class="line">    DWORD   CheckSum;<span class="comment">//*</span></span><br><span class="line">    WORD    Subsystem;</span><br><span class="line">    WORD    DllCharacteristics;</span><br><span class="line">    DWORD   SizeOfStackReserve;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfStackCommit;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfHeapReserve;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfHeapCommit;<span class="comment">//*</span></span><br><span class="line">    DWORD   LoaderFlags;</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure><p>Standard fields.</p><table><thead><tr><th>变量名</th><th>变量值</th></tr></thead><tbody><tr><td>Magic</td><td>010B</td></tr><tr><td>MajorLinkerVersion</td><td>05</td></tr><tr><td>MinorLinkerVersion</td><td>00</td></tr><tr><td>SizeOfCode</td><td>000AF000</td></tr><tr><td>SizeOfInitializedData</td><td>0016CE00</td></tr><tr><td>SizeOfUninitializedData</td><td>00000000</td></tr><tr><td>AddressOfEntryPoint</td><td>00001000</td></tr><tr><td>BaseOfCode</td><td>00001000</td></tr><tr><td>BaseOfData</td><td>000B0000</td></tr></tbody></table><p>NT additional fields.</p><table><thead><tr><th>变量名</th><th>变量值</th></tr></thead><tbody><tr><td>ImageBase</td><td>00400000</td></tr><tr><td>SectionAlignment</td><td>00001000</td></tr><tr><td>FileAlignment</td><td>00000200</td></tr><tr><td>MajorOperatingSystemVersion</td><td>0004</td></tr><tr><td>MinorOperatingSystemVersion</td><td>0000</td></tr><tr><td>MajorImageVersion</td><td>0000</td></tr><tr><td>MinorImageVersion</td><td>0000</td></tr><tr><td>MajorSubsystemVersion</td><td>0004</td></tr><tr><td>MinorSubsystemVersion</td><td>0000</td></tr><tr><td>Win32VersionValue</td><td>00000000</td></tr><tr><td>SizeOfImage</td><td>001AF000</td></tr><tr><td>SizeOfHeaders</td><td>00000600</td></tr><tr><td>CheckSum</td><td>00000000</td></tr><tr><td>Subsystem</td><td>0002</td></tr><tr><td>DllCharacteristics</td><td>0000</td></tr><tr><td>SizeOfStackReserve</td><td>00100000</td></tr><tr><td>SizeOfStackCommit</td><td>00020000</td></tr><tr><td>SizeOfHeapReserve</td><td>01000000</td></tr><tr><td>SizeOfHeapCommit</td><td>00001000</td></tr><tr><td>LoaderFlags</td><td>00000000</td></tr><tr><td>NumberOfRvaAndSizes</td><td>00000010</td></tr><tr><td>IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]</td><td>非常多暂时不管</td></tr></tbody></table><ol><li>Magic: The state of the image file.<ul><li>0x010b <strong>IMAGE_NT_OPTIONAL_HDR32_MAGIC</strong> The file is an executable image.</li><li>0x020b <strong>IMAGE_NT_OPTIONAL_HDR64_MAGIC</strong> The file is an executable image.</li><li>0x0107 <strong>IMAGE_ROM_OPTIONAL_HDR_MAGIC</strong> The file is a ROM image.</li></ul></li><li>SizeOfCode: The size of the code section, in bytes, or the sum of all such sections if there are multiple code sections. 简单来说就是代码段有多大</li><li>SizeOfInitializedData: The size of the initialized data section, in bytes, or the sum of all such sections if there are multiple initialized data sections. 初始化数据段长度</li><li>SizeOfUninitializedData: The size of the uninitialized data section, in bytes, or the sum of all such sections if there are multiple uninitialized data section 未初始化数据段长度</li><li>AddressOfEntryPoint: A pointer to the entry point function, relative to the image base address. For executable files, this is the starting address. For device drivers, this is the address of the initialization function. The entry point function is optional for DLLs. When no entry point is present, this member is zero. 入口点地址</li><li>BaseOfCode: A pointer to the beginning of the code section, relative to the image base.</li><li>BaseOfData: A pointer to the beginning of the data section, relative to the image base</li><li>ImageBase: The preferred address of the first byte of the image when it is loaded in memory. This value is a multiple of 64K bytes. The default value for DLLs is 0x10000000. The default value for applications is 0x00400000, except on Windows CE where it is 0x00010000.</li><li>SectionAlignment: The alignment of sections loaded in memory, in bytes. This value must be greater than or equal to the <strong>FileAlignment</strong> member. The default value is the page size for the system.</li><li>FileAlignment: The alignment of the raw data of sections in the image file, in bytes. The value should be a power of 2 between 512 and 64K (inclusive). The default is 512. If the <strong>SectionAlignment</strong> member is less than the system page size, this member must be the same as <strong>SectionAlignment</strong>.</li><li>SizeOfImage: The size of the image, in bytes, including all headers. Must be a multiple of <strong>SectionAlignment</strong>.</li><li>SizeOfHeaders: The combined size of the following items, rounded to a multiple of the value specified in the <strong>FileAlignment</strong> member.<ul><li><strong>e_lfanew</strong> member of <strong>IMAGE_DOS_HEADER</strong></li><li>4 byte signature</li><li>size of <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vd2luZG93cy9kZXNrdG9wL2FwaS93aW5udC9ucy13aW5udC1pbWFnZV9maWxlX2hlYWRlcg==" title="https://docs.microsoft.com/windows/desktop/api/winnt/ns-winnt-image_file_header">IMAGE_FILE_HEADER<i class="fa fa-external-link"></i></span></li><li>size of optional header</li><li>size of all section headers</li></ul></li><li>CheckSum: The image file checksum. The following files are validated at load time: all drivers, any DLL loaded at boot time, and any DLL loaded into a critical system process.</li><li>SizeOfStackReserve: The number of bytes to reserve for the stack. Only the memory specified by the <strong>SizeOfStackCommit</strong> member is committed at load time; the rest is made available one page at a time until this reserve size is reached.</li><li>SizeOfStackCommit: The number of bytes to commit for the stack.</li><li>SizeOfHeapReserve: The number of bytes to reserve for the local heap. Only the memory specified by the <strong>SizeOfHeapCommit</strong> member is committed at load time; the rest is made available one page at a time until this reserve size is reached.</li><li>The number of bytes to commit for the local heap.</li></ol><h2 id="pe文件解析"><a href="#pe文件解析" class="headerlink" title="pe文件解析"></a>pe文件解析</h2><p>doc头</p><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>WORD e_magic</td><td>*</td><td></td><td></td><td>“MZ标记” 用于判断是否为可执行文件.</td><td></td><td></td><td></td></tr><tr><td>DWORD e_lfanew;</td><td>*</td><td></td><td></td><td>PE头相对于文件的偏移，用于定位PE文件</td><td></td><td></td><td></td></tr></tbody></table><p>标准pe头</p><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>WORD Machine; *</td><td></td><td></td><td></td><td>程序运行的CPU型号：0x0 任何处理器/0x14C 386及后续处理器</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD NumberOfSections; *</td><td></td><td></td><td></td><td>文件中存在的节的总数,如果要新增节或者合并节 就要修改这个值.</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD TimeDateStamp; *</td><td></td><td></td><td></td><td>时间戳：文件的创建时间(和操作系统的创建时间无关)，编译器填写的.</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD PointerToSymbolTable;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD NumberOfSymbols;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD SizeOfOptionalHeader; *</td><td></td><td></td><td></td><td>可选PE头的大小，32位PE文件默认E0h 64位PE文件默认为F0h 大小可以自定义.</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD Characteristics; *</td><td></td><td></td><td></td><td>每个位有不同的含义，可执行文件值为10F 即0 1 2 3 8位置1</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>可选PE头：</p><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>WORD Magic; *</td><td></td><td></td><td></td><td>说明文件类型：10B 32位下的PE文件 20B 64位下的PE文件</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>BYTE MajorLinkerVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>BYTE MinorLinkerVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfCode;*</td><td></td><td></td><td></td><td>所有代码节的和，必须是FileAlignment的整数倍 编译器填的 没用</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfInitializedData;*</td><td></td><td></td><td></td><td>已初始化数据大小的和,必须是FileAlignment的整数倍 编译器填的 没用</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfUninitializedData;*</td><td></td><td></td><td></td><td>未初始化数据大小的和,必须是FileAlignment的整数倍 编译器填的 没用</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD AddressOfEntryPoint;*</td><td></td><td></td><td></td><td>程序入口</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD BaseOfCode;*</td><td></td><td></td><td></td><td>代码开始的基址，编译器填的 没用</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD BaseOfData;*</td><td></td><td></td><td></td><td>数据开始的基址，编译器填的 没用</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD ImageBase;*</td><td></td><td></td><td></td><td>内存镜像基址</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SectionAlignment;*</td><td></td><td></td><td></td><td>内存对齐</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD FileAlignment;*</td><td></td><td></td><td></td><td>文件对齐</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD MajorOperatingSystemVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD MinorOperatingSystemVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD MajorImageVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD MinorImageVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD MajorSubsystemVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD MinorSubsystemVersion;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD Win32VersionValue;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfImage;*</td><td></td><td></td><td></td><td>内存中整个PE文件的映射的尺寸，可以比实际的值大，但必须是SectionAlignment的整数倍</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfHeaders;*</td><td></td><td></td><td></td><td>所有头+节表按照文件对齐后的大小，否则加载会出错</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD CheckSum;*</td><td></td><td></td><td></td><td>校验和，一些系统文件有要求.用来判断文件是否被修改.</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD Subsystem;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>WORD DllCharacteristics;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfStackReserve;*</td><td></td><td></td><td></td><td>初始化时保留的堆栈大小</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfStackCommit;*</td><td></td><td></td><td></td><td>初始化时实际提交的大小</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfHeapReserve;*</td><td></td><td></td><td></td><td>初始化时保留的堆大小</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD SizeOfHeapCommit;*</td><td></td><td></td><td></td><td>初始化时实践提交的大小</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD LoaderFlags;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DWORD NumberOfRvaAndSizes;*</td><td></td><td></td><td></td><td>目录项数目</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><h2 id="编写exe读取PE头"><a href="#编写exe读取PE头" class="headerlink" title="编写exe读取PE头"></a>编写exe读取PE头</h2><p>name.h:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NAME_H_INCLUDED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NAME_H_INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> DWORD;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">short</span> WORD;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> BYTE;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> LONG;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span>* LPRVOID;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">short</span>* PWORD;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span>* PDWORD;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DOS_SIGNATURE 0x5A4D</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_NT_SIGNATURE 0x4550</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SIZEOF_FILE_HEADER 20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span> &#123;</span>      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number *</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// Bytes on last page of file</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// Pages in file</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// Relocations</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// Size of header in paragraphs</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// Minimum extra paragraphs needed</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// Maximum extra paragraphs needed</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// Initial (relative) SS value</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// Initial SP value</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// Initial IP value</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// Initial (relative) CS value</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// File address of relocation table</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM identifier (for e_oeminfo)</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM information; e_oemid specific</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// File address of new exe header *</span></span><br><span class="line">&#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class="line">  WORD  Machine;  <span class="comment">//*</span></span><br><span class="line">  WORD  NumberOfSections;<span class="comment">//*</span></span><br><span class="line">  DWORD TimeDateStamp;<span class="comment">//*</span></span><br><span class="line">  DWORD PointerToSymbolTable;</span><br><span class="line">  DWORD NumberOfSymbols;</span><br><span class="line">  WORD  SizeOfOptionalHeader;<span class="comment">//*</span></span><br><span class="line">  WORD  Characteristics;<span class="comment">//*</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORD    Magic; <span class="comment">//*</span></span><br><span class="line">    BYTE    MajorLinkerVersion;</span><br><span class="line">    BYTE    MinorLinkerVersion;</span><br><span class="line">    DWORD   SizeOfCode; <span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfInitializedData;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfUninitializedData;<span class="comment">//*</span></span><br><span class="line">    DWORD   AddressOfEntryPoint;<span class="comment">//*</span></span><br><span class="line">    DWORD   BaseOfCode;<span class="comment">//*</span></span><br><span class="line">    DWORD   BaseOfData;<span class="comment">//*</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;<span class="comment">//*</span></span><br><span class="line">    DWORD   SectionAlignment;<span class="comment">//*</span></span><br><span class="line">    DWORD   FileAlignment;<span class="comment">//*</span></span><br><span class="line">    WORD    MajorOperatingSystemVersion;</span><br><span class="line">    WORD    MinorOperatingSystemVersion;</span><br><span class="line">    WORD    MajorImageVersion;</span><br><span class="line">    WORD    MinorImageVersion;</span><br><span class="line">    WORD    MajorSubsystemVersion;</span><br><span class="line">    WORD    MinorSubsystemVersion;</span><br><span class="line">    DWORD   Win32VersionValue;</span><br><span class="line">    DWORD   SizeOfImage;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfHeaders;<span class="comment">//*</span></span><br><span class="line">    DWORD   CheckSum;<span class="comment">//*</span></span><br><span class="line">    WORD    Subsystem;</span><br><span class="line">    WORD    DllCharacteristics;</span><br><span class="line">    DWORD   SizeOfStackReserve;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfStackCommit;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfHeapReserve;<span class="comment">//*</span></span><br><span class="line">    DWORD   SizeOfHeapCommit;<span class="comment">//*</span></span><br><span class="line">    DWORD   LoaderFlags;</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;</span><br><span class="line">    <span class="comment">//IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span></span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NT_HEADER</span> &#123;</span></span><br><span class="line">    DWORD signature; <span class="comment">//ansi字符串　恒定为50 45 PE</span></span><br><span class="line">    IMAGE_FILE_HEADER fileHeader; <span class="comment">//后续介绍</span></span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 optionalHeader;<span class="comment">//后续介绍</span></span><br><span class="line">&#125; IMAGE_NT_HEADERS, *PIMAGE_NT_HEADERS;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// NAME_H_INCLUDED</span></span></span><br></pre></td></tr></table></figure><p>main.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"name.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">LPRVOID <span class="title">ReadPEFile</span><span class="params">(LPRVOID fileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *pFile = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD fileSize = <span class="number">0</span>;</span><br><span class="line">    LPRVOID pFileBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//open file</span></span><br><span class="line">    <span class="keyword">if</span>(!(pFile=fopen(fileName, <span class="string">"rb"</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"无法打开exe文件\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//read the size</span></span><br><span class="line">    <span class="keyword">if</span>(fseek(pFile, <span class="number">0</span>, SEEK_END)!=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fseek end error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((fileSize = ftell(pFile)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"size error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fseek(pFile, <span class="number">0</span>, SEEK_SET)!=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fseek start error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(pFileBuffer = <span class="built_in">malloc</span>(fileSize)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"malloc error\n"</span>);</span><br><span class="line">        fclose(pFile);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//read into buffer</span></span><br><span class="line">    <span class="keyword">if</span>(!fread(pFileBuffer, fileSize, <span class="number">1</span>, pFile))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"read error\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">        fclose(pFile);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(pFile);</span><br><span class="line">    <span class="keyword">return</span> pFileBuffer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintHeaders</span><span class="params">(LPRVOID addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPRVOID pFileBuffer = addr;</span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!pFileBuffer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Read file error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//judge if start with MZ</span></span><br><span class="line">    <span class="keyword">if</span>(*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Not a pe file!!!\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************DOS头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"MZ标志: 0x%x\n"</span>, pDosHeader-&gt;e_magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PE偏移: 0x%x\n"</span>, pDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">//judge if pe</span></span><br><span class="line">    <span class="keyword">if</span>(*((PDWORD)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew)) != IMAGE_NT_SIGNATURE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"不是有效的PE标志\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">//print NT_Header</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************NT头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NT: 0x%x\n"</span>, pNTHeader-&gt;signature);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************PE头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PE: 0x%x\n"</span>, pPEHeader-&gt;Machine);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfSections: 0x%x\n"</span>, pPEHeader-&gt;NumberOfSections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"TimeDateStamp: 0x%x\n"</span>, pPEHeader-&gt;TimeDateStamp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfOptionHeader: 0x%x\n"</span>, pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Characteristics: 0x%x\n"</span>, pPEHeader-&gt;Characteristics);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************OPTIOIN_PE头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"OPTION_PE: 0x%x\n"</span>, pOptionHeader-&gt;Magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"AddressOfEntryPoint: 0x%x\n"</span>, pOptionHeader-&gt;AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ImageBase: 0x%x\n"</span>, pOptionHeader-&gt;ImageBase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SectionAlignment: 0x%x\n"</span>, pOptionHeader-&gt;SectionAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"FileAlignment: 0x%x\n"</span>, pOptionHeader-&gt;FileAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfImage: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfImage);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfHeaders: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfHeaders);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CheckSum: 0x%x\n"</span>, pOptionHeader-&gt;CheckSum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfStackReserve: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfStackReserve);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfStackCommit: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfStackCommit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfHeapReserve: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfHeapReserve);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfHeapCommit: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfHeapCommit);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The real entrypoint is: 0x%x"</span>, pOptionHeader-&gt;ImageBase + pOptionHeader-&gt;AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPRVOID addr = ReadPEFile(<span class="string">"C:\\吾爱破解[LCG].exe"</span>);</span><br><span class="line">    PrintHeaders(addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过StudyPE对比一致</p><h2 id="节表学习"><a href="#节表学习" class="headerlink" title="节表学习"></a>节表学习</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_SIZEOF_SHORT_NAME              8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;</span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   SizeOfRawData;</span><br><span class="line">    DWORD   PointerToRawData;</span><br><span class="line">    DWORD   PointerToRelocations;</span><br><span class="line">    DWORD   PointerToLinenumbers;</span><br><span class="line">    WORD    NumberOfRelocations;</span><br><span class="line">    WORD    NumberOfLinenumbers;</span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure><p>节表通过pPEHeader的NumberOfSection 还有 SizeOfOptionHeader两个来查找，通过SizeOfOptionHeader可以找到节表起始地址，而NumberOfSection可以当做循环的终止条件，进行遍历查找</p><p>8+4*6+4+4=40</p><ol><li>Name:8个字节,一般情况下是以”\0”结尾的ASCII吗字符串来标识的名称，内容可以自定义.<ul><li>注意：该名称并不遵守必须以”\0”结尾的规律，如果不是以”\0”结尾，系统会截取8个字节的长度进行处理.</li></ul></li><li>Misc: 双字 是该节在没有对齐前的真实尺寸,该值可以不准确。</li><li>VirtualAddress 节区在内存中的偏移地址。加上ImageBase才是在内存中的真正地址.</li><li>SizeOfRawData 节在文件中对齐后的尺寸.</li><li>PointerToRawData 节区在文件中的偏移.</li><li>PointerToRelocations 在obj文件中使用 对exe无意义 //不用背</li><li>PointerToLinenumbers 行号表的位置 调试的时候使用//不用背</li><li>NumberOfRelocations 在obj文件中使用 对exe无意义//不用背</li><li>NumberOfLinenumbers 行号表中行号的数量 调试的时候使用//不用背</li><li>Characteristics 节的属性</li></ol><p><img src="https://gitee.com/NoOne-hub/picture/raw/master/img/20200131155415.png" alt></p><p>PE加载的过程：</p><ol><li>根据SizeOfImage的大小，开辟一块缓冲区(ImageBuffer).</li><li>根据SizeOfHeader的大小，将头信息从FileBuffer拷贝到ImageBuffer</li><li>根据节表中的信息循环讲FileBuffer中的节拷贝到ImageBuffer中.</li></ol><p><img src="https://gitee.com/NoOne-hub/picture/raw/master/img/20200131154632.png" alt></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PIMAGE_SECTION_HEADER pSectionHeader =(PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"********************IMAGE_SECTIONS_HEADER********************\n"</span>);</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(; i&lt;pPEHeader-&gt;NumberOfSections; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Name: %s\n"</span>, pSectionHeader-&gt;Name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Misc: 0x%x\n"</span>, pSectionHeader-&gt;Misc.PhysicalAddress);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"VirtualAddress: 0x%x\n"</span>, pSectionHeader-&gt;VirtualAddress);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfRawData: 0x%x\n"</span>, pSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PointerToRawData: 0x%x\n"</span>, pSectionHeader-&gt;PointerToRawData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Characteristics: 0x%x\n"</span>, pSectionHeader-&gt;Characteristics);</span><br><span class="line">    pSectionHeader += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="FileBuffer和ImageBuffer"><a href="#FileBuffer和ImageBuffer" class="headerlink" title="FileBuffer和ImageBuffer"></a>FileBuffer和ImageBuffer</h2><p>PE加载的过程：<br>1、根据SizeOfImage的大小，开辟一块缓冲区(ImageBuffer).<br>2、根据SizeOfHeader的大小，将头信息从FileBuffer拷贝到ImageBuffer<br>3、根据节表中的信息循环讲FileBuffer中的节拷贝到ImageBuffer中.<br>4、Misc.VirtualSize 和 SizeOfRawData谁大？ 看情况，VirtualSize是内存中的，而SizeOfRawData是文件中的<br>5、FileBuffer与ImageBuffer谁大？ ImageBuffer大</p><h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p><img src="https://gitee.com/NoOne-hub/picture/raw/master/img/20200131205411.png" alt></p><p>2、编写一个函数，能够将RVA的值转换成FOA.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"name.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="comment">//ReadPEFile:将文件读取到缓冲区</span></span><br><span class="line"><span class="comment">//参数说明：</span></span><br><span class="line"><span class="comment">//fileName 文件路径</span></span><br><span class="line"><span class="comment">//pFileBuffer 缓冲区指针</span></span><br><span class="line"><span class="comment">//返回值说明：</span></span><br><span class="line"><span class="comment">//读取失败返回0  否则返回实际读取的大小</span></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="function">DWORD <span class="title">ReadPEFile</span><span class="params">(IN LPSTR fileName,OUT LPVOID* pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *pFile = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD fileSize = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//open file</span></span><br><span class="line">    <span class="keyword">if</span>(!(pFile=fopen(fileName, <span class="string">"rb"</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"无法打开exe文件\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//read the size</span></span><br><span class="line">    <span class="keyword">if</span>(fseek(pFile, <span class="number">0</span>, SEEK_END)!=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fseek end error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((fileSize = ftell(pFile)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"size error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fseek(pFile, <span class="number">0</span>, SEEK_SET)!=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fseek pSectionHeader error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(*pFileBuffer = <span class="built_in">malloc</span>(fileSize)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"malloc error\n"</span>);</span><br><span class="line">        fclose(pFile);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//read into buffer</span></span><br><span class="line">    <span class="keyword">if</span>(!fread(*pFileBuffer, fileSize, <span class="number">1</span>, pFile))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"read error\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">        fclose(pFile);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(pFile);</span><br><span class="line">    <span class="keyword">return</span> fileSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//CopyFileBufferToImageBuffer:将文件从FileBuffer复制到ImageBuffer</span></span><br><span class="line"><span class="comment">//参数说明：</span></span><br><span class="line"><span class="comment">//pFileBuffer  FileBuffer指针</span></span><br><span class="line"><span class="comment">//pImageBuffer ImageBuffer指针</span></span><br><span class="line"><span class="comment">//返回值说明：</span></span><br><span class="line"><span class="comment">//读取失败返回0  否则返回复制的大小</span></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="function">DWORD <span class="title">CopyFileBufferToImageBuffer</span><span class="params">(IN LPVOID pFileBuffer,OUT LPVOID* pImageBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//记录复制数</span></span><br><span class="line">    DWORD copyNum = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取ImageBuffer大小</span></span><br><span class="line">    DWORD ImageSize = pOptionHeader-&gt;SizeOfImage;</span><br><span class="line">    <span class="comment">//申请内存</span></span><br><span class="line">    <span class="keyword">if</span>(!(*pImageBuffer = <span class="built_in">calloc</span>(ImageSize, <span class="number">1</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"malloc error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取SizeOfHeaders</span></span><br><span class="line">    DWORD HeadersSize = pOptionHeader-&gt;SizeOfHeaders;</span><br><span class="line">    <span class="comment">//复制全部头+节表+文件对齐</span></span><br><span class="line">    <span class="built_in">memcpy</span>(*pImageBuffer, pFileBuffer, HeadersSize);</span><br><span class="line">    copyNum += HeadersSize;</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; i&lt;NumberOfSection; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//获取SizeOfRawData</span></span><br><span class="line">        DWORD SizeOfRawData = pSectionHeader-&gt;SizeOfRawData;</span><br><span class="line">        <span class="comment">//获取VirtualAddress + ImageBuffer</span></span><br><span class="line">        <span class="built_in">memcpy</span>((LPVOID)((DWORD)*pImageBuffer + pSectionHeader-&gt;VirtualAddress), (LPVOID)((DWORD)pFileBuffer + pSectionHeader-&gt;PointerToRawData), SizeOfRawData);</span><br><span class="line">        copyNum += SizeOfRawData;</span><br><span class="line">        pSectionHeader += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> copyNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//CopyImageBufferToNewBuffer:将ImageBuffer中的数据复制到新的缓冲区</span></span><br><span class="line"><span class="comment">//参数说明：</span></span><br><span class="line"><span class="comment">//pImageBuffer ImageBuffer指针</span></span><br><span class="line"><span class="comment">//pNewBuffer NewBuffer指针</span></span><br><span class="line"><span class="comment">//返回值说明：</span></span><br><span class="line"><span class="comment">//读取失败返回0  否则返回复制的大小</span></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="function">DWORD <span class="title">CopyImageBufferToNewBuffer</span><span class="params">(IN LPVOID pImageBuffer,OUT LPVOID* pNewBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//记录复制数</span></span><br><span class="line">    DWORD copyNum = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取SizeOfHeaders</span></span><br><span class="line">    DWORD HeadersSize = pOptionHeader-&gt;SizeOfHeaders;</span><br><span class="line">    <span class="comment">//复制全部头+节表+文件对齐</span></span><br><span class="line">    <span class="built_in">memcpy</span>(*pNewBuffer, pImageBuffer, HeadersSize);</span><br><span class="line">    copyNum += HeadersSize;</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; i&lt;NumberOfSection; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//获取SizeOfRawData</span></span><br><span class="line">        DWORD SizeOfRawData = pSectionHeader-&gt;SizeOfRawData;</span><br><span class="line">        <span class="comment">//获取VirtualAddress + ImageBuffer</span></span><br><span class="line">        <span class="built_in">memcpy</span>( (LPVOID)((DWORD)*pNewBuffer + (pSectionHeader-&gt;PointerToRawData)), (LPVOID)((DWORD)pImageBuffer + pSectionHeader-&gt;VirtualAddress), SizeOfRawData);</span><br><span class="line">        copyNum += SizeOfRawData;</span><br><span class="line">        pSectionHeader += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> copyNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="comment">//MemeryTOFile:将内存中的数据复制到文件</span></span><br><span class="line"><span class="comment">//参数说明：</span></span><br><span class="line"><span class="comment">//pMemBuffer 内存中数据的指针</span></span><br><span class="line"><span class="comment">//size 要复制的大小</span></span><br><span class="line"><span class="comment">//lpszFile 要存储的文件路径</span></span><br><span class="line"><span class="comment">//返回值说明：</span></span><br><span class="line"><span class="comment">//读取失败返回0  否则返回复制的大小</span></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="function">DWORD <span class="title">MemeryTOFile</span><span class="params">(IN LPVOID pMemBuffer,IN <span class="keyword">size_t</span> size,OUT LPSTR lpszFile)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *pFile = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD fileSize = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//open file</span></span><br><span class="line">    <span class="keyword">if</span>(!(pFile=fopen(lpszFile, <span class="string">"wb"</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"无法创建文件\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!fwrite(pMemBuffer, size, <span class="number">1</span>, pFile))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"write error\n"</span>);</span><br><span class="line">        fclose(pFile);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(pFile);</span><br><span class="line">    <span class="keyword">return</span> fileSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="comment">//RvaToFileOffset:将内存偏移转换为文件偏移</span></span><br><span class="line"><span class="comment">//参数说明：</span></span><br><span class="line"><span class="comment">//pFileBuffer FileBuffer指针</span></span><br><span class="line"><span class="comment">//dwRva RVA的值</span></span><br><span class="line"><span class="comment">//返回值说明：</span></span><br><span class="line"><span class="comment">//返回转换后的FOA的值  如果失败返回0</span></span><br><span class="line"><span class="comment">//**************************************************************************</span></span><br><span class="line"><span class="function">DWORD <span class="title">RvaToFileOffset</span><span class="params">(IN LPVOID pFileBuffer,IN DWORD dwRva)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//记录结果</span></span><br><span class="line">    DWORD result = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; i&lt;NumberOfSection; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//获取SizeOfRawData</span></span><br><span class="line">        DWORD VirtualAddress = pSectionHeader-&gt;VirtualAddress;</span><br><span class="line">        DWORD NextVirtualAddress = VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize;</span><br><span class="line">        <span class="keyword">if</span>(dwRva &gt; VirtualAddress &amp;&amp; dwRva &lt; NextVirtualAddress)</span><br><span class="line">        &#123;</span><br><span class="line">            result = (dwRva - VirtualAddress) + pSectionHeader-&gt;PointerToRawData;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pSectionHeader += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintHeaders</span><span class="params">(LPVOID pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(!pFileBuffer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Read file error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//judge if pSectionHeader with MZ</span></span><br><span class="line">    <span class="keyword">if</span>(*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Not a pe file!!!\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************DOS头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"MZ标志: 0x%x\n"</span>, pDosHeader-&gt;e_magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PE偏移: 0x%x\n"</span>, pDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">//judge if pe</span></span><br><span class="line">    <span class="keyword">if</span>(*((PDWORD)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew)) != IMAGE_NT_SIGNATURE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"不是有效的PE标志\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">//print NT_Header</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************NT头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NT: 0x%x\n"</span>, pNTHeader-&gt;signature);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************PE头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PE: 0x%x\n"</span>, pPEHeader-&gt;Machine);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfSections: 0x%x\n"</span>, pPEHeader-&gt;NumberOfSections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"TimeDateStamp: 0x%x\n"</span>, pPEHeader-&gt;TimeDateStamp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfOptionHeader: 0x%x\n"</span>, pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Characteristics: 0x%x\n"</span>, pPEHeader-&gt;Characteristics);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"********************OPTIOIN_PE头********************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"OPTION_PE: 0x%x\n"</span>, pOptionHeader-&gt;Magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"AddressOfEntryPoint: 0x%x\n"</span>, pOptionHeader-&gt;AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ImageBase: 0x%x\n"</span>, pOptionHeader-&gt;ImageBase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SectionAlignment: 0x%x\n"</span>, pOptionHeader-&gt;SectionAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"FileAlignment: 0x%x\n"</span>, pOptionHeader-&gt;FileAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfImage: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfImage);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfHeaders: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfHeaders);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CheckSum: 0x%x\n"</span>, pOptionHeader-&gt;CheckSum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfStackReserve: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfStackReserve);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfStackCommit: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfStackCommit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfHeapReserve: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfHeapReserve);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfHeapCommit: 0x%x\n"</span>, pOptionHeader-&gt;SizeOfHeapCommit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The real entrypoint is: 0x%x\n"</span>, pOptionHeader-&gt;ImageBase + pOptionHeader-&gt;AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="手动在代码区添加Shellcode"><a href="#手动在代码区添加Shellcode" class="headerlink" title="手动在代码区添加Shellcode"></a>手动在代码区添加Shellcode</h2><p>1、获取MessageBox地址，构造ShellCode代码.<br>2、E8 E9计算公式<br>3、在代码区手动添加代码<br>4、修改OEP，指向ShellCode.</p><p>选了PE提取这个exe,然后发觉他FileAlign跟SectionAlign都是0x1000，所以</p><p>计算笔记:</p><p>7DCBFD1E &gt; 8BFF mov edi,edi<br>42409D + x = 7DCBFD1E<br>4240A2 + x = 40A301</p><p>6A 00 6A 00 6A 00 6A 00 E8 81 BC 89 7D E9 5F 62 FE FF</p><h2 id="任意节添加Shellcode"><a href="#任意节添加Shellcode" class="headerlink" title="任意节添加Shellcode"></a>任意节添加Shellcode</h2><p>编写exe实现</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddShellcode</span><span class="params">(LPVOID* pImageBuffer,DWORD where)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//记录复制数</span></span><br><span class="line">    DWORD copyNum = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)*pImageBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)*pImageBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取SizeOfHeaders</span></span><br><span class="line">    DWORD HeadersSize = pOptionHeader-&gt;SizeOfHeaders;</span><br><span class="line">    copyNum += HeadersSize;</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; i&lt;NumberOfSection; i++, pSectionHeader++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(where != i)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">//获取shellcode长度</span></span><br><span class="line">        DWORD length = <span class="keyword">sizeof</span>(shellcode)/<span class="keyword">sizeof</span>(shellcode[<span class="number">0</span>])+<span class="number">0x10</span>;</span><br><span class="line">        <span class="comment">//判断是否还有空闲位置存放shellcode</span></span><br><span class="line">        <span class="keyword">if</span>(pSectionHeader-&gt;SizeOfRawData - pSectionHeader-&gt;Misc.VirtualSize &lt; length)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Not enough space to write this shellcode"</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取SectionNullBegin;</span></span><br><span class="line">        DWORD SectionNullBegin= (DWORD)*pImageBuffer+ pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize;</span><br><span class="line">        <span class="comment">//获取shellcode开始地址</span></span><br><span class="line">        DWORD shellcodeStart = pOptionHeader-&gt;ImageBase + pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize;</span><br><span class="line">        <span class="comment">//对齐，在整数地址节开始添加</span></span><br><span class="line">        DWORD align = (<span class="number">0x10</span>- (shellcodeStart &amp; <span class="number">0xf</span>));</span><br><span class="line">        SectionNullBegin += align;</span><br><span class="line">        shellcodeStart += align;</span><br><span class="line">        <span class="built_in">memcpy</span>((LPVOID)SectionNullBegin, shellcode, length);</span><br><span class="line">        <span class="comment">//修正call_addr</span></span><br><span class="line">        *(PDWORD)(SectionNullBegin+<span class="number">0x9</span>) = (DWORD)(MessageBoxA_addr - (shellcodeStart+<span class="number">0xd</span>));</span><br><span class="line">        <span class="comment">//修正jmp addr</span></span><br><span class="line">        *(PDWORD)(SectionNullBegin+<span class="number">0xe</span>) = (DWORD)((DWORD)(pOptionHeader-&gt;ImageBase + pOptionHeader-&gt;AddressOfEntryPoint) - shellcodeStart<span class="number">-0x12</span>);</span><br><span class="line">        <span class="comment">//修改OEP</span></span><br><span class="line">        pOptionHeader-&gt;AddressOfEntryPoint = shellcodeStart - (pOptionHeader-&gt;ImageBase);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(i == NumberOfSection)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"没有足够多的Section"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="添加节"><a href="#添加节" class="headerlink" title="添加节"></a>添加节</h2><p><img src="https://gitee.com/NoOne-hub/picture/raw/master/img/20200202122230.png" alt></p><p>添加节，特别要注意SizeOfImage,还有VirtualAddress，这里跟视频讲解不太一样，照着视频的会出错，高能高能，节属性要设置可读可写可执行，不要随便设置复制，会出错的，我被坑惨了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddSection</span><span class="params">(LPVOID* pImageBuffer, DWORD length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeaderEnd = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeaderBefore = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)*pImageBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)*pImageBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取SizeOfHeaders</span></span><br><span class="line">    DWORD HeadersSize = pOptionHeader-&gt;SizeOfHeaders;</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    <span class="comment">//获取最后一个和最后一个的前一个节表结束的地址</span></span><br><span class="line">    pSectionHeaderEnd = pSectionHeader + NumberOfSection;</span><br><span class="line">    pSectionHeaderBefore = pSectionHeader + (NumberOfSection<span class="number">-1</span>);</span><br><span class="line">    DWORD restSize = HeadersSize - pDosHeader-&gt;e_lfanew - <span class="number">20</span> - pPEHeader-&gt;SizeOfOptionalHeader - <span class="number">0x28</span>*NumberOfSection;</span><br><span class="line">    <span class="keyword">if</span>(restSize &lt; <span class="number">0x28</span>*<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Not enough space to add Section"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//复制节跟.text相同属性</span></span><br><span class="line">    *pSectionHeaderEnd = *pSectionHeader;</span><br><span class="line">    <span class="comment">//修改名字</span></span><br><span class="line">    BYTE NAME[<span class="number">8</span>] = &#123;<span class="string">".NewSec"</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; i&lt;<span class="number">8</span>; i++)</span><br><span class="line">        pSectionHeaderEnd-&gt;Name[i] = NAME[i];</span><br><span class="line">    <span class="comment">//填充00</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(pSectionHeaderEnd + <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x28</span>);</span><br><span class="line">    <span class="comment">//修改virtualSize</span></span><br><span class="line">    pSectionHeaderEnd-&gt;Misc.VirtualSize = getAlign(length, pOptionHeader-&gt;SectionAlignment);</span><br><span class="line">    <span class="comment">//修改VirtualAddress 谁大取谁</span></span><br><span class="line"><span class="comment">//    pSectionHeaderEnd-&gt;VirtualAddress = pSectionHeaderBefore-&gt;VirtualAddress +</span></span><br><span class="line"><span class="comment">//     (pSectionHeaderBefore-&gt;SizeOfRawData &gt; pSectionHeaderBefore-&gt;Misc.VirtualSize</span></span><br><span class="line"><span class="comment">//     ? pSectionHeaderBefore-&gt;SizeOfRawData:pSectionHeaderBefore-&gt;Misc.VirtualSize);</span></span><br><span class="line">    pSectionHeaderEnd-&gt;VirtualAddress = getAlign(pOptionHeader-&gt;SizeOfImage, pOptionHeader-&gt;SectionAlignment);</span><br><span class="line">    <span class="comment">//修改SizeOfRawData</span></span><br><span class="line">    pSectionHeaderEnd-&gt;SizeOfRawData = getAlign(length, pOptionHeader-&gt;FileAlignment);</span><br><span class="line">    <span class="comment">//修改PointerToRawData</span></span><br><span class="line">    pSectionHeaderEnd-&gt;PointerToRawData = pSectionHeaderBefore-&gt;PointerToRawData + pSectionHeaderBefore-&gt;SizeOfRawData;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, pSectionHeaderEnd-&gt;PointerToRawData);</span><br><span class="line">    <span class="comment">//修改节的Charact</span></span><br><span class="line">    pSectionHeaderEnd-&gt;Characteristics = <span class="number">0xE00000C0</span>;</span><br><span class="line">    <span class="comment">//修改节的数量</span></span><br><span class="line">    pPEHeader-&gt;NumberOfSections += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改SizeOfImage</span></span><br><span class="line">    pOptionHeader-&gt;SizeOfImage += getAlign(length, pOptionHeader-&gt;SectionAlignment);</span><br><span class="line">    <span class="comment">//提升空间</span></span><br><span class="line"></span><br><span class="line">    *pImageBuffer = <span class="built_in">realloc</span>(*pImageBuffer, pOptionHeader-&gt;SizeOfImage);</span><br><span class="line">    <span class="comment">//清空空间</span></span><br><span class="line">    <span class="built_in">memset</span>((DWORD)*pImageBuffer+pOptionHeader-&gt;SizeOfImage - length, <span class="number">0</span>, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>扩展节</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ExtendSection</span><span class="params">(LPVOID* pImageBuffer, DWORD where, DWORD length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeaderEnd = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)*pImageBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)*pImageBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    <span class="comment">//获取指定节</span></span><br><span class="line">    <span class="keyword">if</span>(where &gt;= NumberOfSection)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"OverFlow the Section table\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pSectionHeaderEnd = pSectionHeader + where;</span><br><span class="line">    <span class="comment">//增大节空间</span></span><br><span class="line">    pSectionHeaderEnd-&gt;Misc.VirtualSize += length;</span><br><span class="line">    pSectionHeaderEnd-&gt;SizeOfRawData += length;</span><br><span class="line">    <span class="comment">//修改ImageSize</span></span><br><span class="line">    pOptionHeader-&gt;SizeOfImage += length;</span><br><span class="line">    <span class="comment">//提升空间</span></span><br><span class="line">    <span class="built_in">realloc</span>(*pImageBuffer, pOptionHeader-&gt;SizeOfImage);</span><br><span class="line">    <span class="comment">//清空空间</span></span><br><span class="line">    <span class="built_in">memset</span>(*pImageBuffer+pOptionHeader-&gt;SizeOfImage - length, <span class="number">0</span>, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>移动节</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveSection</span><span class="params">(LPVOID* pImageBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)*pImageBuffer;</span><br><span class="line">    <span class="keyword">if</span>(pDosHeader-&gt;e_lfanew - <span class="keyword">sizeof</span>(IMAGE_DOS_HEADER) &lt; <span class="number">0x28</span>*<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"No enough space to add Section\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD peStart = <span class="keyword">sizeof</span>(IMAGE_DOS_HEADER);</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)*pImageBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取SizeOfHeaders</span></span><br><span class="line">    DWORD HeadersSize = pOptionHeader-&gt;SizeOfHeaders;</span><br><span class="line">    DWORD copyNum = HeadersSize - pDosHeader-&gt;e_lfanew;</span><br><span class="line">    <span class="built_in">memcpy</span>((LPVOID)(*pImageBuffer+peStart), pNTHeader, copyNum);</span><br><span class="line">    <span class="comment">//修改起始位置</span></span><br><span class="line">    pDosHeader-&gt;e_lfanew = peStart;</span><br><span class="line">    <span class="comment">//重新获取地址</span></span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)*pImageBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过移动节可以增大剩余节的空间，通过扩展节，可以添加shellcode</p><p>问题:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增大节空间</span></span><br><span class="line">pSectionHeaderEnd-&gt;Misc.VirtualSize += <span class="number">0x1000</span>;</span><br><span class="line">pSectionHeaderEnd-&gt;SizeOfRawData += length;</span><br><span class="line"><span class="comment">//修改ImageSize</span></span><br><span class="line">pOptionHeader-&gt;SizeOfImage += <span class="number">0x1000</span>;</span><br></pre></td></tr></table></figure><p>这里不能是三个相同，因为我添加shellcode代码要求SizeOfRawData-VirtualSize &gt; 0x28*2</p><p>经过测试，SizeOfImage和VirtualSize不能乱改，改错就直接执行不了</p><h2 id="合并节"><a href="#合并节" class="headerlink" title="合并节"></a>合并节</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">MergeSection</span><span class="params">(LPVOID* pImageBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)*pImageBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)*pImageBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改第一个节表大小</span></span><br><span class="line">    DWORD FinalSize = pOptionHeader-&gt;SizeOfImage - pSectionHeader-&gt;VirtualAddress;</span><br><span class="line">    pSectionHeader-&gt;SizeOfRawData = pSectionHeader-&gt;Misc.VirtualSize =  FinalSize;</span><br><span class="line">    <span class="comment">//关键，修改属性</span></span><br><span class="line">    pSectionHeader-&gt;Characteristics = <span class="number">0xE0000020</span>;</span><br><span class="line">    <span class="built_in">memset</span>(pSectionHeader+<span class="number">1</span>, <span class="number">0</span>, <span class="number">0x28</span>);</span><br><span class="line">    <span class="comment">//修改节表数量</span></span><br><span class="line">    pPEHeader-&gt;NumberOfSections = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> pOptionHeader-&gt;SizeOfImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>内存对齐</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">getAlign</span><span class="params">(DWORD x, DWORD y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x/y == x/(<span class="keyword">float</span>)y ? x: (x/y+<span class="number">1</span>)*y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>x为值，y为对齐的值</p><h2 id="动态链接和静态链接"><a href="#动态链接和静态链接" class="headerlink" title="动态链接和静态链接"></a>动态链接和静态链接</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQzMzczOTcvYXJ0aWNsZS9kZXRhaWxzLzgwODkyODM5" title="https://blog.csdn.net/u014337397/article/details/80892839">codeblock静态链接<i class="fa fa-external-link"></i></span></p><h3 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h3><ol><li>名称导出</li><li>序号导出</li></ol><h2 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h2><p>函数数量= 最大序号-最小序号+1，所以可能会不准</p><p>2,3,5,6 6-2+1 = 5,实际是4个函数</p><p>序号表存的减去base的，所以要base+序号表才是真正序号导出</p><h3 id="手动找导出表"><a href="#手动找导出表" class="headerlink" title="手动找导出表"></a>手动找导出表</h3><p>ReadPEFile-&gt;FileBuffer-&gt;pOptionHeader-&gt;DataDirectory-&gt;Export_Table</p><p>然后获取到三张表地址,AddressOfFunction, AddressOfName, AddressOfNameOrdinals</p><p>查表过程</p><p>注意:</p><ol><li>三个Address都是RVA的地址</li><li>AddressOfFunction 4个字节，AddressOfNameOrdinals 2个字节， AddressOfName 4个字节</li><li>AddressOfName里存的是名字的RVA，AddressOfFunction里存的也是RVA</li></ol><p>序号查:</p><p>将序号减去导出表的Base，然后直接从AddressOfFunction里找对应目录项，获取到RVA，然后在转成FOA</p><p><img src="https://gitee.com/NoOne-hub/picture/raw/master/img/20200204145337.png" alt></p><p>名称查:</p><p>将名字同AddressOfName里每个目录项对比，若相同，则去对应的AddressOfNameOrdinals里找序号，然后转到AddressOfFunction里</p><p><img src="https://gitee.com/NoOne-hub/picture/raw/master/img/20200204145314.png" alt></p><h3 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h3><p>获取导出表并打印</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getExportTable</span><span class="params">(LPVOID pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExportDirectory= <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Export_Table: %x %x\n"</span>, pDataDirectory-&gt;VirtualAddress, pDataDirectory-&gt;Size);</span><br><span class="line">    pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pDataDirectory-&gt;VirtualAddress));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ImageBase: %x\n"</span>, pOptionHeader-&gt;ImageBase);</span><br><span class="line">    PrintfExportDirectory(pFileBuffer, pExportDirectory);</span><br><span class="line">    <span class="keyword">char</span> Name[]=<span class="string">"Sub"</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s: %x\n"</span>, Name, GetFunctionAddrByName(pFileBuffer, Name));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"序号3: %x\n"</span>, GetFunctionAddrByOrdinals(pFileBuffer, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印重定位表</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintfExportDirectory</span><span class="params">(LPVOID pFileBuffer, PIMAGE_EXPORT_DIRECTORY pExportDirectory)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Characteristics: %x\n"</span>, pExportDirectory-&gt;Characteristics);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"TimeDateStamp: %x\n"</span>, pExportDirectory-&gt;TimeDateStamp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"MajorVersion: %x\n"</span>, pExportDirectory-&gt;MajorVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"MinorVersion: %x\n"</span>, pExportDirectory-&gt;MinorVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Base: %x\n"</span>, pExportDirectory-&gt;Base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfFunctions: %x\n"</span>, pExportDirectory-&gt;NumberOfFunctions);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfNames: %x\n"</span>, pExportDirectory-&gt;NumberOfNames);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  |函数地址表|函数序号表|函数名称表|\n"</span>);</span><br><span class="line">    DWORD max = pExportDirectory-&gt;NumberOfFunctions &gt; pExportDirectory-&gt;NumberOfNames ? pExportDirectory-&gt;NumberOfFunctions:pExportDirectory-&gt;NumberOfNames;</span><br><span class="line">    <span class="keyword">for</span>(; i&lt; max; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%2x"</span>, i);</span><br><span class="line">        <span class="keyword">if</span>(i &lt; pExportDirectory-&gt;NumberOfFunctions)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"|%9x |"</span>, RvaToFileOffset(pFileBuffer, ((PDWORD)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfFunctions)))[i]));</span><br><span class="line">            <span class="comment">//printf("|%9x |", ((PDWORD)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfFunctions)))[i]);</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"|---------|"</span>);</span><br><span class="line">        <span class="keyword">if</span>(i &lt; pExportDirectory-&gt;NumberOfNames)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%9x |"</span>, ((PWORD)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfNameOrdinals)))[i]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%9x |"</span>, RvaToFileOffset(pFileBuffer, ((PDWORD)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfNames)))[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过两种方式获取地址</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">GetFunctionAddrByName</span><span class="params">(LPVOID pFileBuffer, LPVOID pName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExportDirectory= <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pDataDirectory-&gt;VirtualAddress));</span><br><span class="line">    PDWORD AddressName = pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfNames);</span><br><span class="line">    DWORD i = <span class="number">0</span>;</span><br><span class="line">    DWORD NumberOfNames = pExportDirectory-&gt;NumberOfNames;</span><br><span class="line">    <span class="keyword">for</span>(; i &lt; NumberOfNames ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>( (PDWORD)(pFileBuffer + RvaToFileOffset(pFileBuffer, AddressName[i])), pName))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(i &gt;= NumberOfNames)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Not found"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PWORD AddressOfNameOrdinals = pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfNameOrdinals);</span><br><span class="line">    PDWORD AddressOfFunction =  pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfFunctions);</span><br><span class="line">    DWORD result = RvaToFileOffset(pFileBuffer, AddressOfFunction[AddressOfNameOrdinals[i]]);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">GetFunctionAddrByOrdinals</span><span class="params">(LPVOID pFileBuffer, DWORD num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExportDirectory= <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pDataDirectory-&gt;VirtualAddress));</span><br><span class="line">    PDWORD AddressOfFunction = pFileBuffer + RvaToFileOffset(pFileBuffer, pExportDirectory-&gt;AddressOfFunctions);</span><br><span class="line">    <span class="keyword">return</span> RvaToFileOffset(pFileBuffer, AddressOfFunction[num - pExportDirectory-&gt;Base]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h2><p>获取重定位表</p><p>重定位表就是处理地址冲突的表，假设有个dll是0x10000000,另一个dll的ImageBase也是，加载到内存中必然会冲突，所以重定位的话，假设让他放到0x20000000，然后就可以处理冲突了，但是代码的偏移都需要改变</p><h3 id="打印重定位表"><a href="#打印重定位表" class="headerlink" title="打印重定位表"></a>打印重定位表</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRelaction</span><span class="params">(LPVOID pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BASE_RELOCATION pBaseRelocation= <span class="literal">NULL</span>;</span><br><span class="line">    PBYTE pName = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = (PIMAGE_DATA_DIRECTORY)pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    pBaseRelocation = (PIMAGE_BASE_RELOCATION)(pFileBuffer + RvaToFileOffset(pFileBuffer, pDataDirectory[<span class="number">5</span>].VirtualAddress));</span><br><span class="line">    <span class="comment">//pBaseRelocation = (PIMAGE_BASE_RELOCATION)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer,pDataDirectory));</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Relocation_Table: %x %x\n"</span>, RvaToFileOffset(pFileBuffer, pDataDirectory[<span class="number">5</span>].VirtualAddress), pDataDirectory[<span class="number">5</span>].Size);</span><br><span class="line">    DWORD i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        DWORD VirtualAddress = pBaseRelocation-&gt;VirtualAddress;</span><br><span class="line">        DWORD SizeOfBlock = pBaseRelocation-&gt;SizeOfBlock;</span><br><span class="line">        pName = getSectionName(pFileBuffer, VirtualAddress);</span><br><span class="line">        DWORD NumberOfBlock = (SizeOfBlock - <span class="number">8</span>)/<span class="number">2</span>;</span><br><span class="line">        PWORD pSection = (DWORD)pBaseRelocation + <span class="number">8</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s VirtualAddress: %x Size: %x\n"</span>, pName, VirtualAddress, SizeOfBlock);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;NumberOfBlock; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"第%d项: Address:%x 属性:%x\n"</span>,i, VirtualAddress + (((WORD)(pSection[i]&lt;&lt;<span class="number">4</span>))&gt;&gt;<span class="number">4</span>), pSection[i]&gt;&gt;<span class="number">12</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        pBaseRelocation = (DWORD)pBaseRelocation + SizeOfBlock;</span><br><span class="line">    &#125;<span class="keyword">while</span>(pBaseRelocation-&gt;VirtualAddress!=<span class="number">0</span> &amp;&amp; pBaseRelocation-&gt;SizeOfBlock!=<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="移动导出表"><a href="#移动导出表" class="headerlink" title="移动导出表"></a>移动导出表</h3><ol><li>新增一个节</li><li>移动AddressOfFunctions表</li><li>移动AddressOfNameOrdinals表</li><li>移动AddressOfName表</li><li>移动AddressOfName表中每个地址的内容，同时修复AddressOfName</li><li>移动整个表结构，同时修复AddressOfFunctions，AddressOfNameOrdinals,AddressOfName三个的RVA</li><li>修复pDataDirectory[0].VirtualAddress为新表的VirtualAddress</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestAddSectionAndMoveExportTable</span><span class="params">(DWORD size, PBYTE NAME)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPVOID pFileBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD num = ReadPEFile(peFile, &amp;pFileBuffer);</span><br><span class="line">    <span class="keyword">if</span>(!num)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ReadPEFile error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ReadPEFile finish: %x\n"</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD FOA = AddSectionFromFileBuffer(&amp;pFileBuffer, num, NAME, size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"FOA is: %x\n"</span>, FOA);</span><br><span class="line">    MoveExportTable(pFileBuffer, FOA);</span><br><span class="line">    MemeryTOFile(pFileBuffer, num+size, <span class="string">"1.dll"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveExportTable</span><span class="params">(LPVOID pFileBuffer, DWORD FOA)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExportDirectory= <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pCopyPlace = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pNewExportDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    pSectionHeader = pSectionHeader + (NumberOfSection<span class="number">-1</span>);</span><br><span class="line">    DWORD VirtualAddress = pSectionHeader-&gt;VirtualAddress;</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Export_Table: %x %x\n"</span>, pDataDirectory-&gt;VirtualAddress, pDataDirectory-&gt;Size);</span><br><span class="line">    pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + getFOA(pDataDirectory-&gt;VirtualAddress));</span><br><span class="line">    pCopyPlace = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + FOA);</span><br><span class="line">    <span class="comment">//复制函数地址</span></span><br><span class="line">    PDWORD AddressOfFunction = pFileBuffer + getFOA(pExportDirectory-&gt;AddressOfFunctions);</span><br><span class="line">    DWORD NumberOfFunction = pExportDirectory-&gt;NumberOfFunctions;</span><br><span class="line">    DWORD length = <span class="number">0</span>;<span class="comment">//记录已复制数目</span></span><br><span class="line">    <span class="comment">//一个地址4个字节</span></span><br><span class="line">    <span class="built_in">memcpy</span>((LPVOID)pCopyPlace, (LPVOID)AddressOfFunction, NumberOfFunction*<span class="number">4</span>);</span><br><span class="line">    length += NumberOfFunction*<span class="number">4</span>;</span><br><span class="line">    <span class="comment">//复制函数对应表</span></span><br><span class="line">    DWORD AddressOfNameOrdinals = (DWORD)pFileBuffer + getFOA(pExportDirectory-&gt;AddressOfNames);</span><br><span class="line">    DWORD NumberOfNames = pExportDirectory-&gt;NumberOfNames;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, AddressOfNameOrdinals);</span><br><span class="line">    <span class="built_in">memcpy</span>((DWORD)pCopyPlace+length, AddressOfNameOrdinals, <span class="number">2</span>*NumberOfNames);</span><br><span class="line">    length += <span class="number">2</span>*NumberOfNames;</span><br><span class="line">    <span class="comment">//复制函数名称表</span></span><br><span class="line">    PDWORD AddressOfName = (DWORD)pFileBuffer + getFOA(pExportDirectory-&gt;AddressOfNames);</span><br><span class="line">    DWORD i = <span class="number">0</span>;<span class="comment">//循环变量</span></span><br><span class="line">    DWORD size = <span class="number">0</span>;<span class="comment">//size记录名称长度</span></span><br><span class="line">    DWORD realAddr = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>((DWORD)pCopyPlace+length, AddressOfName, <span class="number">4</span>*NumberOfNames);</span><br><span class="line">    length += <span class="number">4</span>*NumberOfNames;</span><br><span class="line">    <span class="keyword">for</span>(; i&lt;NumberOfNames; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        realAddr = (DWORD)pFileBuffer + getFOA(AddressOfName[i]);</span><br><span class="line">        size = <span class="built_in">strlen</span>((PBYTE)realAddr)+<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>((DWORD)pCopyPlace+length, realAddr, size);</span><br><span class="line">        <span class="comment">//修复名称表</span></span><br><span class="line">        AddressOfName[i] = VirtualAddress+ length;</span><br><span class="line">        length += size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//复制表结构</span></span><br><span class="line">    <span class="built_in">memcpy</span>((DWORD)pCopyPlace+length, pExportDirectory, <span class="keyword">sizeof</span>(IMAGE_EXPORT_DIRECTORY));</span><br><span class="line">    <span class="comment">//修复表</span></span><br><span class="line">    pNewExportDirectory = (PIMAGE_EXPORT_DIRECTORY)(DWORD)pCopyPlace+length;</span><br><span class="line">    pNewExportDirectory-&gt;AddressOfFunctions = VirtualAddress;</span><br><span class="line">    pNewExportDirectory-&gt;AddressOfNameOrdinals = pNewExportDirectory-&gt;AddressOfFunctions + NumberOfFunction*<span class="number">4</span> ;</span><br><span class="line">    pNewExportDirectory-&gt;AddressOfNames = pNewExportDirectory-&gt;AddressOfNameOrdinals + NumberOfNames*<span class="number">2</span>;</span><br><span class="line">    <span class="comment">//printf("%x\n", getFOA(pNewExportDirectory-&gt;AddressOfNameOrdinals));</span></span><br><span class="line"></span><br><span class="line">    pDataDirectory-&gt;VirtualAddress = VirtualAddress + length ;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, getFOA(pDataDirectory-&gt;VirtualAddress));</span><br><span class="line">    length += <span class="keyword">sizeof</span>(IMAGE_EXPORT_DIRECTORY);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="移动重定位表"><a href="#移动重定位表" class="headerlink" title="移动重定位表"></a>移动重定位表</h3><ol><li>新增一个节</li><li>将重定位表整体移动到新节里</li><li>修改pDataDirectory[5].VirtualAddress为新增节的VirtualAddress</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestAddSectionAndMoveRelocationTable</span><span class="params">(DWORD size, PBYTE NAME)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPVOID pFileBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD num = ReadPEFile(peFile, &amp;pFileBuffer);</span><br><span class="line">    <span class="keyword">if</span>(!num)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ReadPEFile error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ReadPEFile finish: %x\n"</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD FOA = AddSectionFromFileBuffer(&amp;pFileBuffer, num, NAME, size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"FOA is: %x\n"</span>, FOA);</span><br><span class="line">    MoveRelocationTable(pFileBuffer, FOA);</span><br><span class="line">    MemeryTOFile(pFileBuffer, num+size, <span class="string">"1.dll"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveRelocationTable</span><span class="params">(LPVOID pFileBuffer,DWORD FOA)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BASE_RELOCATION pBaseRelocation = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BASE_RELOCATION pCopyPlace = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BASE_RELOCATION pNewExportDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    pSectionHeader = pSectionHeader + (NumberOfSection<span class="number">-1</span>);</span><br><span class="line">    DWORD VirtualAddress = pSectionHeader-&gt;VirtualAddress;</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    pDataDirectory += <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Relocation_Table: %x %x\n"</span>, pDataDirectory-&gt;VirtualAddress, pDataDirectory-&gt;Size);</span><br><span class="line">    pBaseRelocation = (PIMAGE_BASE_RELOCATION)((DWORD)pFileBuffer + getFOA(pDataDirectory-&gt;VirtualAddress));</span><br><span class="line">    pCopyPlace = (PIMAGE_BASE_RELOCATION)((DWORD)pFileBuffer + FOA);</span><br><span class="line">    DWORD i = <span class="number">0</span>;</span><br><span class="line">    DWORD length = <span class="number">0</span>;<span class="comment">//记录长度</span></span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        DWORD SizeOfBlock = pBaseRelocation-&gt;SizeOfBlock;</span><br><span class="line">        DWORD realAddr = (DWORD)pFileBuffer + getFOA(pBaseRelocation-&gt;VirtualAddress);</span><br><span class="line">        <span class="built_in">memcpy</span>((DWORD)pCopyPlace+length, pBaseRelocation, SizeOfBlock);</span><br><span class="line">        pBaseRelocation = (DWORD)pBaseRelocation + SizeOfBlock;</span><br><span class="line">        length += SizeOfBlock;</span><br><span class="line">    &#125;<span class="keyword">while</span>(pBaseRelocation-&gt;VirtualAddress!=<span class="number">0</span> &amp;&amp; pBaseRelocation-&gt;SizeOfBlock!=<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//增加结束标志</span></span><br><span class="line">    <span class="built_in">memcpy</span>((DWORD)pCopyPlace+length,pBaseRelocation, <span class="keyword">sizeof</span>(PIMAGE_BASE_RELOCATION));</span><br><span class="line">    <span class="comment">//新增节的地址</span></span><br><span class="line">    pDataDirectory-&gt;VirtualAddress = VirtualAddress;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, pDataDirectory-&gt;VirtualAddress);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, getFOA(pDataDirectory-&gt;VirtualAddress));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="模拟操作系统重定位过程"><a href="#模拟操作系统重定位过程" class="headerlink" title="模拟操作系统重定位过程"></a>模拟操作系统重定位过程</h3><ol><li>修改ImageBase</li><li>找到重定位表</li><li>根据重定位表修改每个地址原来的值</li><li>注意单位应该是4个字节，因为ImageBase也是4个字节</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChangeImageBase</span><span class="params">(LPVOID pFileBuffer,DWORD Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BASE_RELOCATION pBaseRelocation = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    pSectionHeader = pSectionHeader + (NumberOfSection<span class="number">-1</span>);</span><br><span class="line">    DWORD VirtualAddress = pSectionHeader-&gt;VirtualAddress;</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Relocation_Table: %x %x\n"</span>, pDataDirectory[<span class="number">5</span>].VirtualAddress, pDataDirectory[<span class="number">5</span>].Size);</span><br><span class="line">    pBaseRelocation = (PIMAGE_BASE_RELOCATION)((DWORD)pFileBuffer + getFOA(pDataDirectory[<span class="number">5</span>].VirtualAddress));</span><br><span class="line">    <span class="comment">//修改ImageBase</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, pOptionHeader-&gt;ImageBase);</span><br><span class="line">    pOptionHeader-&gt;ImageBase += Size;</span><br><span class="line">    <span class="comment">//修复地址</span></span><br><span class="line">    DWORD i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        DWORD VirtualAddress = pBaseRelocation-&gt;VirtualAddress;</span><br><span class="line">        DWORD SizeOfBlock = pBaseRelocation-&gt;SizeOfBlock;</span><br><span class="line">        DWORD NumberOfBlock = (SizeOfBlock - <span class="number">8</span>)/<span class="number">2</span>;</span><br><span class="line">        PWORD pSection = (DWORD)pBaseRelocation + <span class="number">8</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"VirtualAddress: %x Size: %x\n"</span>, VirtualAddress, SizeOfBlock);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;NumberOfBlock; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>((pSection[i]&gt;&gt;<span class="number">12</span>) == <span class="number">0x3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                PDWORD Addr = (DWORD)pFileBuffer + getFOA(VirtualAddress + (((WORD)(pSection[i]&lt;&lt;<span class="number">4</span>))&gt;&gt;<span class="number">4</span>));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, Addr);</span><br><span class="line">                *Addr += Size;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pBaseRelocation = (DWORD)pBaseRelocation + SizeOfBlock;</span><br><span class="line">    &#125;<span class="keyword">while</span>(pBaseRelocation-&gt;VirtualAddress!=<span class="number">0</span> &amp;&amp; pBaseRelocation-&gt;SizeOfBlock!=<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestChangeImageBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPVOID pFileBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD num = ReadPEFile(peFile, &amp;pFileBuffer);</span><br><span class="line">    <span class="keyword">if</span>(!num)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ReadPEFile error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ReadPEFile finish: %x\n"</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">    ChangeImageBase(pFileBuffer, <span class="number">0x10000000</span>);</span><br><span class="line">    MemeryTOFile(pFileBuffer, num, <span class="string">"1.dll"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IAT表"><a href="#IAT表" class="headerlink" title="IAT表"></a>IAT表</h2><p>导入表hook, 修改导入表，然后让其跳转到我们的代码</p><p>动态解析导入的函数</p><h2 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h2><p>打印导入表，有个问题，DLL跟EXE的导入表不一样，DLL的IAT是正确的，他的INT存的是地址，而且是</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintImportTable</span><span class="params">(LPVOID pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BASE_RELOCATION pBaseRelocation = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pImportDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_THUNK_DATA32 pThunkData32 = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Import_Table: %x Size: %x\n"</span>, pDataDirectory[<span class="number">1</span>].VirtualAddress, pDataDirectory[<span class="number">1</span>].Size);</span><br><span class="line">    pImportDescriptor = (DWORD)pFileBuffer + getFOA(pDataDirectory[<span class="number">1</span>].VirtualAddress);</span><br><span class="line">    DWORD count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Name: %s\n"</span>, (DWORD)pFileBuffer + getFOA(pImportDescriptor[count].Name));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"OriginalFirstThunk: %x\n"</span>, pImportDescriptor[count].OriginalFirstThunk);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"FirstThunk: %x\n"</span>, pImportDescriptor[count].FirstThunk);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"------------------OriginalFirstThunk------------------\n"</span>);</span><br><span class="line">        pThunkData32 = (DWORD)pFileBuffer + getFOA(pImportDescriptor[count].OriginalFirstThunk);</span><br><span class="line">        DWORD i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="comment">//说明是导出序号</span></span><br><span class="line">            <span class="keyword">if</span>( pThunkData32[i].u1.Ordinal &amp; <span class="number">0x80000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"序号导出: %d\n"</span>, pThunkData32[i].u1.Ordinal &amp;<span class="number">0x7fffffff</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"名称导出: %s\n"</span>, (DWORD)pFileBuffer + getFOA(pThunkData32[i].u1.AddressOfData)+<span class="number">2</span> );</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;<span class="keyword">while</span>(pThunkData32[i].u1.AddressOfData!=<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"------------------FirstThunk------------------\n"</span>);</span><br><span class="line">        pThunkData32 = (DWORD)pFileBuffer + getFOA(pImportDescriptor[count].FirstThunk);</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="comment">//说明是导出序号</span></span><br><span class="line">            <span class="keyword">if</span>( pThunkData32[i].u1.Ordinal &amp; <span class="number">0x80000000</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"序号导出: %x\n"</span>, pThunkData32[i].u1.Ordinal &amp;<span class="number">0x7fffffff</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"名称导出: %s\n"</span>, (DWORD)pFileBuffer + getFOA(pThunkData32[i].u1.AddressOfData)+<span class="number">2</span> );</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;<span class="keyword">while</span>(pThunkData32[i].u1.AddressOfData!=<span class="literal">NULL</span>);</span><br><span class="line">        count ++;</span><br><span class="line">    &#125;<span class="keyword">while</span>(pImportDescriptor[count].Name!=<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="绑定导入表"><a href="#绑定导入表" class="headerlink" title="绑定导入表"></a>绑定导入表</h2><p>解决了导入表输出错误的问题，根据TimeStamp来判断是否是绑定的，绑定的话，地址就写死在那里</p><p>PE加载EXE相关的DLL时，首先会根据IMAGE_IMPORT_DESCRIPTOR结构中的TimeDateStamp来判断是否要重新计算IAT表中的地址。</p><p>TimeDateStamp == 0 未绑定</p><p>TimeDateStamp == -1 已绑定 真正的绑定时间为IMAGE_BOUND_IMPORT_DESCRIPTOR的TimeDateStamp</p><p>绑定导入表位于数据目录的第12项</p><p>还有ModuleOffset是相对于第一个的偏移，不是相对每个模块的偏移</p><p>打印绑定导入表…找不到一个有绑定导入表的，dll的VirtualAddress看不懂，然后打印不出来,到后面一节视频才知道VirtualAddress在节表里是找不到的，PEheader不用转换，因为直接复制过去的所以RVA-&gt;FOA需要考虑小于sizeOfHeader，小于的默认就是那个值</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintBoundImportTable</span><span class="params">(LPVOID pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BASE_RELOCATION pBaseRelocation = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BOUND_IMPORT_DESCRIPTOR pBoundImportDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_BOUND_FORWARDER_REF pBoundForwarderRef = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Import_Table: %x Size: %x\n"</span>, pDataDirectory[<span class="number">11</span>].VirtualAddress, pDataDirectory[<span class="number">11</span>].Size);</span><br><span class="line">    pBoundImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)((DWORD)pFileBuffer + pDataDirectory[<span class="number">11</span>].VirtualAddress);</span><br><span class="line">    DWORD i = <span class="number">0</span>;</span><br><span class="line">    DWORD j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"TimeStamp: %x\n"</span>, pBoundImportDescriptor[i].TimeDateStamp);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"OffsetModuleName: %x\n"</span>, pBoundImportDescriptor[i].OffsetModuleName);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"NumberOfModuleForwarderRefs: %x\n"</span>, pBoundImportDescriptor[i].NumberOfModuleForwarderRefs);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Name: %s\n"</span>, (DWORD)pBoundImportDescriptor + pBoundImportDescriptor[i].OffsetModuleName);</span><br><span class="line">        i++;</span><br><span class="line">        pBoundForwarderRef = &amp;pBoundImportDescriptor[i];</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j&lt;pBoundImportDescriptor[i].NumberOfModuleForwarderRefs; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"TimeStamp: %x\n"</span>, pBoundForwarderRef[j].TimeDateStamp);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"OffsetModuleName: %x\n"</span>, pBoundForwarderRef[j].OffsetModuleName);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Name: %s\n"</span>, (DWORD)pBoundImportDescriptor + pBoundForwarderRef[j].OffsetModuleName);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Reserved: %x\n"</span>, pBoundForwarderRef-&gt;Reserved);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="comment">//超过需要减1</span></span><br><span class="line">        <span class="keyword">if</span>(j &gt;= pBoundImportDescriptor[i].NumberOfModuleForwarderRefs &amp;&amp; j!=<span class="number">0</span> )</span><br><span class="line">           j--;</span><br><span class="line">        i = i + j ;</span><br><span class="line">    &#125;<span class="keyword">while</span>(pBoundImportDescriptor[i].OffsetModuleName!=<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="导入表注入"><a href="#导入表注入" class="headerlink" title="导入表注入"></a>导入表注入</h2><p>真的坑，以为自己代码写错，对着16进制数据一通对比也没发现错误，重新按一种规格写了一遍，还是不行，草，最后发觉是节属性的问题，被节属性坑了好几遍了，所以把代码改了就行了，</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改节的Characteristics</span></span><br><span class="line">   pSectionHeaderEnd-&gt;Characteristics = <span class="number">0xE00000C0</span>;</span><br></pre></td></tr></table></figure><p>写了两个版本的,第一种不为什么，就是知道什么填什么，然后慢慢填满的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InjectDll</span><span class="params">(LPVOID pFileBuffer, DWORD FOA, <span class="keyword">char</span>* NAME, <span class="keyword">char</span>* FuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pImportDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pCopyPlace = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_THUNK_DATA32 pThunkData32 = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pNewImportDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Import_Table: %x Size: %x\n"</span>, pDataDirectory[<span class="number">1</span>].VirtualAddress, pDataDirectory[<span class="number">1</span>].Size);</span><br><span class="line">    pImportDescriptor = (DWORD)pFileBuffer + getFOA(pDataDirectory[<span class="number">1</span>].VirtualAddress);</span><br><span class="line">    pCopyPlace = (DWORD)pFileBuffer + FOA;</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    DWORD length = <span class="keyword">sizeof</span>(IMAGE_IMPORT_DESCRIPTOR);</span><br><span class="line">    DWORD num = <span class="number">0</span>;<span class="comment">//记录拷贝数</span></span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((DWORD)pCopyPlace+num, pImportDescriptor, length);</span><br><span class="line">        pImportDescriptor++;</span><br><span class="line">        num += length;</span><br><span class="line">    &#125;<span class="keyword">while</span>(pImportDescriptor-&gt;Name!=<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建结构</span></span><br><span class="line">    pNewImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)pCopyPlace + num);</span><br><span class="line">    pNewImportDescriptor-&gt;TimeDateStamp = <span class="number">0</span>;</span><br><span class="line">    pNewImportDescriptor-&gt;ForwarderChain = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    num += (length*<span class="number">2</span>);<span class="comment">//保留2个结构体</span></span><br><span class="line">    <span class="comment">//创建名字</span></span><br><span class="line">    DWORD temp = <span class="built_in">strlen</span>(NAME);</span><br><span class="line">    <span class="built_in">memcpy</span>(((DWORD)pCopyPlace + num), NAME, temp);</span><br><span class="line">    pNewImportDescriptor-&gt;Name = pSectionHeader[NumberOfSection<span class="number">-1</span>].VirtualAddress + num;</span><br><span class="line">    <span class="comment">//printf("%x %x\n",getFOA(pSectionHeader[NumberOfSection-1].VirtualAddress), getFOA(pCopyPlace-&gt;Name));</span></span><br><span class="line">    <span class="comment">//printf("%x\n temp", getAlign(temp, 4));</span></span><br><span class="line">    num += (getAlign(temp+<span class="number">1</span>,<span class="number">4</span>));<span class="comment">//\x00结尾字符串</span></span><br><span class="line">    <span class="comment">//创建OrginalFirst</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建函数名</span></span><br><span class="line">    temp = <span class="built_in">strlen</span>(FuncName);</span><br><span class="line">    <span class="comment">//伪造Thunk结构体</span></span><br><span class="line">    <span class="built_in">memset</span>((DWORD)pCopyPlace+num, <span class="number">0</span>, <span class="number">2</span>);<span class="comment">//Hint</span></span><br><span class="line">    <span class="built_in">memcpy</span>((DWORD)pCopyPlace+num+<span class="number">2</span>, FuncName, temp);<span class="comment">//Name</span></span><br><span class="line">    <span class="comment">//伪造OriginalFirst的表</span></span><br><span class="line">    <span class="comment">//第一个指向结构体</span></span><br><span class="line">    DWORD align = getAlign(<span class="number">3</span>+temp, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace + num + align)) = pSectionHeader[NumberOfSection<span class="number">-1</span>].VirtualAddress + num;</span><br><span class="line">    <span class="comment">//第二个作为结尾标记</span></span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace + num + align + <span class="number">4</span>)) = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//修复OriginalFirst</span></span><br><span class="line">    pNewImportDescriptor-&gt;OriginalFirstThunk = pSectionHeader[NumberOfSection<span class="number">-1</span>].VirtualAddress + num + align;</span><br><span class="line">    pNewImportDescriptor-&gt;FirstThunk = pNewImportDescriptor-&gt;OriginalFirstThunk;</span><br><span class="line">    <span class="comment">//伪造IAT</span></span><br><span class="line">    <span class="comment">//memset((DWORD)pCopyPlace+num, 0, 8);//两个RVA</span></span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace + num + align + <span class="number">8</span>)) = pSectionHeader[NumberOfSection<span class="number">-1</span>].VirtualAddress + num;</span><br><span class="line">    <span class="comment">//第二个作为结尾标记</span></span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace + num + align + <span class="number">8</span> + <span class="number">4</span>)) = <span class="number">0</span>;</span><br><span class="line">    num += (align + <span class="number">8</span>);<span class="comment">//\x00结尾字符串并且加上两个RVA</span></span><br><span class="line">    <span class="comment">//修复表结构</span></span><br><span class="line">    pNewImportDescriptor-&gt;FirstThunk = pSectionHeader[NumberOfSection<span class="number">-1</span>].VirtualAddress + num;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修复目录项</span></span><br><span class="line">    pDataDirectory[<span class="number">1</span>].VirtualAddress = pSectionHeader[NumberOfSection<span class="number">-1</span>].VirtualAddress;</span><br><span class="line">    pDataDirectory[<span class="number">1</span>].Size += length;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Name: %x\n"</span>, getFOA(pNewImportDescriptor-&gt;Name));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Original: %x\n"</span>, getFOA(pNewImportDescriptor-&gt;OriginalFirstThunk));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"First_Thunk: %x\n"</span>, getFOA(pNewImportDescriptor-&gt;FirstThunk));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二个版本，先设计好在进行填充的，所以写的很快</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InjectDll</span><span class="params">(LPVOID pFileBuffer, DWORD FOA, <span class="keyword">char</span>* NAME, <span class="keyword">char</span>* FuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">//初始化部分</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pPEHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pImportDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pCopyPlace = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_THUNK_DATA32 pThunkData32 = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pNewImportDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//初始化地址指针</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-&gt;e_lfanew);</span><br><span class="line">    pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class="number">4</span>);</span><br><span class="line">    pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">    pDataDirectory = pOptionHeader-&gt;DataDirectory;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Import_Table: %x Size: %x\n"</span>, pDataDirectory[<span class="number">1</span>].VirtualAddress, pDataDirectory[<span class="number">1</span>].Size);</span><br><span class="line">    pImportDescriptor = (DWORD)pFileBuffer + getFOA(pDataDirectory[<span class="number">1</span>].VirtualAddress);</span><br><span class="line">    pCopyPlace = (DWORD)pFileBuffer + FOA;</span><br><span class="line">    <span class="comment">//获取节表起始地址</span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="comment">//获取节表数量</span></span><br><span class="line">    DWORD NumberOfSection = pPEHeader-&gt;NumberOfSections;</span><br><span class="line">    DWORD length = <span class="keyword">sizeof</span>(IMAGE_IMPORT_DESCRIPTOR);</span><br><span class="line">    DWORD copyNum = <span class="number">0</span>;<span class="comment">//记录总长度</span></span><br><span class="line">    DWORD temp = <span class="number">0</span>;<span class="comment">//临时记录长度</span></span><br><span class="line">    DWORD funcNameAddr = <span class="number">0</span>;<span class="comment">//记录函数名偏移</span></span><br><span class="line">    DWORD IATAddr = <span class="number">0</span>;<span class="comment">//记录IAT表偏移</span></span><br><span class="line">    DWORD INTAddr = <span class="number">0</span>;<span class="comment">//记录INT表偏移</span></span><br><span class="line">    DWORD VirtualAddress = pSectionHeader[NumberOfSection<span class="number">-1</span>].VirtualAddress;</span><br><span class="line">    <span class="comment">//复制Dll名</span></span><br><span class="line">    temp = <span class="built_in">strlen</span>(NAME);</span><br><span class="line">    <span class="built_in">memcpy</span>(pCopyPlace, NAME, temp);</span><br><span class="line">    temp = getAlign(temp+<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">    copyNum += temp;<span class="comment">//对齐后</span></span><br><span class="line">    funcNameAddr = copyNum;</span><br><span class="line">    <span class="comment">//复制函数名</span></span><br><span class="line">    temp = <span class="built_in">strlen</span>(FuncName);</span><br><span class="line">    <span class="built_in">memset</span>((DWORD)pCopyPlace+copyNum, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((DWORD)pCopyPlace+copyNum+<span class="number">2</span>, FuncName, temp);</span><br><span class="line">    temp = getAlign(temp+<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">    INTAddr = copyNum+temp;</span><br><span class="line">    <span class="comment">//INT表</span></span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace +INTAddr)) = VirtualAddress + funcNameAddr;</span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace + INTAddr)+<span class="number">1</span>) = <span class="number">0</span> ;</span><br><span class="line">    <span class="comment">//INT表</span></span><br><span class="line">    IATAddr = INTAddr + <span class="number">8</span>;</span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace + IATAddr)) = VirtualAddress + funcNameAddr;</span><br><span class="line">    *((PDWORD)((DWORD)pCopyPlace + IATAddr)+<span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">    copyNum = (IATAddr+<span class="number">8</span>);</span><br><span class="line">    <span class="comment">//复制所有导入表结构</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, copyNum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, (DWORD)pCopyPlace);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, (DWORD)pImportDescriptor);</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((DWORD)pCopyPlace+copyNum, pImportDescriptor, length);</span><br><span class="line">        pImportDescriptor++;</span><br><span class="line">        copyNum += length;</span><br><span class="line">    &#125;<span class="keyword">while</span>(pImportDescriptor-&gt;Name!=<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//新增导入表结构</span></span><br><span class="line"></span><br><span class="line">    pNewImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)pCopyPlace+copyNum);</span><br><span class="line">    pNewImportDescriptor-&gt;Characteristics = <span class="number">0</span>;</span><br><span class="line">    pNewImportDescriptor-&gt;TimeDateStamp = <span class="number">0</span>;</span><br><span class="line">    pNewImportDescriptor-&gt;ForwarderChain = <span class="number">0</span>;</span><br><span class="line">    pNewImportDescriptor-&gt;Name = VirtualAddress;</span><br><span class="line">    pNewImportDescriptor-&gt;OriginalFirstThunk = VirtualAddress + INTAddr;</span><br><span class="line">    pNewImportDescriptor-&gt;FirstThunk = VirtualAddress + IATAddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改目录表</span></span><br><span class="line">    pDataDirectory[<span class="number">1</span>].VirtualAddress = VirtualAddress + (IATAddr+<span class="number">8</span>);</span><br><span class="line">    pDataDirectory[<span class="number">1</span>].Size += length;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Name: %x\n"</span>, getFOA(pNewImportDescriptor-&gt;Name));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Original: %x\n"</span>, getFOA(pNewImportDescriptor-&gt;OriginalFirstThunk));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"First_Thunk: %x\n"</span>, getFOA(pNewImportDescriptor-&gt;FirstThunk));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>启动不了有可能是节的属性出问题</strong></p><p><strong>本文作者</strong>：NoOne<br><strong>本文地址</strong>： <a href="https://noonegroup.xyz/posts/6fd44671/">https://noonegroup.xyz/posts/6fd44671/</a><br><strong>版权声明</strong>：转载请注明出处！</p></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/reverse-%E9%80%86%E5%90%91/" rel="tag"># reverse,逆向</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/1f1233d7/" rel="next" title="14-移位"><i class="fa fa-chevron-left"></i> 14-移位</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/97ad516e/" rel="prev" title="16-C++">16-C++ <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments" id="comments"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PE文件"><span class="nav-number">1.</span> <span class="nav-text">PE文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#手动解析PE文件"><span class="nav-number">1.1.</span> <span class="nav-text">手动解析PE文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dos头"><span class="nav-number">1.1.1.</span> <span class="nav-text">dos头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NT-HEADER"><span class="nav-number">1.1.2.</span> <span class="nav-text">NT_HEADER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IMAGE-FILE-HEADER"><span class="nav-number">1.1.3.</span> <span class="nav-text">IMAGE_FILE_HEADER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IMAGE-OPTIONAL-HEADER"><span class="nav-number">1.1.4.</span> <span class="nav-text">IMAGE_OPTIONAL_HEADER</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pe文件解析"><span class="nav-number">1.2.</span> <span class="nav-text">pe文件解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写exe读取PE头"><span class="nav-number">1.3.</span> <span class="nav-text">编写exe读取PE头</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#节表学习"><span class="nav-number">1.4.</span> <span class="nav-text">节表学习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FileBuffer和ImageBuffer"><span class="nav-number">1.5.</span> <span class="nav-text">FileBuffer和ImageBuffer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#练习"><span class="nav-number">1.5.1.</span> <span class="nav-text">练习</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#手动在代码区添加Shellcode"><span class="nav-number">1.6.</span> <span class="nav-text">手动在代码区添加Shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#任意节添加Shellcode"><span class="nav-number">1.7.</span> <span class="nav-text">任意节添加Shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加节"><span class="nav-number">1.8.</span> <span class="nav-text">添加节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合并节"><span class="nav-number">1.9.</span> <span class="nav-text">合并节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态链接和静态链接"><span class="nav-number">1.10.</span> <span class="nav-text">动态链接和静态链接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#动态链接"><span class="nav-number">1.10.1.</span> <span class="nav-text">动态链接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#导出表"><span class="nav-number">1.11.</span> <span class="nav-text">导出表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#手动找导出表"><span class="nav-number">1.11.1.</span> <span class="nav-text">手动找导出表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习-1"><span class="nav-number">1.11.2.</span> <span class="nav-text">练习</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重定位表"><span class="nav-number">1.12.</span> <span class="nav-text">重定位表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#打印重定位表"><span class="nav-number">1.12.1.</span> <span class="nav-text">打印重定位表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#移动导出表"><span class="nav-number">1.12.2.</span> <span class="nav-text">移动导出表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#移动重定位表"><span class="nav-number">1.12.3.</span> <span class="nav-text">移动重定位表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟操作系统重定位过程"><span class="nav-number">1.12.4.</span> <span class="nav-text">模拟操作系统重定位过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IAT表"><span class="nav-number">1.13.</span> <span class="nav-text">IAT表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#导入表"><span class="nav-number">1.14.</span> <span class="nav-text">导入表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#绑定导入表"><span class="nav-number">1.15.</span> <span class="nav-text">绑定导入表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#导入表注入"><span class="nav-number">1.16.</span> <span class="nav-text">导入表注入</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="NoOne" src="/images/photo.jpg"><p class="site-author-name" itemprop="name">NoOne</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">187</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">44</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">60</span> <span class="site-state-item-name">tags</span></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05vT25lLWh1Yg==" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;NoOne-hub"><i class="fa fa-fw fa-github"></i>GitHub</span> </span><span class="links-of-author-item"><span class="exturl" data-url="Tm9PbmU6ZG90YWVyZGF5QGdtYWlsLmNvbQ==" title="E-Mail &amp;rarr; NoOne:dotaerday@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</span></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">NoOne</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="Symbols count total">1m</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="Reading time total">15:46</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="Total Visitors"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="Total Views"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script src="//code.tidio.co/4fgjfhjokt1utyyp9l0cra3v0uw4uuwf.js"></script><script>NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'v5gtaUCUdFsLSpiQc2h4QM2E-MdYXbMMI',
    appKey: 'v5Re9AbMl3E5Y38ILfYDfkCj',
    placeholder: "Just go go",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);</script></body></html><!-- rebuild by neat -->